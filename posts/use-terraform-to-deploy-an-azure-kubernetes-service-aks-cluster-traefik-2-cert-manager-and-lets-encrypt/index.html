<!doctype html><html lang=en><head><title>Use Terraform to Deploy an Azure Kubernetes Service (AKS) Cluster, Traefik 2, cert-manager, and Let's Encrypt ::
Michael Schnerring — Coder and Computer Enthusiast</title><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content="In this post, we will deploy a simple Azure Kubernetes Service (AKS) cluster from scratch. To expose our web services securely, we will install Traefik 2 and configure cert-manager to manage Let&amp;rsquo;s Encrypt certificates. The best part about it: we will do everything with Terraform.
"><meta name=keywords content><meta name=robots content="noodp"><link rel=canonical href=https://schnerring.net/posts/use-terraform-to-deploy-an-azure-kubernetes-service-aks-cluster-traefik-2-cert-manager-and-lets-encrypt/><link rel=stylesheet href=https://schnerring.net/assets/style.css><link rel=stylesheet href=https://schnerring.net/style.css><link rel=apple-touch-icon-precomposed sizes=144x144 href=https://schnerring.net/img/apple-touch-icon-144-precomposed.png><link rel="shortcut icon" href=https://schnerring.net/img/favicon.png><link href=https://schnerring.net/assets/fonts/Inter-Italic.woff2 rel=preload type=font/woff2 as=font crossorigin><link href=https://schnerring.net/assets/fonts/Inter-Regular.woff2 rel=preload type=font/woff2 as=font crossorigin><link href=https://schnerring.net/assets/fonts/Inter-Medium.woff2 rel=preload type=font/woff2 as=font crossorigin><link href=https://schnerring.net/assets/fonts/Inter-MediumItalic.woff2 rel=preload type=font/woff2 as=font crossorigin><link href=https://schnerring.net/assets/fonts/Inter-Bold.woff2 rel=preload type=font/woff2 as=font crossorigin><link href=https://schnerring.net/assets/fonts/Inter-BoldItalic.woff2 rel=preload type=font/woff2 as=font crossorigin><meta name=twitter:card content="summary"><meta name=twitter:title content="Use Terraform to Deploy an Azure Kubernetes Service (AKS) Cluster, Traefik 2, cert-manager, and Let's Encrypt"><meta name=twitter:description content="In this post, we will deploy a simple Azure Kubernetes Service (AKS) cluster from scratch. To expose our web services securely, we will install Traefik 2 and configure cert-manager to manage Let&rsquo;s Encrypt certificates. The best part about it: we will do everything with Terraform."><meta property="og:title" content="Use Terraform to Deploy an Azure Kubernetes Service (AKS) Cluster, Traefik 2, cert-manager, and Let's Encrypt"><meta property="og:description" content="In this post, we will deploy a simple Azure Kubernetes Service (AKS) cluster from scratch. To expose our web services securely, we will install Traefik 2 and configure cert-manager to manage Let&rsquo;s Encrypt certificates. The best part about it: we will do everything with Terraform."><meta property="og:type" content="article"><meta property="og:url" content="https://schnerring.net/posts/use-terraform-to-deploy-an-azure-kubernetes-service-aks-cluster-traefik-2-cert-manager-and-lets-encrypt/"><meta property="article:section" content="posts"><meta property="article:published_time" content="2021-04-25T01:00:27+02:00"><meta property="article:modified_time" content="2021-04-25T01:00:27+02:00"><meta property="og:site_name" content="Michael Schnerring"></head><body><div class=container><header class=header><span class=header__inner><a href=/ class=logo style=text-decoration:none><span class=logo__mark><svg xmlns="http://www.w3.org/2000/svg" class="greater-icon" viewBox="0 0 44 44"><path fill="none" d="M15 8l14.729 14.382L15 35.367"/></svg></span><span class=logo__text>schnerring.net</span>
<span class=logo__cursor></span></a><span class=header__right><nav class=menu><ul class="menu__inner menu__inner--desktop"><li><a href=/about>About</a></li></ul><ul class="menu__inner menu__inner--mobile"><li><a href=/about>About</a></li></ul></nav><span class=menu-trigger><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M0 0h24v24H0z" fill="none"/><path d="M3 18h18v-2H3v2zm0-5h18v-2H3v2zm0-7v2h18V6H3z"/></svg></span><span class=theme-toggle><svg class="theme-toggler" width="24" height="24" viewBox="0 0 48 48" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M22 41c10.4934.0 19-8.5066 19-19C41 11.5066 32.4934 3 22 3 11.5066 3 3 11.5066 3 22s8.5066 19 19 19zM7 22C7 13.7157 13.7157 7 22 7V37C13.7157 37 7 30.2843 7 22z"/></svg></span></span></span></header><div class=content><div class=post><h1 class=post-title>Use Terraform to Deploy an Azure Kubernetes Service (AKS) Cluster, Traefik 2, cert-manager, and Let&rsquo;s Encrypt</h1><div class=post-meta><span class=post-date>2021-04-25</span></div><span class=post-tags><a href=https://schnerring.net/tags/aks/>#aks</a>&nbsp;
<a href=https://schnerring.net/tags/azure/>#azure</a>&nbsp;
<a href=https://schnerring.net/tags/azure-kubernetes-service/>#azure kubernetes service</a>&nbsp;
<a href=https://schnerring.net/tags/cert-manager/>#cert-manager</a>&nbsp;
<a href=https://schnerring.net/tags/devops/>#devops</a>&nbsp;
<a href=https://schnerring.net/tags/helm/>#helm</a>&nbsp;
<a href=https://schnerring.net/tags/k8s/>#k8s</a>&nbsp;
<a href=https://schnerring.net/tags/kubernetes/>#kubernetes</a>&nbsp;
<a href=https://schnerring.net/tags/letsencrypt/>#letsencrypt</a>&nbsp;
<a href=https://schnerring.net/tags/terraform/>#terraform</a>&nbsp;
<a href=https://schnerring.net/tags/traefik/>#traefik</a>&nbsp;</span><div class=post-content><p>In this post, we will deploy a simple <a href=https://azure.microsoft.com/en-us/services/kubernetes-service/>Azure Kubernetes Service (AKS)</a> cluster from scratch. To expose our web services securely, we will install Traefik 2 and configure <a href=https://cert-manager.io/>cert-manager</a> to manage Let&rsquo;s Encrypt certificates. The best part about it: we will do everything with <a href=https://www.terraform.io/>Terraform</a>.</p><h2 id=prerequisites>Prerequisites</h2><p>Keep in mind that I have tested the steps that follow on Windows. So if you are using another OS, you might have to modify them slightly. I also omit some non-essential steps in between, so it helps if you are already familiar with Azure, Kubernetes, and Terraform.</p><p>To follow along, you will need the following things:</p><ul><li><a href=https://azure.microsoft.com/en-us/free/>An active Azure subscription</a></li><li><a href=https://www.terraform.io/downloads.html>Install Terraform</a></li><li><a href=https://kubernetes.io/docs/tasks/tools/install-kubectl-windows/>Install kubectl</a></li><li>A registered domain</li><li>A DNS provider:<ul><li>that <a href=https://cert-manager.io/docs/configuration/acme/dns01/#supported-dns01-providers>supports cert-manager DNS01 challenge validation</a></li><li>with API access, so we can manage DNS records with Terraform — I use Cloudflare</li></ul></li></ul><h2 id=overview>Overview</h2><p>Here is an outline of the steps required to build our solution:</p><ol><li><a href=#step-1-setup-terraform>Setup Terraform</a></li><li><a href=#step-2-create-the-aks-cluster>Create the AKS cluster</a></li><li><a href=#step-3-deploy-cert-manager>Deploy cert-manager</a></li><li><a href=#step-4-configure-lets-encrypt>Configure Let&rsquo;s Encrypt</a></li><li><a href=#step-5-deploy-traefik>Deploy Traefik</a></li><li><a href=#step-6-deploy-a-demo-application>Deploy a demo application</a></li></ol><h2 id=step-1-setup-terraform>Step 1: Setup Terraform</h2><p>We will make use of Terraform providers to put everything together:</p><ul><li><a href=https://registry.terraform.io/providers/hashicorp/azurerm/latest><code>azurerm</code></a> to manage our AKS cluster</li><li><a href=https://registry.terraform.io/providers/hashicorp/helm/latest><code>helm</code></a> to deploy cert-manager and Traefik</li><li><a href=https://registry.terraform.io/providers/hashicorp/kubernetes/latest><code>kubernetes</code></a> to manage namespaces and deploy our demo app</li><li><a href=https://registry.terraform.io/providers/hashicorp/kubernetes-alpha/latest><code>kubernetes-alpha</code></a> to manage <a href=https://kubernetes.io/docs/concepts/extend-kubernetes/api-extension/custom-resources/>CRD resources</a></li><li><a href=https://registry.terraform.io/providers/cloudflare/cloudflare/latest><code>cloudflare</code></a> to manage DNS records</li></ul><p>We add a <code>provider.tf</code> file with the following content:</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-hcl data-lang=hcl><span style=color:#66d9ef>terraform</span> {
  required_version <span style=color:#f92672>=</span> &#34;<span style=color:#f92672>=</span> <span style=color:#ae81ff>0</span>.<span style=color:#ae81ff>14</span>.<span style=color:#ae81ff>9</span><span style=color:#960050;background-color:#1e0010>&#34;</span>

  <span style=color:#66d9ef>required_providers</span> {
    azurerm <span style=color:#f92672>=</span> {
      source  <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;azurerm&#34;</span>
      version <span style=color:#f92672>=</span> &#34;<span style=color:#f92672>=</span><span style=color:#ae81ff>2</span>.<span style=color:#ae81ff>56</span>.<span style=color:#ae81ff>0</span><span style=color:#960050;background-color:#1e0010>&#34;</span>
    }

    cloudflare <span style=color:#f92672>=</span> {
      source  <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;cloudflare/cloudflare&#34;</span>
      version <span style=color:#f92672>=</span> &#34;<span style=color:#f92672>=</span><span style=color:#ae81ff>2</span>.<span style=color:#ae81ff>20</span>.<span style=color:#ae81ff>0</span><span style=color:#960050;background-color:#1e0010>&#34;</span>
    }

    helm <span style=color:#f92672>=</span> {
      source  <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;helm&#34;</span>
      version <span style=color:#f92672>=</span> &#34;<span style=color:#f92672>=</span><span style=color:#ae81ff>2</span>.<span style=color:#ae81ff>1</span>.<span style=color:#ae81ff>1</span><span style=color:#960050;background-color:#1e0010>&#34;</span>
    }

    kubernetes <span style=color:#f92672>=</span> {
      source  <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;kubernetes&#34;</span>
      version <span style=color:#f92672>=</span> &#34;<span style=color:#f92672>=</span><span style=color:#ae81ff>2</span>.<span style=color:#ae81ff>1</span>.<span style=color:#ae81ff>0</span><span style=color:#960050;background-color:#1e0010>&#34;</span>
    }

    kubernetes-alpha <span style=color:#f92672>=</span> {
      source  <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;kubernetes-alpha&#34;</span>
      version <span style=color:#f92672>=</span> &#34;<span style=color:#f92672>=</span><span style=color:#ae81ff>0</span>.<span style=color:#ae81ff>3</span>.<span style=color:#ae81ff>2</span><span style=color:#960050;background-color:#1e0010>&#34;</span>
    }
  }
}

<span style=color:#66d9ef>provider</span> <span style=color:#e6db74>&#34;azurerm&#34;</span> {
  <span style=color:#66d9ef>features</span> {}
}

<span style=color:#66d9ef>provider</span> <span style=color:#e6db74>&#34;cloudflare&#34;</span> {}
</code></pre></div><p>For now, we only configured the <code>azurerm</code> and <code>cloudflare</code> providers. After we set up the AKS cluster, we will configure the <code>helm</code>, <code>kubernetes</code>, and <code>kubernetes-alpha</code> providers.</p><p>I have opted to <a href=https://registry.terraform.io/providers/hashicorp/azurerm/latest/docs/guides/service_principal_client_secret#configuring-the-service-principal-in-terraform>configure the <code>azurerm</code> provider with environment variables</a>. You might want to <a href=https://registry.terraform.io/providers/hashicorp/azurerm/latest/docs#authenticating-to-azure>choose a different approach</a> depending on your needs.</p><p>To authenticate the <code>cloudflare</code> provider, I use a <a href=https://developers.cloudflare.com/api/tokens/create>Cloudflare API Token</a> with <code>Edit Zone</code> permissions.</p><p>After, we have to make sure to run <code>terraform init</code> to get started.</p><h2 id=step-2-create-the-aks-cluster>Step 2: Create the AKS cluster</h2><p>Creating a production-ready AKS cluster is out of scope for this post, which means that we will not delve too deep into AKS configuration. There are many things we are skipping over, like <a href=https://docs.microsoft.com/en-us/azure/aks/operator-best-practices-storage>backups</a> and <a href=https://docs.microsoft.com/en-us/azure/azure-monitor/containers/container-insights-overview>monitoring</a>. For a little more elaborate example, check out the <a href=https://docs.microsoft.com/en-us/azure/developer/terraform/create-k8s-cluster-with-tf-and-aks>official Terraform on Azure documentation</a>.</p><p>We create a new file <code>k8s.tf</code> with the following content:</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-hcl data-lang=hcl><span style=color:#66d9ef>resource</span> <span style=color:#e6db74>&#34;azurerm_resource_group&#34; &#34;k8s&#34;</span> {
  name     <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;k8s-rg&#34;</span>
  location <span style=color:#f92672>=</span> <span style=color:#66d9ef>var</span>.<span style=color:#66d9ef>location</span>
}

<span style=color:#66d9ef>resource</span> <span style=color:#e6db74>&#34;random_id&#34; &#34;random&#34;</span> {
  byte_length <span style=color:#f92672>=</span> <span style=color:#ae81ff>2</span>
}

<span style=color:#66d9ef>resource</span> <span style=color:#e6db74>&#34;azurerm_kubernetes_cluster&#34; &#34;k8s&#34;</span> {
  name                <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;k8s-aks&#34;</span>
  resource_group_name <span style=color:#f92672>=</span> <span style=color:#66d9ef>azurerm_resource_group</span>.<span style=color:#66d9ef>k8s</span>.<span style=color:#66d9ef>name</span>
  location            <span style=color:#f92672>=</span> <span style=color:#66d9ef>var</span>.<span style=color:#66d9ef>location</span>
  tags                <span style=color:#f92672>=</span> <span style=color:#66d9ef>var</span>.<span style=color:#66d9ef>tags</span>

  dns_prefix <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;k8saks${random_id.random.dec}&#34;</span>

  <span style=color:#66d9ef>default_node_pool</span> {
    name       <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;default&#34;</span>
    node_count <span style=color:#f92672>=</span> <span style=color:#ae81ff>1</span>
    vm_size    <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;Standard_B2s&#34;</span>
  }

  <span style=color:#66d9ef>identity</span> {
    type <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;SystemAssigned&#34;</span>
  }
}
</code></pre></div><p>Note that I have defined the <code>var.location</code> and <code>var.tags</code> variables in a separate <a href=https://github.com/schnerring/infrastructure/blob/0.1.0/variables.tf>variables.tf</a> file.</p><p>To be able to access the AKS cluster locally with <code>kubectl</code>, we define a Terraform <a href=https://www.terraform.io/docs/language/values/outputs.html><code>output</code></a> in the <code>outputs.tf</code> file:</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-hcl data-lang=hcl><span style=color:#66d9ef>output</span> <span style=color:#e6db74>&#34;kube_config&#34;</span> {
  value       <span style=color:#f92672>=</span> <span style=color:#66d9ef>azurerm_kubernetes_cluster</span>.<span style=color:#66d9ef>k8s</span>.<span style=color:#66d9ef>kube_config_raw</span>
  description <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;kubeconfig for kubectl access.&#34;</span>
  sensitive   <span style=color:#f92672>=</span> <span style=color:#66d9ef>true</span>
}
</code></pre></div><p>We have to set <code>sensitive = true</code> so our credentials will not get leaked, which could happen if we later decide to run Terraform with GitHub Actions. We apply our configuration by running Terraform:</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell>terraform plan -out infrastructure.tfplan
terraform apply infrastructure.tfplan
</code></pre></div><p>After the deployment completes, we set up <code>kubectl</code> to be able to access our cluster:</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell>terraform output -raw kube_config &gt; ~/.kube/config
</code></pre></div><p>We check the deployment by running <code>kubectl get all</code>:</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-txt data-lang=txt>NAME                 TYPE        CLUSTER-IP   EXTERNAL-IP   PORT(S)   AGE
service/kubernetes   ClusterIP   10.0.0.1     &lt;none&gt;        443/TCP   3m54s
</code></pre></div><h2 id=step-3-deploy-cert-manager>Step 3: Deploy cert-manager</h2><p>To issue free <a href=https://letsencrypt.org/>Let&rsquo;s Encrypt</a> certificates for the web services we provide, the first thing we have to deploy is <a href=https://cert-manager.io/docs/installation/kubernetes/#installing-with-helm>cert-manager</a>. We need to configure the <a href=https://registry.terraform.io/providers/hashicorp/helm/latest/docs#credentials-config><code>helm</code></a> provider first. While we are on it, we also configure the <a href=https://registry.terraform.io/providers/hashicorp/kubernetes/latest/docs#authentication><code>kubernetes</code></a> and <a href=https://registry.terraform.io/providers/hashicorp/kubernetes-alpha/latest/docs><code>kubernetes-alpha</code></a> providers:</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-hcl data-lang=hcl><span style=color:#66d9ef>provider</span> <span style=color:#e6db74>&#34;helm&#34;</span> {
  <span style=color:#66d9ef>kubernetes</span> {
    host <span style=color:#f92672>=</span> <span style=color:#66d9ef>azurerm_kubernetes_cluster</span>.<span style=color:#66d9ef>k8s</span>.<span style=color:#66d9ef>kube_config</span>.<span style=color:#ae81ff>0</span>.<span style=color:#66d9ef>host</span>

    client_certificate     <span style=color:#f92672>=</span> <span style=color:#66d9ef>base64decode</span>(<span style=color:#66d9ef>azurerm_kubernetes_cluster</span>.<span style=color:#66d9ef>k8s</span>.<span style=color:#66d9ef>kube_config</span>.<span style=color:#ae81ff>0</span>.<span style=color:#66d9ef>client_certificate</span>)
    client_key             <span style=color:#f92672>=</span> <span style=color:#66d9ef>base64decode</span>(<span style=color:#66d9ef>azurerm_kubernetes_cluster</span>.<span style=color:#66d9ef>k8s</span>.<span style=color:#66d9ef>kube_config</span>.<span style=color:#ae81ff>0</span>.<span style=color:#66d9ef>client_key</span>)
    cluster_ca_certificate <span style=color:#f92672>=</span> <span style=color:#66d9ef>base64decode</span>(<span style=color:#66d9ef>azurerm_kubernetes_cluster</span>.<span style=color:#66d9ef>k8s</span>.<span style=color:#66d9ef>kube_config</span>.<span style=color:#ae81ff>0</span>.<span style=color:#66d9ef>cluster_ca_certificate</span>)
  }
}

<span style=color:#66d9ef>provider</span> <span style=color:#e6db74>&#34;kubernetes&#34;</span> {
  host <span style=color:#f92672>=</span> <span style=color:#66d9ef>azurerm_kubernetes_cluster</span>.<span style=color:#66d9ef>k8s</span>.<span style=color:#66d9ef>kube_config</span>.<span style=color:#ae81ff>0</span>.<span style=color:#66d9ef>host</span>

  client_certificate     <span style=color:#f92672>=</span> <span style=color:#66d9ef>base64decode</span>(<span style=color:#66d9ef>azurerm_kubernetes_cluster</span>.<span style=color:#66d9ef>k8s</span>.<span style=color:#66d9ef>kube_config</span>.<span style=color:#ae81ff>0</span>.<span style=color:#66d9ef>client_certificate</span>)
  client_key             <span style=color:#f92672>=</span> <span style=color:#66d9ef>base64decode</span>(<span style=color:#66d9ef>azurerm_kubernetes_cluster</span>.<span style=color:#66d9ef>k8s</span>.<span style=color:#66d9ef>kube_config</span>.<span style=color:#ae81ff>0</span>.<span style=color:#66d9ef>client_key</span>)
  cluster_ca_certificate <span style=color:#f92672>=</span> <span style=color:#66d9ef>base64decode</span>(<span style=color:#66d9ef>azurerm_kubernetes_cluster</span>.<span style=color:#66d9ef>k8s</span>.<span style=color:#66d9ef>kube_config</span>.<span style=color:#ae81ff>0</span>.<span style=color:#66d9ef>cluster_ca_certificate</span>)
}

<span style=color:#66d9ef>provider</span> <span style=color:#e6db74>&#34;kubernetes-alpha&#34;</span> {
  host <span style=color:#f92672>=</span> <span style=color:#66d9ef>azurerm_kubernetes_cluster</span>.<span style=color:#66d9ef>k8s</span>.<span style=color:#66d9ef>kube_config</span>.<span style=color:#ae81ff>0</span>.<span style=color:#66d9ef>host</span>

  client_certificate     <span style=color:#f92672>=</span> <span style=color:#66d9ef>base64decode</span>(<span style=color:#66d9ef>azurerm_kubernetes_cluster</span>.<span style=color:#66d9ef>k8s</span>.<span style=color:#66d9ef>kube_config</span>.<span style=color:#ae81ff>0</span>.<span style=color:#66d9ef>client_certificate</span>)
  client_key             <span style=color:#f92672>=</span> <span style=color:#66d9ef>base64decode</span>(<span style=color:#66d9ef>azurerm_kubernetes_cluster</span>.<span style=color:#66d9ef>k8s</span>.<span style=color:#66d9ef>kube_config</span>.<span style=color:#ae81ff>0</span>.<span style=color:#66d9ef>client_key</span>)
  cluster_ca_certificate <span style=color:#f92672>=</span> <span style=color:#66d9ef>base64decode</span>(<span style=color:#66d9ef>azurerm_kubernetes_cluster</span>.<span style=color:#66d9ef>k8s</span>.<span style=color:#66d9ef>kube_config</span>.<span style=color:#ae81ff>0</span>.<span style=color:#66d9ef>cluster_ca_certificate</span>)
}
</code></pre></div><p>Next, we deploy cert-manager with Helm by adding the following Terraform code to the <code>k8s.tf</code> file:</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-hcl data-lang=hcl><span style=color:#66d9ef>resource</span> <span style=color:#e6db74>&#34;kubernetes_namespace&#34; &#34;cert_manager&#34;</span> {
  <span style=color:#66d9ef>metadata</span> {
    name <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;cert-manager&#34;</span>
  }
}

<span style=color:#66d9ef>resource</span> <span style=color:#e6db74>&#34;helm_release&#34; &#34;cert_manager&#34;</span> {
  name       <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;cert-manager&#34;</span>
  repository <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;https://charts.jetstack.io&#34;</span>
  chart      <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;cert-manager&#34;</span>
  version    <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;1.3.1&#34;</span>
  namespace  <span style=color:#f92672>=</span> <span style=color:#66d9ef>kubernetes_namespace</span>.<span style=color:#66d9ef>cert_manager</span>.<span style=color:#66d9ef>metadata</span>[<span style=color:#ae81ff>0</span>].<span style=color:#66d9ef>name</span>

  <span style=color:#66d9ef>set</span> {
    name  <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;installCRDs&#34;</span>
    value <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;true&#34;</span>
  }
}
</code></pre></div><p>We then run <code>terraform apply</code> to deploy cert-manager. We then check our work by running <code>kubectl get all --namespace cert-manager</code>, which should display something like this:</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-txt data-lang=txt>NAME                                           READY   STATUS    RESTARTS   AGE
pod/cert-manager-7998c69865-vrvrd              1/1     Running   0          75s
pod/cert-manager-cainjector-7b744d56fb-qb54k   1/1     Running   0          75s
pod/cert-manager-webhook-7d6d4c78bc-svzq5      1/1     Running   0          75s

NAME                           TYPE        CLUSTER-IP    EXTERNAL-IP   PORT(S)    AGE
service/cert-manager           ClusterIP   10.0.141.59   &lt;none&gt;        9402/TCP   75s
service/cert-manager-webhook   ClusterIP   10.0.18.192   &lt;none&gt;        443/TCP    75s

NAME                                      READY   UP-TO-DATE   AVAILABLE   AGE
deployment.apps/cert-manager              1/1     1            1           75s
deployment.apps/cert-manager-cainjector   1/1     1            1           75s
deployment.apps/cert-manager-webhook      1/1     1            1           75s

NAME                                                 DESIRED   CURRENT   READY   AGE
replicaset.apps/cert-manager-7998c69865              1         1         1       75s
replicaset.apps/cert-manager-cainjector-7b744d56fb   1         1         1       75s
replicaset.apps/cert-manager-webhook-7d6d4c78bc      1         1         1       75s
</code></pre></div><h2 id=step-4-configure-lets-encrypt>Step 4: Configure Let&rsquo;s Encrypt</h2><p>In Kubernetes, <code>Issuer</code>s are Kubernetes resources representing certificate authorities able to generate certificates. We have to create a single <code>ClusterIssuer</code>, a cluster-wide <code>Issuer</code>, using <a href=https://cert-manager.io/docs/configuration/acme/dns01/>DNS01 challenge validation</a> with Let&rsquo;s Encrypt servers. As mentioned earlier, we will use Cloudflare, but <a href=https://cert-manager.io/docs/configuration/acme/dns01/#supported-dns01-providers>many other DNS providers are supported</a>.</p><p>First, we need to create a Cloudflare API Token on the Cloudflare website, at <code>User Profile</code> → <code>API Tokens</code>. <a href=https://cert-manager.io/docs/configuration/acme/dns01/cloudflare/#api-tokens>The following permissions are required</a>:</p><ul><li><code>Zone</code> - <code>DNS</code> - <code>Edit</code></li><li><code>Zone</code> - <code>Zone</code> - <code>Read</code></li></ul><p>To securely pass the token to Terraform, we create a <code>sensitive</code> variable. We also add a variable containing the email address where Let&rsquo;s Encrypt can notify us about expiring certificates:</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-hcl data-lang=hcl><span style=color:#66d9ef>variable</span> <span style=color:#e6db74>&#34;letsencrypt_email&#34;</span> {
  type        <span style=color:#f92672>=</span> <span style=color:#66d9ef>string</span>
  description <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;Email address that Let&#39;s Encrypt will use to send notifications about expiring certificates and account-related issues to.&#34;</span>
  sensitive   <span style=color:#f92672>=</span> <span style=color:#66d9ef>true</span>
}

<span style=color:#66d9ef>variable</span> <span style=color:#e6db74>&#34;letsencrypt_cloudflare_api_token&#34;</span> {
  type        <span style=color:#f92672>=</span> <span style=color:#66d9ef>string</span>
  description <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;Cloudflare API token with Zone-DNS-Edit and Zone-Zone-Read permissions, which is required for DNS01 challenge validation.&#34;</span>
  sensitive   <span style=color:#f92672>=</span> <span style=color:#66d9ef>true</span>
}
</code></pre></div><p>With Terraform, we then add the secret containing the API token to our cluster. Since <code>ClusterIssuer</code> is a cluster-scoped resource, we need to make sure the secret is globally available by putting it in the <code>cert-manager</code> namespace:</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-hcl data-lang=hcl><span style=color:#66d9ef>resource</span> <span style=color:#e6db74>&#34;kubernetes_secret&#34; &#34;letsencrypt_cloudflare_api_token_secret&#34;</span> {
  <span style=color:#66d9ef>metadata</span> {
    name      <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;letsencrypt-cloudflare-api-token-secret&#34;</span>
    namespace <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;cert-manager&#34;</span>
  }

  data <span style=color:#f92672>=</span> {
    &#34;api-token&#34; <span style=color:#f92672>=</span> <span style=color:#66d9ef>var</span>.<span style=color:#66d9ef>letsencrypt_cloudflare_api_token</span>
  }
}
</code></pre></div><p>Next, we add the staging and production <code>ClusterIssuer</code> cert-manager CRD resources for Let&rsquo;s Encrypt. We will have to use regular Kubernetes YAML manifests since we cannot deploy CRDs with the <code>kubernetes</code> provider. Here, the <a href=https://registry.terraform.io/providers/hashicorp/kubernetes-alpha/latest/docs/resources/kubernetes_manifest><code>kubernetes_manifest</code></a> resource of the <code>kubernetes-alpha</code> provider comes in. Together with the Terraform <a href=https://www.terraform.io/docs/language/functions/yamldecode.html><code>yamldecode()</code></a> and <a href=https://www.terraform.io/docs/language/functions/templatefile.html><code>templatefile()</code></a> functions, we get a pretty nice solution.</p><p>Let&rsquo;s start by defining the <code>letsencrypt-issuer.tpl.yaml</code> template file:</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=color:#f92672>apiVersion</span>: <span style=color:#ae81ff>cert-manager.io/v1</span>
<span style=color:#f92672>kind</span>: <span style=color:#ae81ff>ClusterIssuer</span>
<span style=color:#f92672>metadata</span>:
  <span style=color:#f92672>name</span>: <span style=color:#ae81ff>${name}</span>
<span style=color:#f92672>spec</span>:
  <span style=color:#f92672>acme</span>:
    <span style=color:#f92672>email</span>: <span style=color:#ae81ff>${email}</span>
    <span style=color:#f92672>server</span>: <span style=color:#ae81ff>${server}</span>
    <span style=color:#f92672>privateKeySecretRef</span>:
      <span style=color:#f92672>name</span>: <span style=color:#ae81ff>issuer-account-key-${name}</span>
    <span style=color:#f92672>solvers</span>:
      - <span style=color:#f92672>dns01</span>:
          <span style=color:#f92672>cloudflare</span>:
            <span style=color:#f92672>apiTokenSecretRef</span>:
              <span style=color:#f92672>name</span>: <span style=color:#ae81ff>${api_token_secret_name}</span>
              <span style=color:#f92672>key</span>: <span style=color:#ae81ff>${api_token_secret_data_key}</span>
</code></pre></div><p>We then create the staging and production <code>ClusterIssuer</code>s like so:</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-hcl data-lang=hcl><span style=color:#66d9ef>resource</span> <span style=color:#e6db74>&#34;kubernetes_manifest&#34; &#34;letsencrypt_issuer_staging&#34;</span> {
  provider <span style=color:#f92672>=</span> <span style=color:#66d9ef>kubernetes</span><span style=color:#960050;background-color:#1e0010>-</span><span style=color:#66d9ef>alpha</span>

  manifest <span style=color:#f92672>=</span> <span style=color:#66d9ef>yamldecode</span>(<span style=color:#66d9ef>templatefile</span>(
    <span style=color:#e6db74>&#34;${path.module}/letsencrypt-issuer.tpl.yaml&#34;</span>,
    {
      &#34;name&#34;                      <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;letsencrypt-staging&#34;</span>
      &#34;email&#34;                     <span style=color:#f92672>=</span> <span style=color:#66d9ef>var</span>.<span style=color:#66d9ef>letsencrypt_email</span>
      &#34;server&#34;                    <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;https://acme-staging-v02.api.letsencrypt.org/directory&#34;</span>
      &#34;api_token_secret_name&#34;     <span style=color:#f92672>=</span> <span style=color:#66d9ef>kubernetes_secret</span>.<span style=color:#66d9ef>letsencrypt_cloudflare_api_token_secret</span>.<span style=color:#66d9ef>metadata</span>[<span style=color:#ae81ff>0</span>].<span style=color:#66d9ef>name</span>
      &#34;api_token_secret_data_key&#34; <span style=color:#f92672>=</span> <span style=color:#66d9ef>keys</span>(<span style=color:#66d9ef>kubernetes_secret</span>.<span style=color:#66d9ef>letsencrypt_cloudflare_api_token_secret</span>.<span style=color:#66d9ef>data</span>)[<span style=color:#ae81ff>0</span>]
    }
  ))

  depends_on <span style=color:#f92672>=</span> [<span style=color:#66d9ef>helm_release</span>.<span style=color:#66d9ef>cert_manager</span>]
}

<span style=color:#66d9ef>resource</span> <span style=color:#e6db74>&#34;kubernetes_manifest&#34; &#34;letsencrypt_issuer_production&#34;</span> {
  provider <span style=color:#f92672>=</span> <span style=color:#66d9ef>kubernetes</span><span style=color:#960050;background-color:#1e0010>-</span><span style=color:#66d9ef>alpha</span>

  manifest <span style=color:#f92672>=</span> <span style=color:#66d9ef>yamldecode</span>(<span style=color:#66d9ef>templatefile</span>(
    <span style=color:#e6db74>&#34;${path.module}/letsencrypt-issuer.tpl.yaml&#34;</span>,
    {
      &#34;name&#34;                      <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;letsencrypt-production&#34;</span>
      &#34;email&#34;                     <span style=color:#f92672>=</span> <span style=color:#66d9ef>var</span>.<span style=color:#66d9ef>letsencrypt_email</span>
      &#34;server&#34;                    <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;https://acme-v02.api.letsencrypt.org/directory&#34;</span>
      &#34;api_token_secret_name&#34;     <span style=color:#f92672>=</span> <span style=color:#66d9ef>kubernetes_secret</span>.<span style=color:#66d9ef>letsencrypt_cloudflare_api_token_secret</span>.<span style=color:#66d9ef>metadata</span>[<span style=color:#ae81ff>0</span>].<span style=color:#66d9ef>name</span>
      &#34;api_token_secret_data_key&#34; <span style=color:#f92672>=</span> <span style=color:#66d9ef>keys</span>(<span style=color:#66d9ef>kubernetes_secret</span>.<span style=color:#66d9ef>letsencrypt_cloudflare_api_token_secret</span>.<span style=color:#66d9ef>data</span>)[<span style=color:#ae81ff>0</span>]
    }
  ))

  depends_on <span style=color:#f92672>=</span> [<span style=color:#66d9ef>helm_release</span>.<span style=color:#66d9ef>cert_manager</span>]
}
</code></pre></div><p>Now we <code>terraform apply</code> the changes.</p><h2 id=step-5-deploy-traefik>Step 5: Deploy Traefik</h2><p>To manage external access to our Kubernetes cluster, we need to configure Kubernetes <a href=https://kubernetes.io/docs/concepts/services-networking/ingress/><code>Ingress</code> resources</a>. To satisfy an <code>Ingress</code>, we first need to configure an <a href=https://kubernetes.io/docs/concepts/services-networking/ingress-controllers/>Ingress Controller</a>. We will use Traefik for this.</p><p>To manage ingress, we could also use the Traefik <code>IngressRoute</code> CRD. However, at the time of this writing, <a href=https://doc.traefik.io/traefik/providers/kubernetes-crd/#letsencrypt-support-with-the-custom-resource-definition-provider>cert-manager cannot directly interface with Traefik CRDs</a>, so we would have to manage <code>Certificate</code> and <code>Secret</code> resources manually, which is cumbersome.</p><p>We add the following to the <code>k8s.tf</code> file:</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-hcl data-lang=hcl><span style=color:#66d9ef>resource</span> <span style=color:#e6db74>&#34;kubernetes_namespace&#34; &#34;traefik&#34;</span> {
  <span style=color:#66d9ef>metadata</span> {
    name <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;traefik&#34;</span>
  }
}

<span style=color:#66d9ef>resource</span> <span style=color:#e6db74>&#34;helm_release&#34; &#34;traefik&#34;</span> {
  name       <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;traefik&#34;</span>
  repository <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;https://helm.traefik.io/traefik&#34;</span>
  chart      <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;traefik&#34;</span>
  version    <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;9.18.2&#34;</span>
  namespace  <span style=color:#f92672>=</span> <span style=color:#66d9ef>kubernetes_namespace</span>.<span style=color:#66d9ef>traefik</span>.<span style=color:#66d9ef>metadata</span>[<span style=color:#ae81ff>0</span>].<span style=color:#66d9ef>name</span>

  <span style=color:#66d9ef>set</span> {
    name  <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;ports.web.redirectTo&#34;</span>
    value <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;websecure&#34;</span>
  }
}
</code></pre></div><p>Setting <code>ports.web.redirectTo</code> to <code>websecure</code> forces all HTTP traffic to be redirected to HTTPS.</p><p>After running <code>terraform apply</code>, we check the deployment by running <code>kubectl get all --namespace traefik</code>:</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-txt data-lang=txt>NAME                           READY   STATUS    RESTARTS   AGE
pod/traefik-6b6767d778-hxzzw   1/1     Running   0          68s

NAME              TYPE           CLUSTER-IP   EXTERNAL-IP      PORT(S)                      AGE
service/traefik   LoadBalancer   10.0.247.4   51.103.157.225   80:32468/TCP,443:31284/TCP   69s

NAME                      READY   UP-TO-DATE   AVAILABLE   AGE
deployment.apps/traefik   1/1     1            1           69s

NAME                                 DESIRED   CURRENT   READY   AGE
replicaset.apps/traefik-6b6767d778   1         1         1       69s
</code></pre></div><p>Next, we add a wildcard DNS record with the IP of our Traefik service. To obtain the external IP address of the service, we leverage the <code>kubernetes_service</code> <a href=https://www.terraform.io/docs/language/data-sources/index.html>Data Source</a> of the <code>kubernetes</code> provider. We then add the wildcard DNS record <code>*.k8s.schnerring.net</code> pointing to the external IP of Traefik.</p><p>Let us update the <code>k8s.tf</code> file accordingly and <code>terraform apply</code> the changes:</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-hcl data-lang=hcl><span style=color:#66d9ef>data</span> <span style=color:#e6db74>&#34;kubernetes_service&#34; &#34;traefik&#34;</span> {
  <span style=color:#66d9ef>metadata</span> {
    name      <span style=color:#f92672>=</span> <span style=color:#66d9ef>helm_release</span>.<span style=color:#66d9ef>traefik</span>.<span style=color:#66d9ef>name</span>
    namespace <span style=color:#f92672>=</span> <span style=color:#66d9ef>helm_release</span>.<span style=color:#66d9ef>traefik</span>.<span style=color:#66d9ef>namespace</span>
  }
}

<span style=color:#66d9ef>resource</span> <span style=color:#e6db74>&#34;cloudflare_record&#34; &#34;traefik&#34;</span> {
  zone_id <span style=color:#f92672>=</span> <span style=color:#66d9ef>cloudflare_zone</span>.<span style=color:#66d9ef>schnerring_net</span>.<span style=color:#66d9ef>id</span>
  name    <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;*.k8s&#34;</span>
  type    <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;A&#34;</span>
  value   <span style=color:#f92672>=</span> <span style=color:#66d9ef>data</span>.<span style=color:#66d9ef>kubernetes_service</span>.<span style=color:#66d9ef>traefik</span>.<span style=color:#66d9ef>status</span>.<span style=color:#ae81ff>0</span>.<span style=color:#66d9ef>load_balancer</span>.<span style=color:#ae81ff>0</span>.<span style=color:#66d9ef>ingress</span>.<span style=color:#ae81ff>0</span>.<span style=color:#66d9ef>ip</span>
}
</code></pre></div><p>How awesome is that?</p><h2 id=step-6-deploy-a-demo-application>Step 6: Deploy a Demo Application</h2><p>We are almost at the finish line. All that is missing is reaping the fruit of our hard labor. To create a simple demo, we will use the <a href=https://hub.docker.com/r/nginxdemos/hello/>nginxdemos/hello</a> image and make it available at <a href=https://hello.k8s.schnerring.net/>https://hello.k8s.schnerring.net/</a>.</p><p>To make it happen, we add a <code>kubernetes_namespace</code>, <code>kubernetes_deployment</code>, <code>kubernetes_service</code>, and <code>kubernetes_ingress</code> resource to a new <code>hello.tf</code> file:</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-hcl data-lang=hcl><span style=color:#66d9ef>resource</span> <span style=color:#e6db74>&#34;kubernetes_namespace&#34; &#34;hello&#34;</span> {
  <span style=color:#66d9ef>metadata</span> {
    name <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;hello&#34;</span>
  }
}

<span style=color:#66d9ef>resource</span> <span style=color:#e6db74>&#34;kubernetes_deployment&#34; &#34;hello&#34;</span> {
  <span style=color:#66d9ef>metadata</span> {
    name      <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;hello-deploy&#34;</span>
    namespace <span style=color:#f92672>=</span> <span style=color:#66d9ef>kubernetes_namespace</span>.<span style=color:#66d9ef>hello</span>.<span style=color:#66d9ef>metadata</span>.<span style=color:#ae81ff>0</span>.<span style=color:#66d9ef>name</span>

    labels <span style=color:#f92672>=</span> {
      app <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;hello&#34;</span>
    }
  }

  <span style=color:#66d9ef>spec</span> {
    replicas <span style=color:#f92672>=</span> <span style=color:#ae81ff>2</span>

    <span style=color:#66d9ef>selector</span> {
      match_labels <span style=color:#f92672>=</span> {
        app <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;hello&#34;</span>
      }
    }

    <span style=color:#66d9ef>template</span> {
      <span style=color:#66d9ef>metadata</span> {
        labels <span style=color:#f92672>=</span> {
          app <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;hello&#34;</span>
        }
      }

      <span style=color:#66d9ef>spec</span> {
        <span style=color:#66d9ef>container</span> {
          image <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;nginxdemos/hello&#34;</span>
          name  <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;hello&#34;</span>

          <span style=color:#66d9ef>port</span> {
            container_port <span style=color:#f92672>=</span> <span style=color:#ae81ff>80</span>
          }
        }
      }
    }
  }
}

<span style=color:#66d9ef>resource</span> <span style=color:#e6db74>&#34;kubernetes_service&#34; &#34;hello&#34;</span> {
  <span style=color:#66d9ef>metadata</span> {
    name      <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;hello-svc&#34;</span>
    namespace <span style=color:#f92672>=</span> <span style=color:#66d9ef>kubernetes_namespace</span>.<span style=color:#66d9ef>hello</span>.<span style=color:#66d9ef>metadata</span>.<span style=color:#ae81ff>0</span>.<span style=color:#66d9ef>name</span>
  }

  <span style=color:#66d9ef>spec</span> {
    selector <span style=color:#f92672>=</span> {
      app <span style=color:#f92672>=</span> <span style=color:#66d9ef>kubernetes_deployment</span>.<span style=color:#66d9ef>hello</span>.<span style=color:#66d9ef>metadata</span>.<span style=color:#ae81ff>0</span>.<span style=color:#66d9ef>labels</span>.<span style=color:#66d9ef>app</span>
    }

    <span style=color:#66d9ef>port</span> {
      port        <span style=color:#f92672>=</span> <span style=color:#ae81ff>80</span>
      target_port <span style=color:#f92672>=</span> <span style=color:#ae81ff>80</span>
    }
  }
}

<span style=color:#66d9ef>resource</span> <span style=color:#e6db74>&#34;kubernetes_ingress&#34; &#34;hello&#34;</span> {
  <span style=color:#66d9ef>metadata</span> {
    name      <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;hello-ing&#34;</span>
    namespace <span style=color:#f92672>=</span> <span style=color:#66d9ef>kubernetes_namespace</span>.<span style=color:#66d9ef>hello</span>.<span style=color:#66d9ef>metadata</span>.<span style=color:#ae81ff>0</span>.<span style=color:#66d9ef>name</span>
    annotations <span style=color:#f92672>=</span> {
      &#34;cert-manager.io/cluster-issuer&#34;           <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;letsencrypt-staging&#34;</span>
      &#34;traefik.ingress.kubernetes.io/router.tls&#34; <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;true&#34;</span>
    }
  }

  <span style=color:#66d9ef>spec</span> {
    <span style=color:#66d9ef>rule</span> {
      host <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;hello.k8s.schnerring.net&#34;</span>

      <span style=color:#66d9ef>http</span> {
        <span style=color:#66d9ef>path</span> {
          path <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;/&#34;</span>

          <span style=color:#66d9ef>backend</span> {
            service_name <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;hello-svc&#34;</span>
            service_port <span style=color:#f92672>=</span> <span style=color:#ae81ff>80</span>
          }
        }
      }
    }

    <span style=color:#66d9ef>tls</span> {
      hosts       <span style=color:#f92672>=</span> [<span style=color:#e6db74>&#34;hello.k8s.schnerring.net&#34;</span>]
      secret_name <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;hello-tls-secret&#34;</span>
    }
  }
}
</code></pre></div><p>After running <code>terraform apply</code> again, we should be able to visit the demo site <a href=https://hello.k8s.schnerring.net/>https://hello.k8s.schnerring.net/</a>:</p><p><img src=img/nginx-demo.png alt="nginx Demo"></p><p>To verify the HTTPS redirect works, we run <code>curl -svDL http://hello.k8s.schnerring.net</code> (PowerShell), or <code>curl -sLD - http://hello.k8s.schnerring.net</code> (Bash):</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-txt data-lang=txt>...
&lt; HTTP/1.1 301 Moved Permanently
&lt; Location: https://hello.k8s.schnerring.net/
...
</code></pre></div><p>To get rid of the certificate warning, set <code>"cert-manager.io/cluster-issuer" = "letsencrypt-production"</code>. But be aware of <a href=https://letsencrypt.org/docs/rate-limits/>rate limits that apply to the Let&rsquo;s Encrypt production API</a>!</p><h2 id=one-last-thing>One Last Thing</h2><p>If we want to tear down the cluster and rebuild, we cannot achieve this in <em>one</em> <code>terraform apply</code> operation. The reason is that the <code>kubernetes-alpha</code> provider <a href=https://github.com/hashicorp/terraform-provider-kubernetes-alpha/issues/180#issuecomment-805169792>requires an operational cluster</a> during the <code>terraform plan</code> phase. On top of that, any CRDs we deploy with the <code>kubernetes-alpha</code> provider have to be available during <code>terraform plan</code>, too.</p><p>So when rebuilding, we would first create the AKS cluster and deploy cert-manager and then apply the rest:</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell>terraform destroy -target <span style=color:#e6db74>&#34;azurerm_resource_group.k8s&#34;</span>

terraform plan -out infrastructure.tfplan -target <span style=color:#e6db74>&#34;helm_release.cert_manager&#34;</span>
terraform apply infrastructure.tfplan

terraform plan -out infrastructure.tfplan
terraform apply infrastructure.tfplan
</code></pre></div><p>Besides that caveat, we created a pretty cool solution, fully managed by Terraform, have we not?</p><p>You can find all the code on GitHub in my <a href=https://github.com/schnerring/infrastructure/tree/0.1.0>schnerring/infrastructure repository</a>, which is evolving continuously. After committing the code to the repo, I added the <code>0.1.0</code> tag. This way, in the future, we can easily find the code depicted in this post.</p></div></div></div><footer class=footer><div class=footer__inner><div class="copyright copyright--user"><p>Copyright © 2020 Michael Schnerring</p><p xmlns:dct=http://purl.org/dc/terms/ xmlns:cc=http://creativecommons.org/ns# class=license-text><a rel=cc:attributionurl property="dct:title" href=https://github.com/schnerring/schnerring.github.io/tree/main/content>Content</a> licensed under <a rel=license href=https://creativecommons.org/licenses/by/4.0>CC BY 4.0</a></p></div></div></footer><script src=https://schnerring.net/assets/main.js></script><script src=https://schnerring.net/assets/prism.js></script></div></body></html>