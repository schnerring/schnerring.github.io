<!doctype html><html lang=en><head><title>Use Custom DNS Servers With Mullvad And Any WireGuard Client ::
Michael Schnerring — Coder and Computer Enthusiast</title><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content="I&amp;rsquo;ve been using Mullvad VPN for a while now but only ever used it with the official client on my workstation. I use DNS extensively in my home network, so as soon as I activate Mullvad, I can&amp;rsquo;t resolve DNS names locally. Of course, this is by design and expected. I own an OPNsense appliance, so the natural solution is to move the tunnel there.
TL;DR Use the following shell command to request an IP with no DNS hijacking:"><meta name=keywords content><meta name=robots content="noodp"><link rel=canonical href=https://schnerring.net/posts/use-custom-dns-servers-with-mullvad-and-any-wireguard-client/><link rel=stylesheet href=https://schnerring.net/assets/style.css><link rel=stylesheet href=https://schnerring.net/style.css><link rel=apple-touch-icon-precomposed sizes=144x144 href=https://schnerring.net/img/apple-touch-icon-144-precomposed.png><link rel="shortcut icon" href=https://schnerring.net/img/favicon.png><link href=https://schnerring.net/assets/fonts/Inter-Italic.woff2 rel=preload type=font/woff2 as=font crossorigin><link href=https://schnerring.net/assets/fonts/Inter-Regular.woff2 rel=preload type=font/woff2 as=font crossorigin><link href=https://schnerring.net/assets/fonts/Inter-Medium.woff2 rel=preload type=font/woff2 as=font crossorigin><link href=https://schnerring.net/assets/fonts/Inter-MediumItalic.woff2 rel=preload type=font/woff2 as=font crossorigin><link href=https://schnerring.net/assets/fonts/Inter-Bold.woff2 rel=preload type=font/woff2 as=font crossorigin><link href=https://schnerring.net/assets/fonts/Inter-BoldItalic.woff2 rel=preload type=font/woff2 as=font crossorigin><meta name=twitter:card content="summary"><meta name=twitter:title content="Use Custom DNS Servers With Mullvad And Any WireGuard Client"><meta name=twitter:description content="I&rsquo;ve been using Mullvad VPN for a while now but only ever used it with the official client on my workstation. I use DNS extensively in my home network, so as soon as I activate Mullvad, I can&rsquo;t resolve DNS names locally. Of course, this is by design and expected. I own an OPNsense appliance, so the natural solution is to move the tunnel there.
TL;DR Use the following shell command to request an IP with no DNS hijacking:"><meta property="og:title" content="Use Custom DNS Servers With Mullvad And Any WireGuard Client"><meta property="og:description" content="I&rsquo;ve been using Mullvad VPN for a while now but only ever used it with the official client on my workstation. I use DNS extensively in my home network, so as soon as I activate Mullvad, I can&rsquo;t resolve DNS names locally. Of course, this is by design and expected. I own an OPNsense appliance, so the natural solution is to move the tunnel there.
TL;DR Use the following shell command to request an IP with no DNS hijacking:"><meta property="og:type" content="article"><meta property="og:url" content="https://schnerring.net/posts/use-custom-dns-servers-with-mullvad-and-any-wireguard-client/"><meta property="article:section" content="posts"><meta property="article:published_time" content="2021-10-31T08:19:52+01:00"><meta property="article:modified_time" content="2021-10-31T08:19:52+01:00"><meta property="og:site_name" content="Michael Schnerring"><script async defer data-domain=schnerring.net src=https://plausible.schnerring.net/js/plausible.js></script></head><body><div class=container><header class=header><span class=header__inner><a href=/ class=logo style=text-decoration:none><span class=logo__mark><svg xmlns="http://www.w3.org/2000/svg" class="greater-icon" viewBox="0 0 44 44"><path fill="none" d="M15 8l14.729 14.382L15 35.367"/></svg></span><span class=logo__text>schnerring.net</span>
<span class=logo__cursor></span></a><span class=header__right><nav class=menu><ul class="menu__inner menu__inner--desktop"><li><a href=/about>About</a></li></ul><ul class="menu__inner menu__inner--mobile"><li><a href=/about>About</a></li></ul></nav><span class=menu-trigger><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M0 0h24v24H0z" fill="none"/><path d="M3 18h18v-2H3v2zm0-5h18v-2H3v2zm0-7v2h18V6H3z"/></svg></span><span class=theme-toggle><svg class="theme-toggler" width="24" height="24" viewBox="0 0 48 48" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M22 41c10.4934.0 19-8.5066 19-19C41 11.5066 32.4934 3 22 3 11.5066 3 3 11.5066 3 22s8.5066 19 19 19zM7 22C7 13.7157 13.7157 7 22 7V37C13.7157 37 7 30.2843 7 22z"/></svg></span></span></span></header><div class=content><div class=post><h1 class=post-title>Use Custom DNS Servers With Mullvad And Any WireGuard Client</h1><div class=post-meta><span class=post-date>2021-10-31</span></div><span class=post-tags><a href=https://schnerring.net/tags/dns/>#dns</a>&nbsp;
<a href=https://schnerring.net/tags/mullvad/>#mullvad</a>&nbsp;
<a href=https://schnerring.net/tags/vpn/>#vpn</a>&nbsp;
<a href=https://schnerring.net/tags/wireguard/>#wireguard</a>&nbsp;</span><figure class=post-cover><img src=https://schnerring.net/posts/use-custom-dns-servers-with-mullvad-and-any-wireguard-client/img/cover.svg alt="Use Custom DNS Servers With Mullvad And Any WireGuard Client"></figure><div class=post-content><p>I&rsquo;ve been using <a href=https://mullvad.net/>Mullvad VPN</a> for a while now but only ever used it with the official client on my workstation. I use DNS extensively in my home network, so as soon as I activate Mullvad, I can&rsquo;t resolve DNS names locally. Of course, this is by design and expected. I own an <a href=https://opnsense.org/>OPNsense</a> appliance, so the natural solution is to move the tunnel there.</p><h2 id=tldr>TL;DR</h2><p>Use the following shell command to request an IP with no DNS hijacking:</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell>curl -sSL https://api.mullvad.net/app/v1/wireguard-keys <span style=color:#ae81ff>\
</span><span style=color:#ae81ff></span>  -H <span style=color:#e6db74>&#34;Content-Type: application/json&#34;</span> <span style=color:#ae81ff>\
</span><span style=color:#ae81ff></span>  -H <span style=color:#e6db74>&#34;Authorization: Token YOURMULLVADACCOUNTNUMBER&#34;</span> <span style=color:#ae81ff>\
</span><span style=color:#ae81ff></span>  -d <span style=color:#e6db74>&#39;{&#34;pubkey&#34;:&#34;YOURWIREGUARDPUBLICKEY&#34;}&#39;</span>
</code></pre></div><h2 id=mullvad-hijacks-dns-queries-over-wireguard-tunnels>Mullvad Hijacks DNS Queries Over WireGuard Tunnels</h2><p>Instead of using the OpenVPN protocol, I decided to go with the latest and greatest: <a href=https://www.wireguard.com/>WireGuard</a>. OPNsense is a fork of FreeBSD but lacks a kernel implementation of WireGuard, requiring a plugin. It&rsquo;s good enough for me to try, and I hope WireGuard will be natively supported soon.</p><p>During my research on how to best configure this, there seemed to be the <a href=https://forum.netgate.com/topic/166804/unbound-dns-resolver-through-wireguard-tunnel-mullvad-vpn>caveat of Mullvad hijacking DNS traffic going through WireGuard tunnels</a>, redirecting it to their DNS servers. It decreases the likelihood of DNS leaks, but power users like you and I might not want that. What if I want to query DNS root servers through the VPN tunnel because I use my own DNS resolver? Mullvad hijacking DNS queries would make my DNS resolver trip up.</p><p>What a bummer, right? Looking at the <a href=https://mullvad.net/en/help/faq/>Mullvad FAQ</a>, it seemed the only solution was to resort to OpenVPN:</p><blockquote><p>Ports 1400 UDP and 1401 TCP do not have DNS hijacking enabled, which might work better for pfSense users</p></blockquote><p><a href=https://mullvad.net/ar/blog/2021/4/15/support-custom-dns-servers-launched/>But Mullvad launched support for custom DNS servers on the Mullvad VPN app back in April 2021</a>. It also works for WireGuard, so what&rsquo;s the secret?</p><h2 id=reverse-engineering-the-mullvad-app>Reverse-engineering the Mullvad App</h2><p>Searching through the docs, I found the <a href=https://mullvad.net/es/help/running-wireguard-router/>WireGuard on a router article explaining how to get an IP to use with Mullvad via API</a>:</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell>curl https://api.mullvad.net/wg/ -d account<span style=color:#f92672>=</span>YOURMULLVADACCOUNTNUMBER --data-urlencode pubkey<span style=color:#f92672>=</span>YOURPUBLICKEY
</code></pre></div><p>Next, let&rsquo;s look at how the app requests IPs. <a href=https://github.com/mullvad/mullvadvpn-app/issues/473#issuecomment-852064948>Fortunately it&rsquo;s open-source and available on GitHub</a>, so the only reverse-engineering we&rsquo;re going to be doing is reading some code. <a href=https://github.com/mullvad/mullvadvpn-app/blob/b214ba74cafc18b6a13ee5678055355302386cde/mullvad-rpc/src/lib.rs>It turns out that the app uses a different API to request IPs, found in the <code>push_wg_key</code> function</a>: <code>https://api.mullvad.net/app/v1/wireguard-keys</code>.</p><h2 id=testing-both-apis>Testing Both APIs</h2><p>For testing, we&rsquo;ll be using the <a href=https://www.wireguard.com/install/>official WireGuard client</a>. Let&rsquo;s open the client, click <code>Add empty tunnel...</code>, and give it a name:</p><p><img src=img/wireguard-add-tunnel-menu.png alt="Screenshot of WireGuard client &ldquo;Add Tunnel&rdquo; context menu"></p><p>The tunnel will initially look like this:</p><p><img src=img/wireguard-initial-tunnel-configuration.png alt="Screenshot of initial tunnel configuration"></p><p>Copy the public key and execute the following to request our Mullvad IPs:</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell>curl https://api.mullvad.net/wg/ -d account<span style=color:#f92672>=</span>YOURMULLVADACCOUNTNUMBER --data-urlencode pubkey<span style=color:#f92672>=</span>YOURPUBLICKEY
</code></pre></div><p>The response will return an IPv4 and IPv6 address. Add the following to the configuration file:</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-text data-lang=text>[Interface]
PrivateKey = &lt;PRIVATE KEY&gt;
Address = &lt;IPv4 ADRESS&gt;
DNS = 9.9.9.9

[Peer]
PublicKey = 9hIGjit4ApkNGuEWYBLpahxokEoP0cT9CMZ+ELEygzo=
AllowedIPs = 0.0.0.0/0
Endpoint = 194.36.25.18:51820
</code></pre></div><p>We use the <code>de24-wireguard</code> Mullvad server as peer and <a href=https://quad9.org/>Quad9</a> as DNS server.</p><p>Let&rsquo;s activate the tunnel and browse to <a href=mullvad.net/check>Mullvad&rsquo;s connection check</a>:</p><p><img src=img/mullvad-connection-check-no-leak.png alt="Screenshot of Mullvad connection check without leak"></p><p>As expected, the Quad9 DNS server is not leaking through because Mullvad hijacks our DNS requests and redirects them to their DNS servers.</p><p>Next, we use the API the app uses to request the Mullvad IPs. We expect to get a different IP for which DNS hijacking is disabled. Before we can do this, we need to <a href=https://mullvad.net/en/account/#/ports>revoke the WireGuard key on the Mullvad website</a> because we already requested an IP for this public key:</p><p><img src=img/mullvad-revoke-key.png alt="Screenshot of &ldquo;Manage ports and WireGuard key&rdquo; page on Mullvad webiste"></p><p>After revoking the key, we run the following command:</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell>curl -sSL https://api.mullvad.net/app/v1/wireguard-keys -H <span style=color:#e6db74>&#34;Content-Type: application/json&#34;</span> -H <span style=color:#e6db74>&#34;Authorization: Token YOURMULLVADACCOUNTNUMBER&#34;</span> -d <span style=color:#e6db74>&#39;{&#34;pubkey&#34;:&#34;YOURPUBLICKEY&#34;}&#39;</span>
</code></pre></div><p>Next, we replace the IP in <code>Address</code> field of the WireGuard config with the new IP we received. Then we re-activate the tunnel and visit <a href=mullvad.net/check>Mullvad&rsquo;s connection check</a>:</p><p><img src=img/mullvad-connection-check-leak.png alt="Screenshot of Mullvad connection check with leak"></p><p>Hooray, the Quad9 DNS servers leak through, so Mullvad is not hijacking our DNS traffic for this tunnel!</p></div><div id=remark42></div><script>const defaultTheme="light";function getHelloFriendTheme(){const a=localStorage&&localStorage.getItem("theme");return a||defaultTheme}</script><script>var remark_config={host:"https://remark42.schnerring.net",site_id:"schnerring.net",theme:getHelloFriendTheme(),show_email_subscription:!1}</script><script>!function(d,b){for(var c=0,a,e,f;c<d.length;c++)a=b.createElement("script"),e=".js",f=b.head||b.body,"noModule"in a?(a.type="module",e=".mjs"):a.async=!0,a.defer=!0,a.src=remark_config.host+"/web/"+d[c]+e,f.appendChild(a)}(remark_config.components||["embed"],document)</script><script>const themeToggle=document.querySelector(".theme-toggle");themeToggle.addEventListener("click",()=>{setTimeout(()=>window.REMARK42.changeTheme(getHelloFriendTheme()),10)})</script></div></div><footer class=footer><div class=footer__inner><div class="copyright copyright--user"><p>Copyright © 2020 Michael Schnerring</p><p xmlns:dct=http://purl.org/dc/terms/ xmlns:cc=http://creativecommons.org/ns# class=license-text><a rel=cc:attributionurl property="dct:title" href=https://github.com/schnerring/schnerring.github.io/tree/main/content>Content</a> licensed under <a rel=license href=https://creativecommons.org/licenses/by/4.0>CC BY 4.0</a></p></div></div></footer><script src=https://schnerring.net/assets/main.js></script><script src=https://schnerring.net/assets/prism.js></script></div></body></html>