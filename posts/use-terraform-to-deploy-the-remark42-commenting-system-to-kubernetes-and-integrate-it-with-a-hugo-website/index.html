<!doctype html><html lang=en><head><title>Use Terraform to Deploy the Remark42 Commenting System to Kubernetes and Integrate it with a Hugo Website ::
Michael Schnerring â€” Coder and Computer Enthusiast</title><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content="Building upon our previous work, we will deploy Remark42 on Kubernetes with Terraform and integrate it with your existing Hugo website. Make sure to check out my previous posts about creating a Hugo Website and deploying an Azure Kubernetes Service cluster if you haven&amp;rsquo;t already.
"><meta name=keywords content><meta name=robots content="noodp"><link rel=canonical href=https://schnerring.net/posts/use-terraform-to-deploy-the-remark42-commenting-system-to-kubernetes-and-integrate-it-with-a-hugo-website/><link rel=stylesheet href=https://schnerring.net/assets/style.css><link rel=stylesheet href=https://schnerring.net/style.css><link rel=apple-touch-icon-precomposed sizes=144x144 href=https://schnerring.net/img/apple-touch-icon-144-precomposed.png><link rel="shortcut icon" href=https://schnerring.net/img/favicon.png><link href=https://schnerring.net/assets/fonts/Inter-Italic.woff2 rel=preload type=font/woff2 as=font crossorigin><link href=https://schnerring.net/assets/fonts/Inter-Regular.woff2 rel=preload type=font/woff2 as=font crossorigin><link href=https://schnerring.net/assets/fonts/Inter-Medium.woff2 rel=preload type=font/woff2 as=font crossorigin><link href=https://schnerring.net/assets/fonts/Inter-MediumItalic.woff2 rel=preload type=font/woff2 as=font crossorigin><link href=https://schnerring.net/assets/fonts/Inter-Bold.woff2 rel=preload type=font/woff2 as=font crossorigin><link href=https://schnerring.net/assets/fonts/Inter-BoldItalic.woff2 rel=preload type=font/woff2 as=font crossorigin><meta name=twitter:card content="summary"><meta name=twitter:title content="Use Terraform to Deploy the Remark42 Commenting System to Kubernetes and Integrate it with a Hugo Website"><meta name=twitter:description content="Building upon our previous work, we will deploy Remark42 on Kubernetes with Terraform and integrate it with your existing Hugo website. Make sure to check out my previous posts about creating a Hugo Website and deploying an Azure Kubernetes Service cluster if you haven&rsquo;t already."><meta property="og:title" content="Use Terraform to Deploy the Remark42 Commenting System to Kubernetes and Integrate it with a Hugo Website"><meta property="og:description" content="Building upon our previous work, we will deploy Remark42 on Kubernetes with Terraform and integrate it with your existing Hugo website. Make sure to check out my previous posts about creating a Hugo Website and deploying an Azure Kubernetes Service cluster if you haven&rsquo;t already."><meta property="og:type" content="article"><meta property="og:url" content="https://schnerring.net/posts/use-terraform-to-deploy-the-remark42-commenting-system-to-kubernetes-and-integrate-it-with-a-hugo-website/"><meta property="article:section" content="posts"><meta property="article:published_time" content="2021-05-09T09:31:13+02:00"><meta property="article:modified_time" content="2021-05-09T09:31:13+02:00"><meta property="og:site_name" content="Michael Schnerring"><script async defer data-domain=schnerring.net src=https://plausible.schnerring.net/js/plausible.js></script></head><body><div class=container><header class=header><span class=header__inner><a href=/ class=logo style=text-decoration:none><span class=logo__mark><svg xmlns="http://www.w3.org/2000/svg" class="greater-icon" viewBox="0 0 44 44"><path fill="none" d="M15 8l14.729 14.382L15 35.367"/></svg></span><span class=logo__text>schnerring.net</span>
<span class=logo__cursor></span></a><span class=header__right><nav class=menu><ul class="menu__inner menu__inner--desktop"><li><a href=/about>About</a></li></ul><ul class="menu__inner menu__inner--mobile"><li><a href=/about>About</a></li></ul></nav><span class=menu-trigger><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M0 0h24v24H0z" fill="none"/><path d="M3 18h18v-2H3v2zm0-5h18v-2H3v2zm0-7v2h18V6H3z"/></svg></span><span class=theme-toggle><svg class="theme-toggler" width="24" height="24" viewBox="0 0 48 48" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M22 41c10.4934.0 19-8.5066 19-19C41 11.5066 32.4934 3 22 3 11.5066 3 3 11.5066 3 22s8.5066 19 19 19zM7 22C7 13.7157 13.7157 7 22 7V37C13.7157 37 7 30.2843 7 22z"/></svg></span></span></span></header><div class=content><div class=post><h1 class=post-title>Use Terraform to Deploy the Remark42 Commenting System to Kubernetes and Integrate it with a Hugo Website</h1><div class=post-meta><span class=post-date>2021-05-09</span></div><span class=post-tags><a href=https://schnerring.net/tags/hugo/>#hugo</a>&nbsp;
<a href=https://schnerring.net/tags/k8s/>#k8s</a>&nbsp;
<a href=https://schnerring.net/tags/kubernetes/>#kubernetes</a>&nbsp;
<a href=https://schnerring.net/tags/remark42/>#remark42</a>&nbsp;
<a href=https://schnerring.net/tags/terraform/>#terraform</a>&nbsp;</span><figure class=post-cover><img src=https://schnerring.net/posts/use-terraform-to-deploy-the-remark42-commenting-system-to-kubernetes-and-integrate-it-with-a-hugo-website/img/cover.svg alt="Use Terraform to Deploy the Remark42 Commenting System to Kubernetes and Integrate it with a Hugo Website"></figure><div class=post-content><p>Building upon our previous work, we will deploy <a href=https://remark42.com/>Remark42</a> on Kubernetes with <a href=https://www.terraform.io/>Terraform</a> and integrate it with your existing <a href=https://gohugo.io/>Hugo</a> website. Make sure to check out my previous posts about <a href=../create-a-hugo-website-with-github-pages-github-actions-and-cloudflare>creating a Hugo Website</a> and <a href=../use-terraform-to-deploy-an-azure-kubernetes-service-aks-cluster-traefik-2-cert-manager-and-lets-encrypt>deploying an Azure Kubernetes Service cluster</a> if you haven&rsquo;t already.</p><h2 id=about-remark42>About Remark42</h2><blockquote><p>Remark42 is a self-hosted, lightweight, and simple (yet functional) commenting system, which doesn&rsquo;t spy on users.</p></blockquote><p>I like simplicity, I am a privacy enthusiast, and I build this blog with this in mind. More popular, hands-off solutions like <a href=https://disqus.com/>Disqus</a> offer easier integration and more sophisticated features, like automated spam moderation and advertising. But for my intents, it&rsquo;s too bloated and invasive. For low-traffic websites like mine, Remark42 is just the better fit.</p><h2 id=preparation>Preparation</h2><p>Besides a Hugo website and a Kubernetes cluster, you will have to install the following software on your workstation:</p><ul><li><a href=https://www.terraform.io/downloads.html>Terraform</a></li><li><a href=https://kompose.io/installation/>kompose</a> (optional)</li></ul><h2 id=converting-the-original-docker-composeyml>Converting the original <code>docker-compose.yml</code></h2><p>The <a href=https://github.com/umputun/remark42>official Remark42 repository</a> includes a <a href=https://github.com/umputun/remark42/blob/master/docker-compose.yml><code>docker-compose.yml</code></a> that we can download:</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell>curl -O https://raw.githubusercontent.com/umputun/remark42/master/docker-compose.yml
</code></pre></div><p>We then run <code>kompose convert</code> to generate regular Kubernetes YAML manifests from the <code>docker-compose.yml</code> file:</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-text data-lang=text>Kubernetes file &#34;remark-deployment.yaml&#34; created
Kubernetes file &#34;remark-claim0-persistentvolumeclaim.yaml&#34; created
</code></pre></div><p>To figure out what resources we need to create, we use the generated manifests as a starting point.</p><h2 id=create-a-namespace>Create a Namespace</h2><p>First, we create the <a href=https://kubernetes.io/docs/concepts/overview/working-with-objects/namespaces/><code>Namespace</code></a> where our Remark42 resources will reside. We add the following Terraform code to a new file named <code>remark42.yml</code>:</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-hcl data-lang=hcl><span style=color:#66d9ef>resource</span> <span style=color:#e6db74>&#34;kubernetes_namespace&#34; &#34;remark42&#34;</span> {
  <span style=color:#66d9ef>metadata</span> {
    name <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;remark42&#34;</span>
  }
}
</code></pre></div><p>Deploy the changes by running:</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell>terraform plan -out infrastructure.tfplan
terraform apply infrastructure.tfplan
</code></pre></div><h2 id=create-the-persistent-volume-claim>Create the Persistent Volume Claim</h2><p>To enable persistence for Remark42, we create a <a href=https://kubernetes.io/docs/concepts/storage/persistent-volumes/#persistentvolumeclaims><code>PersistentVolumeClaim</code></a> (PVC) resource. Using the generate <code>remark-claim0-persistentvolumeclaim.yaml</code> file as a blueprint, we can easily derive the Terraform equivalent from it and add it to the <code>remark42.tf</code> file:</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-hcl data-lang=hcl><span style=color:#66d9ef>resource</span> <span style=color:#e6db74>&#34;kubernetes_persistent_volume_claim&#34; &#34;remark42&#34;</span> {
  <span style=color:#66d9ef>metadata</span> {
    name      <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;remark42-pvc&#34;</span>
    namespace <span style=color:#f92672>=</span> <span style=color:#66d9ef>kubernetes_namespace</span>.<span style=color:#66d9ef>remark42</span>.<span style=color:#66d9ef>metadata</span>.<span style=color:#ae81ff>0</span>.<span style=color:#66d9ef>name</span>
    labels <span style=color:#f92672>=</span> {
      &#34;app&#34; <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;remark42-pvc&#34;</span>
    }
  }

  <span style=color:#66d9ef>spec</span> {
    access_modes       <span style=color:#f92672>=</span> [<span style=color:#e6db74>&#34;ReadWriteOnce&#34;</span>]
    storage_class_name <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;azurefile&#34;</span>

    <span style=color:#66d9ef>resources</span> {
      requests <span style=color:#f92672>=</span> {
        &#34;storage&#34; <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;1Gi&#34;</span>
      }
    }
  }
}
</code></pre></div><p>AKS comes pre-configured with multiple <a href=https://kubernetes.io/docs/concepts/storage/storage-classes/><code>StorageClass</code>es</a>. Here, I use the <code>azurefile</code> storage class to dynamically provision a persistent volume with <a href=https://docs.microsoft.com/en-us/azure/aks/azure-files-dynamic-pv>Azure Files</a>. At the time of this writing, I use a <code>B2ms</code>-sized VM as a node which is limited to four data disks. Using Azure Files whenever possible helps me circumventing this limitation.</p><h2 id=create-configmap-and-secret>Create ConfigMap and Secret</h2><p>To store configuration parameters for our Remark42 deployment, we make use of Kubernetes <a href=https://kubernetes.io/docs/concepts/configuration/configmap/><code>ConfigMap</code></a> and <a href=https://kubernetes.io/docs/concepts/configuration/secret/><code>Secret</code></a> resources.</p><p>To store sensitive values, we use <code>Secret</code>:</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-hcl data-lang=hcl><span style=color:#66d9ef>resource</span> <span style=color:#e6db74>&#34;kubernetes_secret&#34; &#34;remark42&#34;</span> {
  <span style=color:#66d9ef>metadata</span> {
    name      <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;remark42-secret&#34;</span>
    namespace <span style=color:#f92672>=</span> <span style=color:#66d9ef>kubernetes_namespace</span>.<span style=color:#66d9ef>remark42</span>.<span style=color:#66d9ef>metadata</span>.<span style=color:#ae81ff>0</span>.<span style=color:#66d9ef>name</span>
  }

  data <span style=color:#f92672>=</span> {
    &#34;SECRET&#34; <span style=color:#f92672>=</span> <span style=color:#66d9ef>random_password</span>.<span style=color:#66d9ef>remark42_secret</span>.<span style=color:#66d9ef>result</span>
  }
}
</code></pre></div><p>For non-sensitive stuff, we use <code>ConfigMap</code>:</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-hcl data-lang=hcl><span style=color:#66d9ef>resource</span> <span style=color:#e6db74>&#34;kubernetes_config_map&#34; &#34;remark42&#34;</span> {
  <span style=color:#66d9ef>metadata</span> {
    name      <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;remark42-cm&#34;</span>
    namespace <span style=color:#f92672>=</span> <span style=color:#66d9ef>kubernetes_namespace</span>.<span style=color:#66d9ef>remark42</span>.<span style=color:#66d9ef>metadata</span>.<span style=color:#ae81ff>0</span>.<span style=color:#66d9ef>name</span>
  }

  data <span style=color:#f92672>=</span> {
    &#34;REMARK_URL&#34; <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;https://${cloudflare_record.remark42.hostname}&#34;</span>
    &#34;SITE&#34;       <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;schnerring.net&#34;</span>
  }
}
</code></pre></div><p>For this post, I have kept the configuration to a minimum:</p><ul><li><code>REMARK_URL</code>: URL to Remark42 server</li><li><code>SITE</code>: site name(s)</li><li><code>SECRET</code>: secret key</li></ul><p>Check the <a href=https://github.com/umputun/remark42#parameters>official documentation</a> or <a href=https://github.com/schnerring/infrastructure/blob/v0.2.0/remark42.tf>my code on GitHub</a> for more configuration options.</p><p>You might have noticed that I reference a <code>cloudflare_record</code> in the <code>REMARK_URL</code> part. That&rsquo;s because I also manage my DNS records with Terraform. The DNS record for <code>remark42.schnerring.net</code> pointing to the DNS record of my cluster looks like this:</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-hcl data-lang=hcl><span style=color:#66d9ef>resource</span> <span style=color:#e6db74>&#34;cloudflare_record&#34; &#34;remark42&#34;</span> {
  zone_id <span style=color:#f92672>=</span> <span style=color:#66d9ef>cloudflare_zone</span>.<span style=color:#66d9ef>schnerring_net</span>.<span style=color:#66d9ef>id</span>
  name    <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;remark42&#34;</span>
  type    <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;CNAME&#34;</span>
  value   <span style=color:#f92672>=</span> <span style=color:#66d9ef>cloudflare_record</span>.<span style=color:#66d9ef>traefik</span>.<span style=color:#66d9ef>hostname</span>
  proxied <span style=color:#f92672>=</span> <span style=color:#66d9ef>true</span>
}
</code></pre></div><h2 id=create-the-deployment>Create the Deployment</h2><p>Next, we add the <a href=https://kubernetes.io/docs/concepts/workloads/controllers/deployment/><code>Deployment</code></a> to the <code>remark42.tf</code> file, using the <code>remark-deployment.yaml</code> file as a model. We map the previously defined configuration parameters to environment variables and mount the PVC to <code>/srv/var</code>.</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-hcl data-lang=hcl><span style=color:#66d9ef>resource</span> <span style=color:#e6db74>&#34;kubernetes_deployment&#34; &#34;remark42&#34;</span> {
  <span style=color:#66d9ef>metadata</span> {
    name      <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;remark42-deploy&#34;</span>
    namespace <span style=color:#f92672>=</span> <span style=color:#66d9ef>kubernetes_namespace</span>.<span style=color:#66d9ef>remark42</span>.<span style=color:#66d9ef>metadata</span>.<span style=color:#ae81ff>0</span>.<span style=color:#66d9ef>name</span>
    labels <span style=color:#f92672>=</span> {
      &#34;app&#34; <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;remark42&#34;</span>
    }
  }
  <span style=color:#66d9ef>spec</span> {
    replicas <span style=color:#f92672>=</span> <span style=color:#ae81ff>1</span>

    <span style=color:#66d9ef>selector</span> {
      match_labels <span style=color:#f92672>=</span> {
        &#34;app&#34; <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;remark42&#34;</span>
      }
    }

    <span style=color:#66d9ef>strategy</span> {
      type <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;Recreate&#34;</span>
    }

    <span style=color:#66d9ef>template</span> {
      <span style=color:#66d9ef>metadata</span> {
        labels <span style=color:#f92672>=</span> {
          &#34;app&#34; <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;remark42&#34;</span>
        }
      }

      <span style=color:#66d9ef>spec</span> {
        hostname       <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;remark42&#34;</span>
        restart_policy <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;Always&#34;</span>

        <span style=color:#66d9ef>container</span> {
          name  <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;remark42&#34;</span>
          image <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;umputun/remark42:${var.remark42_image_version}&#34;</span>

          <span style=color:#66d9ef>port</span> {
            container_port <span style=color:#f92672>=</span> <span style=color:#ae81ff>8080</span>
          }

          <span style=color:#66d9ef>env</span> {
            name <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;REMARK_URL&#34;</span>

            <span style=color:#66d9ef>value_from</span> {
              <span style=color:#66d9ef>config_map_key_ref</span> {
                key  <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;REMARK_URL&#34;</span>
                name <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;remark42-cm&#34;</span>
              }
            }
          }

          <span style=color:#66d9ef>env</span> {
            name <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;SECRET&#34;</span>

            <span style=color:#66d9ef>value_from</span> {
              <span style=color:#66d9ef>secret_key_ref</span> {
                key  <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;SECRET&#34;</span>
                name <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;remark42-secret&#34;</span>
              }
            }
          }

          <span style=color:#66d9ef>env</span> {
            name <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;SITE&#34;</span>

            <span style=color:#66d9ef>value_from</span> {
              <span style=color:#66d9ef>config_map_key_ref</span> {
                key  <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;SITE&#34;</span>
                name <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;remark42-cm&#34;</span>
              }
            }
          }

          <span style=color:#66d9ef>volume_mount</span> {
            mount_path <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;/srv/var&#34;</span>
            name       <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;remark42-vol&#34;</span>
          }
        }

        <span style=color:#66d9ef>volume</span> {
          name <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;remark42-vol&#34;</span>

          <span style=color:#66d9ef>persistent_volume_claim</span> {
            claim_name <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;remark42-pvc&#34;</span>
          }
        }
      }
    }
  }
}
</code></pre></div><h2 id=create-the-service>Create the Service</h2><p>To expose our deployment as a network service, we create a <a href=https://kubernetes.io/docs/concepts/services-networking/service/><code>Service</code></a> resource by adding the following to the <code>remark42.tf</code> file:</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-hcl data-lang=hcl><span style=color:#66d9ef>resource</span> <span style=color:#e6db74>&#34;kubernetes_service&#34; &#34;remark42&#34;</span> {
  <span style=color:#66d9ef>metadata</span> {
    name      <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;remark42-svc&#34;</span>
    namespace <span style=color:#f92672>=</span> <span style=color:#66d9ef>kubernetes_namespace</span>.<span style=color:#66d9ef>remark42</span>.<span style=color:#66d9ef>metadata</span>.<span style=color:#ae81ff>0</span>.<span style=color:#66d9ef>name</span>
  }

  <span style=color:#66d9ef>spec</span> {
    selector <span style=color:#f92672>=</span> {
      &#34;app&#34; <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;remark42&#34;</span>
    }

    <span style=color:#66d9ef>port</span> {
      name        <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;http&#34;</span>
      port        <span style=color:#f92672>=</span> <span style=color:#ae81ff>80</span>
      target_port <span style=color:#f92672>=</span> <span style=color:#ae81ff>8080</span>
    }
  }
}
</code></pre></div><h2 id=create-the-ingress>Create the Ingress</h2><p>I use <a href=https://doc.traefik.io/traefik/>Traefik 2</a> as <a href=https://kubernetes.io/docs/concepts/services-networking/ingress-controllers/><code>Ingress Controller</code></a> in combination with the <a href=https://doc.traefik.io/traefik/providers/kubernetes-ingress/>Traefik Kubernetes Ingress provider</a>. To manage Let&rsquo;s Encrypt certificates, I use <a href=https://cert-manager.io/docs/>cert-manager</a>. So depending on your cluster configuration, the following steps might differ.</p><p>Let us add an <a href=https://kubernetes.io/docs/concepts/services-networking/ingress/><code>Ingress</code></a> to the <code>remark42.tf</code> file, to expose our service to the world:</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-hcl data-lang=hcl><span style=color:#66d9ef>resource</span> <span style=color:#e6db74>&#34;kubernetes_ingress&#34; &#34;remark42&#34;</span> {
  <span style=color:#66d9ef>metadata</span> {
    name      <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;remark42-ing&#34;</span>
    namespace <span style=color:#f92672>=</span> <span style=color:#66d9ef>kubernetes_namespace</span>.<span style=color:#66d9ef>remark42</span>.<span style=color:#66d9ef>metadata</span>.<span style=color:#ae81ff>0</span>.<span style=color:#66d9ef>name</span>
    annotations <span style=color:#f92672>=</span> {
      &#34;cert-manager.io/cluster-issuer&#34;           <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;letsencrypt-production&#34;</span>
      &#34;traefik.ingress.kubernetes.io/router.tls&#34; <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;true&#34;</span>
    }
  }

  <span style=color:#66d9ef>spec</span> {
    <span style=color:#66d9ef>rule</span> {
      host <span style=color:#f92672>=</span> <span style=color:#66d9ef>cloudflare_record</span>.<span style=color:#66d9ef>remark42</span>.<span style=color:#66d9ef>hostname</span>

      <span style=color:#66d9ef>http</span> {
        <span style=color:#66d9ef>path</span> {
          path <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;/&#34;</span>

          <span style=color:#66d9ef>backend</span> {
            service_name <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;remark42-svc&#34;</span>
            service_port <span style=color:#f92672>=</span> <span style=color:#ae81ff>80</span>
          }
        }
      }
    }

    <span style=color:#66d9ef>tls</span> {
      hosts       <span style=color:#f92672>=</span> [<span style=color:#66d9ef>cloudflare_record</span>.<span style=color:#66d9ef>remark42</span>.<span style=color:#66d9ef>hostname</span>]
      secret_name <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;remark42-tls-secret&#34;</span>
    }
  }
}
</code></pre></div><p>Now run <code>terraform apply</code> to deploy everything. Note that we are using <code>letsencrypt-staging</code> as cluster issuer. We will have to change this to <code>letsencrypt-production</code> once we finished testing.</p><p>Browse to the demo site at <a href=https://remark42.schnerring.net/web>https://remark42.schnerring.net/web</a> and check whether Remark42 works. If you want to post a comment on the demo site, make sure to add the <code>remark</code> site ID to the <code>SITE</code> environment variable, separated by a <code>,</code> (i.e., <code>schnerring.net,remark</code>).</p><h2 id=integrate-remark42-with-hugo>Integrate Remark42 with Hugo</h2><p>To add the Remark42 comment widget to our Hugo site, we have to integrate it with our theme. At the time of this writing, I use the <a href=https://github.com/panr/hugo-theme-hello-friend/>Hello Friend</a> theme, which includes a <a href=https://gohugo.io/templates/partials/>partial template</a> for the comment section. We add the Remark42 widget to the <code>layouts/partials/comments.html</code> file:</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-html data-lang=html>&lt;<span style=color:#f92672>div</span> <span style=color:#a6e22e>id</span><span style=color:#f92672>=</span><span style=color:#e6db74>&#34;remark42&#34;</span>&gt;&lt;/<span style=color:#f92672>div</span>&gt;

&lt;<span style=color:#f92672>script</span>&gt;
  <span style=color:#66d9ef>var</span> <span style=color:#a6e22e>remark_config</span> <span style=color:#f92672>=</span> {
    <span style=color:#a6e22e>host</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#34;https://remark42.schnerring.net&#34;</span>,
    <span style=color:#a6e22e>site_id</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#34;schnerring.net&#34;</span>,
    <span style=color:#a6e22e>theme</span><span style=color:#f92672>:</span> <span style=color:#a6e22e>getHelloFriendTheme</span>(),
    <span style=color:#a6e22e>show_email_subscription</span><span style=color:#f92672>:</span> <span style=color:#66d9ef>false</span>,
  };
&lt;/<span style=color:#f92672>script</span>&gt;

&lt;<span style=color:#f92672>script</span>&gt;
  <span style=color:#f92672>!</span>(<span style=color:#66d9ef>function</span> (<span style=color:#a6e22e>e</span>, <span style=color:#a6e22e>n</span>) {
    <span style=color:#66d9ef>for</span> (<span style=color:#66d9ef>var</span> <span style=color:#a6e22e>o</span> <span style=color:#f92672>=</span> <span style=color:#ae81ff>0</span>; <span style=color:#a6e22e>o</span> <span style=color:#f92672>&lt;</span> <span style=color:#a6e22e>e</span>.<span style=color:#a6e22e>length</span>; <span style=color:#a6e22e>o</span><span style=color:#f92672>++</span>) {
      <span style=color:#66d9ef>var</span> <span style=color:#a6e22e>r</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>n</span>.<span style=color:#a6e22e>createElement</span>(<span style=color:#e6db74>&#34;script&#34;</span>),
        <span style=color:#a6e22e>c</span> <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;.js&#34;</span>,
        <span style=color:#a6e22e>d</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>n</span>.<span style=color:#a6e22e>head</span> <span style=color:#f92672>||</span> <span style=color:#a6e22e>n</span>.<span style=color:#a6e22e>body</span>;
      <span style=color:#e6db74>&#34;noModule&#34;</span> <span style=color:#66d9ef>in</span> <span style=color:#a6e22e>r</span> <span style=color:#f92672>?</span> ((<span style=color:#a6e22e>r</span>.<span style=color:#a6e22e>type</span> <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;module&#34;</span>), (<span style=color:#a6e22e>c</span> <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;.mjs&#34;</span>)) <span style=color:#f92672>:</span> (<span style=color:#a6e22e>r</span>.<span style=color:#66d9ef>async</span> <span style=color:#f92672>=</span> <span style=color:#f92672>!</span><span style=color:#ae81ff>0</span>),
        (<span style=color:#a6e22e>r</span>.<span style=color:#a6e22e>defer</span> <span style=color:#f92672>=</span> <span style=color:#f92672>!</span><span style=color:#ae81ff>0</span>),
        (<span style=color:#a6e22e>r</span>.<span style=color:#a6e22e>src</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>remark_config</span>.<span style=color:#a6e22e>host</span> <span style=color:#f92672>+</span> <span style=color:#e6db74>&#34;/web/&#34;</span> <span style=color:#f92672>+</span> <span style=color:#a6e22e>e</span>[<span style=color:#a6e22e>o</span>] <span style=color:#f92672>+</span> <span style=color:#a6e22e>c</span>),
        <span style=color:#a6e22e>d</span>.<span style=color:#a6e22e>appendChild</span>(<span style=color:#a6e22e>r</span>);
    }
  })(<span style=color:#a6e22e>remark_config</span>.<span style=color:#a6e22e>components</span> <span style=color:#f92672>||</span> [<span style=color:#e6db74>&#34;embed&#34;</span>], document);
&lt;/<span style=color:#f92672>script</span>&gt;
</code></pre></div><p>You can find more configuration options for the widget in the <a href=https://github.com/umputun/remark42#comments>Remark42 GitHub README</a>.</p><p>Next, we implement the <code>getHelloFriendTheme()</code> function, so Remark42 loads the correct theme. The Hello Friend theme <a href=https://github.com/panr/hugo-theme-hello-friend/blob/master/assets/js/theme.js>stores the current theme in the local storage of the browser</a>. Knowing that, implementing the function is pretty straight forward:</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-html data-lang=html>&lt;<span style=color:#f92672>script</span>&gt;
  <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>defaultTheme</span> <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;light&#34;</span>; <span style=color:#75715e>// same as defaultTheme in config.toml
</span><span style=color:#75715e></span>  <span style=color:#66d9ef>function</span> <span style=color:#a6e22e>getHelloFriendTheme</span>() {
    <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>theme</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>localStorage</span> <span style=color:#f92672>&amp;&amp;</span> <span style=color:#a6e22e>localStorage</span>.<span style=color:#a6e22e>getItem</span>(<span style=color:#e6db74>&#34;theme&#34;</span>);
    <span style=color:#66d9ef>if</span> (<span style=color:#f92672>!</span><span style=color:#a6e22e>theme</span>) {
      <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>defaultTheme</span>;
    } <span style=color:#66d9ef>else</span> {
      <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>theme</span>;
    }
  }
&lt;/<span style=color:#f92672>script</span>&gt;
</code></pre></div><p>The last thing we have to take care of is to also toggle the Remark42 theme, when clicking the theme toggle button of the Hello Friend theme. To do so, we register an additional <code>click</code> event handler to the <code>.theme-toggle</code> button and call the <a href=https://github.com/umputun/remark42#themes><code>window.REMARK42.changeTheme()</code> function</a>:</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-html data-lang=html>&lt;<span style=color:#f92672>script</span>&gt;
  <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>themeToggle</span> <span style=color:#f92672>=</span> document.<span style=color:#a6e22e>querySelector</span>(<span style=color:#e6db74>&#34;.theme-toggle&#34;</span>);
  <span style=color:#a6e22e>themeToggle</span>.<span style=color:#a6e22e>addEventListener</span>(<span style=color:#e6db74>&#34;click&#34;</span>, () =&gt; {
    <span style=color:#a6e22e>setTimeout</span>(() =&gt; window.<span style=color:#a6e22e>REMARK42</span>.<span style=color:#a6e22e>changeTheme</span>(<span style=color:#a6e22e>getHelloFriendTheme</span>()), <span style=color:#ae81ff>10</span>);
  });
&lt;/<span style=color:#f92672>script</span>&gt;
</code></pre></div><p>Note that we wait 10 ms before reading from local storage to avoid race conditions. All we have to do now is to enable comments by setting <code>comments: true</code> via <a href=https://gohugo.io/content-management/front-matter/>Hugo Front Matter</a>.</p><h2 id=what-do-you-think>What Do You Think?</h2><p>You can find all the code on my GitHub. I also tagged the commits to make it easier to find the code for future reference:</p><ul><li><a href=https://github.com/schnerring/infrastructure/blob/v0.2.0/remark42.tf>schnerring/infrastructure</a> (Terraform, tag <code>v0.2.0</code>)</li><li><a href=https://github.com/schnerring/schnerring.github.io/blob/v1.1.0/layouts/partials/comments.html>schnerring/schnerring.github.io</a> (Hugo, tag <code>v1.1.0</code>)</li></ul><p>Any feedback in the comments below is appreciated.</p></div><div id=remark42></div><script>const defaultTheme="light";function getHelloFriendTheme(){const a=localStorage&&localStorage.getItem("theme");return a||defaultTheme}</script><script>var remark_config={host:"https://remark42.schnerring.net",site_id:"schnerring.net",theme:getHelloFriendTheme(),show_email_subscription:!1}</script><script>!function(d,b){for(var c=0,a,e,f;c<d.length;c++)a=b.createElement("script"),e=".js",f=b.head||b.body,"noModule"in a?(a.type="module",e=".mjs"):a.async=!0,a.defer=!0,a.src=remark_config.host+"/web/"+d[c]+e,f.appendChild(a)}(remark_config.components||["embed"],document)</script><script>const themeToggle=document.querySelector(".theme-toggle");themeToggle.addEventListener("click",()=>{setTimeout(()=>window.REMARK42.changeTheme(getHelloFriendTheme()),10)})</script></div></div><footer class=footer><div class=footer__inner><div class="copyright copyright--user"><p>Copyright Â© 2020 Michael Schnerring</p><p xmlns:dct=http://purl.org/dc/terms/ xmlns:cc=http://creativecommons.org/ns# class=license-text><a rel=cc:attributionurl property="dct:title" href=https://github.com/schnerring/schnerring.github.io/tree/main/content>Content</a> licensed under <a rel=license href=https://creativecommons.org/licenses/by/4.0>CC BY 4.0</a></p></div></div></footer><script src=https://schnerring.net/assets/main.js></script><script src=https://schnerring.net/assets/prism.js></script></div></body></html>