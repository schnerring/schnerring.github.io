<!doctype html><html lang=en data-theme=dark><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><link rel=preload as=font type=font/woff2 href=/fonts/roboto-slab-latin-400.woff2 crossorigin=anonymous><link rel=preload as=font type=font/woff2 href=/fonts/roboto-slab-latin-700.woff2 crossorigin=anonymous><link rel=preload as=font type=font/woff2 href=/fonts/fira-code-latin-300.woff2 crossorigin=anonymous><link rel=preload as=font type=font/woff2 href=/fonts/fira-code-latin-400.woff2 crossorigin=anonymous><link rel=preload as=font type=font/woff2 href=/fonts/fira-code-latin-700.woff2 crossorigin=anonymous><meta name=robots content="index, follow, max-snippet:-1, max-image-preview:large, max-video-preview:-1"><title>OPNsense Baseline Guide with Mullvad VPN Multi-WAN, Guest, and VLAN Support</title>
<meta name=description content="This beginner-friendly, step-by-step guide walks you through the initial configuration of your OPNsense firewall. The title of this guide is an homage to the pfSense baseline guide with VPN, Guest, and VLAN support that some of you guys might know, and this is an OPNsense migration of it. I found that guide two years ago and immediately fell in love with the network setup. After researching for weeks, I decided to use OPNsense instead of pfSense."><link rel=canonical href=https://schnerring.net/blog/opnsense-baseline-guide-with-vpn-guest-and-vlan-support/><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="https://schnerring.net/blog/opnsense-baseline-guide-with-vpn-guest-and-vlan-support/cover.png"><meta name=twitter:title content="OPNsense Baseline Guide with Mullvad VPN Multi-WAN, Guest, and VLAN Support"><meta name=twitter:description content="This beginner-friendly, step-by-step guide walks you through the initial configuration of your OPNsense firewall. The title of this guide is an homage to the pfSense baseline guide with VPN, Guest, and VLAN support that some of you guys might know, and this is an OPNsense migration of it. I found that guide two years ago and immediately fell in love with the network setup. After researching for weeks, I decided to use OPNsense instead of pfSense."><meta property="og:url" content="https://schnerring.net/blog/opnsense-baseline-guide-with-vpn-guest-and-vlan-support/"><meta property="og:site_name" content="Michael Schnerring"><meta property="og:title" content="OPNsense Baseline Guide with Mullvad VPN Multi-WAN, Guest, and VLAN Support"><meta property="og:description" content="This beginner-friendly, step-by-step guide walks you through the initial configuration of your OPNsense firewall. The title of this guide is an homage to the pfSense baseline guide with VPN, Guest, and VLAN support that some of you guys might know, and this is an OPNsense migration of it. I found that guide two years ago and immediately fell in love with the network setup. After researching for weeks, I decided to use OPNsense instead of pfSense."><meta property="og:locale" content="en"><meta property="og:type" content="article"><meta property="article:section" content="blog"><meta property="article:published_time" content="2021-11-17T03:56:35+01:00"><meta property="article:modified_time" content="2023-07-30T04:53:09+02:00"><meta property="article:tag" content="DNS"><meta property="article:tag" content="Dnsmasq"><meta property="article:tag" content="Firewall"><meta property="article:tag" content="Homelab"><meta property="article:tag" content="Let's Encrypt"><meta property="article:tag" content="Mullvad"><meta property="og:image" content="https://schnerring.net/blog/opnsense-baseline-guide-with-vpn-guest-and-vlan-support/cover.png"><meta itemprop=name content="OPNsense Baseline Guide with Mullvad VPN Multi-WAN, Guest, and VLAN Support"><meta itemprop=description content="This beginner-friendly, step-by-step guide walks you through the initial configuration of your OPNsense firewall. The title of this guide is an homage to the pfSense baseline guide with VPN, Guest, and VLAN support that some of you guys might know, and this is an OPNsense migration of it. I found that guide two years ago and immediately fell in love with the network setup. After researching for weeks, I decided to use OPNsense instead of pfSense."><meta itemprop=datePublished content="2021-11-17T03:56:35+01:00"><meta itemprop=dateModified content="2023-07-30T04:53:09+02:00"><meta itemprop=wordCount content="6424"><meta itemprop=image content="https://schnerring.net/blog/opnsense-baseline-guide-with-vpn-guest-and-vlan-support/cover.png"><meta itemprop=keywords content="DNS,Dnsmasq,Firewall,Homelab,Let's Encrypt,Mullvad,Network,OPNsense,Router,Self-Host,Unbound,VLAN,VPN,WireGuard"><script async defer data-domain=schnerring.net src=https://plausible.schnerring.net/js/plausible.js></script><style>@font-face{font-display:swap;font-family:Roboto Slab;font-style:normal;font-weight:100;src:local("Roboto Slab Thin "),local("Roboto Slab-Thin"),url(/fonts/roboto-slab-latin-100.woff2) format("woff2"),url(/fonts/roboto-slab-latin-100.woff) format("woff")}@font-face{font-display:swap;font-family:Roboto Slab;font-style:normal;font-weight:200;src:local("Roboto Slab Extra Light "),local("Roboto Slab-Extra Light"),url(/fonts/roboto-slab-latin-200.woff2) format("woff2"),url(/fonts/roboto-slab-latin-200.woff) format("woff")}@font-face{font-display:swap;font-family:Roboto Slab;font-style:normal;font-weight:300;src:local("Roboto Slab Light "),local("Roboto Slab-Light"),url(/fonts/roboto-slab-latin-300.woff2) format("woff2"),url(/fonts/roboto-slab-latin-300.woff) format("woff")}@font-face{font-display:swap;font-family:Roboto Slab;font-style:normal;font-weight:400;src:local("Roboto Slab Regular "),local("Roboto Slab-Regular"),url(/fonts/roboto-slab-latin-400.woff2) format("woff2"),url(/fonts/roboto-slab-latin-400.woff) format("woff")}@font-face{font-display:swap;font-family:Roboto Slab;font-style:normal;font-weight:500;src:local("Roboto Slab Medium "),local("Roboto Slab-Medium"),url(/fonts/roboto-slab-latin-500.woff2) format("woff2"),url(/fonts/roboto-slab-latin-500.woff) format("woff")}@font-face{font-display:swap;font-family:Roboto Slab;font-style:normal;font-weight:600;src:local("Roboto Slab SemiBold "),local("Roboto Slab-SemiBold"),url(/fonts/roboto-slab-latin-600.woff2) format("woff2"),url(/fonts/roboto-slab-latin-600.woff) format("woff")}@font-face{font-display:swap;font-family:Roboto Slab;font-style:normal;font-weight:700;src:local("Roboto Slab Bold "),local("Roboto Slab-Bold"),url(/fonts/roboto-slab-latin-700.woff2) format("woff2"),url(/fonts/roboto-slab-latin-700.woff) format("woff")}@font-face{font-display:swap;font-family:Roboto Slab;font-style:normal;font-weight:800;src:local("Roboto Slab ExtraBold "),local("Roboto Slab-ExtraBold"),url(/fonts/roboto-slab-latin-800.woff2) format("woff2"),url(/fonts/roboto-slab-latin-800.woff) format("woff")}@font-face{font-display:swap;font-family:Roboto Slab;font-style:normal;font-weight:900;src:local("Roboto Slab Black "),local("Roboto Slab-Black"),url(/fonts/roboto-slab-latin-900.woff2) format("woff2"),url(/fonts/roboto-slab-latin-900.woff) format("woff")}@font-face{font-display:swap;font-family:Fira Code;font-style:normal;font-weight:300;src:local("Fira Code Light "),local("Fira Code-Light"),url(/fonts/fira-code-latin-300.woff2) format("woff2"),url(/fonts/fira-code-latin-300.woff) format("woff")}@font-face{font-display:swap;font-family:Fira Code;font-style:normal;font-weight:400;src:local("Fira Code Regular "),local("Fira Code-Regular"),url(/fonts/fira-code-latin-400.woff2) format("woff2"),url(/fonts/fira-code-latin-400.woff) format("woff")}@font-face{font-display:swap;font-family:Fira Code;font-style:normal;font-weight:500;src:local("Fira Code Medium "),local("Fira Code-Medium"),url(/fonts/fira-code-latin-500.woff2) format("woff2"),url(/fonts/fira-code-latin-500.woff) format("woff")}@font-face{font-display:swap;font-family:Fira Code;font-style:normal;font-weight:600;src:local("Fira Code SemiBold "),local("Fira Code-SemiBold"),url(/fonts/fira-code-latin-600.woff2) format("woff2"),url(/fonts/fira-code-latin-600.woff) format("woff")}@font-face{font-display:swap;font-family:Fira Code;font-style:normal;font-weight:700;src:local("Fira Code Bold "),local("Fira Code-Bold"),url(/fonts/fira-code-latin-700.woff2) format("woff2"),url(/fonts/fira-code-latin-700.woff) format("woff")}

/*! normalize.css v8.0.1 | MIT License | github.com/necolas/normalize.css */html{line-height:1.15;-webkit-text-size-adjust:100%}body{margin:0}main{display:block}h1{font-size:2em;margin:.67em 0}hr{box-sizing:content-box;height:0;overflow:visible}pre{font-family:monospace,monospace;font-size:1em}a{background-color:transparent}abbr[title]{border-bottom:none;-webkit-text-decoration:underline;text-decoration:underline;-webkit-text-decoration:underline dotted;text-decoration:underline dotted}b,strong{font-weight:bolder}code,kbd,samp{font-family:monospace,monospace;font-size:1em}small{font-size:80%}sub,sup{font-size:75%;line-height:0;position:relative;vertical-align:baseline}sub{bottom:-.25em}sup{top:-.5em}img{border-style:none}button,input,optgroup,select,textarea{font-family:inherit;font-size:100%;line-height:1.15;margin:0}button,input{overflow:visible}button,select{text-transform:none}[type=button],[type=reset],[type=submit],button{-webkit-appearance:button}[type=button]::-moz-focus-inner,[type=reset]::-moz-focus-inner,[type=submit]::-moz-focus-inner,button::-moz-focus-inner{border-style:none;padding:0}[type=button]:-moz-focusring,[type=reset]:-moz-focusring,[type=submit]:-moz-focusring,button:-moz-focusring{outline:1px dotted ButtonText}fieldset{padding:.35em .75em .625em}legend{box-sizing:border-box;color:inherit;display:table;max-width:100%;padding:0;white-space:normal}progress{vertical-align:baseline}textarea{overflow:auto}[type=checkbox],[type=radio]{box-sizing:border-box;padding:0}[type=number]::-webkit-inner-spin-button,[type=number]::-webkit-outer-spin-button{height:auto}[type=search]{-webkit-appearance:textfield;outline-offset:-2px}[type=search]::-webkit-search-decoration{-webkit-appearance:none}::-webkit-file-upload-button{-webkit-appearance:button;font:inherit}details{display:block}summary{display:list-item}[hidden],template{display:none}

/*! CC BY-SA 3.0 License | https://stackoverflow.com/a/36118384/1154965 */@keyframes blink{50%{opacity:0}to{opacity:1}}

/*! MIT License | github.com/schnerring/hugo-theme-gruvbox */:root[data-theme=light]{--bg:var(--bg0_h);--bg0:#fbf1c7;--bg0_h:#f9f5d7;--bg0_s:#f2e5bc;--bg1:#ebdbb2;--bg2:#d5c4a1;--bg3:#bdae93;--bg4:#a89984;--fg:var(--fg1);--fg0:#282828;--fg1:#3c3836;--fg2:#504945;--fg3:#665c54;--fg4:#7c6f64;--gray1:var(--fg4);--gray2:#928374;--red1:#cc241d;--red2:#9d0006;--green1:#98971a;--green2:#797403;--yellow1:#d79921;--yellow2:#b57614;--blue1:#458588;--blue2:#076678;--purple1:#b16286;--purple2:#8f3f71;--aqua1:#689d6a;--aqua2:#427b58;--orange1:#d65d0e;--orange2:#af3a03}[data-theme=light]:root .light--hidden{display:none}:root[data-theme=dark]{--bg:var(--bg0_h);--bg0:#282828;--bg0_h:#1d2021;--bg0_s:#32302f;--bg1:#3c3836;--bg2:#504945;--bg3:#665c54;--bg4:#7c6f64;--fg:var(--fg1);--fg0:#fbf1c7;--fg1:#ebdbb2;--fg2:#d5c4a1;--fg3:#bdae93;--fg4:#a89984;--gray1:var(--fg4);--gray2:#928374;--red1:#cc241d;--red2:#fb4934;--green1:#98971a;--green2:#b8bb26;--yellow1:#d79921;--yellow2:#fabd2f;--blue1:#458588;--blue2:#83a598;--purple1:#b16286;--purple2:#d3869b;--aqua1:#689d6a;--aqua2:#8ec07c;--orange1:#d65d0e;--orange2:#fe8019}[data-theme=dark]:root .dark--hidden{display:none}:root{--primary:var(--aqua1);--primary-alt:var(--aqua2);--font-monospace:"Fira Code","Lucida Console",Monaco,monospace;--font-sans-serif:Verdana,Helvetica,sans-serif;--font-serif:"Roboto Slab",Georgia,serif}html{font-family:Roboto Slab,Georgia,serif;font-family:var(--font-serif);font-size:1rem;scroll-behavior:smooth}body{background:var(--bg);color:var(--fg);line-height:1.675;word-wrap:break-word}strong{letter-spacing:.35px}a{color:inherit;-webkit-text-decoration:none;text-decoration:none}a.link--external:after{content:"\2009↗"}img,video{border:2px solid var(--bg1);height:auto;max-width:100%}figure{display:inline-block}figcaption{color:var(--fg3);font-family:Roboto Slab,Georgia,serif;font-family:var(--font-serif);font-size:.9rem}::-moz-selection{background:var(--bg4);color:var(--fg0)}::selection{background:var(--bg4);color:var(--fg0)}h1,h2,h3,h4,h5{color:var(--fg0);font-family:Fira Code,Lucida Console,Monaco,monospace;font-family:var(--font-monospace);font-weight:300;line-height:1.4}h1 code,h2 code,h3 code,h4 code,h5 code{font-size:1em}h2,h3,h4,h5{border-bottom:1px solid var(--bg1)}h1,h2{font-weight:400}h1{font-size:1.875rem}h2{font-size:1.75rem}h3{font-size:1.625rem}@media (min-width:768px){h1{font-size:2.375rem}h2{font-size:2rem}h3{font-size:1.75rem}}h4{font-size:1.5rem}h5{font-size:1.375rem}table{border-collapse:collapse;margin:2rem 0;table-layout:fixed;width:100%}table,td,th{border:1px solid var(--bg1);padding:.5rem}hr{background:var(--bg1);border:none;height:1px;margin:3rem auto;width:80%}blockquote,code,pre{border-radius:.2rem;padding:0 .2em}pre code{padding:0}blockquote,code,pre,th{background:var(--bg1)}code,pre,th{font-family:Fira Code,Lucida Console,Monaco,monospace;font-family:var(--font-monospace)}code code{background:var(--bg2)}blockquote,pre{padding:1rem}pre{background:var(--bg1)!important;overflow:auto}pre code{background:none}blockquote{border-left:5px solid var(--primary-alt);margin:.5rem 0}blockquote:not(.does-not-exist) code{background:var(--bg2)}blockquote:not(.does-not-exist) p:first-of-type{margin-top:0}blockquote:not(.does-not-exist) p:last-of-type{margin-bottom:0}pre::-webkit-scrollbar{height:.5rem;scrollbar-width:auto}pre::-webkit-scrollbar-track{background:var(--bg2);border-radius:.2rem}pre::-webkit-scrollbar-thumb{background:var(--bg4);border-radius:.2rem}.layout{display:grid;grid-template-areas:"header" "main" "footer";grid-template-rows:auto 1fr auto;height:100vh}main{align-items:start;display:grid;grid-area:main;grid-template-areas:"empty content sidebar";grid-template-columns:1fr minmax(0,650px) 4fr}header{background:var(--bg1);grid-area:header}footer{grid-area:footer}footer,main{margin:.5em 1.1em}.content{grid-area:content}.sidebar{display:none;flex-direction:column;grid-area:sidebar;margin-top:3rem;position:sticky;top:2rem}@media (min-width:992px){.sidebar{display:flex}}header{display:grid;font-family:Fira Code,Lucida Console,Monaco,monospace;font-family:var(--font-monospace);font-size:1.125rem;grid-template-areas:"heading search nav theme-toggle";grid-template-columns:auto auto 1fr auto;padding:.75rem}.logo{color:var(--fg0);display:flex;font-weight:700;grid-area:heading}.logo:hover .logo__cursor{animation:blink 1s infinite;opacity:1}.logo__chevron,.logo__cursor{margin-left:.5rem}.logo__cursor{opacity:0}.logo__text{display:none}@media (min-width:768px){.logo__text{display:block}}.search{display:flex;grid-area:search;margin:0 1rem}#search__text{background:var(--bg2);border:1px solid var(--bg2);border-radius:.2rem;caret-color:var(--fg);color:var(--fg);outline:none;padding:0 .5rem;width:100%}#search__text:hover{border-color:var(--bg3)}#search__text:focus{border-color:var(--bg4)}#search__text::-moz-placeholder{color:var(--fg3)}#search__text::placeholder{color:var(--fg3)}#search__text[type=search]::-webkit-search-cancel-button{-webkit-appearance:none;appearance:none}#search__suggestions{background:var(--bg);border-radius:.2rem;box-shadow:0 .5rem 1rem var(--bg1);font-family:Roboto Slab,Georgia,serif;font-family:var(--font-serif);left:0;margin-top:2rem;position:absolute;width:95vw;z-index:1000}@media (min-width:768px){.search{position:relative}#search__suggestions{width:60vw}}.search__suggestions--hidden{display:none}.search__suggestion-item{border-bottom:1px dashed var(--bg2);display:grid;grid-template-columns:1fr 2fr}.search__suggestion-item:focus,.search__suggestion-item:focus-visible,.search__suggestion-item:hover{background:var(--bg1);cursor:pointer;outline:none}.search__suggestion-item:last-child{border:none}.search__suggestion-description,.search__suggestion-title{margin:1rem 0;padding:0 1rem}.search__suggestion-title{font-weight:700}.search__suggestion-description{border-left:1px solid var(--bg2)}.search__no-results{padding:.75rem}.theme__toggle{align-items:center;background:none;border:none;color:var(--yellow1);cursor:pointer;display:flex;grid-area:theme-toggle;margin:0 1rem}.theme__toggle:hover{color:var(--yellow2)}.theme__toggle svg{height:28px;width:28px}nav#menu{align-items:center;display:flex;grid-area:nav;justify-content:flex-end}nav#menu .menu__item{color:var(--fg)}nav#menu .menu__item:hover{color:var(--fg3);cursor:pointer}nav#menu ul{list-style:none;margin:0;padding:0}nav#menu ul.menu--horizontal{align-items:center;display:none}nav#menu ul.menu--horizontal li{display:inline-block;margin:0 .75rem}@media (min-width:768px){nav#menu ul.menu--horizontal{display:flex}}nav#menu ul.menu--vertical{background:var(--fg0);bottom:0;margin:0;padding:3rem;position:fixed;right:0;top:0;transform:translate(100%);transition:transform .5s cubic-bezier(.9,0,.1,1);width:50%;z-index:10}nav#menu ul.menu--vertical .menu__item{color:var(--bg1)}nav#menu ul.menu--vertical .menu__item:hover{color:var(--bg4)}nav#menu .menu__burger{display:flex;height:24px;width:24px}nav#menu .menu__burger>*{position:absolute}nav#menu .menu__burger svg{height:inherit;width:inherit;z-index:20}nav#menu .menu__burger svg line{transition-duration:.5s;transition-property:stroke,opacity,transform;transition-timing-function:cubic-bezier(.9,0,.1,1)}nav#menu .menu__burger svg line:first-of-type{transform-origin:center 6px}nav#menu .menu__burger svg line:nth-of-type(2){transform-origin:center 12px}nav#menu .menu__burger svg line:nth-of-type(3){transform-origin:center 18px}nav#menu .menu__burger input{height:inherit;opacity:0;width:inherit;z-index:30}nav#menu .menu__burger input:checked~ul.menu--vertical{transform:none}nav#menu .menu__burger input:checked~svg{stroke:var(--bg1)}nav#menu .menu__burger input:checked~svg line:first-of-type{transform:translateY(6px) rotate(45deg)}nav#menu .menu__burger input:checked~svg line:nth-of-type(2){opacity:0;transform:scale(.2)}nav#menu .menu__burger input:checked~svg line:nth-of-type(3){transform:translateY(-6px) rotate(-45deg)}@media (min-width:768px){nav#menu .menu__burger{display:none}}.sidebar{font-family:Fira Code,Lucida Console,Monaco,monospace;font-family:var(--font-monospace);margin-left:auto;margin-right:auto;max-width:350px;padding-left:2.5rem}.sidebar hr{margin:1.5rem auto}.sidebar svg{fill:var(--fg)}.sidebar__heading{font-size:1.3rem}aside.toc a{color:var(--primary-alt)}aside.toc a:hover{color:var(--primary)}aside.toc ul{list-style:none;margin:0;padding:0}aside.toc ul ul{font-size:.9rem;margin-left:.5rem}aside.toc ul li{line-height:1.1}aside.toc ul li a{display:block;padding:.2rem 0}.jr-basics__image{background:var(--bg1);border:2px solid var(--bg2)}.jr-basics__summary{color:var(--fg3);font-family:Roboto Slab,Georgia,serif;font-family:var(--font-serif);margin:.75rem 0}.jr-basics__profile a:hover{color:var(--fg3)}.jr-basics__profile a:hover svg{fill:var(--fg3)}.content-section,.post{border-bottom:2px dotted var(--bg1);padding:2rem 0}.post figure,.post img:not(figure img),.post video:not(figure video){box-sizing:border-box;margin:.5rem 0}.post-content__read-more,.post-header{font-family:Fira Code,Lucida Console,Monaco,monospace;font-family:var(--font-monospace)}.post-content{margin:1.3rem 0}.post-content__read-more{color:var(--primary-alt);margin-top:1.3rem}.post-content a,.post-header a{color:var(--primary-alt)}.post-content a:hover,.post-header a:hover{color:var(--primary)}.post-tags{align-items:center;display:flex;flex-wrap:wrap;gap:.9rem;margin:1rem 0}.post-tag{font-size:.9rem;line-height:1}.post-tag:before{content:"#"}.post-heading__anchor{display:none}h1:hover .post-heading__anchor,h2:hover .post-heading__anchor,h3:hover .post-heading__anchor,h4:hover .post-heading__anchor,h5:hover .post-heading__anchor{display:inline-block}.jr__item-meta{flex-direction:column}.jr-basics__image,.jr-basics__item,.jr-basics__profile-icon,.jr-basics__profile-item,.jr__item-meta{align-items:center;display:flex}.jr-basics__name,.jr-projects__roles,.jr-work__position{font-size:1.125rem;font-weight:700}.jr-basics__item{flex-direction:column;text-align:center}.jr-basics__item hr{margin:1.5rem auto}.jr-basics__image{border-radius:50%;height:250px;justify-content:center;overflow:hidden;width:250px}.jr-basics__label,.jr-basics__name,.jr-basics__summary{margin-top:.75rem}.jr-basics__profile svg{height:24px;width:24px}.jr-basics__profile,.jr-basics__profile-item{display:flex}.jr-basics__profile-item{display:flex;padding:.2rem}.jr-basics__profile--row{flex-wrap:wrap;justify-content:space-evenly}.jr-basics__profile-icon{padding:0 .75rem}.jr__item-meta{align-items:start;flex-flow:column;font-family:Fira Code,Lucida Console,Monaco,monospace;font-family:var(--font-monospace)}@media (min-width:768px){.jr__item-meta{align-items:center;flex-flow:row wrap}.jr-work__location,.jr__date-range{flex-grow:1;text-align:right}}#cookie-consent{animation:fadeIn .75s;background:var(--fg0);border-radius:.2rem;bottom:1rem;box-shadow:0 -.5rem 1rem var(--bg1);color:var(--bg1);font-family:Fira Code,Lucida Console,Monaco,monospace;font-family:var(--font-monospace);left:1rem;padding:1rem;position:fixed;right:1rem;z-index:2000}@media (min-width:768px){#cookie-consent{padding:2.5rem}}#cookie-consent button{background:none;border:none;color:var(--primary);font-size:1.125rem;margin:0 1rem;white-space:nowrap}#cookie-consent button:hover{color:var(--primary-alt);cursor:pointer}.cookie-consent--hidden{display:none}.cli-prompt{display:flex;justify-content:center}.cli-prompt__cursor{animation:blink 1s infinite}@keyframes fadeIn{0%{opacity:0}to{opacity:1}}.social-share{align-items:center;border-top:2px dotted var(--bg1);display:flex;flex-wrap:wrap;gap:.9rem;margin:3rem 0;padding-top:3rem}.social-share svg{fill:var(--fg);height:24px;width:24px}.social-share svg.icon-tabler{fill:none;stroke:var(--fg)}.social-share__item{background:var(--bg1);display:flex;padding:.5rem}</style><link rel=preload href="/css/non-critical.337c8f4cb58340e40be13eb232f89e4e12c02a13f92b6cd3c29a31c1397a0b150922b6cf8f80cd3037768bdcf919626d3205923713ad33f8c502a973337d3d63.css" as=style onload='this.onload=null,this.rel="stylesheet"' integrity="sha512-M3yPTLWDQOQL4T6yMvieThLAKhP5K2zTwpoxwTl6CxUJIrbPj4DNMDd2i9z5GWJtMgWSNxOtM/jFAqlzM309Yw=="><link id=prism-dark rel=preload href=/prism-themes/prism-gruvbox-dark.min.54aecc64074623a4f9898544dcbdab9e804f1560ef0b38f4cf8e10fcaaf72264e798cb407c601aca6ecd833ec4eb93d66535581f18d45ba202cf848b70dbc332.css as=style onload='this.onload=null,this.rel="stylesheet"' integrity="sha512-VK7MZAdGI6T5iYVE3L2rnoBPFWDvCzj0z44Q/Kr3ImTnmMtAfGAaym7Ngz7E65PWZTVYHxjUW6ICz4SLcNvDMg=="><link id=prism-light rel=preload href=/prism-themes/prism-gruvbox-light.min.42a221741efe997fcc94187c39d63c555560678789ac9ca856c74a5f0ddb2aa6c50d38b2ffbecc7a99038cbbd2efa99746e862267f781c559e0cfec10b88a5fc.css as=style onload='this.onload=null,this.rel="stylesheet"' integrity="sha512-QqIhdB7+mX/MlBh8OdY8VVVgZ4eJrJyoVsdKXw3bKqbFDTiy/77MepkDjLvS76mXRuhiJn94HFWeDP7BC4il/A==" disabled><noscript><link rel=stylesheet href=/prism-themes/prism-gruvbox-dark.min.54aecc64074623a4f9898544dcbdab9e804f1560ef0b38f4cf8e10fcaaf72264e798cb407c601aca6ecd833ec4eb93d66535581f18d45ba202cf848b70dbc332.css integrity="sha512-VK7MZAdGI6T5iYVE3L2rnoBPFWDvCzj0z44Q/Kr3ImTnmMtAfGAaym7Ngz7E65PWZTVYHxjUW6ICz4SLcNvDMg=="><link rel=stylesheet href="/css/non-critical.337c8f4cb58340e40be13eb232f89e4e12c02a13f92b6cd3c29a31c1397a0b150922b6cf8f80cd3037768bdcf919626d3205923713ad33f8c502a973337d3d63.css" integrity="sha512-M3yPTLWDQOQL4T6yMvieThLAKhP5K2zTwpoxwTl6CxUJIrbPj4DNMDd2i9z5GWJtMgWSNxOtM/jFAqlzM309Yw=="></noscript><script>(()=>{function n(){if(localStorage&&localStorage.getItem("theme"))return localStorage.getItem("theme");if(window.matchMedia)return window.matchMedia("(prefers-color-scheme: light)").matches?"light":"dark"}function e(e){document.documentElement.setAttribute("data-theme",e);let t=document.getElementById("prism-dark"),n=document.getElementById("prism-light");t.toggleAttribute("disabled",e==="light"),n.toggleAttribute("disabled",e==="dark"),localStorage.setItem("theme",e)}var t=n();t&&e(t);function s(t){let n=t.currentTarget.classList.contains("light--hidden")?"light":"dark";e(n)}document.addEventListener("DOMContentLoaded",function(){document.querySelectorAll(".theme__toggle").forEach(e=>{e.addEventListener("click",s)})})})()</script><link rel=apple-touch-icon sizes=180x180 href=/apple-touch-icon.png><link rel=icon type=image/png sizes=32x32 href=/favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=/favicon-16x16.png><link rel=manifest href=/site.webmanifest><meta name=msapplication-TileColor content="#282828"><meta name=theme-color content="#282828"></head><body><div class=layout><header><a class=logo href=/><div class=logo__text>schnerring.net</div><div class=logo__chevron>></div><div class=logo__cursor>█</div></a><div class=search><input id=search__text type=search placeholder=Search... aria-label=Search autocomplete=off><div id=search__suggestions class=search__suggestions--hidden></div></div><nav id=menu><ul class=menu--horizontal><li class=menu__item><a href=/blog>Blog</a></li><li class=menu__item><a href=/projects>Projects</a></li><li class=menu__item><a href=/about>About</a></li><li class=menu__item><a href=/stats>Stats</a></li></ul><div class=menu__burger><input class=menu__item type=checkbox aria-label="Open main menu"><svg class="icon icon-tabler icon-tabler-menu-2" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M4 6h16"/><path d="M4 12h16"/><path d="M4 18h16"/></svg><ul class=menu--vertical><li><a class=menu__item href=/blog>Blog</a></li><li><a class=menu__item href=/projects>Projects</a></li><li><a class=menu__item href=/about>About</a></li><li><a class=menu__item href=/stats>Stats</a></li></ul></div></nav><button class="theme__toggle light--hidden" aria-label="Toggle light mode">
<svg class="icon icon-tabler icon-tabler-sun" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M12 12m-4 0a4 4 0 108 0 4 4 0 10-8 0"/><path d="M3 12h1m8-9v1m8 8h1m-9 8v1M5.6 5.6l.7.7m12.1-.7-.7.7m0 11.4.7.7m-12.1-.7-.7.7"/></svg>
</button>
<button class="theme__toggle dark--hidden" aria-label="Toggle dark mode"><svg class="icon icon-tabler icon-tabler-moon" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M12 3c.132.0.263.0.393.0a7.5 7.5.0 007.92 12.446A9 9 0 1112 2.992z"/></svg></button></header><main><div class=content><article class=post><div class=post-header><h1>OPNsense Baseline Guide with Mullvad VPN Multi-WAN, Guest, and VLAN Support</h1><div class=post-meta><span>2021-11-17</span><span> (updated: 2023-07-30)</span><div class=post-tags><a class=post-tag href=https://schnerring.net/tags/dns>dns</a><a class=post-tag href=https://schnerring.net/tags/dnsmasq>dnsmasq</a><a class=post-tag href=https://schnerring.net/tags/firewall>firewall</a><a class=post-tag href=https://schnerring.net/tags/homelab>homelab</a><a class=post-tag href=https://schnerring.net/tags/lets-encrypt>lets&#8209;encrypt</a><a class=post-tag href=https://schnerring.net/tags/mullvad>mullvad</a><a class=post-tag href=https://schnerring.net/tags/network>network</a><a class=post-tag href=https://schnerring.net/tags/opnsense>opnsense</a><a class=post-tag href=https://schnerring.net/tags/router>router</a><a class=post-tag href=https://schnerring.net/tags/self-host>self&#8209;host</a><a class=post-tag href=https://schnerring.net/tags/unbound>unbound</a><a class=post-tag href=https://schnerring.net/tags/vlan>vlan</a><a class=post-tag href=https://schnerring.net/tags/vpn>vpn</a><a class=post-tag href=https://schnerring.net/tags/wireguard>wireguard</a></div><picture><source type=image/webp srcset="/blog/opnsense-baseline-guide-with-vpn-guest-and-vlan-support/cover_hu11938571017164757928.webp 300w,/blog/opnsense-baseline-guide-with-vpn-guest-and-vlan-support/cover_hu6836410132584476179.webp 500w,/blog/opnsense-baseline-guide-with-vpn-guest-and-vlan-support/cover_hu17200008421969938607.webp 617w" sizes="(max-width: 499px) 300px,(max-width: 699px) 500px,617px"><img src=/blog/opnsense-baseline-guide-with-vpn-guest-and-vlan-support/cover.png srcset="/blog/opnsense-baseline-guide-with-vpn-guest-and-vlan-support/cover_hu1613894814680285011.png 300w,/blog/opnsense-baseline-guide-with-vpn-guest-and-vlan-support/cover_hu2537975692644653138.png 500w,/blog/opnsense-baseline-guide-with-vpn-guest-and-vlan-support/cover_hu15138670044156750811.png 617w" sizes="(max-width: 499px) 300px,(max-width: 699px) 500px,617px" alt width=617 height=976></picture></div></div><div class=post-content><p>This beginner-friendly, step-by-step guide walks you through the initial
configuration of your OPNsense firewall. The title of this guide is an homage to
the
<a href=https://nguvu.org/pfsense/pfsense-baseline-setup class=link--external target=_blank rel=noreferrer>pfSense baseline guide with VPN, Guest, and VLAN support</a>
that some of you guys might know, and this is an
<a href=https://opnsense.org class=link--external target=_blank rel=noreferrer>OPNsense</a> migration of it. I found that guide two years
ago and immediately fell in love with the network setup. After researching for
weeks, I decided to use OPNsense instead of pfSense. I bit the bullet and bought
the <a href=https://www.deciso.com/product-catalog/dec630/ class=link--external target=_blank rel=noreferrer>Deciso DEC630</a> appliance.
Albeit expensive and possibly overkill for my needs, I&rsquo;m happy to support the
open-source mission of Deciso, the maintainers of OPNsense. The only thing I
regret about the purchase is that I now can&rsquo;t afford the sexier-looking
successor model, the
<a href=https://shop.opnsense.com/dec600-series-opnsense-desktop-security-appliances/ class=link--external target=_blank rel=noreferrer>DEC690</a>.</p><p>To configure OPNsense, I followed the instructions of the pfSense guide, taking
notes on the differences. Some options moved to different menus or changed. As
my notes grew, I decided to publish them as a guide on my website.</p><p>My goal was to create a comprehensive guide that&rsquo;s easy to follow. But I tried
to strike a different balance regarding the brevity of the instructions compared
to the pfSense guide. It&rsquo;s a matter of personal taste, but I find the
instructions in that guide too verbose. I intentionally omit most of the
repetitive &ldquo;click save and apply&rdquo; instructions and only list configuration
changes deviating from defaults, making exceptions for important settings. I
consider the OPNsense defaults stable enough for this approach in the hope of
keeping the effort required to maintain this guide to a minimum.</p><p>I&rsquo;m a homelab hobbyist, so be warned that this guide likely contains errors.
Please, verify the steps yourself and do your research. I hope this guide is as
helpful and inspiring to you as the pfSense guide was to me. Your feedback is
always welcome and very much appreciated.</p><h2 id=overview>Overview<a href=#overview class=post-heading__anchor aria-hidden=true>#</a></h2><h3 id=wan>WAN<a href=#wan class=post-heading__anchor aria-hidden=true>#</a></h3><ul><li>DHCP WAN from a single Internet Service Provider (ISP)</li><li><a href=https://mullvad.net class=link--external target=_blank rel=noreferrer>Mullvad VPN</a> multi-WAN with gateway groups</li></ul><h3 id=lan>LAN<a href=#lan class=post-heading__anchor aria-hidden=true>#</a></h3><p>We segregate the local network into several areas with different requirements.</p><h4 id=management-network-vlan-10>Management Network (VLAN 10)<a href=#management-network-vlan-10 class=post-heading__anchor aria-hidden=true>#</a></h4><p>The Management network connects native management interfaces like WiFi access
points and IPMI interfaces.</p><h4 id=vpn-network-vlan-20>VPN Network (VLAN 20)<a href=#vpn-network-vlan-20 class=post-heading__anchor aria-hidden=true>#</a></h4><p>The primary LAN network uses the WireGuard VPN tunnels for outbound connections,
maximizing privacy and security. If the VPN tunnels fail, outbound connections
won&rsquo;t be possible. Exceptions to selectively route traffic through the ISP WAN
gateway are possible.</p><h4 id=clear-network-vlan-30>&ldquo;Clear&rdquo; Network (VLAN 30)<a href=#clear-network-vlan-30 class=post-heading__anchor aria-hidden=true>#</a></h4><p>General-purpose web access network that doesn&rsquo;t use VPN tunnels. All outgoing
connections leave through the ISP WAN gateway. It serves as a backup network in
case the VPN tunnels fail.</p><h4 id=guest-network-vlan-40>Guest Network (VLAN 40)<a href=#guest-network-vlan-40 class=post-heading__anchor aria-hidden=true>#</a></h4><p>The network that visitors use. It allows unrestricted internet access. Local
networks aren&rsquo;t accessible.</p><h4 id=lan-network>LAN Network<a href=#lan-network class=post-heading__anchor aria-hidden=true>#</a></h4><p>&ldquo;Native&rdquo; VLAN, used to debug and test new configurations.</p><h3 id=dns-services>DNS Services<a href=#dns-services class=post-heading__anchor aria-hidden=true>#</a></h3><p>We&rsquo;ll configure a DNS resolver (Unbound), as well as a DNS forwarder (Dnsmasq)
in OPNsense. Management and VPN networks will use the resolver, the Clear
network will use the forwarder, and the Guest network will use Cloudflare as an
external DNS resolver. <a href=#dns>We&rsquo;ll dig into the details later</a>.</p><h2 id=hardware-selection-and-installation>Hardware Selection and Installation<a href=#hardware-selection-and-installation class=post-heading__anchor aria-hidden=true>#</a></h2><p>The original pfSense guide features a
<a href=https://nguvu.org/pfsense/pfsense-baseline-setup/#Hardware%20selection class=link--external target=_blank rel=noreferrer>large section of hardware recommendations</a>
and
<a href=https://nguvu.org/pfsense/pfsense-baseline-setup/#Install%20pfSense class=link--external target=_blank rel=noreferrer>installation instructions</a>.</p><p>As mentioned earlier, I bought the
<a href=https://www.deciso.com/product-catalog/dec630/ class=link--external target=_blank rel=noreferrer>Deciso DEC630</a> appliance, which
is why I&rsquo;m not advising on hardware choices. Have a look at the
<a href=https://docs.opnsense.org/manual/hardware.html class=link--external target=_blank rel=noreferrer>official hardware sizing & setup guidelines</a>
for more information. See also
<a href=https://docs.opnsense.org/manual/install.html class=link--external target=_blank rel=noreferrer>Initial Installation & Configuration</a>.</p><p>I verified this guide with a clean install of OPNsense version <code>21.7.5</code>.</p><h2 id=wizard>Wizard<a href=#wizard class=post-heading__anchor aria-hidden=true>#</a></h2><p>Navigate to <code>192.168.1.1</code> in your browser and login with default credentials:</p><ul><li><strong>Username</strong>: <code>root</code></li><li><strong>Password</strong>: <code>opnsense</code></li></ul><p>Click <code>Next</code> to leave the welcome screen and get started with the initial wizard
configuration.</p><h3 id=general-information>General Information<a href=#general-information class=post-heading__anchor aria-hidden=true>#</a></h3><p><picture><source type=image/webp srcset="/blog/opnsense-baseline-guide-with-vpn-guest-and-vlan-support/wizard-general-config_hu6609361081003343936.webp 300w,/blog/opnsense-baseline-guide-with-vpn-guest-and-vlan-support/wizard-general-config_hu7422028398700835776.webp 500w,/blog/opnsense-baseline-guide-with-vpn-guest-and-vlan-support/wizard-general-config_hu6857270088176005362.webp 507w" sizes="(max-width: 499px) 300px,(max-width: 699px) 500px,507px"><img src=/blog/opnsense-baseline-guide-with-vpn-guest-and-vlan-support/wizard-general-config.png srcset="/blog/opnsense-baseline-guide-with-vpn-guest-and-vlan-support/wizard-general-config_hu4580682344736843677.png 300w,/blog/opnsense-baseline-guide-with-vpn-guest-and-vlan-support/wizard-general-config_hu765247234436499025.png 500w,/blog/opnsense-baseline-guide-with-vpn-guest-and-vlan-support/wizard-general-config_hu13252425812429908340.png 507w" sizes="(max-width: 499px) 300px,(max-width: 699px) 500px,507px" alt="Screenshot of the general wizard settings" loading=lazy width=507 height=584></picture></p><p>I prefer using the DNS servers of <a href=https://quad9.org/ class=link--external target=_blank rel=noreferrer>Quad9</a> over the ones of
my ISP. Only the Clear network will use these anyway, as secured networks use
Unbound instead. The Guest network will use Cloudflare DNS servers.</p><p>For the domain, I prefer to use a subdomain of a domain name I own, like
<code>corp.example.com</code>. I only use this subdomain internally. I consider the
<code>local.lan</code> pattern a relic of the past. To prevent our local network structure
from leaking to the outside world, we&rsquo;ll later configure Unbound and Dnsmasq to
treat the domain as private.</p><table><thead><tr><th></th><th></th></tr></thead><tbody><tr><td>Domain</td><td><code>corp.example.com</code></td></tr><tr><td>Primary DNS Server</td><td><code>9.9.9.9</code></td></tr><tr><td>Secondary DNS Server</td><td><code>149.112.112.112</code></td></tr><tr><td>Override DNS</td><td><code>unchecked</code></td></tr><tr><td>Enable DNSSEC Support</td><td><code>checked</code></td></tr><tr><td>Harden DNSSEC data</td><td><code>checked</code></td></tr></tbody></table><p>If you prefer using your ISP&rsquo;s DNS servers, leave the <strong>Override DNS</strong> option
checked.</p><h3 id=time-server-information>Time Server Information<a href=#time-server-information class=post-heading__anchor aria-hidden=true>#</a></h3><p>Choose the NTP servers geographically closest to your location. I live in
Switzerland, which makes the
<a href=https://www.pool.ntp.org/zone/ch class=link--external target=_blank rel=noreferrer>servers from the <code>ch.pool.ntp.org</code> pool</a> the
natural choice.</p><table><thead><tr><th></th><th></th></tr></thead><tbody><tr><td>Time server hostname</td><td><code>0.ch.pool.ntp.org 1.ch.pool.ntp.org 2.ch.pool.ntp.org 3.ch.pool.ntp.org</code></td></tr><tr><td>Timezone</td><td><code>Europe/Zurich</code></td></tr></tbody></table><h3 id=configure-interfaces>Configure Interfaces<a href=#configure-interfaces class=post-heading__anchor aria-hidden=true>#</a></h3><p>By default, the WAN interface obtains an IP address from your ISP via DHCP. DHCP
is also configured for the LAN interface by default and has the IP
<code>192.168.1.1</code>. It works for most people, so we just keep the defaults.</p><h3 id=set-root-password>Set Root Password<a href=#set-root-password class=post-heading__anchor aria-hidden=true>#</a></h3><p>Choose a strong root password and complete the wizard.</p><h2 id=general-settings>General Settings<a href=#general-settings class=post-heading__anchor aria-hidden=true>#</a></h2><h3 id=access>Access<a href=#access class=post-heading__anchor aria-hidden=true>#</a></h3><p>Navigate to <strong>System</strong><span> → </span><strong>Settings</strong><span> → </span><strong>Administration</strong>.</p><table><thead><tr><th>HTTP Redirect</th><th></th></tr></thead><tbody><tr><td>Disable web GUI redirect rule</td><td><code>checked</code></td></tr></tbody></table><p>Permitting root user login and password login is a quick and dirty way of
enabling SSH access, but I strongly discourage you from doing it. They are
disabled for security reasons. I highly recommend using certificate- or
<a href=https://www.digitalocean.com/community/tutorials/how-to-configure-ssh-key-based-authentication-on-a-linux-server class=link--external target=_blank rel=noreferrer>key-based authentication</a>.
If your device has a serial console port, like the Deciso DEC630, enabling SSH
is not required.</p><table><thead><tr><th>Secure Shell</th><th></th><th></th></tr></thead><tbody><tr><td>Secure Shell Server</td><td><code>checked</code></td><td></td></tr></tbody></table><table><thead><tr><th>Authentication</th><th></th><th></th></tr></thead><tbody><tr><td>Sudo</td><td><code>Ask password</code></td><td>Permit sudo usage for administrators with shell access.</td></tr></tbody></table><p>Navigate to <strong>System</strong><span> → </span><strong>Access</strong><span> → </span><strong>Users</strong> and add a new user.</p><table><thead><tr><th></th><th></th></tr></thead><tbody><tr><td>Username</td><td><code>&lt;choose a username></code></td></tr><tr><td>Password</td><td><code>&lt;choose a secure password></code></td></tr><tr><td>Login shell</td><td><code>/bin/csh</code></td></tr><tr><td>Group Memberships</td><td><code>admins</code></td></tr><tr><td>Authorized keys</td><td><code>&lt;valid SSH public key></code></td></tr></tbody></table><p>Configuring the SSH client and generating keys is out of scope for this guide,
so I&rsquo;ll just recommend this
<a href=https://www.digitalocean.com/community/tutorials/ssh-essentials-working-with-ssh-servers-clients-and-keys class=link--external target=_blank rel=noreferrer>DigitalOcean tutorial covering SSH essentials</a>.</p><h3 id=miscellaneous>Miscellaneous<a href=#miscellaneous class=post-heading__anchor aria-hidden=true>#</a></h3><p>Navigate to <strong>System</strong><span> → </span><strong>Settings</strong><span> → </span><strong>Miscellaneous</strong>.</p><table><thead><tr><th>Power Savings</th><th></th></tr></thead><tbody><tr><td>Use PowerD</td><td><code>checked</code></td></tr><tr><td>Power Mode</td><td><code>Hiadaptive</code></td></tr></tbody></table><p>Choose <strong>Cryptography settings</strong> and <strong>Thermal Sensors</strong> settings compatible
with your hardware.</p><h3 id=firewall-settings>Firewall Settings<a href=#firewall-settings class=post-heading__anchor aria-hidden=true>#</a></h3><p>Navigate to <strong>Firewall</strong><span> → </span><strong>Settings</strong><span> → </span><strong>Advanced</strong>.</p><p>Although IPv6 is something I want to use, it&rsquo;s out of scope for this guide, so
we uncheck the following.</p><table><thead><tr><th></th><th></th></tr></thead><tbody><tr><td>Allow IPv6</td><td><code>unchecked</code></td></tr></tbody></table><p>When a rule uses a specific gateway and goes down, a rule gets created, sending
traffic to the default gateway. Checking this option skips the creation of this
rule.</p><table><thead><tr><th>Gateway Monitoring</th><th></th></tr></thead><tbody><tr><td>Skip rules</td><td><code>checked</code></td></tr></tbody></table><p>Depending on your hardware, you might want to tweak the following settings to
improve performance.</p><table><thead><tr><th>Miscellaneous</th><th></th><th></th></tr></thead><tbody><tr><td>Firewall Optimization</td><td><code>conservative</code></td><td>Tries to avoid dropping any legitimate idle connections at the expense of increased memory usage and CPU utilization.</td></tr><tr><td>Firewall Maximum Table Entries</td><td><code>2000000</code></td><td>default is 1'000'000</td></tr></tbody></table><p>We disable the auto-generated anti-lockout rule because we&rsquo;ll define it manually
later.</p><table><thead><tr><th></th><th></th></tr></thead><tbody><tr><td>Disable anti-lockout</td><td><code>checked</code></td></tr></tbody></table><h3 id=checksum-offloading>Checksum Offloading<a href=#checksum-offloading class=post-heading__anchor aria-hidden=true>#</a></h3><p>For some hardware, checksum offloading doesn&rsquo;t work, particularly some Realtek
cards. Rarely, drivers may have problems with checksum offloading and some
specific NICs. If your hardware is incompatible with checksum offloading,
disable it.</p><p>Navigate to <strong>Interfaces</strong><span> → </span><strong>Settings</strong>.</p><table><thead><tr><th></th><th></th><th></th></tr></thead><tbody><tr><td>Hardware CRC</td><td><code>unchecked</code></td><td>Disable hardware checksum offload</td></tr></tbody></table><h2 id=vlans>VLANs<a href=#vlans class=post-heading__anchor aria-hidden=true>#</a></h2><h3 id=switch-choice>Switch Choice<a href=#switch-choice class=post-heading__anchor aria-hidden=true>#</a></h3><p>A 802.1Q-capable switch with properly configured VLANs is required. Check my
<a href=/posts/router-on-a-stick-vlan-configuration-with-swos-on-the-mikrotik-crs328-24p-4s+rm-switch>router on a stick VLAN configuration guide</a>
to see an example setup with a <a href=https://mikrotik.com/ class=link--external target=_blank rel=noreferrer>Mikrotik</a> switch.</p><h3 id=vlan-definitions>VLAN Definitions<a href=#vlan-definitions class=post-heading__anchor aria-hidden=true>#</a></h3><p>Typically, the <code>LAN</code> port also carries the VLAN traffic and functions as
<a href=https://www.techopedia.com/definition/27008/trunk-port class=link--external target=_blank rel=noreferrer>trunk port</a>. For me,
the default is the <code>igb0</code> port. I chose it as the parent interface for all VLANs
in the following steps.</p><p><picture><source type=image/webp srcset="/blog/opnsense-baseline-guide-with-vpn-guest-and-vlan-support/vlan-configuration_hu708878311606520537.webp 300w,/blog/opnsense-baseline-guide-with-vpn-guest-and-vlan-support/vlan-configuration_hu9666735676351508184.webp 500w,/blog/opnsense-baseline-guide-with-vpn-guest-and-vlan-support/vlan-configuration_hu6983229955622744886.webp 618w" sizes="(max-width: 499px) 300px,(max-width: 699px) 500px,618px"><img src=/blog/opnsense-baseline-guide-with-vpn-guest-and-vlan-support/vlan-configuration.png srcset="/blog/opnsense-baseline-guide-with-vpn-guest-and-vlan-support/vlan-configuration_hu15072998079968157591.png 300w,/blog/opnsense-baseline-guide-with-vpn-guest-and-vlan-support/vlan-configuration_hu7729272436335211101.png 500w,/blog/opnsense-baseline-guide-with-vpn-guest-and-vlan-support/vlan-configuration_hu10267790937030524354.png 618w" sizes="(max-width: 499px) 300px,(max-width: 699px) 500px,618px" alt="Screenshot of VLAN configurations" loading=lazy width=618 height=210></picture></p><p>Navigate to <strong>Interfaces</strong><span> → </span><strong>Other Types</strong><span> → </span><strong>VLAN</strong> and add the
VLANs.</p><h4 id=management-vlan>Management VLAN<a href=#management-vlan class=post-heading__anchor aria-hidden=true>#</a></h4><table><thead><tr><th></th><th></th></tr></thead><tbody><tr><td>Parent</td><td><code>igb0</code></td></tr><tr><td>VLAN tag</td><td><code>10</code></td></tr><tr><td>Description</td><td><code>VLAN10_MANAGE</code></td></tr></tbody></table><h4 id=vpn-vlan>VPN VLAN<a href=#vpn-vlan class=post-heading__anchor aria-hidden=true>#</a></h4><table><thead><tr><th></th><th></th></tr></thead><tbody><tr><td>Parent</td><td><code>igb0</code></td></tr><tr><td>VLAN tag</td><td><code>20</code></td></tr><tr><td>Description</td><td><code>VLAN20_VPN</code></td></tr></tbody></table><h4 id=clear-vlan>Clear VLAN<a href=#clear-vlan class=post-heading__anchor aria-hidden=true>#</a></h4><table><thead><tr><th></th><th></th></tr></thead><tbody><tr><td>Parent</td><td><code>igb0</code></td></tr><tr><td>VLAN tag</td><td><code>30</code></td></tr><tr><td>Description</td><td><code>VLAN30_CLEAR</code></td></tr></tbody></table><h4 id=guest-vlan>Guest VLAN<a href=#guest-vlan class=post-heading__anchor aria-hidden=true>#</a></h4><table><thead><tr><th></th><th></th></tr></thead><tbody><tr><td>Parent</td><td><code>igb0</code></td></tr><tr><td>VLAN tag</td><td><code>40</code></td></tr><tr><td>Description</td><td><code>VLAN40_GUEST</code></td></tr></tbody></table><h3 id=vlan-interfaces>VLAN Interfaces<a href=#vlan-interfaces class=post-heading__anchor aria-hidden=true>#</a></h3><p>We add an interface for each VLAN. Navigate to
<strong>Interfaces</strong><span> → </span><strong>Assignments</strong>.</p><p><picture><source type=image/webp srcset="/blog/opnsense-baseline-guide-with-vpn-guest-and-vlan-support/interface-assignments_hu3796470480351762109.webp 300w,/blog/opnsense-baseline-guide-with-vpn-guest-and-vlan-support/interface-assignments_hu1555378861866404277.webp 500w,/blog/opnsense-baseline-guide-with-vpn-guest-and-vlan-support/interface-assignments_hu10054330993211898383.webp 700w" sizes="(max-width: 499px) 300px,(max-width: 699px) 500px,700px"><img src=/blog/opnsense-baseline-guide-with-vpn-guest-and-vlan-support/interface-assignments.png srcset="/blog/opnsense-baseline-guide-with-vpn-guest-and-vlan-support/interface-assignments_hu11374893376149673819.png 300w,/blog/opnsense-baseline-guide-with-vpn-guest-and-vlan-support/interface-assignments_hu4575218191664173741.png 500w,/blog/opnsense-baseline-guide-with-vpn-guest-and-vlan-support/interface-assignments_hu5827165543069073257.png 700w" sizes="(max-width: 499px) 300px,(max-width: 699px) 500px,700px" alt="Screenshot of interface assignments" loading=lazy width=706 height=488></picture></p><ul><li>Select <code>vlan 10</code>, enter the description <code>VLAN10_MANAGE</code>, and click <code>+</code></li><li>Select <code>vlan 20</code>, enter the description <code>VLAN20_VPN</code>, and click <code>+</code></li><li>Select <code>vlan 30</code>, enter the description <code>VLAN30_CLEAR</code>, and click <code>+</code></li><li>Select <code>vlan 40</code>, enter the description <code>VLAN40_GUEST</code>, and click <code>+</code></li></ul><p>Click <code>Save</code>.</p><h3 id=vlan-interface-ips>VLAN Interface IPs<a href=#vlan-interface-ips class=post-heading__anchor aria-hidden=true>#</a></h3><p>To easier remember which IP range belongs to which VLAN, I like the convention
of matching the third octet of the IP with the VLAN ID. I.e., assigning the VLAN
with the ID <strong>10</strong> the address 192.168.<strong>10</strong>.0/24.</p><p><picture><source type=image/webp srcset="/blog/opnsense-baseline-guide-with-vpn-guest-and-vlan-support/interface-ip-config_hu13505691152331093996.webp 300w,/blog/opnsense-baseline-guide-with-vpn-guest-and-vlan-support/interface-ip-config_hu7514201742844764830.webp 500w,/blog/opnsense-baseline-guide-with-vpn-guest-and-vlan-support/interface-ip-config_hu18365068820199062640.webp 636w" sizes="(max-width: 499px) 300px,(max-width: 699px) 500px,636px"><img src=/blog/opnsense-baseline-guide-with-vpn-guest-and-vlan-support/interface-ip-config.png srcset="/blog/opnsense-baseline-guide-with-vpn-guest-and-vlan-support/interface-ip-config_hu5223152976931038619.png 300w,/blog/opnsense-baseline-guide-with-vpn-guest-and-vlan-support/interface-ip-config_hu14942524353743474802.png 500w,/blog/opnsense-baseline-guide-with-vpn-guest-and-vlan-support/interface-ip-config_hu10607903044688518388.png 636w" sizes="(max-width: 499px) 300px,(max-width: 699px) 500px,636px" alt="Screenshot of VLAN logical interface configuration" loading=lazy width=636 height=978></picture></p><h4 id=interface-vlan10_manage>Interface: VLAN10_MANAGE<a href=#interface-vlan10_manage class=post-heading__anchor aria-hidden=true>#</a></h4><p>Select the <code>VLAN10_MANAGE</code> interface.</p><table><thead><tr><th></th><th></th></tr></thead><tbody><tr><td>Enable Interface</td><td><code>checked</code></td></tr><tr><td>IPv4 Configuration Type</td><td><code>Static IPv4</code></td></tr><tr><td>IPv4 Address</td><td><code>192.168.10.1/24</code></td></tr></tbody></table><p>Click <code>Save</code>.</p><h4 id=interface-vlan20_vpn>Interface: VLAN20_VPN<a href=#interface-vlan20_vpn class=post-heading__anchor aria-hidden=true>#</a></h4><table><thead><tr><th></th><th></th></tr></thead><tbody><tr><td>Enable Interface</td><td><code>checked</code></td></tr><tr><td>IPv4 Configuration Type</td><td><code>Static IPv4</code></td></tr><tr><td>IPv4 Address</td><td><code>192.168.20.1/24</code></td></tr></tbody></table><h4 id=interface-vlan30_clear>Interface: VLAN30_CLEAR<a href=#interface-vlan30_clear class=post-heading__anchor aria-hidden=true>#</a></h4><table><thead><tr><th></th><th></th></tr></thead><tbody><tr><td>Enable Interface</td><td><code>checked</code></td></tr><tr><td>IPv4 Configuration Type</td><td><code>Static IPv4</code></td></tr><tr><td>IPv4 Address</td><td><code>192.168.30.1/24</code></td></tr></tbody></table><h4 id=interface-vlan40_guest>Interface: VLAN40_GUEST<a href=#interface-vlan40_guest class=post-heading__anchor aria-hidden=true>#</a></h4><table><thead><tr><th></th><th></th></tr></thead><tbody><tr><td>Enable Interface</td><td><code>checked</code></td></tr><tr><td>IPv4 Configuration Type</td><td><code>Static IPv4</code></td></tr><tr><td>IPv4 Address</td><td><code>192.168.40.1/24</code></td></tr></tbody></table><h3 id=vlan-interface-dhcp>VLAN Interface DHCP<a href=#vlan-interface-dhcp class=post-heading__anchor aria-hidden=true>#</a></h3><p>We need to configure DHCP for each VLAN we created. I use <code>x.x.x.100-199</code> for
dynamic and <code>x.x.x.10.10-99</code> for static IP address assignments. You might want
to amend these ranges to your requirements.</p><p><picture><source type=image/webp srcset="/blog/opnsense-baseline-guide-with-vpn-guest-and-vlan-support/interface-dhcp-config_hu17199391607601813911.webp 300w,/blog/opnsense-baseline-guide-with-vpn-guest-and-vlan-support/interface-dhcp-config_hu18216627069745243483.webp 500w,/blog/opnsense-baseline-guide-with-vpn-guest-and-vlan-support/interface-dhcp-config_hu3115405311125749810.webp 665w" sizes="(max-width: 499px) 300px,(max-width: 699px) 500px,665px"><img src=/blog/opnsense-baseline-guide-with-vpn-guest-and-vlan-support/interface-dhcp-config.png srcset="/blog/opnsense-baseline-guide-with-vpn-guest-and-vlan-support/interface-dhcp-config_hu7861584565697952256.png 300w,/blog/opnsense-baseline-guide-with-vpn-guest-and-vlan-support/interface-dhcp-config_hu18417407654517410583.png 500w,/blog/opnsense-baseline-guide-with-vpn-guest-and-vlan-support/interface-dhcp-config_hu9842725462719007647.png 665w" sizes="(max-width: 499px) 300px,(max-width: 699px) 500px,665px" alt="Screenshot of VLAN interface DHCP configuration" loading=lazy width=665 height=352></picture></p><p>Navigate to <strong>Services</strong><span> → </span><strong>DHCPv4</strong>.</p><h4 id=dhcp-vlan10_manage>DHCP: VLAN10_MANAGE<a href=#dhcp-vlan10_manage class=post-heading__anchor aria-hidden=true>#</a></h4><p>Select <code>VLAN10_MANAGE</code>.</p><table><thead><tr><th></th><th></th></tr></thead><tbody><tr><td>Enable</td><td><code>checked</code></td></tr><tr><td>Range</td><td>from <code>192.168.10.100</code> to <code>192.168.10.199</code></td></tr></tbody></table><p>Click <code>Save</code>.</p><h4 id=dhcp-vlan20_vpn>DHCP: VLAN20_VPN<a href=#dhcp-vlan20_vpn class=post-heading__anchor aria-hidden=true>#</a></h4><table><thead><tr><th></th><th></th></tr></thead><tbody><tr><td>Enable</td><td><code>checked</code></td></tr><tr><td>Range</td><td>from <code>192.168.20.100</code> to <code>192.168.20.199</code></td></tr></tbody></table><h4 id=dhcp-vlan30_clear>DHCP: VLAN30_CLEAR<a href=#dhcp-vlan30_clear class=post-heading__anchor aria-hidden=true>#</a></h4><table><thead><tr><th></th><th></th></tr></thead><tbody><tr><td>Enable</td><td><code>checked</code></td></tr><tr><td>Range</td><td>from <code>192.168.30.100</code> to <code>192.168.30.199</code></td></tr></tbody></table><h4 id=dhcp-vlan40_guest>DHCP: VLAN40_GUEST<a href=#dhcp-vlan40_guest class=post-heading__anchor aria-hidden=true>#</a></h4><table><thead><tr><th></th><th></th></tr></thead><tbody><tr><td>Enable</td><td><code>checked</code></td></tr><tr><td>Range</td><td>from <code>192.168.40.100</code> to <code>192.168.40.199</code></td></tr><tr><td>DNS servers</td><td><code>1.1.1.1</code> <code>1.0.0.1</code></td></tr></tbody></table><h4 id=dhcp-lan>DHCP: LAN<a href=#dhcp-lan class=post-heading__anchor aria-hidden=true>#</a></h4><table><thead><tr><th></th><th></th></tr></thead><tbody><tr><td>Range</td><td>from <code>192.168.1.100</code> to <code>192.168.1.199</code></td></tr></tbody></table><h2 id=wireguard-vpn-with-mullvad>WireGuard VPN with Mullvad<a href=#wireguard-vpn-with-mullvad class=post-heading__anchor aria-hidden=true>#</a></h2><p>In recent years, <a href=https://mullvad.net/ class=link--external target=_blank rel=noreferrer>Mullvad</a> has been my VPN provider of
choice. When <em>That One Privacy Site</em> was still a thing, Mullvad was one of the
top recommendations there. After reading the review, I decided to try it out and
haven&rsquo;t looked back since. No personally identifiable information is required to
register, and paying cash via mail works perfectly.</p><p>I decided to go with <a href=https://www.wireguard.com/ class=link--external target=_blank rel=noreferrer>WireGuard</a> because I&rsquo;m fine
riding the bleeding edge. 😎 For more detailed steps, check the official
OPNsense documentation on setting up
<a href=https://docs.opnsense.org/manual/how-tos/wireguard-client-mullvad.html class=link--external target=_blank rel=noreferrer>WireGuard with Mullvad</a>
and
<a href=https://docs.opnsense.org/manual/how-tos/wireguard-selective-routing.html class=link--external target=_blank rel=noreferrer>WireGuard selective routing</a>.</p><p>Please note that the FreeBSD kernel does not (yet) natively support WireGuard,
so you must install it as a plugin. Possibly, this doesn&rsquo;t meet your stability,
security, or performance requirements.</p><p>Navigate to <strong>System</strong><span> → </span><strong>Firmware</strong><span> → </span><strong>Plugins</strong> and install
<code>os-wireguard</code>. Refresh the browser and navigate to
<strong>VPN</strong><span> → </span><strong>WireGuard</strong>.</p><h3 id=remote-peers>Remote Peers<a href=#remote-peers class=post-heading__anchor aria-hidden=true>#</a></h3><p>Select your preferred WireGuard servers from the
<a href=https://mullvad.net/en/servers/ class=link--external target=_blank rel=noreferrer>Mullvad&rsquo;s server list</a> and take note of their
names and public keys. It&rsquo;s worth spending some time to benchmark server
performance before making a choice.</p><p><picture><source type=image/webp srcset="/blog/opnsense-baseline-guide-with-vpn-guest-and-vlan-support/wireguard-remote-peers_hu12614653661981356977.webp 300w,/blog/opnsense-baseline-guide-with-vpn-guest-and-vlan-support/wireguard-remote-peers_hu7734729403477589302.webp 500w,/blog/opnsense-baseline-guide-with-vpn-guest-and-vlan-support/wireguard-remote-peers_hu10316078869161330607.webp 643w" sizes="(max-width: 499px) 300px,(max-width: 699px) 500px,643px"><img src=/blog/opnsense-baseline-guide-with-vpn-guest-and-vlan-support/wireguard-remote-peers.png srcset="/blog/opnsense-baseline-guide-with-vpn-guest-and-vlan-support/wireguard-remote-peers_hu16407530846241225150.png 300w,/blog/opnsense-baseline-guide-with-vpn-guest-and-vlan-support/wireguard-remote-peers_hu8340791248152497954.png 500w,/blog/opnsense-baseline-guide-with-vpn-guest-and-vlan-support/wireguard-remote-peers_hu2323456450340215645.png 643w" sizes="(max-width: 499px) 300px,(max-width: 699px) 500px,643px" alt="Screenshot of WireGuard Endpoint configurations" loading=lazy width=643 height=119></picture></p><p>Select the <strong>Endpoints</strong> tab and click <strong>Add</strong>. Here is the configuration for
the remote <code>ch5-wireguard</code> Mullvad endpoint.</p><table><thead><tr><th></th><th></th></tr></thead><tbody><tr><td>Name</td><td><code>mullvad-ch5-wireguard</code></td></tr><tr><td>Public Key</td><td><code>/iivwlyqWqxQ0BVWmJRhcXIFdJeo0WbHQ/hZwuXaN3g=</code></td></tr><tr><td>Allowed IPs</td><td><code>0.0.0.0/0</code></td></tr><tr><td>Endpoint Address</td><td><code>193.32.127.66</code></td></tr><tr><td>Endpoint Port</td><td><code>51820</code></td></tr><tr><td>Keepalive</td><td><code>25</code></td></tr></tbody></table><p>To mitigate risks against DNS poisoning, resolve the server&rsquo;s hostname and enter
its IP as <strong>Endpoint Address</strong>. You can do this by running
<code>nslookup ch5-wireguard.mullvad.net</code> in a shell. Make sure to not confuse this
address with the SOCKS5 Proxy Address from Mullvad&rsquo;s server list!</p><p>Repeat the steps above to add another server, e.g., <code>ch6-wireguard</code>. Note that
all endpoint configurations use the <strong>Endpoint Port</strong> <code>51820</code>.</p><h3 id=local-peers>Local Peers<a href=#local-peers class=post-heading__anchor aria-hidden=true>#</a></h3><p>Select the <strong>Local</strong> tab, click <code>Add</code>, and enable the <code>advanced mode</code>.</p><table><thead><tr><th></th><th></th></tr></thead><tbody><tr><td>Name</td><td><code>mullvad0</code></td></tr><tr><td>Listen Port</td><td><code>51820</code></td></tr><tr><td>Tunnel Address</td><td><code>&lt;LEAVE EMPTY></code></td></tr><tr><td>Peers</td><td><code>ch5-wireguard</code></td></tr><tr><td>Disable Routes</td><td><code>checked</code></td></tr><tr><td>Gateway</td><td><code>&lt;LEAVE EMPTY></code></td></tr></tbody></table><p>Click <code>Save</code> to generate the WireGuard key pair. Click <code>Edit</code> and copy the
generated <strong>Public Key</strong>.</p><p>Next, run the following shell command to get a Mullvad access token:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>access_token<span style=color:#f92672>=</span><span style=color:#66d9ef>$(</span> <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>  curl -X <span style=color:#e6db74>&#39;POST&#39;</span> <span style=color:#e6db74>&#39;https://api.mullvad.net/auth/v1/token&#39;</span> <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>    -H <span style=color:#e6db74>&#39;accept: application/json&#39;</span> -H <span style=color:#e6db74>&#39;content-type: application/json&#39;</span> <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>    -d <span style=color:#e6db74>&#39;{ &#34;account_number&#34;: &#34;YOUR MULLVAD ACCOUNT NUMBER&#34; }&#39;</span> <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>  | jq -r .access_token<span style=color:#66d9ef>)</span>
</span></span></code></pre></div><p>Then run the following command to create a <em>Mullvad Device</em> with DNS hijacking
disabled:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>curl -X POST https://api.mullvad.net/accounts/v1/devices <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>  -H <span style=color:#e6db74>&#34;Authorization: Bearer </span>$access_token<span style=color:#e6db74>&#34;</span> -H <span style=color:#e6db74>&#39;content-type: application/json&#39;</span> <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>  -d <span style=color:#e6db74>&#39;{&#34;pubkey&#34;:&#34;YOUR PUBLIC KEY&#34;,&#34;hijack_dns&#34;:false}&#39;</span>
</span></span></code></pre></div><p>I cover the snippet above and Mullvad&rsquo;s DNS hijacking in another post:
<a href=/posts/use-custom-dns-servers-with-mullvad-and-any-wireguard-client>Use Custom DNS Servers With Mullvad And Any WireGuard Client</a>.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-json data-lang=json><span style=display:flex><span>{
</span></span><span style=display:flex><span>  <span style=color:#f92672>&#34;id&#34;</span>: <span style=color:#e6db74>&#34;d8f07004-4559-4d19-b58b-985b257cd115&#34;</span>,
</span></span><span style=display:flex><span>  <span style=color:#f92672>&#34;name&#34;</span>: <span style=color:#e6db74>&#34;uptown insect&#34;</span>,
</span></span><span style=display:flex><span>  <span style=color:#f92672>&#34;pubkey&#34;</span>: <span style=color:#e6db74>&#34;ufO5jCni55uvioHM/eLBgyrrUMocEXsADPc2OvYhF3k=&#34;</span>,
</span></span><span style=display:flex><span>  <span style=color:#f92672>&#34;hijack_dns&#34;</span>: <span style=color:#66d9ef>false</span>,
</span></span><span style=display:flex><span>  <span style=color:#f92672>&#34;created&#34;</span>: <span style=color:#e6db74>&#34;2023-07-30T02:08:41+00:00&#34;</span>,
</span></span><span style=display:flex><span>  <span style=color:#f92672>&#34;ipv4_address&#34;</span>: <span style=color:#e6db74>&#34;10.138.30.139/32&#34;</span>,
</span></span><span style=display:flex><span>  <span style=color:#f92672>&#34;ipv6_address&#34;</span>: <span style=color:#e6db74>&#34;fc00:bbbb:bbbb:bb01:d:0:a:1e8b/128&#34;</span>,
</span></span><span style=display:flex><span>  <span style=color:#f92672>&#34;ports&#34;</span>: []
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>Copy the IPv4 IP address to the <strong>Tunnel Address</strong> field of the Wireguard local
peer. Subtract one from the <strong>Tunnel Address</strong> and enter the result as
<strong>Gateway</strong> IP. E.g., <code>10.105.248.50</code> for the example above. It&rsquo;s just a
convention I like, but you can use any arbitrary, unused
<a href=https://datatracker.ietf.org/doc/html/rfc1918 class=link--external target=_blank rel=noreferrer>private RFC1918 IP</a>.</p><p><picture><source type=image/webp srcset="/blog/opnsense-baseline-guide-with-vpn-guest-and-vlan-support/wireguard-local-peer_hu17142354455038761007.webp 300w,/blog/opnsense-baseline-guide-with-vpn-guest-and-vlan-support/wireguard-local-peer_hu3871139136687696316.webp 500w,/blog/opnsense-baseline-guide-with-vpn-guest-and-vlan-support/wireguard-local-peer_hu4530213798390182954.webp 550w" sizes="(max-width: 499px) 300px,(max-width: 699px) 500px,550px"><img src=/blog/opnsense-baseline-guide-with-vpn-guest-and-vlan-support/wireguard-local-peer.png srcset="/blog/opnsense-baseline-guide-with-vpn-guest-and-vlan-support/wireguard-local-peer_hu5949391160164136307.png 300w,/blog/opnsense-baseline-guide-with-vpn-guest-and-vlan-support/wireguard-local-peer_hu13277271925004524306.png 500w,/blog/opnsense-baseline-guide-with-vpn-guest-and-vlan-support/wireguard-local-peer_hu5600311680145611193.png 550w" sizes="(max-width: 499px) 300px,(max-width: 699px) 500px,550px" alt="Screenshot of WireGuard Local Peer configuration" loading=lazy width=550 height=602></picture></p><p>Repeat the steps above to create a second local peer named <code>mullvad1</code>. Remember
to use a <em>different</em> <strong>Listen Port</strong> (e.g., <code>51821</code>).</p><p><picture><source type=image/webp srcset="/blog/opnsense-baseline-guide-with-vpn-guest-and-vlan-support/wireguard-local-peers_hu10794901138390016399.webp 300w,/blog/opnsense-baseline-guide-with-vpn-guest-and-vlan-support/wireguard-local-peers_hu16712877435224530740.webp 500w,/blog/opnsense-baseline-guide-with-vpn-guest-and-vlan-support/wireguard-local-peers_hu3843022744201582299.webp 519w" sizes="(max-width: 499px) 300px,(max-width: 699px) 500px,519px"><img src=/blog/opnsense-baseline-guide-with-vpn-guest-and-vlan-support/wireguard-local-peers.png srcset="/blog/opnsense-baseline-guide-with-vpn-guest-and-vlan-support/wireguard-local-peers_hu2928383663380041168.png 300w,/blog/opnsense-baseline-guide-with-vpn-guest-and-vlan-support/wireguard-local-peers_hu16275047512865123158.png 500w,/blog/opnsense-baseline-guide-with-vpn-guest-and-vlan-support/wireguard-local-peers_hu18328937969346844858.png 519w" sizes="(max-width: 499px) 300px,(max-width: 699px) 500px,519px" alt="Screenshot of WireGuard Local Peer configurations" loading=lazy width=519 height=118></picture></p><p>When you finish, select the <code>General</code> tab. Check <strong>Enable WireGuard</strong>. You
should see a handshake for the <code>wg0</code> and <code>wg1</code> tunnels on the <strong>Handshakes</strong>
tab.</p><h3 id=wireguard-interfaces>WireGuard Interfaces<a href=#wireguard-interfaces class=post-heading__anchor aria-hidden=true>#</a></h3><p>Navigate to <strong>Interfaces</strong><span> → </span><strong>Assignments</strong>.</p><ul><li>Select <code>wg0</code>, add the description <code>WAN_VPN0</code>, and click <code>+</code></li><li>Select <code>wg1</code>, add the description <code>WAN_VPN1</code>, and click <code>+</code></li></ul><p>Enable the newly created interfaces and restart the WireGuard service after. It
ensures the interfaces get an IP address from WireGuard.</p><h3 id=vpn-gateways>VPN Gateways<a href=#vpn-gateways class=post-heading__anchor aria-hidden=true>#</a></h3><p><picture><source type=image/webp srcset="/blog/opnsense-baseline-guide-with-vpn-guest-and-vlan-support/gateway-config_hu3543527364840388984.webp 300w,/blog/opnsense-baseline-guide-with-vpn-guest-and-vlan-support/gateway-config_hu7091776508405490021.webp 500w,/blog/opnsense-baseline-guide-with-vpn-guest-and-vlan-support/gateway-config_hu11718750719297987304.webp 700w" sizes="(max-width: 499px) 300px,(max-width: 699px) 500px,700px"><img src=/blog/opnsense-baseline-guide-with-vpn-guest-and-vlan-support/gateway-config.png srcset="/blog/opnsense-baseline-guide-with-vpn-guest-and-vlan-support/gateway-config_hu409717190721450523.png 300w,/blog/opnsense-baseline-guide-with-vpn-guest-and-vlan-support/gateway-config_hu11307546465512424515.png 500w,/blog/opnsense-baseline-guide-with-vpn-guest-and-vlan-support/gateway-config_hu5642760267143311905.png 700w" sizes="(max-width: 499px) 300px,(max-width: 699px) 500px,700px" alt="Screenshot of gateway configuration overview" loading=lazy width=705 height=257></picture></p><p>Navigate to <strong>System</strong><span> → </span><strong>Gateways</strong><span> → </span><strong>Single</strong> and add the VPN
gateways.</p><h4 id=wan_vpn0>WAN_VPN0<a href=#wan_vpn0 class=post-heading__anchor aria-hidden=true>#</a></h4><table><thead><tr><th></th><th></th></tr></thead><tbody><tr><td>Name</td><td><code>WAN_VPN0</code></td></tr><tr><td>Interface</td><td><code>WAN_VPN0</code></td></tr><tr><td>Address Family</td><td><code>IPv4</code></td></tr><tr><td>IP Address</td><td><code>10.105.248.50</code></td></tr><tr><td>Far Gateway</td><td><code>checked</code></td></tr><tr><td>Disable Gateway Monitoring</td><td><code>unchecked</code></td></tr><tr><td>Monitor IP</td><td><code>100.64.0.1</code></td></tr></tbody></table><h4 id=wan_vpn1>WAN_VPN1<a href=#wan_vpn1 class=post-heading__anchor aria-hidden=true>#</a></h4><table><thead><tr><th></th><th></th></tr></thead><tbody><tr><td>Name</td><td><code>WAN_VPN1</code></td></tr><tr><td>Interface</td><td><code>WAN_VPN1</code></td></tr><tr><td>Address Family</td><td><code>IPv4</code></td></tr><tr><td>IP Address</td><td><code>10.109.231.89</code></td></tr><tr><td>Far Gateway</td><td><code>checked</code></td></tr><tr><td>Disable Gateway Monitoring</td><td><code>unchecked</code></td></tr><tr><td>Monitor IP</td><td><code>100.64.0.2</code></td></tr></tbody></table><h4 id=monitoring-ips>Monitoring IPs<a href=#monitoring-ips class=post-heading__anchor aria-hidden=true>#</a></h4><p>Each VPN gateway requires a unique monitoring IP because setting a monitoring IP
installs a static route. Optimally, the monitoring IP should be the least
possible amount of hops away from the gateway. For Mullvad specifically, we can
&ldquo;abuse&rdquo; the local infrastructure that&rsquo;s available through a Mullvad connection.
Any of the following IPs are only <em>one</em> hop away from the tunnel exit.</p><ul><li><code>100.64.0.1</code> to <code>100.64.0.3</code> are
<a href=https://mullvad.net/it/blog/2021/5/27/how-set-ad-blocking-our-app/ class=link--external target=_blank rel=noreferrer>Mullvad&rsquo;s ad-blocking and tracker-blocking DNS service servers</a></li><li><code>10.64.0.1</code> is the local Mullvad gateway</li></ul><p>You can easily verify the above by running <code>traceroute 100.64.0.1</code> from a host
connected to Mullvad.</p><h4 id=add-static-ipv4-configuration-to-the-wireguard-interfaces>Add Static IPv4 Configuration to the WireGuard Interfaces<a href=#add-static-ipv4-configuration-to-the-wireguard-interfaces class=post-heading__anchor aria-hidden=true>#</a></h4><p>OPNsense versions newer than <code>21.7.3</code> require adding static IPv4 configuration
to the WireGuard interface. Otherwise, Unbound will use the default route
despite setting the <strong>Outgoing Network Interfaces</strong> option. Other solutions
exist, but I&rsquo;m not sure which the &ldquo;best&rdquo; or most logical one is. As WireGuard
integration matures, this section hopefully becomes obsolete.
<a href=https://github.com/opnsense/core/issues/5329#issuecomment-958397043 class=link--external target=_blank rel=noreferrer>You can find more information regarding this issue on GitHub</a>.</p><p>Navigate to <strong>Interfaces</strong> and edit the WireGuard interfaces.</p><h5 id=ip-configuration-wan_vpn0>IP Configuration: WAN_VPN0<a href=#ip-configuration-wan_vpn0 class=post-heading__anchor aria-hidden=true>#</a></h5><table><thead><tr><th></th><th></th></tr></thead><tbody><tr><td>IPv4 Configuration Type</td><td><code>Static IPv4</code></td></tr><tr><td>IPv4 address</td><td><code>10.105.248.51/32</code></td></tr><tr><td>IPv4 Upstream Gateway</td><td><code>WAN_VPN0 - 10.105.248.50</code></td></tr></tbody></table><h5 id=ip-configuration-wan_vpn1>IP Configuration: WAN_VPN1<a href=#ip-configuration-wan_vpn1 class=post-heading__anchor aria-hidden=true>#</a></h5><table><thead><tr><th></th><th></th></tr></thead><tbody><tr><td>IPv4 Configuration Type</td><td><code>Static IPv4</code></td></tr><tr><td>IPv4 address</td><td><code>10.109.231.90/32</code></td></tr><tr><td>IPv4 Upstream Gateway</td><td><code>WAN_VPN1 - 10.109.231.89</code></td></tr></tbody></table><h4 id=gateway-group>Gateway Group<a href=#gateway-group class=post-heading__anchor aria-hidden=true>#</a></h4><p>Navigate to <strong>System</strong><span> → </span><strong>Gateways</strong><span> → </span><strong>Group</strong> and click <code>Add</code>.</p><table><thead><tr><th></th><th></th></tr></thead><tbody><tr><td>Group Name</td><td><code>WAN_VPN_GROUP</code></td></tr><tr><td>WAN_VPN0</td><td><code>Tier 1</code></td></tr><tr><td>WAN_VPN1</td><td><code>Tier 2</code> (failover)</td></tr><tr><td>Trigger Level</td><td><code>Packet Loss or High Latency</code></td></tr></tbody></table><p>It&rsquo;s also possible to configure load balancing by putting multiple interfaces
into the same tier.</p><h3 id=static-routes-optional>Static Routes (Optional)<a href=#static-routes-optional class=post-heading__anchor aria-hidden=true>#</a></h3><p>Defining static routes for the tunnel gateways is optional. It would be
necessary, for example, if we want to consider the VPN gateways as default
gateway candidates. It requires static routes to the ISP WAN gateway to keep the
tunnel connections alive.</p><p><picture><source type=image/webp srcset="/blog/opnsense-baseline-guide-with-vpn-guest-and-vlan-support/static-routes-wireguard_hu16961764728582576121.webp 300w,/blog/opnsense-baseline-guide-with-vpn-guest-and-vlan-support/static-routes-wireguard_hu306872632999186738.webp 500w,/blog/opnsense-baseline-guide-with-vpn-guest-and-vlan-support/static-routes-wireguard_hu1493324395538439574.webp 567w" sizes="(max-width: 499px) 300px,(max-width: 699px) 500px,567px"><img src=/blog/opnsense-baseline-guide-with-vpn-guest-and-vlan-support/static-routes-wireguard.png srcset="/blog/opnsense-baseline-guide-with-vpn-guest-and-vlan-support/static-routes-wireguard_hu6087579888423261600.png 300w,/blog/opnsense-baseline-guide-with-vpn-guest-and-vlan-support/static-routes-wireguard_hu1617970682669724921.png 500w,/blog/opnsense-baseline-guide-with-vpn-guest-and-vlan-support/static-routes-wireguard_hu14037544304702179608.png 567w" sizes="(max-width: 499px) 300px,(max-width: 699px) 500px,567px" alt="Screenshot of the static routes for WireGuard tunnel" loading=lazy width=567 height=118></picture></p><p>Navigate to <strong>System</strong><span> → </span><strong>Routes</strong><span> → </span><strong>Configuration</strong> and click
<code>Add</code>.</p><table><thead><tr><th></th><th></th></tr></thead><tbody><tr><td>Network Address</td><td><code>193.32.127.66/32</code></td></tr><tr><td>Gateway</td><td><code>WAN_DHCP</code></td></tr><tr><td>Description</td><td><code>Keep tunnels to mullvad-ch5-wireguard alive</code></td></tr></tbody></table><table><thead><tr><th></th><th></th></tr></thead><tbody><tr><td>Network Address</td><td><code>193.32.127.67/32</code></td></tr><tr><td>Gateway</td><td><code>WAN_DHCP</code></td></tr><tr><td>Description</td><td><code>Keep tunnels to mullvad-ch6-wireguard alive</code></td></tr></tbody></table><h2 id=dns>DNS<a href=#dns class=post-heading__anchor aria-hidden=true>#</a></h2><p><picture><source type=image/webp srcset="/blog/opnsense-baseline-guide-with-vpn-guest-and-vlan-support/dns-architecture_hu4194192338990897252.webp 300w,/blog/opnsense-baseline-guide-with-vpn-guest-and-vlan-support/dns-architecture_hu13762071487405391502.webp 500w,/blog/opnsense-baseline-guide-with-vpn-guest-and-vlan-support/dns-architecture_hu7903502342611383226.webp 692w" sizes="(max-width: 499px) 300px,(max-width: 699px) 500px,692px"><img src=/blog/opnsense-baseline-guide-with-vpn-guest-and-vlan-support/dns-architecture.png srcset="/blog/opnsense-baseline-guide-with-vpn-guest-and-vlan-support/dns-architecture_hu3605552686603254055.png 300w,/blog/opnsense-baseline-guide-with-vpn-guest-and-vlan-support/dns-architecture_hu3523149272081177426.png 500w,/blog/opnsense-baseline-guide-with-vpn-guest-and-vlan-support/dns-architecture_hu1630943946289371231.png 692w" sizes="(max-width: 499px) 300px,(max-width: 699px) 500px,692px" alt="Diagram of DNS architecture" loading=lazy width=692 height=715></picture></p><p>OPNsense includes a DNS <em>resolver</em> (Unbound) and a DNS <em>forwarder</em> (Dnsmasq /
Unbound in forwarding mode). Simple setups usually use one of either, but we&rsquo;ll
use both. Because we&rsquo;ll also use Unbound and Dnsmasq for internal DNS
resolution, we don&rsquo;t want to use them for the Guest network, as this would
expose our internal network structure. That&rsquo;s the reason why we earlier
configured it to use Cloudflare DNS servers instead.</p><p>Like the name suggests, a DNS forwarder forwards DNS requests to an external DNS
resolver of an ISP, Quad9, Cloudflare, or similar service provider. We&rsquo;ll
configure the forwarder for the Clear network. In case the primary, secured
networks lose connectivity, the Clear network can serve as a backup.</p><p>One of the advantages of self-hosting a DNS resolver is improved privacy. A
resolver iteratively queries a chain of one or more DNS servers to resolve a
request, so there isn&rsquo;t a single instance knowing all your DNS requests. It
comes at the cost of speed when resolving a hostname for the first time. As
Unbound&rsquo;s cache grows, the cost diminishes. We&rsquo;ll configure our primary networks
to use Unbound.</p><p>We&rsquo;ll also keep DNS traffic from Unbound within the VPN tunnels. In the rare
case of a VPN outage, we&rsquo;ll want local DNS services to fail and not leak through
the ISP WAN. The reason for this isn&rsquo;t improved privacy as you might think. In
some cases, this might even hurt your privacy. Why? Either your ISP or your VPN
provider will see the iterative DNS requests Unbound sends. So it becomes a
question of who you rather entrust with this data. But if there are no privacy
benefits, why do it? Honestly, I don&rsquo;t require such a setup. I configured it for
educational purposes and fun. Other reasons that don&rsquo;t affect me but other users
are:</p><ul><li>ISP selling user data</li><li>ISP enforcing censorship</li><li>ISP hijacking DNS traffic to redirect it to their DNS resolver; this makes
self-hosting a DNS resolver impossible</li></ul><p>Let&rsquo;s summarize our goals:</p><ul><li>Use a DNS resolver for the management and VPN networks</li><li>Resolve private domain hostnames for management and VPN networks</li><li>Prevent DNS leaks from Unbound through the ISP WAN gateway</li><li>Use DNS forwarding for the Clear network</li><li>Use external DNS resolvers for the Guest network</li></ul><h3 id=resolver-unbound>Resolver (Unbound)<a href=#resolver-unbound class=post-heading__anchor aria-hidden=true>#</a></h3><p>Navigate to <strong>Services</strong><span> → </span><strong>Unbound DNS</strong><span> → </span><strong>General</strong>.</p><table><thead><tr><th></th><th></th></tr></thead><tbody><tr><td>Network Interfaces</td><td><code>LAN</code> <code>VLAN10_MANAGE</code> <code>VLAN20_VPN</code></td></tr><tr><td>DNSSEC</td><td><code>checked</code></td></tr><tr><td>DHCP registration</td><td><code>checked</code></td></tr><tr><td>DHCP static mappings</td><td><code>checked</code></td></tr><tr><td>Local Zone Type</td><td><code>static</code></td></tr><tr><td>Outgoing Network Interfaces</td><td><code>WAN_VPN0</code> <code>WAN_VPN1</code></td></tr></tbody></table><p>Navigate to <strong>Services</strong><span> → </span><strong>Unbound DNS</strong><span> → </span><strong>Advanced</strong>.</p><table><thead><tr><th></th><th></th></tr></thead><tbody><tr><td>Hide Identity</td><td><code>checked</code></td></tr><tr><td>Hide Version</td><td><code>checked</code></td></tr><tr><td>Prefetch Support</td><td><code>checked</code></td></tr><tr><td>Prefetch DNS Key Support</td><td><code>checked</code></td></tr><tr><td>Harden DNSSEC data</td><td><code>checked</code></td></tr></tbody></table><p>The final step is to add a custom
<a href=https://www.cloudflare.com/learning/dns/dns-records/dns-soa-record/ class=link--external target=_blank rel=noreferrer>SOA record</a>
to the local zone making Unbound the authoritative name server for
<code>corp.example.com</code>. This way, we prevent Unbound from querying external name
servers for the internal domain and exposing our network structure to the
outside world. For
<a href=https://docs.opnsense.org/manual/unbound.html#advanced-configurations class=link--external target=_blank rel=noreferrer>advanced Unbound configuration like this</a>,
we use
<a href=https://docs.opnsense.org/development/backend/templates.html class=link--external target=_blank rel=noreferrer>Templates</a>.</p><p>Connect to OPNsense via serial console or SSH and add a <code>+TARGETS</code> file by
running
<code>sudo vi /usr/local/opnsense/service/templates/OPNsense/Unbound/+TARGETS</code>
containing:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-text data-lang=text><span style=display:flex><span>private_domains.conf:/usr/local/etc/unbound.opnsense.d/private_domains.conf
</span></span></code></pre></div><p>Add the template file by running
<code>sudo vi /usr/local/opnsense/service/templates/OPNsense/Unbound/private_domains.conf</code>
containing:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-text data-lang=text><span style=display:flex><span>server:
</span></span><span style=display:flex><span>  local-data: &#34;corp.example.com. 3600 IN SOA opnsense.corp.example.com. root.example.com. 2021110201 86400 7200 3600000 3600&#34;
</span></span></code></pre></div><p>Here is a translation of what the SOA record means.</p><table><thead><tr><th></th><th></th></tr></thead><tbody><tr><td>Name</td><td><code>corp.example.com</code></td></tr><tr><td>Record Type</td><td><code>SOA</code></td></tr><tr><td>Primary Name Server</td><td><code>opnsense.corp.example.com</code></td></tr><tr><td>Administrator Email</td><td><code>root@example.com</code></td></tr><tr><td>Serial</td><td><code>2021110201</code> (YYMMDDnn)</td></tr><tr><td>Refresh</td><td><code>86400</code> (24 hours)</td></tr><tr><td>Retry</td><td><code>7200</code> (2 hours)</td></tr><tr><td>Expire</td><td><code>3600000</code> (1000 hours)</td></tr><tr><td>TTL</td><td><code>3600</code> (1 hour)</td></tr></tbody></table><p>Run the following to verify the configuration.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span><span style=color:#75715e># generate template</span>
</span></span><span style=display:flex><span>configctl template reload OPNsense/Unbound
</span></span><span style=display:flex><span><span style=color:#75715e># show generated file</span>
</span></span><span style=display:flex><span>cat /usr/local/etc/unbound.opnsense.d/private_domains.conf
</span></span><span style=display:flex><span><span style=color:#75715e># check if configuration is valid</span>
</span></span><span style=display:flex><span>configctl unbound check
</span></span></code></pre></div><h3 id=forwarder-dnsmasq>Forwarder (Dnsmasq)<a href=#forwarder-dnsmasq class=post-heading__anchor aria-hidden=true>#</a></h3><p>Dnsmasq will forward DNS requests to the configured system DNS servers and
<code>127.0.0.1</code> (Unbound). Earlier, you either explicitly configured them or decided
to receive the DNS servers via DHCP from your ISP. Because Unbound already uses
port 53, we&rsquo;ll use port 5335 for Dnsmasq. We&rsquo;ll later create rules to port
forward DNS traffic to this port.</p><p>Navigate to <strong>Services</strong><span> → </span><strong>Dnsmasq DNS</strong><span> → </span><strong>Settings</strong>.</p><table><thead><tr><th></th><th></th></tr></thead><tbody><tr><td>Enable</td><td><code>checked</code></td></tr><tr><td>Listen Port</td><td><code>5335</code></td></tr><tr><td>Do not forward private reverse lookups</td><td><code>checked</code></td></tr></tbody></table><p>Forward reverse DNS lookups in the <code>192.168.0.0/16</code> range to Unbound by adding
the following <strong>Domain Override</strong>s. We additionally make Unbound the
authoritative DNS server for <code>corp.example.com</code>.</p><table><thead><tr><th>Domain</th><th>IP</th><th>Description</th></tr></thead><tbody><tr><td><code>168.192.in-addr.arpa</code></td><td><code>192.168.20.1</code></td><td>Forward reverse lookups of private IP addresses to Unbound</td></tr><tr><td><code>corp.example.com</code></td><td><code>192.168.20.1</code></td><td>Make Unbound the authoritative DNS server for private domain</td></tr></tbody></table><h2 id=firewall>Firewall<a href=#firewall class=post-heading__anchor aria-hidden=true>#</a></h2><p>Here is an overview of what we want to implement with firewall rules.</p><ul><li>Allow internet access for specific ports through WAN and VPN</li><li>Allow intranet communications</li><li>Redirect outbound DNS traffic to either Unbound or Dnsmasq</li><li>Redirect NTP traffic to OPNsense</li><li>Block intranet access for the Guest network</li></ul><table><thead><tr><th></th><th>VLAN10</th><th>VLAN20</th><th>VLAN30</th><th>VLAN40</th><th>LAN</th></tr></thead><tbody><tr><td><strong>Internet</strong></td><td>WAN</td><td>VPN + selective WAN</td><td>WAN</td><td>WAN</td><td>WAN</td></tr><tr><td><strong>Intranet</strong></td><td>pass</td><td>pass</td><td>pass</td><td>block</td><td>pass</td></tr><tr><td><strong>ICMP</strong></td><td>pass</td><td>pass</td><td>pass</td><td>pass</td><td>pass</td></tr><tr><td><strong>Anti-lockout</strong></td><td>yes</td><td>no</td><td>no</td><td>no</td><td>yes</td></tr><tr><td><strong>DNS</strong></td><td>Unbound</td><td>Unbound</td><td>Dnsmasq</td><td>external</td><td>Unbound</td></tr><tr><td><strong>NTP</strong></td><td>local</td><td>local</td><td>local</td><td>external</td><td>external</td></tr></tbody></table><h3 id=interface-groups>Interface Groups<a href=#interface-groups class=post-heading__anchor aria-hidden=true>#</a></h3><p>We use <a href=https://docs.opnsense.org/manual/firewall_groups.html class=link--external target=_blank rel=noreferrer>interface groups</a>
to apply policies to multiple interfaces at once and reduce the number of
required firewall rules significantly. Do not use them for WAN interfaces
because they don&rsquo;t use the <code>reply-to</code> directive!</p><p>I&rsquo;m honestly not sure if I went overboard with interface groups and
over-abstracted things. Currently, I&rsquo;m happy with the configuration, and I guess
only time will tell how maintainable this approach is. I&rsquo;d like to know what you
think and would very much appreciate your feedback.</p><p><picture><source type=image/webp srcset="/blog/opnsense-baseline-guide-with-vpn-guest-and-vlan-support/firewall-interface-groups_hu18249302474029087024.webp 300w,/blog/opnsense-baseline-guide-with-vpn-guest-and-vlan-support/firewall-interface-groups_hu15322232253296304975.webp 500w,/blog/opnsense-baseline-guide-with-vpn-guest-and-vlan-support/firewall-interface-groups_hu7849132953261074213.webp 560w" sizes="(max-width: 499px) 300px,(max-width: 699px) 500px,560px"><img src=/blog/opnsense-baseline-guide-with-vpn-guest-and-vlan-support/firewall-interface-groups.png srcset="/blog/opnsense-baseline-guide-with-vpn-guest-and-vlan-support/firewall-interface-groups_hu9639480117550241297.png 300w,/blog/opnsense-baseline-guide-with-vpn-guest-and-vlan-support/firewall-interface-groups_hu1154982027683193334.png 500w,/blog/opnsense-baseline-guide-with-vpn-guest-and-vlan-support/firewall-interface-groups_hu2884262383281092720.png 560w" sizes="(max-width: 499px) 300px,(max-width: 699px) 500px,560px" alt="Screenshot of firewall interface groups" loading=lazy width=560 height=444></picture></p><p>Navigate to <strong>Firewall</strong><span> → </span><strong>Groups</strong> and add the following
interface groups.</p><h4 id=ig_local>IG_LOCAL<a href=#ig_local class=post-heading__anchor aria-hidden=true>#</a></h4><table><thead><tr><th></th><th></th></tr></thead><tbody><tr><td>Name</td><td><code>IG_LOCAL</code></td></tr><tr><td>Description</td><td><code>All local interfaces</code></td></tr><tr><td>Members</td><td><code>LAN</code> <code>VLAN10_MANAGE</code> <code>VLAN20_VPN</code> <code>VLAN30_CLEAR</code> <code>VLAN40_GUEST</code></td></tr></tbody></table><h4 id=ig_out_wan>IG_OUT_WAN<a href=#ig_out_wan class=post-heading__anchor aria-hidden=true>#</a></h4><table><thead><tr><th></th><th></th></tr></thead><tbody><tr><td>Name</td><td><code>IG_OUT_WAN</code></td></tr><tr><td>Description</td><td><code>Interfaces allowing outbound WAN traffic</code></td></tr><tr><td>Members</td><td><code>LAN</code> <code>VLAN10_MANAGE</code> <code>VLAN30_CLEAR</code> <code>VLAN40_GUEST</code></td></tr></tbody></table><h4 id=ig_out_vpn>IG_OUT_VPN<a href=#ig_out_vpn class=post-heading__anchor aria-hidden=true>#</a></h4><table><thead><tr><th></th><th></th></tr></thead><tbody><tr><td>Name</td><td><code>IG_OUT_VPN</code></td></tr><tr><td>Description</td><td><code>Interfaces allowing outbound VPN traffic and selective outbound WAN traffic</code></td></tr><tr><td>Members</td><td><code>VLAN20_VPN</code></td></tr></tbody></table><h4 id=ig_dns_resolve>IG_DNS_RESOLVE<a href=#ig_dns_resolve class=post-heading__anchor aria-hidden=true>#</a></h4><table><thead><tr><th></th><th></th></tr></thead><tbody><tr><td>Name</td><td><code>IG_DNS_RESOLVE</code></td></tr><tr><td>Description</td><td><code>Interfaces forced to use Unbound</code></td></tr><tr><td>Members</td><td><code>VLAN10_MANAGE</code> <code>VLAN20_VPN</code></td></tr></tbody></table><h4 id=ig_dns_forward>IG_DNS_FORWARD<a href=#ig_dns_forward class=post-heading__anchor aria-hidden=true>#</a></h4><table><thead><tr><th></th><th></th></tr></thead><tbody><tr><td>Name</td><td><code>IG_DNS_FORWARD</code></td></tr><tr><td>Description</td><td><code>Interfaces forced to use Dnsmasq</code></td></tr><tr><td>Members</td><td><code>VLAN30_CLEAR</code></td></tr></tbody></table><h4 id=ig_ntp>IG_NTP<a href=#ig_ntp class=post-heading__anchor aria-hidden=true>#</a></h4><table><thead><tr><th></th><th></th></tr></thead><tbody><tr><td>Name</td><td><code>IG_NTP</code></td></tr><tr><td>Description</td><td><code>Interfaces forced to use OPNsense as NTP server</code></td></tr><tr><td>Members</td><td><code>VLAN10_MANAGE</code> <code>VLAN20_VPN</code> <code>VLAN30_CLEAR</code></td></tr></tbody></table><h3 id=aliases>Aliases<a href=#aliases class=post-heading__anchor aria-hidden=true>#</a></h3><p>We define a few reusable
<a href=https://docs.opnsense.org/manual/aliases.html class=link--external target=_blank rel=noreferrer>aliases</a> that help us condense
our firewall rules. Some of them might become hard to maintain as they grow, in
which case you might want to consider nesting aliases.</p><p><picture><source type=image/webp srcset="/blog/opnsense-baseline-guide-with-vpn-guest-and-vlan-support/firewall-aliases_hu877051440071277116.webp 300w,/blog/opnsense-baseline-guide-with-vpn-guest-and-vlan-support/firewall-aliases_hu13788729576948839068.webp 500w,/blog/opnsense-baseline-guide-with-vpn-guest-and-vlan-support/firewall-aliases_hu18190502594560286230.webp 700w" sizes="(max-width: 499px) 300px,(max-width: 699px) 500px,700px"><img src=/blog/opnsense-baseline-guide-with-vpn-guest-and-vlan-support/firewall-aliases.png srcset="/blog/opnsense-baseline-guide-with-vpn-guest-and-vlan-support/firewall-aliases_hu16195183110910344772.png 300w,/blog/opnsense-baseline-guide-with-vpn-guest-and-vlan-support/firewall-aliases_hu14603543163885478638.png 500w,/blog/opnsense-baseline-guide-with-vpn-guest-and-vlan-support/firewall-aliases_hu2502383909614706229.png 700w" sizes="(max-width: 499px) 300px,(max-width: 699px) 500px,700px" alt="Screenshot of firewall aliases" loading=lazy width=814 height=163></picture></p><p>Navigate to <strong>Firewall</strong><span> → </span><strong>Aliases</strong> and create the following
aliases.</p><h4 id=selective-routing-addresses>Selective Routing Addresses<a href=#selective-routing-addresses class=post-heading__anchor aria-hidden=true>#</a></h4><p>Services like banks might object to traffic originating from known VPN
endpoints. We selectively route traffic from the VPN VLAN through the default
WAN gateway.</p><table><thead><tr><th></th><th></th></tr></thead><tbody><tr><td>Name</td><td><code>SELECTIVE_ROUTING</code></td></tr><tr><td>Type</td><td><code>Host(s)</code></td></tr><tr><td>Description</td><td><code>External hosts reachable from IG_OUT_VPN networks through WAN</code></td></tr></tbody></table><p>If you&rsquo;re having issues with a service not working due to VPN, add the hostname
to this alias, e.g., <code>netflix.com</code>.</p><h4 id=admin--anti-lockout-ports>Admin / Anti-lockout Ports<a href=#admin--anti-lockout-ports class=post-heading__anchor aria-hidden=true>#</a></h4><table><thead><tr><th></th><th></th></tr></thead><tbody><tr><td>Name</td><td><code>PORTS_ANTI_LOCKOUT</code></td></tr><tr><td>Type</td><td><code>Port(s)</code></td></tr><tr><td>Content</td><td><code>443</code> (Web GUI) <code>22</code> (SSH)</td></tr><tr><td>Description</td><td><code>OPNsense admin ports</code></td></tr></tbody></table><h4 id=ports-allowed-to-communicate-between-vlans>Ports Allowed To Communicate Between VLANs<a href=#ports-allowed-to-communicate-between-vlans class=post-heading__anchor aria-hidden=true>#</a></h4><p>Allowed ports for intranet traffic. Amend the list depending on your needs.</p><table><thead><tr><th></th><th></th></tr></thead><tbody><tr><td>Name</td><td><code>PORTS_OUT_LAN</code></td></tr><tr><td>Type</td><td><code>Port(s)</code></td></tr><tr><td>Description</td><td><code>Ports allowed for intranet</code></td></tr></tbody></table><p>Content:</p><ul><li><code>53</code> DNS</li><li><code>5353:5354</code> mDNS</li><li><code>123</code> NTP</li><li><code>21</code> FTP</li><li><code>22</code> SSH</li><li><code>161</code> SNMP</li><li><code>80</code> HTTP</li><li><code>8080</code>: HTTP alt / UniFi device and application communication</li><li><code>443</code> HTTPS</li><li><code>8443</code> HTTPS alt / UniFi application GUI/API as seen in a web browser</li><li><code>8880</code> UniFi HTTP portal redirection</li><li><code>10001</code> UniFi device discovery</li><li><code>5001</code> iPerf</li><li><code>623</code> IPMI</li><li><code>5900</code> VNC</li><li><code>3389</code> RDP</li><li><code>49152:65535</code> ephemeral ports</li></ul><h4 id=ports-allowed-to-communicate-with-the-internet>Ports Allowed to Communicate with the Internet<a href=#ports-allowed-to-communicate-with-the-internet class=post-heading__anchor aria-hidden=true>#</a></h4><p>Allow ports for <em>egress</em> internet traffic. Amend the list depending on your
needs.</p><table><thead><tr><th></th><th></th></tr></thead><tbody><tr><td>Name</td><td><code>PORTS_OUT_WAN</code></td></tr><tr><td>Type</td><td><code>Port(s)</code></td></tr><tr><td>Description</td><td><code>Ports allowed for internet</code></td></tr></tbody></table><p>Content:</p><ul><li><code>21</code> FTP</li><li><code>22</code> SSH</li><li><code>80</code> HTTP</li><li><code>8080</code> HTTP alt</li><li><code>443</code> HTTPS</li><li><code>8443</code> HTTPS alt</li><li><code>465</code> SMTPS</li><li><code>587</code>: SMTPS</li><li><code>993</code>: IMAPS</li><li><code>49152:65535</code> ephemeral ports</li></ul><h5 id=a-fair-warning-about-egress-filtering>A Fair Warning about Egress Filtering<a href=#a-fair-warning-about-egress-filtering class=post-heading__anchor aria-hidden=true>#</a></h5><p>As you add applications, you will be constantly amending the <code>PORTS_OUT_WAN</code>
list. Depending on the application, the required ports may be poorly documented,
so you&rsquo;ll have to figure them out by inspecting the firewall logs. As other
users have mentioned in the comments, blocking all egress traffic for all VLANs
by default is probably not worth the hassle. Personally, I&rsquo;ve given up on egress
filtering altogether because of the administrative overhead that comes with it.</p><p>It is useful for high-security VLANs connecting devices such as cash registers
in a retail store. Another example is VLANs with many untrusted IoT devices that
have noisy telemetry. Putting them into a VLAN with egress filtering prevents
them from &ldquo;calling home&rdquo;.</p><p>If you create the alias <code>ALL_PORTS</code> = <code>1:65535</code> and add it to the <strong>Content</strong>
field of the <code>PORTS_OUT_WAN</code> alias, you can disable all egress filtering with
the option of re-enabling it again later.</p><h3 id=nat>NAT<a href=#nat class=post-heading__anchor aria-hidden=true>#</a></h3><p>Network Address Translation (NAT) is required to translate private to public IP
addresses. We have the following requirements.</p><ul><li>Translate <code>IG_OUT_WAN</code> and <code>IG_OUT_VPN</code> network addresses to the <code>WAN</code> address
range. Translating <code>IG_OUT_VPN</code> to <code>WAN</code> allows selective routing.</li><li>Translate <code>IG_OUT_VPN</code> network addresses to the <code>WAN_VPN0</code> address range.</li></ul><p><picture><source type=image/webp srcset="/blog/opnsense-baseline-guide-with-vpn-guest-and-vlan-support/firewall-nat_hu1739250115130585636.webp 300w,/blog/opnsense-baseline-guide-with-vpn-guest-and-vlan-support/firewall-nat_hu9981369897622508793.webp 500w,/blog/opnsense-baseline-guide-with-vpn-guest-and-vlan-support/firewall-nat_hu1562283413683029892.webp 608w" sizes="(max-width: 499px) 300px,(max-width: 699px) 500px,608px"><img src=/blog/opnsense-baseline-guide-with-vpn-guest-and-vlan-support/firewall-nat.png srcset="/blog/opnsense-baseline-guide-with-vpn-guest-and-vlan-support/firewall-nat_hu3276736432854881025.png 300w,/blog/opnsense-baseline-guide-with-vpn-guest-and-vlan-support/firewall-nat_hu15743663243355395384.png 500w,/blog/opnsense-baseline-guide-with-vpn-guest-and-vlan-support/firewall-nat_hu16590878528245230044.png 608w" sizes="(max-width: 499px) 300px,(max-width: 699px) 500px,608px" alt="Screenshot of NAT rules overview" loading=lazy width=608 height=267></picture></p><p>Navigate to <strong>Firewall</strong><span> → </span><strong>NAT</strong><span> → </span><strong>Outbound</strong>.</p><p>Select <code>Manual outbound NAT rule generation</code> and add the following rules.</p><h4 id=ig_out_wan-to-wan>IG_OUT_WAN to WAN<a href=#ig_out_wan-to-wan class=post-heading__anchor aria-hidden=true>#</a></h4><table><thead><tr><th></th><th></th></tr></thead><tbody><tr><td>Interface</td><td><code>WAN</code></td></tr><tr><td>Source address</td><td><code>IG_OUT_WAN net</code></td></tr><tr><td>Description</td><td><code>IG_OUT_WAN to WAN</code></td></tr></tbody></table><h4 id=ig_out_vpn-to-wan>IG_OUT_VPN to WAN<a href=#ig_out_vpn-to-wan class=post-heading__anchor aria-hidden=true>#</a></h4><table><thead><tr><th></th><th></th></tr></thead><tbody><tr><td>Interface</td><td><code>WAN</code></td></tr><tr><td>Source address</td><td><code>IG_OUT_VPN net</code></td></tr><tr><td>Description</td><td><code>IG_OUT_VPN to WAN</code></td></tr></tbody></table><h4 id=ig_out_vpn-to-wan_vpn0>IG_OUT_VPN to WAN_VPN0<a href=#ig_out_vpn-to-wan_vpn0 class=post-heading__anchor aria-hidden=true>#</a></h4><table><thead><tr><th></th><th></th></tr></thead><tbody><tr><td>Interface</td><td><code>WAN_VPN0</code></td></tr><tr><td>Source address</td><td><code>IG_OUT_VPN net</code></td></tr><tr><td>Description</td><td><code>IG_OUT_VPN to WAN_VPN0</code></td></tr></tbody></table><h4 id=ig_out_vpn-to-wan_vpn1>IG_OUT_VPN to WAN_VPN1<a href=#ig_out_vpn-to-wan_vpn1 class=post-heading__anchor aria-hidden=true>#</a></h4><table><thead><tr><th></th><th></th></tr></thead><tbody><tr><td>Interface</td><td><code>WAN_VPN1</code></td></tr><tr><td>Source address</td><td><code>IG_OUT_VPN net</code></td></tr><tr><td>Description</td><td><code>IG_OUT_VPN to WAN_VPN1</code></td></tr></tbody></table><h3 id=rules>Rules<a href=#rules class=post-heading__anchor aria-hidden=true>#</a></h3><p>Navigate to <strong>Firewall</strong><span> → </span><strong>Rules</strong>.</p><h4 id=anti-lockout>Anti-Lockout<a href=#anti-lockout class=post-heading__anchor aria-hidden=true>#</a></h4><p>Before adding any other rules, we add the anti-lockout ones on the
<code>VLAN10_MANAGE</code> and <code>LAN</code> networks, so we can&rsquo;t lock ourselves out. 😅</p><p><picture><source type=image/webp srcset="/blog/opnsense-baseline-guide-with-vpn-guest-and-vlan-support/firewall-rules-anti-lockout_hu12018300564656982779.webp 300w,/blog/opnsense-baseline-guide-with-vpn-guest-and-vlan-support/firewall-rules-anti-lockout_hu8628339998960368668.webp 500w,/blog/opnsense-baseline-guide-with-vpn-guest-and-vlan-support/firewall-rules-anti-lockout_hu647703468102348016.webp 640w" sizes="(max-width: 499px) 300px,(max-width: 699px) 500px,640px"><img src=/blog/opnsense-baseline-guide-with-vpn-guest-and-vlan-support/firewall-rules-anti-lockout.png srcset="/blog/opnsense-baseline-guide-with-vpn-guest-and-vlan-support/firewall-rules-anti-lockout_hu1683910954414116722.png 300w,/blog/opnsense-baseline-guide-with-vpn-guest-and-vlan-support/firewall-rules-anti-lockout_hu17671957551069903044.png 500w,/blog/opnsense-baseline-guide-with-vpn-guest-and-vlan-support/firewall-rules-anti-lockout_hu6656790467572514826.png 640w" sizes="(max-width: 499px) 300px,(max-width: 699px) 500px,640px" alt="Screenshot of anti-lockout rule" loading=lazy width=640 height=97></picture></p><p>Select <strong>Floating</strong> and add the following rule.</p><table><thead><tr><th></th><th></th></tr></thead><tbody><tr><td>Action</td><td><code>Pass</code></td></tr><tr><td>Interface</td><td><code>LAN</code> <code>VLAN10_MANAGE</code></td></tr><tr><td>Protocol</td><td><code>TCP/UDP</code></td></tr><tr><td>Source</td><td><code>any</code></td></tr><tr><td>Destination</td><td><code>This Firewall</code></td></tr><tr><td>Destination port range</td><td><code>PORTS_ANTI_LOCKOUT</code></td></tr><tr><td>Description</td><td><code>Anti-lockout</code></td></tr></tbody></table><p><code>This Firewall</code> is a pre-defined alias representing all interface addresses of
OPNsense.</p><h4 id=allow-intranet-pings>Allow Intranet Pings<a href=#allow-intranet-pings class=post-heading__anchor aria-hidden=true>#</a></h4><p>We allow ICMP pings for the entire local network. Pings are maliciously
abusable, so you may want to put stricter rules into place if required.</p><p><picture><source type=image/webp srcset="/blog/opnsense-baseline-guide-with-vpn-guest-and-vlan-support/firewall-rules-intranet_hu3192245926484310652.webp 300w,/blog/opnsense-baseline-guide-with-vpn-guest-and-vlan-support/firewall-rules-intranet_hu12310343818197735169.webp 500w,/blog/opnsense-baseline-guide-with-vpn-guest-and-vlan-support/firewall-rules-intranet_hu7634596945695198067.webp 657w" sizes="(max-width: 499px) 300px,(max-width: 699px) 500px,657px"><img src=/blog/opnsense-baseline-guide-with-vpn-guest-and-vlan-support/firewall-rules-intranet.png srcset="/blog/opnsense-baseline-guide-with-vpn-guest-and-vlan-support/firewall-rules-intranet_hu8868217074863709930.png 300w,/blog/opnsense-baseline-guide-with-vpn-guest-and-vlan-support/firewall-rules-intranet_hu4942354542983538340.png 500w,/blog/opnsense-baseline-guide-with-vpn-guest-and-vlan-support/firewall-rules-intranet_hu5297841776731499238.png 657w" sizes="(max-width: 499px) 300px,(max-width: 699px) 500px,657px" alt="Screenshot of intranet firewall rules" loading=lazy width=657 height=131></picture></p><p>Select <strong>IG_LOCAL</strong> and add the following rule.</p><table><thead><tr><th></th><th></th></tr></thead><tbody><tr><td>Action</td><td><code>Pass</code></td></tr><tr><td>Interface</td><td><code>IG_LOCAL</code></td></tr><tr><td>TCP/IP Version</td><td><code>IPv4</code></td></tr><tr><td>Protocol</td><td><code>ICMP</code></td></tr><tr><td>ICMP type</td><td><code>Echo Request</code></td></tr><tr><td>Source</td><td><code>IG_LOCAL net</code></td></tr><tr><td>Description</td><td><code>Allow intranet pings</code></td></tr></tbody></table><h4 id=reject-intranet-traffic-by-default>Reject Intranet Traffic By Default<a href=#reject-intranet-traffic-by-default class=post-heading__anchor aria-hidden=true>#</a></h4><p>By default, we <em>reject</em> traffic on local interfaces instead of <em>blocking</em> it.
<em>Block</em> drops packets silently. <em>Reject</em> returns a &ldquo;friendly&rdquo; response to the
sender. To be able to override this rule, unchecking <strong>Quick</strong> is crucial! To
use <a href=https://docs.opnsense.org/manual/logging_firewall.html class=link--external target=_blank rel=noreferrer>Firewall Logs</a> to
review blocked ports and amend our port list alias if necessary, we enable
logging on this rule.</p><p>Select <strong>IG_LOCAL</strong> and add the following rule.</p><table><thead><tr><th></th><th></th></tr></thead><tbody><tr><td>Action</td><td><code>Reject</code></td></tr><tr><td><strong>Quick</strong></td><td><code>unchecked</code></td></tr><tr><td>Interface</td><td><code>IG_LOCAL</code></td></tr><tr><td>TCP/IP Version</td><td><code>IPv4+IPv6</code></td></tr><tr><td>Protocol</td><td><code>any</code></td></tr><tr><td>Source</td><td><code>IG_LOCAL net</code></td></tr><tr><td>Destination</td><td><code>IG_LOCAL net</code></td></tr><tr><td>Log</td><td><code>checked</code></td></tr><tr><td>Description</td><td><code>Reject intranet traffic by default</code></td></tr></tbody></table><h4 id=allow-intranet-traffic>Allow Intranet Traffic<a href=#allow-intranet-traffic class=post-heading__anchor aria-hidden=true>#</a></h4><p>We only allow intranet traffic on the ports defined in the <code>PORTS_OUT_LAN</code>
alias. We&rsquo;ll override this rule for the <code>VLAN40_GUEST</code> network later, so we must
uncheck the <strong>Quick</strong> option again. For the Management network, you might want
to consider stricter rules, as well.</p><p>Select <strong>IG_LOCAL</strong> and add the following rule.</p><table><thead><tr><th></th><th></th></tr></thead><tbody><tr><td>Action</td><td><code>Pass</code></td></tr><tr><td><strong>Quick</strong></td><td><code>unchecked</code></td></tr><tr><td>Interface</td><td><code>IG_LOCAL</code></td></tr><tr><td>Protocol</td><td><code>TCP/UDP</code></td></tr><tr><td>Source</td><td><code>IG_LOCAL net</code></td></tr><tr><td>Destination</td><td><code>IG_LOCAL net</code></td></tr><tr><td>Destination port range</td><td><code>PORTS_OUT_LAN</code></td></tr><tr><td>Description</td><td><code>Allow intranet traffic</code></td></tr></tbody></table><h4 id=allow-internet-traffic>Allow Internet Traffic<a href=#allow-internet-traffic class=post-heading__anchor aria-hidden=true>#</a></h4><p>We allow internet traffic on <code>PORTS_OUT_WAN</code> for <code>IG_OUT_WAN</code> networks.</p><p><picture><source type=image/webp srcset="/blog/opnsense-baseline-guide-with-vpn-guest-and-vlan-support/firewall-rules-out-wan_hu13676697886052788529.webp 300w,/blog/opnsense-baseline-guide-with-vpn-guest-and-vlan-support/firewall-rules-out-wan_hu1368244634664699521.webp 500w,/blog/opnsense-baseline-guide-with-vpn-guest-and-vlan-support/firewall-rules-out-wan_hu8895583713880802153.webp 680w" sizes="(max-width: 499px) 300px,(max-width: 699px) 500px,680px"><img src=/blog/opnsense-baseline-guide-with-vpn-guest-and-vlan-support/firewall-rules-out-wan.png srcset="/blog/opnsense-baseline-guide-with-vpn-guest-and-vlan-support/firewall-rules-out-wan_hu11279242561211849889.png 300w,/blog/opnsense-baseline-guide-with-vpn-guest-and-vlan-support/firewall-rules-out-wan_hu926529352960733825.png 500w,/blog/opnsense-baseline-guide-with-vpn-guest-and-vlan-support/firewall-rules-out-wan_hu18076349922751265754.png 680w" sizes="(max-width: 499px) 300px,(max-width: 699px) 500px,680px" alt="Screenshot of IG_OUT_WAN firewall rules" loading=lazy width=680 height=60></picture></p><p>Select <strong>IG_OUT_WAN</strong> and add the following rule.</p><table><thead><tr><th></th><th></th></tr></thead><tbody><tr><td>Action</td><td><code>Pass</code></td></tr><tr><td><strong>Quick</strong></td><td><code>unchecked</code></td></tr><tr><td>Interface</td><td><code>IG_OUT_WAN</code></td></tr><tr><td>Protocol</td><td><code>TCP/UDP</code></td></tr><tr><td>Source</td><td><code>IG_OUT_WAN net</code></td></tr><tr><td>Destination / Invert</td><td><code>checked</code></td></tr><tr><td>Destination</td><td><code>IG_LOCAL net</code></td></tr><tr><td>Destination port range</td><td><code>PORTS_OUT_WAN</code></td></tr><tr><td>Description</td><td><code>Allow internet traffic through WAN</code></td></tr></tbody></table><p>We later want to enable unrestricted internet access on the Guest network, so
make sure to uncheck the <strong>Quick</strong> option!</p><p>Next, we allow internet traffic on <code>PORTS_OUT_WAN</code> for the <code>IG_OUT_VPN</code>
networks.</p><p><picture><source type=image/webp srcset="/blog/opnsense-baseline-guide-with-vpn-guest-and-vlan-support/firewall-rules-out-vpn_hu9075669692956670903.webp 300w,/blog/opnsense-baseline-guide-with-vpn-guest-and-vlan-support/firewall-rules-out-vpn_hu8964911866678811985.webp 500w,/blog/opnsense-baseline-guide-with-vpn-guest-and-vlan-support/firewall-rules-out-vpn_hu4281217070176553124.webp 700w" sizes="(max-width: 499px) 300px,(max-width: 699px) 500px,700px"><img src=/blog/opnsense-baseline-guide-with-vpn-guest-and-vlan-support/firewall-rules-out-vpn.png srcset="/blog/opnsense-baseline-guide-with-vpn-guest-and-vlan-support/firewall-rules-out-vpn_hu7709321719536627554.png 300w,/blog/opnsense-baseline-guide-with-vpn-guest-and-vlan-support/firewall-rules-out-vpn_hu9170803678283182531.png 500w,/blog/opnsense-baseline-guide-with-vpn-guest-and-vlan-support/firewall-rules-out-vpn_hu9287087872379149524.png 700w" sizes="(max-width: 499px) 300px,(max-width: 699px) 500px,700px" alt="Screenshot of IG_OUT_VPN firewall rules" loading=lazy width=702 height=213></picture></p><p>Select <strong>IG_OUT_VPN</strong> and add the following rules to configure selective
routing.</p><table><thead><tr><th></th><th></th></tr></thead><tbody><tr><td>Action</td><td><code>Pass</code></td></tr><tr><td>Interface</td><td><code>IG_OUT_VPN</code></td></tr><tr><td>Protocol</td><td><code>TCP/UDP</code></td></tr><tr><td>Source</td><td><code>IG_OUT_VPN net</code></td></tr><tr><td>Destination</td><td><code>SELECTIVE_ROUTING</code></td></tr><tr><td>Destination port range</td><td><code>PORTS_OUT_WAN</code></td></tr><tr><td>Description</td><td><code>Allow selected internet traffic through WAN</code></td></tr></tbody></table><table><thead><tr><th></th><th></th></tr></thead><tbody><tr><td>Action</td><td><code>Pass</code></td></tr><tr><td>Protocol</td><td><code>TCP/UDP</code></td></tr><tr><td>Source</td><td><code>IG_OUT_VPN net</code></td></tr><tr><td>Destination / Invert</td><td><code>checked</code></td></tr><tr><td>Destination</td><td><code>IG_LOCAL net</code></td></tr><tr><td>Destination port range</td><td><code>PORTS_OUT_WAN</code></td></tr><tr><td>Description</td><td><code>Allow internet traffic through WAN_VPN0</code></td></tr><tr><td>Gateway</td><td><code>WAN_VPN_GROUP</code></td></tr></tbody></table><h4 id=restrict-guest-network>Restrict Guest Network<a href=#restrict-guest-network class=post-heading__anchor aria-hidden=true>#</a></h4><p>Select <strong>VLAN40_GUEST</strong> and add the following rules.</p><p><picture><source type=image/webp srcset="/blog/opnsense-baseline-guide-with-vpn-guest-and-vlan-support/firewall-rules-guest_hu17360255599263207055.webp 300w,/blog/opnsense-baseline-guide-with-vpn-guest-and-vlan-support/firewall-rules-guest_hu7626279894829512870.webp 500w,/blog/opnsense-baseline-guide-with-vpn-guest-and-vlan-support/firewall-rules-guest_hu5403105470549121044.webp 700w" sizes="(max-width: 499px) 300px,(max-width: 699px) 500px,700px"><img src=/blog/opnsense-baseline-guide-with-vpn-guest-and-vlan-support/firewall-rules-guest.png srcset="/blog/opnsense-baseline-guide-with-vpn-guest-and-vlan-support/firewall-rules-guest_hu498325412809523319.png 300w,/blog/opnsense-baseline-guide-with-vpn-guest-and-vlan-support/firewall-rules-guest_hu16833186033849438864.png 500w,/blog/opnsense-baseline-guide-with-vpn-guest-and-vlan-support/firewall-rules-guest_hu17443301693701512957.png 700w" sizes="(max-width: 499px) 300px,(max-width: 699px) 500px,700px" alt="Screenshot of Guest network firewall rules" loading=lazy width=708 height=163></picture></p><p>To block Web GUI and SSH access from the Guest network, we block traffic to any
OPNsense interface on the <code>PORTS_ANTI_LOCKOUT</code> ports. We enable logging for this
rule to be able to see if any guests try to access OPNsense.</p><table><thead><tr><th></th><th></th></tr></thead><tbody><tr><td>Action</td><td><code>Block</code></td></tr><tr><td>Interface</td><td><code>VLAN40_GUEST</code></td></tr><tr><td>Protocol</td><td><code>TCP/UDP</code></td></tr><tr><td>Source</td><td><code>VLAN40_GUEST net</code></td></tr><tr><td>Destination</td><td><code>This Firewall</code></td></tr><tr><td>Destination port range</td><td><code>PORTS_ANTI_LOCKOUT</code></td></tr><tr><td>Log</td><td><code>checked</code></td></tr><tr><td>Description</td><td><code>Block admin ports</code></td></tr></tbody></table><p>We block access to other local networks and also enable logging for the rule.</p><table><thead><tr><th></th><th></th></tr></thead><tbody><tr><td>Action</td><td><code>Block</code></td></tr><tr><td>Interface</td><td><code>VLAN40_GUEST</code></td></tr><tr><td>Protocol</td><td><code>TCP/UDP</code></td></tr><tr><td>Source</td><td><code>VLAN40_GUEST net</code></td></tr><tr><td>Destination</td><td><code>IG_LOCAL net</code></td></tr><tr><td>Log</td><td><code>checked</code></td></tr><tr><td>Description</td><td><code>Block traffic to local networks</code></td></tr></tbody></table><p>Finally, we enable unrestricted internet access on Guest networks.</p><table><thead><tr><th></th><th></th></tr></thead><tbody><tr><td>Action</td><td><code>Pass</code></td></tr><tr><td>Interface</td><td><code>VLAN40_GUEST</code></td></tr><tr><td>Protocol</td><td><code>TCP/UDP</code></td></tr><tr><td>Source</td><td><code>VLAN40_GUEST net</code></td></tr><tr><td>Destination / Invert</td><td><code>checked</code></td></tr><tr><td>Destination</td><td><code>IG_LOCAL net</code></td></tr><tr><td>Description</td><td><code>Unrestricted internet access</code></td></tr></tbody></table><h4 id=lan-network-for-testing-and-debugging>LAN Network For Testing And Debugging<a href=#lan-network-for-testing-and-debugging class=post-heading__anchor aria-hidden=true>#</a></h4><p>I just keep the pre-defined &ldquo;LAN to any&rdquo; rules. I periodically reconfigure this
network for testing and debugging and don&rsquo;t use it for anything else.</p><p><picture><source type=image/webp srcset="/blog/opnsense-baseline-guide-with-vpn-guest-and-vlan-support/firewall-rules-lan_hu9393928179632225117.webp 300w,/blog/opnsense-baseline-guide-with-vpn-guest-and-vlan-support/firewall-rules-lan_hu5509686385756591265.webp 500w,/blog/opnsense-baseline-guide-with-vpn-guest-and-vlan-support/firewall-rules-lan_hu2788654866577138909.webp 700w" sizes="(max-width: 499px) 300px,(max-width: 699px) 500px,700px"><img src=/blog/opnsense-baseline-guide-with-vpn-guest-and-vlan-support/firewall-rules-lan.png srcset="/blog/opnsense-baseline-guide-with-vpn-guest-and-vlan-support/firewall-rules-lan_hu2024561996765497416.png 300w,/blog/opnsense-baseline-guide-with-vpn-guest-and-vlan-support/firewall-rules-lan_hu8300425663306452367.png 500w,/blog/opnsense-baseline-guide-with-vpn-guest-and-vlan-support/firewall-rules-lan_hu11277057398638366488.png 700w" sizes="(max-width: 499px) 300px,(max-width: 699px) 500px,700px" alt="Screenshot of LAN rules" loading=lazy width=730 height=182></picture></p><h4 id=redirect-outbound-dns-traffic>Redirect Outbound DNS Traffic<a href=#redirect-outbound-dns-traffic class=post-heading__anchor aria-hidden=true>#</a></h4><p>To prevent clients from explicitly querying outbound DNS and leaking information
to the outside, we redirect any outbound DNS traffic to Unbound or Dnsmasq.</p><p><picture><source type=image/webp srcset="/blog/opnsense-baseline-guide-with-vpn-guest-and-vlan-support/firewall-port-forward-dns_hu4472808789390205702.webp 300w,/blog/opnsense-baseline-guide-with-vpn-guest-and-vlan-support/firewall-port-forward-dns_hu11640833889138755394.webp 500w,/blog/opnsense-baseline-guide-with-vpn-guest-and-vlan-support/firewall-port-forward-dns_hu9675459252311319706.webp 700w" sizes="(max-width: 499px) 300px,(max-width: 699px) 500px,700px"><img src=/blog/opnsense-baseline-guide-with-vpn-guest-and-vlan-support/firewall-port-forward-dns.png srcset="/blog/opnsense-baseline-guide-with-vpn-guest-and-vlan-support/firewall-port-forward-dns_hu9340166599883385280.png 300w,/blog/opnsense-baseline-guide-with-vpn-guest-and-vlan-support/firewall-port-forward-dns_hu14663575924048634010.png 500w,/blog/opnsense-baseline-guide-with-vpn-guest-and-vlan-support/firewall-port-forward-dns_hu5715400136689773684.png 700w" sizes="(max-width: 499px) 300px,(max-width: 699px) 500px,700px" alt="Screenshot of DNS port forwarding configuration" loading=lazy width=718 height=127></picture></p><p>Navigate to <strong>Firewall</strong><span> → </span><strong>NAT</strong><span> → </span><strong>Port Forward</strong> and add the
following rules.</p><table><thead><tr><th></th><th></th></tr></thead><tbody><tr><td>Interface</td><td><code>IG_DNS_FORWARD</code></td></tr><tr><td>Protocol</td><td><code>TCP/UDP</code></td></tr><tr><td>Source</td><td><code>IG_DNS_FORWARD net</code></td></tr><tr><td>Destination</td><td><code>any</code></td></tr><tr><td>Destination port range</td><td><code>DNS</code></td></tr><tr><td>Redirect target IP</td><td><code>127.0.0.1</code></td></tr><tr><td>Redirect target port</td><td><code>5335</code></td></tr><tr><td>Description</td><td><code>Redirect any DNS traffic to Dnsmasq</code></td></tr></tbody></table><table><thead><tr><th></th><th></th></tr></thead><tbody><tr><td>Interface</td><td><code>IG_DNS_RESOLVE</code></td></tr><tr><td>Protocol</td><td><code>TCP/UDP</code></td></tr><tr><td>Source</td><td><code>IG_DNS_RESOLVE net</code></td></tr><tr><td>Destination / Invert</td><td><code>checked</code></td></tr><tr><td>Destination</td><td><code>IG_DNS_RESOLVE net</code></td></tr><tr><td>Destination port range</td><td><code>DNS</code></td></tr><tr><td>Redirect target IP</td><td><code>127.0.0.1</code></td></tr><tr><td>Redirect target port</td><td><code>DNS</code></td></tr><tr><td>Description</td><td><code>Redirect outbound DNS traffic to Unbound</code></td></tr></tbody></table><h4 id=redirect-outbound-ntp-traffic>Redirect Outbound NTP Traffic<a href=#redirect-outbound-ntp-traffic class=post-heading__anchor aria-hidden=true>#</a></h4><p>To sync the time of all our devices on the network to OPNsense, we redirect all
NTP traffic.</p><p><picture><source type=image/webp srcset="/blog/opnsense-baseline-guide-with-vpn-guest-and-vlan-support/firewall-port-forward-ntp_hu3667406633290857985.webp 300w,/blog/opnsense-baseline-guide-with-vpn-guest-and-vlan-support/firewall-port-forward-ntp_hu7161796319735855407.webp 500w,/blog/opnsense-baseline-guide-with-vpn-guest-and-vlan-support/firewall-port-forward-ntp_hu7526797903688773496.webp 700w" sizes="(max-width: 499px) 300px,(max-width: 699px) 500px,700px"><img src=/blog/opnsense-baseline-guide-with-vpn-guest-and-vlan-support/firewall-port-forward-ntp.png srcset="/blog/opnsense-baseline-guide-with-vpn-guest-and-vlan-support/firewall-port-forward-ntp_hu2985979093064157897.png 300w,/blog/opnsense-baseline-guide-with-vpn-guest-and-vlan-support/firewall-port-forward-ntp_hu2558888068428815967.png 500w,/blog/opnsense-baseline-guide-with-vpn-guest-and-vlan-support/firewall-port-forward-ntp_hu3423557212657214776.png 700w" sizes="(max-width: 499px) 300px,(max-width: 699px) 500px,700px" alt="Screenshot of NTP port forwarding configuration" loading=lazy width=723 height=31></picture></p><p>Navigate to <strong>Firewall</strong><span> → </span><strong>NAT</strong><span> → </span><strong>Port Forward</strong> and add the
following rule.</p><table><thead><tr><th></th><th></th></tr></thead><tbody><tr><td>Interface</td><td><code>IG_NTP</code></td></tr><tr><td>Protocol</td><td><code>UDP</code></td></tr><tr><td>Source</td><td><code>IG_NTP net</code></td></tr><tr><td>Destination / Invert</td><td><code>checked</code></td></tr><tr><td>Destination</td><td><code>IG_NTP net</code></td></tr><tr><td>Destination port range</td><td><code>NTP</code></td></tr><tr><td>Redirect target IP</td><td><code>127.0.0.1</code></td></tr><tr><td>Redirect target port</td><td><code>NTP</code></td></tr><tr><td>Description</td><td><code>Redirect outbound NTP traffic to OPNsense</code></td></tr></tbody></table><h2 id=test>Test<a href=#test class=post-heading__anchor aria-hidden=true>#</a></h2><p>Now would be a could time to reboot OPNsense to make sure all settings are
applied.</p><h3 id=test-dhcp>Test DHCP<a href=#test-dhcp class=post-heading__anchor aria-hidden=true>#</a></h3><p>Connect to a host in each VLAN and verify it receives an IP inside the specified
DHCP range. Here is the output of the <code>ip -4 addr show eth0</code> command from a
Ubuntu host connected to the VPN VLAN.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-text data-lang=text><span style=display:flex><span>8: eth0: &lt;BROADCAST,MULTICAST,UP&gt; mtu 1500 group default qlen 1
</span></span><span style=display:flex><span>    inet 192.168.20.106/24 brd 192.168.20.255 scope global dynamic
</span></span><span style=display:flex><span>       valid_lft 7196sec preferred_lft 7196sec
</span></span></code></pre></div><h3 id=test-dns>Test DNS<a href=#test-dns class=post-heading__anchor aria-hidden=true>#</a></h3><p>We have to verify the following functionality of our DNS architecture:</p><ul><li><code>VLAN20_VPN</code><ul><li>Unbound <em>resolves</em> remote and local hostname lookups</li><li>Redirect outbound DNS traffic to Unbound</li><li>Reverse lookups of private IPs</li><li>Don&rsquo;t leak lookups for the private <code>corp.example.com</code> domain</li></ul></li><li><code>VL30_CLEAR</code><ul><li>Dnsmasq <em>forwards</em> remote hostname lookups to the system DNS servers like
Quad9 <em>and</em> Unbound</li><li>Forward local hostname lookups to Unbound</li><li>Redirect outbound DNS traffic to Dnsmasq</li><li>Forward local reverse lookups of private IPs to Unbound</li><li>Don&rsquo;t leak lookups for the private <code>corp.example.com</code> domain and forward
them to Unbound</li></ul></li><li><code>VL40_GUEST</code><ul><li>Use external DNS resolvers</li><li>Allow for clients to override DNS</li><li>OPNsense lookups are blocked</li></ul></li></ul><p>We&rsquo;ll use the <code>dig</code> tool and the firewall logs under
<strong>Firewall</strong><span> → </span><strong>Log Files</strong><span> → </span><strong>Live View</strong> for testing.</p><p>I&rsquo;ll also skip the Management network because it requires the same testing as
the VPN network.</p><h4 id=vlan20_vpn-test-dns>VLAN20_VPN: Test DNS<a href=#vlan20_vpn-test-dns class=post-heading__anchor aria-hidden=true>#</a></h4><p>Connect to <code>VLAN20_VPN</code>.</p><h5 id=vlan20_vpn-remote-hostname-lookups>VLAN20_VPN: Remote Hostname Lookups<a href=#vlan20_vpn-remote-hostname-lookups class=post-heading__anchor aria-hidden=true>#</a></h5><p>Run <code>dig california.gov</code>:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-text data-lang=text><span style=display:flex><span>; &lt;&lt;&gt;&gt; DiG 9.16.1-Ubuntu &lt;&lt;&gt;&gt; california.gov
</span></span><span style=display:flex><span>;; global options: +cmd
</span></span><span style=display:flex><span>;; Got answer:
</span></span><span style=display:flex><span>;; -&gt;&gt;HEADER&lt;&lt;- opcode: QUERY, status: NOERROR, id: 41004
</span></span><span style=display:flex><span>;; flags: qr rd ra ad; QUERY: 1, ANSWER: 1, AUTHORITY: 0, ADDITIONAL: 1
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>;; OPT PSEUDOSECTION:
</span></span><span style=display:flex><span>; EDNS: version: 0, flags:; udp: 1232
</span></span><span style=display:flex><span>;; QUESTION SECTION:
</span></span><span style=display:flex><span>;california.gov.                        IN      A
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>;; ANSWER SECTION:
</span></span><span style=display:flex><span>california.gov.         300     IN      A       63.196.102.29
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>;; Query time: 36 msec
</span></span><span style=display:flex><span>;; SERVER: 192.168.20.1#53(192.168.20.1)
</span></span><span style=display:flex><span>;; WHEN: Tue Nov 16 22:37:34 CET 2021
</span></span><span style=display:flex><span>;; MSG SIZE  rcvd: 59
</span></span></code></pre></div><p>Here are the firewall logs showing the iterative DNS requests Unbound sends.</p><p><picture><source type=image/webp srcset="/blog/opnsense-baseline-guide-with-vpn-guest-and-vlan-support/verify-unbound-fw-logs-remote_hu1546665646064458712.webp 300w,/blog/opnsense-baseline-guide-with-vpn-guest-and-vlan-support/verify-unbound-fw-logs-remote_hu13868339408499345617.webp 445w" sizes="(max-width: 499px) 300px,445px"><img src=/blog/opnsense-baseline-guide-with-vpn-guest-and-vlan-support/verify-unbound-fw-logs-remote.png srcset="/blog/opnsense-baseline-guide-with-vpn-guest-and-vlan-support/verify-unbound-fw-logs-remote_hu458497331828284231.png 300w,/blog/opnsense-baseline-guide-with-vpn-guest-and-vlan-support/verify-unbound-fw-logs-remote_hu3167292649878952887.png 445w" sizes="(max-width: 499px) 300px,445px" alt="Screenshot of firewall logs showing Unbound requests for remote hostnames" loading=lazy width=445 height=299></picture></p><h5 id=vlan20_vpn-local-hostname-lookups>VLAN20_VPN: Local Hostname Lookups<a href=#vlan20_vpn-local-hostname-lookups class=post-heading__anchor aria-hidden=true>#</a></h5><p>Run <code>dig opnsense.corp.example.com</code>:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-text data-lang=text><span style=display:flex><span>; &lt;&lt;&gt;&gt; DiG 9.16.1-Ubuntu &lt;&lt;&gt;&gt; opnsense.corp.example.com
</span></span><span style=display:flex><span>;; global options: +cmd
</span></span><span style=display:flex><span>;; Got answer:
</span></span><span style=display:flex><span>;; -&gt;&gt;HEADER&lt;&lt;- opcode: QUERY, status: NOERROR, id: 22291
</span></span><span style=display:flex><span>;; flags: qr aa rd ra; QUERY: 1, ANSWER: 3, AUTHORITY: 0, ADDITIONAL: 1
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>;; OPT PSEUDOSECTION:
</span></span><span style=display:flex><span>; EDNS: version: 0, flags:; udp: 1232
</span></span><span style=display:flex><span>;; QUESTION SECTION:
</span></span><span style=display:flex><span>;opnsense.corp.example.com.  IN      A
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>;; ANSWER SECTION:
</span></span><span style=display:flex><span>opnsense.corp.example.com. 3600 IN   A       192.168.1.1
</span></span><span style=display:flex><span>opnsense.corp.example.com. 3600 IN   A       192.168.10.1
</span></span><span style=display:flex><span>opnsense.corp.example.com. 3600 IN   A       192.168.20.1
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>;; Query time: 0 msec
</span></span><span style=display:flex><span>;; SERVER: 192.168.20.1#53(192.168.20.1)
</span></span><span style=display:flex><span>;; WHEN: Tue Nov 16 21:48:19 CET 2021
</span></span><span style=display:flex><span>;; MSG SIZE  rcvd: 105
</span></span></code></pre></div><h5 id=vlan20_vpn-redirect-outbound-dns-traffic>VLAN20_VPN: Redirect Outbound DNS Traffic<a href=#vlan20_vpn-redirect-outbound-dns-traffic class=post-heading__anchor aria-hidden=true>#</a></h5><p>Run <code>dig opnsense.org @8.8.8.8</code>:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-text data-lang=text><span style=display:flex><span>; &lt;&lt;&gt;&gt; DiG 9.16.1-Ubuntu &lt;&lt;&gt;&gt; opnsense.org @8.8.8.8
</span></span><span style=display:flex><span>;; global options: +cmd
</span></span><span style=display:flex><span>;; Got answer:
</span></span><span style=display:flex><span>;; -&gt;&gt;HEADER&lt;&lt;- opcode: QUERY, status: NOERROR, id: 17970
</span></span><span style=display:flex><span>;; flags: qr rd ra ad; QUERY: 1, ANSWER: 1, AUTHORITY: 0, ADDITIONAL: 1
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>;; OPT PSEUDOSECTION:
</span></span><span style=display:flex><span>; EDNS: version: 0, flags:; udp: 1232
</span></span><span style=display:flex><span>;; QUESTION SECTION:
</span></span><span style=display:flex><span>;opnsense.org.                  IN      A
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>;; ANSWER SECTION:
</span></span><span style=display:flex><span>opnsense.org.           184     IN      A       178.162.131.118
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>;; Query time: 0 msec
</span></span><span style=display:flex><span>;; SERVER: 8.8.8.8#53(8.8.8.8)
</span></span><span style=display:flex><span>;; WHEN: Tue Nov 16 21:51:15 CET 2021
</span></span><span style=display:flex><span>;; MSG SIZE  rcvd: 57
</span></span></code></pre></div><p><code>dig</code> can&rsquo;t tell that OPNsense hijacked the request and thus displays an
incorrect <code>SERVER</code> value. If you check the firewall logs, you shouldn&rsquo;t see any
requests to <code>8.8.8.8</code>. Instead, you should see iterative root server requests.</p><h5 id=vlan20_vpn-reverse-lookups-of-private-ips>VLAN20_VPN: Reverse Lookups of Private IPs<a href=#vlan20_vpn-reverse-lookups-of-private-ips class=post-heading__anchor aria-hidden=true>#</a></h5><p>Run <code>dig -x 192.168.20.1</code>:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-text data-lang=text><span style=display:flex><span>; &lt;&lt;&gt;&gt; DiG 9.16.1-Ubuntu &lt;&lt;&gt;&gt; -x 192.168.20.1
</span></span><span style=display:flex><span>;; global options: +cmd
</span></span><span style=display:flex><span>;; Got answer:
</span></span><span style=display:flex><span>;; -&gt;&gt;HEADER&lt;&lt;- opcode: QUERY, status: NOERROR, id: 9264
</span></span><span style=display:flex><span>;; flags: qr aa rd ra; QUERY: 1, ANSWER: 1, AUTHORITY: 0, ADDITIONAL: 1
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>;; OPT PSEUDOSECTION:
</span></span><span style=display:flex><span>; EDNS: version: 0, flags:; udp: 1232
</span></span><span style=display:flex><span>;; QUESTION SECTION:
</span></span><span style=display:flex><span>;1.20.168.192.in-addr.arpa.     IN      PTR
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>;; ANSWER SECTION:
</span></span><span style=display:flex><span>1.20.168.192.in-addr.arpa. 3600 IN      PTR     OPNsense.corp.example.com.
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>;; Query time: 0 msec
</span></span><span style=display:flex><span>;; SERVER: 192.168.20.1#53(192.168.20.1)
</span></span><span style=display:flex><span>;; WHEN: Tue Nov 16 21:56:14 CET 2021
</span></span><span style=display:flex><span>;; MSG SIZE  rcvd: 96
</span></span></code></pre></div><p>If you want, additionally reverse-lookup an IP that doesn&rsquo;t exist. The firewall
logs mustn&rsquo;t contain requests to external DNS servers.</p><h5 id=vlan20_vpn-verify-corpexamplecom-is-private>VLAN20_VPN: Verify <code>corp.example.com</code> Is Private<a href=#vlan20_vpn-verify-corpexamplecom-is-private class=post-heading__anchor aria-hidden=true>#</a></h5><p>To test whether OPNsense is the authoritative server for <code>corp.example.com</code>, we
lookup a non-existent hostname in that domain. <code>dig</code> should return an
authoritative <code>NXDOMAIN</code> response with the SOA record we earlier defined earlier
in the <code>AUTHORITY SECTION</code>.</p><p>Run <code>dig nowhere.corp.example.com</code>:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-text data-lang=text><span style=display:flex><span>; &lt;&lt;&gt;&gt; DiG 9.16.1-Ubuntu &lt;&lt;&gt;&gt; nowhere.corp.example.com
</span></span><span style=display:flex><span>;; global options: +cmd
</span></span><span style=display:flex><span>;; Got answer:
</span></span><span style=display:flex><span>;; -&gt;&gt;HEADER&lt;&lt;- opcode: QUERY, status: NXDOMAIN, id: 44590
</span></span><span style=display:flex><span>;; flags: qr aa rd ra; QUERY: 1, ANSWER: 0, AUTHORITY: 1, ADDITIONAL: 1
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>;; OPT PSEUDOSECTION:
</span></span><span style=display:flex><span>; EDNS: version: 0, flags:; udp: 1232
</span></span><span style=display:flex><span>;; QUESTION SECTION:
</span></span><span style=display:flex><span>;nowhere.corp.example.com.   IN      A
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>;; AUTHORITY SECTION:
</span></span><span style=display:flex><span>corp.example.com.    3600    IN      SOA     opnsense.corp.example.com. root.example.com. 2021110201 86400 7200 3600000 3600
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>;; Query time: 0 msec
</span></span><span style=display:flex><span>;; SERVER: 192.168.20.1#53(192.168.20.1)
</span></span><span style=display:flex><span>;; WHEN: Tue Nov 16 21:59:58 CET 2021
</span></span><span style=display:flex><span>;; MSG SIZE  rcvd: 110
</span></span></code></pre></div><h5 id=vlan20_vpn-dns-leak-test>VLAN20_VPN: DNS Leak Test<a href=#vlan20_vpn-dns-leak-test class=post-heading__anchor aria-hidden=true>#</a></h5><p>In your browser, navigate to <a href=https://dnsleaktest.com/ class=link--external target=_blank rel=noreferrer>dnsleaktest.com</a> or
<a href=https://mullvad.net/en/check class=link--external target=_blank rel=noreferrer>mullvad.net/check</a>. We expect the &ldquo;leaked&rdquo; DNS
server to match our Mullvad public Mullvad IP. The second leak is from the
<strong>Outgoing Interface</strong> we configured for Unbound:</p><p><picture><source type=image/webp srcset="/blog/opnsense-baseline-guide-with-vpn-guest-and-vlan-support/verify-dns-leak-test-vpn_hu893521453379076438.webp 300w,/blog/opnsense-baseline-guide-with-vpn-guest-and-vlan-support/verify-dns-leak-test-vpn_hu600777144741542976.webp 411w" sizes="(max-width: 499px) 300px,411px"><img src=/blog/opnsense-baseline-guide-with-vpn-guest-and-vlan-support/verify-dns-leak-test-vpn.png srcset="/blog/opnsense-baseline-guide-with-vpn-guest-and-vlan-support/verify-dns-leak-test-vpn_hu14696408883450166772.png 300w,/blog/opnsense-baseline-guide-with-vpn-guest-and-vlan-support/verify-dns-leak-test-vpn_hu9996856159479062330.png 411w" sizes="(max-width: 499px) 300px,411px" alt="Screenshot of Mullvad DNS leak test for VPN network" loading=lazy width=411 height=575></picture></p><h4 id=vlan30_clear-test-dns>VLAN30_CLEAR: Test DNS<a href=#vlan30_clear-test-dns class=post-heading__anchor aria-hidden=true>#</a></h4><p>Connect to <code>VLAN30_CLEAR</code>.</p><h5 id=vlan30_clear-remote-hostname-lookups>VLAN30_CLEAR: Remote Hostname Lookups<a href=#vlan30_clear-remote-hostname-lookups class=post-heading__anchor aria-hidden=true>#</a></h5><p>Run <code>dig opnsense.org</code>:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-text data-lang=text><span style=display:flex><span>; &lt;&lt;&gt;&gt; DiG 9.16.1-Ubuntu &lt;&lt;&gt;&gt; opnsense.org
</span></span><span style=display:flex><span>;; global options: +cmd
</span></span><span style=display:flex><span>;; Got answer:
</span></span><span style=display:flex><span>;; -&gt;&gt;HEADER&lt;&lt;- opcode: QUERY, status: NOERROR, id: 65053
</span></span><span style=display:flex><span>;; flags: qr rd ra; QUERY: 1, ANSWER: 1, AUTHORITY: 0, ADDITIONAL: 1
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>;; OPT PSEUDOSECTION:
</span></span><span style=display:flex><span>; EDNS: version: 0, flags:; udp: 1232
</span></span><span style=display:flex><span>;; QUESTION SECTION:
</span></span><span style=display:flex><span>;opnsense.org.                  IN      A
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>;; ANSWER SECTION:
</span></span><span style=display:flex><span>opnsense.org.           596     IN      A       178.162.131.118
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>;; Query time: 5 msec
</span></span><span style=display:flex><span>;; SERVER: 192.168.30.1#53(192.168.30.1)
</span></span><span style=display:flex><span>;; WHEN: Tue Nov 16 16:45:08 CET 2021
</span></span><span style=display:flex><span>;; MSG SIZE  rcvd: 57
</span></span></code></pre></div><p>Check the firewall logs. Enable logging for the port forward rule if you want it
to show up.</p><p><picture><source type=image/webp srcset="/blog/opnsense-baseline-guide-with-vpn-guest-and-vlan-support/verify-dnsmasq-fw-logs-remote_hu8157284694213856891.webp 300w,/blog/opnsense-baseline-guide-with-vpn-guest-and-vlan-support/verify-dnsmasq-fw-logs-remote_hu16112945587663850011.webp 477w" sizes="(max-width: 499px) 300px,477px"><img src=/blog/opnsense-baseline-guide-with-vpn-guest-and-vlan-support/verify-dnsmasq-fw-logs-remote.png srcset="/blog/opnsense-baseline-guide-with-vpn-guest-and-vlan-support/verify-dnsmasq-fw-logs-remote_hu12072257478102591731.png 300w,/blog/opnsense-baseline-guide-with-vpn-guest-and-vlan-support/verify-dnsmasq-fw-logs-remote_hu18442422883729482041.png 477w" sizes="(max-width: 499px) 300px,477px" alt="Screenshot of firewall logs showing Dnsmasq redirect for remote hostname requests" loading=lazy width=477 height=357></picture></p><p>You can see that Dnsmasq forwards to the DNS servers defined under
<strong>System</strong><span> → </span><strong>Settings</strong><span> → </span><strong>General</strong> <em>and</em> Unbound.</p><h5 id=vlan30_clear-local-hostname-lookups>VLAN30_CLEAR: Local Hostname Lookups<a href=#vlan30_clear-local-hostname-lookups class=post-heading__anchor aria-hidden=true>#</a></h5><p>Run <code>dig opnsense.corp.example.com</code>:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-text data-lang=text><span style=display:flex><span>; &lt;&lt;&gt;&gt; DiG 9.16.1-Ubuntu &lt;&lt;&gt;&gt; opnsense.corp.example.com
</span></span><span style=display:flex><span>;; global options: +cmd
</span></span><span style=display:flex><span>;; Got answer:
</span></span><span style=display:flex><span>;; -&gt;&gt;HEADER&lt;&lt;- opcode: QUERY, status: NOERROR, id: 61385
</span></span><span style=display:flex><span>;; flags: qr aa rd ra; QUERY: 1, ANSWER: 1, AUTHORITY: 0, ADDITIONAL: 1
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>;; OPT PSEUDOSECTION:
</span></span><span style=display:flex><span>; EDNS: version: 0, flags:; udp: 4096
</span></span><span style=display:flex><span>;; QUESTION SECTION:
</span></span><span style=display:flex><span>;opnsense.corp.example.com.  IN      A
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>;; ANSWER SECTION:
</span></span><span style=display:flex><span>opnsense.corp.example.com. 1 IN      A       192.168.1.1
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>;; Query time: 0 msec
</span></span><span style=display:flex><span>;; SERVER: 192.168.30.1#53(192.168.30.1)
</span></span><span style=display:flex><span>;; WHEN: Wed Nov 17 00:45:49 CET 2021
</span></span><span style=display:flex><span>;; MSG SIZE  rcvd: 73
</span></span></code></pre></div><h5 id=vlan30_clear-redirect-outbound-dns-traffic>VLAN30_CLEAR: Redirect Outbound DNS Traffic<a href=#vlan30_clear-redirect-outbound-dns-traffic class=post-heading__anchor aria-hidden=true>#</a></h5><p>Run <code>dig opnsense.org @8.8.8.8</code>:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-text data-lang=text><span style=display:flex><span>; &lt;&lt;&gt;&gt; DiG 9.16.1-Ubuntu &lt;&lt;&gt;&gt; opnsense.org @8.8.8.8
</span></span><span style=display:flex><span>;; global options: +cmd
</span></span><span style=display:flex><span>;; Got answer:
</span></span><span style=display:flex><span>;; -&gt;&gt;HEADER&lt;&lt;- opcode: QUERY, status: NOERROR, id: 34638
</span></span><span style=display:flex><span>;; flags: qr rd ra; QUERY: 1, ANSWER: 1, AUTHORITY: 0, ADDITIONAL: 1
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>;; OPT PSEUDOSECTION:
</span></span><span style=display:flex><span>; EDNS: version: 0, flags:; udp: 1232
</span></span><span style=display:flex><span>;; QUESTION SECTION:
</span></span><span style=display:flex><span>;opnsense.org.                  IN      A
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>;; ANSWER SECTION:
</span></span><span style=display:flex><span>opnsense.org.           430     IN      A       178.162.131.118
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>;; Query time: 3 msec
</span></span><span style=display:flex><span>;; SERVER: 8.8.8.8#53(8.8.8.8)
</span></span><span style=display:flex><span>;; WHEN: Tue Nov 16 00:12:15 CET 2021
</span></span><span style=display:flex><span>;; MSG SIZE  rcvd: 57
</span></span></code></pre></div><p>We confirm it works by looking at the firewall logs again:</p><p><picture><source type=image/webp srcset="/blog/opnsense-baseline-guide-with-vpn-guest-and-vlan-support/verify-dnsmasq-fw-logs-redirect_hu12316267830372096347.webp 300w,/blog/opnsense-baseline-guide-with-vpn-guest-and-vlan-support/verify-dnsmasq-fw-logs-redirect_hu9007418945317969302.webp 479w" sizes="(max-width: 499px) 300px,479px"><img src=/blog/opnsense-baseline-guide-with-vpn-guest-and-vlan-support/verify-dnsmasq-fw-logs-redirect.png srcset="/blog/opnsense-baseline-guide-with-vpn-guest-and-vlan-support/verify-dnsmasq-fw-logs-redirect_hu13488594412984200165.png 300w,/blog/opnsense-baseline-guide-with-vpn-guest-and-vlan-support/verify-dnsmasq-fw-logs-redirect_hu10457393611415573300.png 479w" sizes="(max-width: 499px) 300px,479px" alt="Screenshot of firewall logs showing Dnsmasq redirect for outbound DNS requests" loading=lazy width=479 height=360></picture></p><h5 id=vlan30_clear-forward-reverse-lookups-of-private-ips-to-unbound>VLAN30_CLEAR: Forward Reverse Lookups of Private IPs to Unbound<a href=#vlan30_clear-forward-reverse-lookups-of-private-ips-to-unbound class=post-heading__anchor aria-hidden=true>#</a></h5><p>Run <code>dig -x 192.168.20.1</code>:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-text data-lang=text><span style=display:flex><span>; &lt;&lt;&gt;&gt; DiG 9.16.1-Ubuntu &lt;&lt;&gt;&gt; -x 192.168.20.1
</span></span><span style=display:flex><span>;; global options: +cmd
</span></span><span style=display:flex><span>;; Got answer:
</span></span><span style=display:flex><span>;; -&gt;&gt;HEADER&lt;&lt;- opcode: QUERY, status: NOERROR, id: 20607
</span></span><span style=display:flex><span>;; flags: qr aa rd ra; QUERY: 1, ANSWER: 1, AUTHORITY: 0, ADDITIONAL: 1
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>;; OPT PSEUDOSECTION:
</span></span><span style=display:flex><span>; EDNS: version: 0, flags:; udp: 1232
</span></span><span style=display:flex><span>;; QUESTION SECTION:
</span></span><span style=display:flex><span>;1.20.168.192.in-addr.arpa.     IN      PTR
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>;; ANSWER SECTION:
</span></span><span style=display:flex><span>1.20.168.192.in-addr.arpa. 3600 IN      PTR     OPNsense.home.schnerring.net.
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>;; Query time: 1 msec
</span></span><span style=display:flex><span>;; SERVER: 192.168.30.1#53(192.168.30.1)
</span></span><span style=display:flex><span>;; WHEN: Wed Nov 17 00:09:05 CET 2021
</span></span><span style=display:flex><span>;; MSG SIZE  rcvd: 96
</span></span></code></pre></div><p>The firewall logs confirm it works.</p><p><picture><source type=image/webp srcset="/blog/opnsense-baseline-guide-with-vpn-guest-and-vlan-support/verify-dnsmasq-fw-logs-reverse_hu13358375054957139145.webp 300w,/blog/opnsense-baseline-guide-with-vpn-guest-and-vlan-support/verify-dnsmasq-fw-logs-reverse_hu14266923223149881795.webp 459w" sizes="(max-width: 499px) 300px,459px"><img src=/blog/opnsense-baseline-guide-with-vpn-guest-and-vlan-support/verify-dnsmasq-fw-logs-reverse.png srcset="/blog/opnsense-baseline-guide-with-vpn-guest-and-vlan-support/verify-dnsmasq-fw-logs-reverse_hu6839793436579151928.png 300w,/blog/opnsense-baseline-guide-with-vpn-guest-and-vlan-support/verify-dnsmasq-fw-logs-reverse_hu422301196309887432.png 459w" sizes="(max-width: 499px) 300px,459px" alt="Screenshot of firewall logs showing Dnsmasq redirect for reverse lookups" loading=lazy width=459 height=128></picture></p><h5 id=vlan30_clear-verify-corpexamplecom-is-private>VLAN30_CLEAR: Verify <code>corp.example.com</code> Is Private<a href=#vlan30_clear-verify-corpexamplecom-is-private class=post-heading__anchor aria-hidden=true>#</a></h5><p>Run <code>dig nowhere.corp.example.com</code>:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-text data-lang=text><span style=display:flex><span>; &lt;&lt;&gt;&gt; DiG 9.16.1-Ubuntu &lt;&lt;&gt;&gt; nowhere.corp.example.com
</span></span><span style=display:flex><span>;; global options: +cmd
</span></span><span style=display:flex><span>;; Got answer:
</span></span><span style=display:flex><span>;; -&gt;&gt;HEADER&lt;&lt;- opcode: QUERY, status: NXDOMAIN, id: 7481
</span></span><span style=display:flex><span>;; flags: qr aa rd ra; QUERY: 1, ANSWER: 0, AUTHORITY: 1, ADDITIONAL: 1
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>;; OPT PSEUDOSECTION:
</span></span><span style=display:flex><span>; EDNS: version: 0, flags:; udp: 1232
</span></span><span style=display:flex><span>;; QUESTION SECTION:
</span></span><span style=display:flex><span>;nowhere.corp.example.com. IN      A
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>;; AUTHORITY SECTION:
</span></span><span style=display:flex><span>corp.example.com.    3600    IN      SOA     opnsense.corp.example.com. root.example.com. 2021110201 86400 7200 3600000 3600
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>;; Query time: 0 msec
</span></span><span style=display:flex><span>;; SERVER: 192.168.30.1#53(192.168.30.1)
</span></span><span style=display:flex><span>;; WHEN: Tue Nov 16 20:44:35 CET 2021
</span></span><span style=display:flex><span>;; MSG SIZE  rcvd: 112
</span></span></code></pre></div><p>This time, requests will only be forwarded to Unbound, but not external DNS
resolvers.</p><p><picture><source type=image/webp srcset="/blog/opnsense-baseline-guide-with-vpn-guest-and-vlan-support/verify-dnsmasq-fw-logs-private_hu17481493108646753938.webp 300w,/blog/opnsense-baseline-guide-with-vpn-guest-and-vlan-support/verify-dnsmasq-fw-logs-private_hu4066153484481904421.webp 455w" sizes="(max-width: 499px) 300px,455px"><img src=/blog/opnsense-baseline-guide-with-vpn-guest-and-vlan-support/verify-dnsmasq-fw-logs-private.png srcset="/blog/opnsense-baseline-guide-with-vpn-guest-and-vlan-support/verify-dnsmasq-fw-logs-private_hu5094815633058450592.png 300w,/blog/opnsense-baseline-guide-with-vpn-guest-and-vlan-support/verify-dnsmasq-fw-logs-private_hu8918711887156781257.png 455w" sizes="(max-width: 499px) 300px,455px" alt="Screenshot of firewall logs showing Dnsmasq redirecting private domain requests to Unbound" loading=lazy width=455 height=171></picture></p><h5 id=vlan30_clear-dns-leak-test>VLAN30_CLEAR: DNS Leak Test<a href=#vlan30_clear-dns-leak-test class=post-heading__anchor aria-hidden=true>#</a></h5><p>As we saw earlier, we expect the Quad9 <em>and</em> the Mullvad public IPs to leak.
Here is the result of an extended test from
<a href=https://dnsleaktest.com/ class=link--external target=_blank rel=noreferrer>dnsleaktest.com</a>:</p><p><picture><source type=image/webp srcset="/blog/opnsense-baseline-guide-with-vpn-guest-and-vlan-support/verify-dns-leak-test-clear_hu13398950136818978541.webp 300w,/blog/opnsense-baseline-guide-with-vpn-guest-and-vlan-support/verify-dns-leak-test-clear_hu14559304005389818372.webp 500w,/blog/opnsense-baseline-guide-with-vpn-guest-and-vlan-support/verify-dns-leak-test-clear_hu15810578633449317049.webp 501w" sizes="(max-width: 499px) 300px,(max-width: 699px) 500px,501px"><img src=/blog/opnsense-baseline-guide-with-vpn-guest-and-vlan-support/verify-dns-leak-test-clear.png srcset="/blog/opnsense-baseline-guide-with-vpn-guest-and-vlan-support/verify-dns-leak-test-clear_hu10802219405650400907.png 300w,/blog/opnsense-baseline-guide-with-vpn-guest-and-vlan-support/verify-dns-leak-test-clear_hu5099644388379716353.png 500w,/blog/opnsense-baseline-guide-with-vpn-guest-and-vlan-support/verify-dns-leak-test-clear_hu9454547785114558450.png 501w" sizes="(max-width: 499px) 300px,(max-width: 699px) 500px,501px" alt="Screenshot of DNS leak test for Clear network" loading=lazy width=501 height=203></picture></p><h4 id=vlan40_guest-test-dns>VLAN40_GUEST: Test DNS<a href=#vlan40_guest-test-dns class=post-heading__anchor aria-hidden=true>#</a></h4><p>Connect to <code>VLAN40_GUEST</code>.</p><p>Verify that <code>dig opnsense.org @192.168.40.1</code> times out.</p><p>The Cloudflare DNS servers you configured in the DHCP settings of the Guest VLAN
should show up when running the leak test:</p><p><picture><source type=image/webp srcset="/blog/opnsense-baseline-guide-with-vpn-guest-and-vlan-support/verify-dns-leak-test-guest_hu12105967369717322694.webp 300w,/blog/opnsense-baseline-guide-with-vpn-guest-and-vlan-support/verify-dns-leak-test-guest_hu1612783776323093907.webp 500w,/blog/opnsense-baseline-guide-with-vpn-guest-and-vlan-support/verify-dns-leak-test-guest_hu10558483248831009483.webp 528w" sizes="(max-width: 499px) 300px,(max-width: 699px) 500px,528px"><img src=/blog/opnsense-baseline-guide-with-vpn-guest-and-vlan-support/verify-dns-leak-test-guest.png srcset="/blog/opnsense-baseline-guide-with-vpn-guest-and-vlan-support/verify-dns-leak-test-guest_hu6621624712099176979.png 300w,/blog/opnsense-baseline-guide-with-vpn-guest-and-vlan-support/verify-dns-leak-test-guest_hu392367176323893232.png 500w,/blog/opnsense-baseline-guide-with-vpn-guest-and-vlan-support/verify-dns-leak-test-guest_hu5289619841587511135.png 528w" sizes="(max-width: 499px) 300px,(max-width: 699px) 500px,528px" alt="Screenshot of Mullvad DNS leak test for Guest network" loading=lazy width=528 height=74></picture></p><h2 id=thanks-for-reading->Thanks For Reading ❤️<a href=#thanks-for-reading- class=post-heading__anchor aria-hidden=true>#</a></h2><p>If you&rsquo;re here, I thank you for reading all this! Any feedback is highly
appreciated.</p><p>When I decided to write this guide, I didn&rsquo;t think it would take soooo long. I
worked on it intensively for the better part of a month. I spent like a week
configuring Unbound to use WireGuard tunnels, only to find out that
<a href=https://github.com/opnsense/core/issues/5329 class=link--external target=_blank rel=noreferrer>I couldn&rsquo;t get it working due to a bug</a>.
But it was all worth it and a fulfilling journey — I have learned so much
OPNsense and networking. But I&rsquo;m also happy to be able to put this aside for a
while. 🎉</p><p>So what&rsquo;s next?</p><p>Let&rsquo;s Encrypt certificates and
<a href=https://docs.opnsense.org/manual/how-tos/haproxy.html class=link--external target=_blank rel=noreferrer>HAProxy</a> to secure
self-hosted services. I imagine configuring it should be pretty straightforward.</p><p>Me and possibly others want to be able to access my home network from the
outside via WireGuard. I have a dynamic IP, so I thought I&rsquo;d have to resort to
<a href=https://docs.opnsense.org/manual/dynamic_dns.html class=link--external target=_blank rel=noreferrer>Dynamic DNS</a>. <del>But I think
<a href=https://mullvad.net/en/help/port-forwarding-and-mullvad/ class=link--external target=_blank rel=noreferrer>port forwarding with Mullvad</a>
is the better solution and doesn&rsquo;t require me to associate my public IP address
with a public DNS record.</del></p><p><a href=https://docs.opnsense.org/manual/shaping.html class=link--external target=_blank rel=noreferrer>Traffic shaping</a> and
<a href=https://docs.opnsense.org/manual/ips.html class=link--external target=_blank rel=noreferrer>intrusion prevention</a> is something I
want to look into, too.</p><p>So yeah, OPNsense and I will be friends for a while. 👫</p><pre tabindex=0><code></code></pre></div><div class=social-share><strong class=social-share__heading>Share this post: </strong><a class=social-share__item href="https://x.com/intent/post?url=https%3A%2F%2Fschnerring.net%2Fblog%2Fopnsense-baseline-guide-with-vpn-guest-and-vlan-support%2F&amp;text=OPNsense+Baseline+Guide+with+Mullvad+VPN+Multi-WAN%2C+Guest%2C+and+VLAN+Support" target=_blank rel=noreferrer><svg role="img" viewBox="0 0 24 24"><title>X</title><path d="M18.901 1.153h3.68l-8.04 9.19L24 22.846h-7.406l-5.8-7.584-6.638 7.584H.474l8.6-9.83L0 1.154h7.594l5.243 6.932zM17.61 20.644h2.039L6.486 3.24H4.298z"/></svg>
</a><a class=social-share__item href="https://www.linkedin.com/sharing/share-offsite/?url=https%3A%2F%2Fschnerring.net%2Fblog%2Fopnsense-baseline-guide-with-vpn-guest-and-vlan-support%2F" target=_blank rel=noreferrer><svg role="img" viewBox="0 0 24 24"><title>LinkedIn</title><path d="M20.447 20.452h-3.554v-5.569c0-1.328-.027-3.037-1.852-3.037-1.853.0-2.136 1.445-2.136 2.939v5.667H9.351V9h3.414v1.561h.046c.477-.9 1.637-1.85 3.37-1.85 3.601.0 4.267 2.37 4.267 5.455v6.286zM5.337 7.433c-1.144.0-2.063-.926-2.063-2.065.0-1.138.92-2.063 2.063-2.063 1.14.0 2.064.925 2.064 2.063.0 1.139-.925 2.065-2.064 2.065zm1.782 13.019H3.555V9h3.564v11.452zM22.225.0H1.771C.792.0.0.774.0 1.729v20.542C0 23.227.792 24 1.771 24h20.451C23.2 24 24 23.227 24 22.271V1.729C24 .774 23.2.0 22.222.0h.003z"/></svg>
</a><a class=social-share__item href="https://www.facebook.com/sharer.php?u=https%3A%2F%2Fschnerring.net%2Fblog%2Fopnsense-baseline-guide-with-vpn-guest-and-vlan-support%2F" target=_blank rel=noreferrer><svg role="img" viewBox="0 0 24 24"><title>Facebook</title><path d="M9.101 23.691v-7.98H6.627v-3.667h2.474v-1.58c0-4.085 1.848-5.978 5.858-5.978.401.0.955.042 1.468.103a8.68 8.68.0 011.141.195v3.325a8.623 8.623.0 00-.653-.036 26.805 26.805.0 00-.733-.009c-.707.0-1.259.096-1.675.309a1.686 1.686.0 00-.679.622c-.258.42-.374.995-.374 1.752v1.297h3.919l-.386 2.103-.287 1.564h-3.246v8.245C19.396 23.238 24 18.179 24 12.044c0-6.627-5.373-12-12-12s-12 5.373-12 12c0 5.628 3.874 10.35 9.101 11.647z"/></svg>
</a><a class=social-share__item href="https://reddit.com/submit?url=https%3A%2F%2Fschnerring.net%2Fblog%2Fopnsense-baseline-guide-with-vpn-guest-and-vlan-support%2F&amp;title=OPNsense+Baseline+Guide+with+Mullvad+VPN+Multi-WAN%2C+Guest%2C+and+VLAN+Support" target=_blank rel=noreferrer><svg role="img" viewBox="0 0 24 24"><title>Reddit</title><path d="M12 0C5.373.0.0 5.373.0 12c0 3.314 1.343 6.314 3.515 8.485l-2.286 2.286C.775 23.225 1.097 24 1.738 24H12c6.627.0 12-5.373 12-12S18.627.0 12 0zm4.388 3.199c1.104.0 1.999.895 1.999 1.999.0 1.105-.895 2-1.999 2-.946.0-1.739-.657-1.947-1.539v.002c-1.147.162-2.032 1.15-2.032 2.341v.007c1.776.067 3.4.567 4.686 1.363.473-.363 1.064-.58 1.707-.58 1.547.0 2.802 1.254 2.802 2.802.0 1.117-.655 2.081-1.601 2.531-.088 3.256-3.637 5.876-7.997 5.876-4.361.0-7.905-2.617-7.998-5.87-.954-.447-1.614-1.415-1.614-2.538.0-1.548 1.255-2.802 2.803-2.802.645.0 1.239.218 1.712.585 1.275-.79 2.881-1.291 4.64-1.365v-.01c0-1.663 1.263-3.034 2.88-3.207.188-.911.993-1.595 1.959-1.595zm-8.085 8.376c-.784.0-1.459.78-1.506 1.797-.047 1.016.64 1.429 1.426 1.429s1.371-.369 1.418-1.385c.047-1.017-.553-1.841-1.338-1.841zm7.406.0c-.786.0-1.385.824-1.338 1.841.047 1.017.634 1.385 1.418 1.385.785.0 1.473-.413 1.426-1.429-.046-1.017-.721-1.797-1.506-1.797zm-3.703 4.013c-.974.0-1.907.048-2.77.135-.147.015-.241.168-.183.305.483 1.154 1.622 1.964 2.953 1.964 1.33.0 2.47-.81 2.953-1.964.057-.137-.037-.29-.184-.305-.863-.087-1.795-.135-2.769-.135z"/></svg>
</a><a class=social-share__item href="https://news.ycombinator.com/submitlink?u=https%3A%2F%2Fschnerring.net%2Fblog%2Fopnsense-baseline-guide-with-vpn-guest-and-vlan-support%2F&amp;t=OPNsense+Baseline+Guide+with+Mullvad+VPN+Multi-WAN%2C+Guest%2C+and+VLAN+Support" target=_blank rel=noreferrer><svg role="img" viewBox="0 0 24 24"><title>Y Combinator</title><path d="M0 24V0h24v24H0zM6.951 5.896l4.112 7.708v5.064h1.583v-4.972l4.148-7.799h-1.749l-2.457 4.875c-.372.745-.688 1.434-.688 1.434s-.297-.708-.651-1.434L8.831 5.896h-1.88z"/></svg>
</a><a class=social-share__item href="mailto:?subject=OPNsense+Baseline+Guide+with+Mullvad+VPN+Multi-WAN%2C+Guest%2C+and+VLAN+Support&amp;body=https%3A%2F%2Fschnerring.net%2Fblog%2Fopnsense-baseline-guide-with-vpn-guest-and-vlan-support%2F" target=_blank rel=noreferrer><svg class="icon icon-tabler icon-tabler-mail" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M3 7a2 2 0 012-2h14a2 2 0 012 2v10a2 2 0 01-2 2H5a2 2 0 01-2-2V7z"/><path d="M3 7l9 6 9-6"/></svg></a></div><div id=remark42></div><script>var remark_config={host:"https://remark42.schnerring.net",site_id:"schnerring.net",theme:localStorage.getItem("theme"),show_email_subscription:!1}</script><script>!function(e,t){for(s=0;s<e.length;s++){var s,n=t.createElement("script"),o=".js",i=t.head||t.body;"noModule"in n?(n.type="module",o=".mjs"):n.async=!0,n.defer=!0,n.src=remark_config.host+"/web/"+e[s]+o,i.appendChild(n)}}(remark_config.components||["embed"],document)</script><script>const themeToggleLight=document.getElementsByClassName("theme__toggle light--hidden").item(0);themeToggleLight.addEventListener("click",()=>{setTimeout(()=>window.REMARK42.changeTheme("light"),10)});const themeToggleDark=document.getElementsByClassName("theme__toggle dark--hidden").item(0);themeToggleDark.addEventListener("click",()=>{setTimeout(()=>window.REMARK42.changeTheme("dark"),10)})</script><script>function cookieConsentClick(){localStorage.setItem("cookie-consent",!0);const e=document.getElementById("cookie-consent");e.classList.add("cookie-consent--hidden")}</script><div id=cookie-consent class=cookie-consent--hidden><div class=cli-prompt><div class=cli-prompt__chevron>>&nbsp;</div><div class=cli-prompt__text><span>When you participate in the comments, a cookie is used to keep you logged in.</span>
<span class=cli-prompt__cursor>█</span></div><button onclick=cookieConsentClick()>Got it!</button></div></div><script>const cookieConsentAccepted=localStorage&&localStorage.getItem("cookie-consent");if(!cookieConsentAccepted){const e=document.getElementById("cookie-consent");e.classList.remove("cookie-consent--hidden")}</script></article></div><div class=sidebar><aside class=toc><nav><p class=sidebar__heading>Table Of Contents</p><nav id=TableOfContents><ul><li><a href=#overview>Overview</a><ul><li><a href=#wan>WAN</a></li><li><a href=#lan>LAN</a></li><li><a href=#dns-services>DNS Services</a></li></ul></li><li><a href=#hardware-selection-and-installation>Hardware Selection and Installation</a></li><li><a href=#wizard>Wizard</a><ul><li><a href=#general-information>General Information</a></li><li><a href=#time-server-information>Time Server Information</a></li><li><a href=#configure-interfaces>Configure Interfaces</a></li><li><a href=#set-root-password>Set Root Password</a></li></ul></li><li><a href=#general-settings>General Settings</a><ul><li><a href=#access>Access</a></li><li><a href=#miscellaneous>Miscellaneous</a></li><li><a href=#firewall-settings>Firewall Settings</a></li><li><a href=#checksum-offloading>Checksum Offloading</a></li></ul></li><li><a href=#vlans>VLANs</a><ul><li><a href=#switch-choice>Switch Choice</a></li><li><a href=#vlan-definitions>VLAN Definitions</a></li><li><a href=#vlan-interfaces>VLAN Interfaces</a></li><li><a href=#vlan-interface-ips>VLAN Interface IPs</a></li><li><a href=#vlan-interface-dhcp>VLAN Interface DHCP</a></li></ul></li><li><a href=#wireguard-vpn-with-mullvad>WireGuard VPN with Mullvad</a><ul><li><a href=#remote-peers>Remote Peers</a></li><li><a href=#local-peers>Local Peers</a></li><li><a href=#wireguard-interfaces>WireGuard Interfaces</a></li><li><a href=#vpn-gateways>VPN Gateways</a></li><li><a href=#static-routes-optional>Static Routes (Optional)</a></li></ul></li><li><a href=#dns>DNS</a><ul><li><a href=#resolver-unbound>Resolver (Unbound)</a></li><li><a href=#forwarder-dnsmasq>Forwarder (Dnsmasq)</a></li></ul></li><li><a href=#firewall>Firewall</a><ul><li><a href=#interface-groups>Interface Groups</a></li><li><a href=#aliases>Aliases</a></li><li><a href=#nat>NAT</a></li><li><a href=#rules>Rules</a></li></ul></li><li><a href=#test>Test</a><ul><li><a href=#test-dhcp>Test DHCP</a></li><li><a href=#test-dns>Test DNS</a></li></ul></li><li><a href=#thanks-for-reading->Thanks For Reading ❤️</a></li></ul></nav></nav></aside><hr><aside class=bio><div class="jr__item jr-basics__item"><div class=jr-basics__image><img src=https://schnerring.net/michael-schnerring.jpg alt="Picture of Michael Schnerring" width=250 height=250></div><div class=jr-basics__name>Michael Schnerring</div><div class=jr-basics__label>Software Engineer</div><div class=jr-basics__summary>I've been a computer geek all my life. I'm passionate about open-source and digital privacy. I like video games and CrossFit. I also blog sometimes.</div><div class=jr-basics__location-city>Basel</div><div class=jr-basics__location-region>Switzerland</div><hr><div class="jr-basics__profile jr-basics__profile--row"><a href=https://github.com/schnerring target=_blank rel="noreferrer me"><div class=jr-basics__profile-item><div class=jr-basics__profile-icon><svg role="img" viewBox="0 0 24 24"><title>GitHub</title><path d="M12 .297c-6.63.0-12 5.373-12 12 0 5.303 3.438 9.8 8.205 11.385.6.113.82-.258.82-.577.0-.285-.01-1.04-.015-2.04-3.338.724-4.042-1.61-4.042-1.61C4.422 18.07 3.633 17.7 3.633 17.7c-1.087-.744.084-.729.084-.729 1.205.084 1.838 1.236 1.838 1.236 1.07 1.835 2.809 1.305 3.495.998.108-.776.417-1.305.76-1.605-2.665-.3-5.466-1.332-5.466-5.93.0-1.31.465-2.38 1.235-3.22-.135-.303-.54-1.523.105-3.176.0.0 1.005-.322 3.3 1.23.96-.267 1.98-.399 3-.405 1.02.006 2.04.138 3 .405 2.28-1.552 3.285-1.23 3.285-1.23.645 1.653.24 2.873.12 3.176.765.84 1.23 1.91 1.23 3.22.0 4.61-2.805 5.625-5.475 5.92.42.36.81 1.096.81 2.22.0 1.606-.015 2.896-.015 3.286.0.315.21.69.825.57C20.565 22.092 24 17.592 24 12.297c0-6.627-5.373-12-12-12"/></svg></div></div></a><a href=https://x.com/schnerringo target=_blank rel="noreferrer me"><div class=jr-basics__profile-item><div class=jr-basics__profile-icon><svg role="img" viewBox="0 0 24 24"><title>X</title><path d="M18.901 1.153h3.68l-8.04 9.19L24 22.846h-7.406l-5.8-7.584-6.638 7.584H.474l8.6-9.83L0 1.154h7.594l5.243 6.932zM17.61 20.644h2.039L6.486 3.24H4.298z"/></svg></div></div></a><a href=https://hachyderm.io/@schnerring target=_blank rel="noreferrer me"><div class=jr-basics__profile-item><div class=jr-basics__profile-icon><svg role="img" viewBox="0 0 24 24"><title>Mastodon</title><path d="M23.268 5.313c-.35-2.578-2.617-4.61-5.304-5.004C17.51.242 15.792.0 11.813.0h-.03c-3.98.0-4.835.242-5.288.309C3.882.692 1.496 2.518.917 5.127.64 6.412.61 7.837.661 9.143c.074 1.874.088 3.745.26 5.611.118 1.24.325 2.47.62 3.68.55 2.237 2.777 4.098 4.96 4.857 2.336.792 4.849.923 7.256.38.265-.061.527-.132.786-.213.585-.184 1.27-.39 1.774-.753a.057.057.0 00.023-.043v-1.809a.052.052.0 00-.02-.041.053.053.0 00-.046-.01 20.282 20.282.0 01-4.709.545c-2.73.0-3.463-1.284-3.674-1.818a5.593 5.593.0 01-.319-1.433.053.053.0 01.066-.054c1.517.363 3.072.546 4.632.546.376.0.75.0 1.125-.01 1.57-.044 3.224-.124 4.768-.422.038-.008.077-.015.11-.024 2.435-.464 4.753-1.92 4.989-5.604.008-.145.03-1.52.03-1.67.002-.512.167-3.63-.024-5.545zm-3.748 9.195h-2.561V8.29c0-1.309-.55-1.976-1.67-1.976-1.23.0-1.846.79-1.846 2.35v3.403h-2.546V8.663c0-1.56-.617-2.35-1.848-2.35-1.112.0-1.668.668-1.67 1.977v6.218H4.822V8.102c0-1.31.337-2.35 1.011-3.12.696-.77 1.608-1.164 2.74-1.164 1.311.0 2.302.5 2.962 1.498l.638 1.06.638-1.06c.66-.999 1.65-1.498 2.96-1.498 1.13.0 2.043.395 2.74 1.164.675.77 1.012 1.81 1.012 3.12z"/></svg></div></div></a><a href=https://www.linkedin.com/in/schnerring target=_blank rel="noreferrer me"><div class=jr-basics__profile-item><div class=jr-basics__profile-icon><svg role="img" viewBox="0 0 24 24"><title>LinkedIn</title><path d="M20.447 20.452h-3.554v-5.569c0-1.328-.027-3.037-1.852-3.037-1.853.0-2.136 1.445-2.136 2.939v5.667H9.351V9h3.414v1.561h.046c.477-.9 1.637-1.85 3.37-1.85 3.601.0 4.267 2.37 4.267 5.455v6.286zM5.337 7.433c-1.144.0-2.063-.926-2.063-2.065.0-1.138.92-2.063 2.063-2.063 1.14.0 2.064.925 2.064 2.063.0 1.139-.925 2.065-2.064 2.065zm1.782 13.019H3.555V9h3.564v11.452zM22.225.0H1.771C.792.0.0.774.0 1.729v20.542C0 23.227.792 24 1.771 24h20.451C23.2 24 24 23.227 24 22.271V1.729C24 .774 23.2.0 22.222.0h.003z"/></svg></div></div></a><a href=https://schnerring.net/index.xml target=_blank rel="noreferrer me"><div class=jr-basics__profile-item><div class=jr-basics__profile-icon><svg role="img" viewBox="0 0 24 24"><title>RSS</title><path d="M19.199 24C19.199 13.467 10.533 4.8.0 4.8V0c13.165.0 24 10.835 24 24h-4.801zM3.291 17.415c1.814.0 3.293 1.479 3.293 3.295.0 1.813-1.485 3.29-3.301 3.29C1.47 24 0 22.526.0 20.71s1.475-3.294 3.291-3.295zM15.909 24h-4.665c0-6.169-5.075-11.245-11.244-11.245V8.09c8.727.0 15.909 7.184 15.909 15.91z"/></svg></div></div></a></div></div></aside></div></main><footer><div class=copyright>© 2020 - 2023 Michael Schnerring</div></footer><script src=/js/main.64c1438168ce40659c4587f5c9c4360f879c91bf1a11a0108f4a10e6fffccd9d6ad88c2ba6ee9e4196298d61146a14f05b5f3f94f839654339bb28daae75220f.js integrity="sha512-ZMFDgWjOQGWcRYf1ycQ2D4eckb8aEaAQj0oQ5v/8zZ1q2Iwrpu6eQZYpjWEUahTwW18/lPg5ZUM5uyjarnUiDw=="></script><script src=/js/flexsearch.1ab5b109bf2ed66903ae10907394415caa12f5c0ee66bc80088ba135ec4a751f62e4961d6a7303b562e4db724392da85945b763b8e1858ea3fd05cc36f9b8156.js integrity="sha512-GrWxCb8u1mkDrhCQc5RBXKoS9cDuZryACIuhNexKdR9i5JYdanMDtWLk23JDktqFlFt2O44YWOo/0FzDb5uBVg=="></script></div></body></html>