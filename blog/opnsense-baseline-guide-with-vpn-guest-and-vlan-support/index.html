<!doctype html><html lang=en theme=dark>
<head>
<meta charset=utf-8>
<meta name=viewport content="width=device-width,initial-scale=1">
<link rel=preload as=font type=font/woff2 href=/fonts/roboto-slab-latin-400.woff2 crossorigin=anonymous>
<link rel=prefetch as=font type=font/woff2 href=/fonts/roboto-slab-latin-700.woff2 crossorigin=anonymous>
<link rel=preload as=font type=font/woff2 href=/fonts/fira-code-latin-300.woff2 crossorigin=anonymous>
<link rel=preload as=font type=font/woff2 href=/fonts/fira-code-latin-400.woff2 crossorigin=anonymous>
<link rel=prefetch as=font type=font/woff2 href=/fonts/fira-code-latin-700.woff2 crossorigin=anonymous>
<meta name=robots content="index, follow, max-snippet:-1, max-image-preview:large, max-video-preview:-1">
<title>OPNsense Baseline Guide with Mullvad VPN Multi-WAN, Guest, and VLAN Support&nbsp;::&nbsp;Michael Schnerring&nbsp;—&nbsp;Software Engineer</title>
<meta name=description content="This beginner-friendly, step-by-step guide walks you through the initial configuration of your OPNsense firewall. The title of this guide is an homage to the pfSense baseline guide with VPN, Guest, and VLAN support that some of you guys might know, and this is an OPNsense migration of it. I found that guide two years ago and immediately fell in love with the network setup. After researching for weeks, I decided to use OPNsense instead of pfSense.">
<link rel=canonical href=https://schnerring.net/blog/opnsense-baseline-guide-with-vpn-guest-and-vlan-support/>
<meta name=twitter:card content="summary_large_image">
<meta name=twitter:image content="https://schnerring.net/blog/opnsense-baseline-guide-with-vpn-guest-and-vlan-support/cover.png">
<meta name=twitter:title content="OPNsense Baseline Guide with Mullvad VPN Multi-WAN, Guest, and VLAN Support">
<meta name=twitter:description content="This beginner-friendly, step-by-step guide walks you through the initial configuration of your OPNsense firewall. The title of this guide is an homage to the pfSense baseline guide with VPN, Guest, and VLAN support that some of you guys might know, and this is an OPNsense migration of it. I found that guide two years ago and immediately fell in love with the network setup. After researching for weeks, I decided to use OPNsense instead of pfSense.">
<meta property="og:title" content="OPNsense Baseline Guide with Mullvad VPN Multi-WAN, Guest, and VLAN Support">
<meta property="og:description" content="This beginner-friendly, step-by-step guide walks you through the initial configuration of your OPNsense firewall. The title of this guide is an homage to the pfSense baseline guide with VPN, Guest, and VLAN support that some of you guys might know, and this is an OPNsense migration of it. I found that guide two years ago and immediately fell in love with the network setup. After researching for weeks, I decided to use OPNsense instead of pfSense.">
<meta property="og:type" content="article">
<meta property="og:url" content="https://schnerring.net/blog/opnsense-baseline-guide-with-vpn-guest-and-vlan-support/"><meta property="og:image" content="https://schnerring.net/blog/opnsense-baseline-guide-with-vpn-guest-and-vlan-support/cover.png"><meta property="article:section" content="blog">
<meta property="article:published_time" content="2021-11-17T03:56:35+01:00">
<meta property="article:modified_time" content="2021-11-17T03:56:35+01:00">
<meta itemprop=name content="OPNsense Baseline Guide with Mullvad VPN Multi-WAN, Guest, and VLAN Support">
<meta itemprop=description content="This beginner-friendly, step-by-step guide walks you through the initial configuration of your OPNsense firewall. The title of this guide is an homage to the pfSense baseline guide with VPN, Guest, and VLAN support that some of you guys might know, and this is an OPNsense migration of it. I found that guide two years ago and immediately fell in love with the network setup. After researching for weeks, I decided to use OPNsense instead of pfSense."><meta itemprop=datePublished content="2021-11-17T03:56:35+01:00">
<meta itemprop=dateModified content="2021-11-17T03:56:35+01:00">
<meta itemprop=wordCount content="6361"><meta itemprop=image content="https://schnerring.net/blog/opnsense-baseline-guide-with-vpn-guest-and-vlan-support/cover.png">
<meta itemprop=keywords content="DNS,Dnsmasq,Firewall,Homelab,Let's Encrypt,Mullvad,Network,OPNsense,Router,Self-host,Unbound,VLAN,VPN,WireGuard,">
<script async defer data-domain=schnerring.net src=https://plausible.schnerring.net/js/plausible.js></script>
<style>@font-face{font-display:swap;font-family:Roboto Slab;font-style:normal;font-weight:100;src:local("Roboto Slab Thin "),local("Roboto Slab-Thin"),url(/fonts/roboto-slab-latin-100.woff2) format("woff2"),url(/fonts/roboto-slab-latin-100.woff) format("woff")}@font-face{font-display:swap;font-family:Roboto Slab;font-style:normal;font-weight:200;src:local("Roboto Slab Extra Light "),local("Roboto Slab-Extra Light"),url(/fonts/roboto-slab-latin-200.woff2) format("woff2"),url(/fonts/roboto-slab-latin-200.woff) format("woff")}@font-face{font-display:swap;font-family:Roboto Slab;font-style:normal;font-weight:300;src:local("Roboto Slab Light "),local("Roboto Slab-Light"),url(/fonts/roboto-slab-latin-300.woff2) format("woff2"),url(/fonts/roboto-slab-latin-300.woff) format("woff")}@font-face{font-display:swap;font-family:Roboto Slab;font-style:normal;font-weight:400;src:local("Roboto Slab Regular "),local("Roboto Slab-Regular"),url(/fonts/roboto-slab-latin-400.woff2) format("woff2"),url(/fonts/roboto-slab-latin-400.woff) format("woff")}@font-face{font-display:swap;font-family:Roboto Slab;font-style:normal;font-weight:500;src:local("Roboto Slab Medium "),local("Roboto Slab-Medium"),url(/fonts/roboto-slab-latin-500.woff2) format("woff2"),url(/fonts/roboto-slab-latin-500.woff) format("woff")}@font-face{font-display:swap;font-family:Roboto Slab;font-style:normal;font-weight:600;src:local("Roboto Slab SemiBold "),local("Roboto Slab-SemiBold"),url(/fonts/roboto-slab-latin-600.woff2) format("woff2"),url(/fonts/roboto-slab-latin-600.woff) format("woff")}@font-face{font-display:swap;font-family:Roboto Slab;font-style:normal;font-weight:700;src:local("Roboto Slab Bold "),local("Roboto Slab-Bold"),url(/fonts/roboto-slab-latin-700.woff2) format("woff2"),url(/fonts/roboto-slab-latin-700.woff) format("woff")}@font-face{font-display:swap;font-family:Roboto Slab;font-style:normal;font-weight:800;src:local("Roboto Slab ExtraBold "),local("Roboto Slab-ExtraBold"),url(/fonts/roboto-slab-latin-800.woff2) format("woff2"),url(/fonts/roboto-slab-latin-800.woff) format("woff")}@font-face{font-display:swap;font-family:Roboto Slab;font-style:normal;font-weight:900;src:local("Roboto Slab Black "),local("Roboto Slab-Black"),url(/fonts/roboto-slab-latin-900.woff2) format("woff2"),url(/fonts/roboto-slab-latin-900.woff) format("woff")}@font-face{font-display:swap;font-family:Fira Code;font-style:normal;font-weight:300;src:local("Fira Code Light "),local("Fira Code-Light"),url(/fonts/fira-code-latin-300.woff2) format("woff2"),url(/fonts/fira-code-latin-300.woff) format("woff")}@font-face{font-display:swap;font-family:Fira Code;font-style:normal;font-weight:400;src:local("Fira Code Regular "),local("Fira Code-Regular"),url(/fonts/fira-code-latin-400.woff2) format("woff2"),url(/fonts/fira-code-latin-400.woff) format("woff")}@font-face{font-display:swap;font-family:Fira Code;font-style:normal;font-weight:500;src:local("Fira Code Medium "),local("Fira Code-Medium"),url(/fonts/fira-code-latin-500.woff2) format("woff2"),url(/fonts/fira-code-latin-500.woff) format("woff")}@font-face{font-display:swap;font-family:Fira Code;font-style:normal;font-weight:600;src:local("Fira Code SemiBold "),local("Fira Code-SemiBold"),url(/fonts/fira-code-latin-600.woff2) format("woff2"),url(/fonts/fira-code-latin-600.woff) format("woff")}@font-face{font-display:swap;font-family:Fira Code;font-style:normal;font-weight:700;src:local("Fira Code Bold "),local("Fira Code-Bold"),url(/fonts/fira-code-latin-700.woff2) format("woff2"),url(/fonts/fira-code-latin-700.woff) format("woff")}

/*! normalize.css v8.0.1 | MIT License | github.com/necolas/normalize.css */html{-webkit-text-size-adjust:100%;line-height:1.15}body{margin:0}main{display:block}h1{font-size:2em;margin:.67em 0}hr{box-sizing:content-box;height:0;overflow:visible}pre{font-family:monospace,monospace;font-size:1em}a{background-color:transparent}abbr[title]{border-bottom:none;text-decoration:underline;-webkit-text-decoration:underline dotted;text-decoration:underline dotted}b,strong{font-weight:bolder}code,kbd,samp{font-family:monospace,monospace;font-size:1em}small{font-size:80%}sub,sup{font-size:75%;line-height:0;position:relative;vertical-align:baseline}sub{bottom:-.25em}sup{top:-.5em}img{border-style:none}button,input,optgroup,select,textarea{font-family:inherit;font-size:100%;line-height:1.15;margin:0}button,input{overflow:visible}button,select{text-transform:none}[type=button],[type=reset],[type=submit],button{-webkit-appearance:button}[type=button]::-moz-focus-inner,[type=reset]::-moz-focus-inner,[type=submit]::-moz-focus-inner,button::-moz-focus-inner{border-style:none;padding:0}[type=button]:-moz-focusring,[type=reset]:-moz-focusring,[type=submit]:-moz-focusring,button:-moz-focusring{outline:1px dotted ButtonText}fieldset{padding:.35em .75em .625em}legend{box-sizing:border-box;color:inherit;display:table;max-width:100%;padding:0;white-space:normal}progress{vertical-align:baseline}textarea{overflow:auto}[type=checkbox],[type=radio]{box-sizing:border-box;padding:0}[type=number]::-webkit-inner-spin-button,[type=number]::-webkit-outer-spin-button{height:auto}[type=search]{-webkit-appearance:textfield;outline-offset:-2px}[type=search]::-webkit-search-decoration{-webkit-appearance:none}::-webkit-file-upload-button{-webkit-appearance:button;font:inherit}details{display:block}summary{display:list-item}[hidden],template{display:none}:root[theme=light]{--bg:var(--bg0_h);--bg0:#fbf1c7;--bg0_h:#f9f5d7;--bg0_s:#f2e5bc;--bg1:#ebdbb2;--bg2:#d5c4a1;--bg3:#bdae93;--bg4:#a89984;--fg:var(--fg1);--fg0:#282828;--fg1:#3c3836;--fg2:#504945;--fg3:#665c54;--fg4:#7c6f64;--gray1:var(--fg4);--gray2:#928374;--red1:#cc241d;--red2:#9d0006;--green1:#98971a;--green2:#797403;--yellow1:#d79921;--yellow2:#b57614;--blue1:#458588;--blue2:#076678;--purple1:#b16286;--purple2:#8f3f71;--aqua1:#689d6a;--aqua2:#427b58;--orange1:#d65d0e;--orange2:#af3a03}:root[theme=light] .light--hidden{display:none}:root[theme=dark]{--bg:var(--bg0_h);--bg0:#282828;--bg0_h:#1d2021;--bg0_s:#32302f;--bg1:#3c3836;--bg2:#504945;--bg3:#665c54;--bg4:#7c6f64;--fg:var(--fg1);--fg0:#fbf1c7;--fg1:#ebdbb2;--fg2:#d5c4a1;--fg3:#bdae93;--fg4:#a89984;--gray1:var(--fg4);--gray2:#928374;--red1:#cc241d;--red2:#fb4934;--green1:#98971a;--green2:#b8bb26;--yellow1:#d79921;--yellow2:#fabd2f;--blue1:#458588;--blue2:#83a598;--purple1:#b16286;--purple2:#d3869b;--aqua1:#689d6a;--aqua2:#8ec07c;--orange1:#d65d0e;--orange2:#fe8019}:root[theme=dark] .dark--hidden{display:none}:root{--primary:var(--aqua1);--primary-alt:var(--aqua2);--font-monospace:"Fira Code","Lucida Console",Monaco,monospace;--font-sans-serif:Verdana,Helvetica,sans-serif;--font-serif:"Roboto Slab",Georgia,serif}html{font-family:Roboto Slab,Georgia,serif;font-family:var(--font-serif);font-size:1rem;scroll-behavior:smooth}body{word-wrap:break-word;background:var(--bg);color:var(--fg);line-height:1.675}strong{letter-spacing:.35px}a{color:inherit;text-decoration:none}a.link--external:after{content:"\2009↗"}img{border:2px solid var(--bg1);height:auto;max-width:100%}::-moz-selection{background:var(--bg4);color:var(--fg0)}::selection{background:var(--bg4);color:var(--fg0)}h1,h2,h3,h4,h5{color:var(--fg0);font-family:Fira Code,Lucida Console,Monaco,monospace;font-family:var(--font-monospace);font-weight:300;line-height:1.4}h1 code,h2 code,h3 code,h4 code,h5 code{font-size:1em}h2,h3,h4,h5{border-bottom:1px solid var(--bg1)}h1,h2{font-weight:400}h1{font-size:1.875rem}h2{font-size:1.75rem}h3{font-size:1.625rem}@media (min-width:768px){h1{font-size:2.375rem}h2{font-size:2rem}h3{font-size:1.75rem}}h4{font-size:1.5rem}h5{font-size:1.375rem}table{border-collapse:collapse;margin:2rem 0;table-layout:fixed;width:100%}table,td,th{border:1px solid var(--bg1);padding:.5rem}hr{background:var(--bg1);border:none;height:1px;margin:3rem auto;width:80%}blockquote,code,pre{border-radius:.2rem;padding:0 .2em}pre code{padding:0}blockquote,code,pre,th{background:var(--bg1)}code,pre,th{font-family:Fira Code,Lucida Console,Monaco,monospace;font-family:var(--font-monospace)}code code{background:var(--bg2)}blockquote,pre{padding:1rem}pre{background:var(--bg1)!important;overflow:auto}pre code{background:none}blockquote{border-left:5px solid var(--primary-alt);margin:.5rem 0}blockquote code{background:var(--bg2)}blockquote p:first-of-type{margin-top:0}blockquote p:last-of-type{margin-bottom:0}pre::-webkit-scrollbar{height:.5rem;scrollbar-width:auto}pre::-webkit-scrollbar-track{background:var(--bg2);border-radius:.2rem}pre::-webkit-scrollbar-thumb{background:var(--bg4);border-radius:.2rem}.layout{display:grid;grid-template-areas:"header" "main" "footer";grid-template-rows:auto 1fr auto;height:100vh}main{align-items:start;display:grid;grid-area:main;grid-template-areas:"empty content sidebar";grid-template-columns:1fr minmax(0,650px) 4fr}header{background:var(--bg1);grid-area:header}footer{grid-area:footer}footer,main{margin:.5em 1.1em}.content{grid-area:content}.sidebar{display:none;flex-direction:column;grid-area:sidebar;margin-top:3rem;position:-webkit-sticky;position:sticky;top:2rem}@media (min-width:992px){.sidebar{display:flex}}header{display:grid;font-family:Fira Code,Lucida Console,Monaco,monospace;font-family:var(--font-monospace);font-size:1.125rem;grid-template-areas:"heading search nav theme-toggle";grid-template-columns:auto auto 1fr auto;padding:.75rem}.logo{color:var(--fg0);display:flex;font-weight:700;grid-area:heading}.logo:hover .logo__cursor{-webkit-animation:blink 1s infinite;animation:blink 1s infinite;opacity:1}.logo__chevron,.logo__cursor{margin-left:.5rem}.logo__cursor{opacity:0}.logo__text{display:none}@media (min-width:768px){.logo__text{display:block}}.search{display:flex;grid-area:search;margin:0 1rem}#search__text{background:var(--bg2);border:1px solid var(--bg2);border-radius:.2rem;caret-color:var(--fg);color:var(--fg);outline:none;padding:0 .5rem;width:100%}#search__text:hover{border-color:var(--bg3)}#search__text:focus{border-color:var(--bg4)}#search__text::-moz-placeholder{color:var(--fg3)}#search__text:-ms-input-placeholder{color:var(--fg3)}#search__text::placeholder{color:var(--fg3)}#search__text[type=search]::-webkit-search-cancel-button{-webkit-appearance:none;appearance:none}#search__suggestions{background:var(--bg);border-radius:.2rem;box-shadow:0 .5rem 1rem var(--bg1);font-family:Roboto Slab,Georgia,serif;font-family:var(--font-serif);left:0;margin-top:2rem;position:absolute;width:95vw;z-index:1000}@media (min-width:768px){.search{position:relative}#search__suggestions{width:60vw}}.search__suggestions--hidden{display:none}.search__suggestion-item{border-bottom:1px dashed var(--bg2);display:grid;grid-template-columns:1fr 2fr}.search__suggestion-item.focus-visible,.search__suggestion-item:focus,.search__suggestion-item:hover{background:var(--bg1);cursor:pointer;outline:none}.search__suggestion-item:focus,.search__suggestion-item:focus-visible,.search__suggestion-item:hover{background:var(--bg1);cursor:pointer;outline:none}.search__suggestion-item:last-child{border:none}.search__suggestion-description,.search__suggestion-title{margin:1rem 0;padding:0 1rem}.search__suggestion-title{font-weight:700}.search__suggestion-description{border-left:1px solid var(--bg2)}.theme__toggle{align-items:center;background:none;border:none;color:var(--yellow1);cursor:pointer;display:flex;grid-area:theme-toggle;margin:0 1rem}.theme__toggle:hover{color:var(--yellow2)}.theme__toggle svg{height:28px;width:28px}nav#menu{align-items:center;display:flex;grid-area:nav;justify-content:flex-end}nav#menu .menu__item{color:var(--fg)}nav#menu .menu__item:hover{color:var(--fg3);cursor:pointer}nav#menu ul{list-style:none;margin:0;padding:0}nav#menu ul.menu--horizontal{align-items:center;display:none}nav#menu ul.menu--horizontal li{display:inline-block;margin:0 .75rem}@media (min-width:768px){nav#menu ul.menu--horizontal{display:flex}}nav#menu ul.menu--vertical{background:var(--fg0);bottom:0;margin:0;padding:3rem;position:fixed;right:0;top:0;transform:translate(100%);transition:transform .5s cubic-bezier(.9,0,.1,1);width:50%;z-index:10}nav#menu ul.menu--vertical .menu__item{color:var(--bg1)}nav#menu ul.menu--vertical .menu__item:hover{color:var(--bg4)}nav#menu .menu__burger{display:flex;height:24px;width:24px}nav#menu .menu__burger>*{position:absolute}nav#menu .menu__burger svg{height:inherit;width:inherit;z-index:20}nav#menu .menu__burger svg line{transition-duration:.5s;transition-property:stroke,opacity,transform;transition-timing-function:cubic-bezier(.9,0,.1,1)}nav#menu .menu__burger svg line:first-of-type{transform-origin:center 6px}nav#menu .menu__burger svg line:nth-of-type(2){transform-origin:center 12px}nav#menu .menu__burger svg line:nth-of-type(3){transform-origin:center 18px}nav#menu .menu__burger input{height:inherit;opacity:0;width:inherit;z-index:30}nav#menu .menu__burger input:checked~ul.menu--vertical{transform:none}nav#menu .menu__burger input:checked~svg{stroke:var(--bg1)}nav#menu .menu__burger input:checked~svg line:first-of-type{transform:translateY(6px) rotate(45deg)}nav#menu .menu__burger input:checked~svg line:nth-of-type(2){opacity:0;transform:scale(.2)}nav#menu .menu__burger input:checked~svg line:nth-of-type(3){transform:translateY(-6px) rotate(-45deg)}@media (min-width:768px){nav#menu .menu__burger{display:none}}

/*! Source: https://stackoverflow.com/a/36118384/1154965 */@keyframes blink{50%{opacity:0}to{opacity:1}}.sidebar{font-family:Fira Code,Lucida Console,Monaco,monospace;font-family:var(--font-monospace);margin-left:auto;margin-right:auto;max-width:350px;padding-left:2.5rem}.sidebar svg{fill:var(--fg)}.sidebar__heading{font-size:1.3rem}aside.toc a{color:var(--aqua2);color:var(--primary-alt)}aside.toc a:hover{color:var(--aqua1);color:var(--primary)}aside.toc ul{list-style:none;margin:0;padding:0}aside.toc ul ul{font-size:.9rem;margin-left:.5rem}aside.toc ul li{line-height:1.1}aside.toc ul li a{display:block;padding:.2rem 0}.jr-basics__image{background:var(--bg1);border:2px solid var(--bg2)}.jr-basics__description{color:var(--fg3);font-family:Roboto Slab,Georgia,serif;font-family:var(--font-serif)}.jr-basics__profile a:hover{color:var(--fg3)}.jr-basics__profile a:hover svg{fill:var(--fg3)}.post{border-bottom:2px dotted var(--bg1);padding:2rem 0}.post-content__read-more,.post-header{font-family:Fira Code,Lucida Console,Monaco,monospace;font-family:var(--font-monospace)}.post-meta img:not(figure img){margin:.5rem 0}.post-content{margin:1.3rem 0}.post-content img:not(figure img){margin:.5rem 0;max-width:calc(100% - 2rem)}.post-content__read-more{margin-top:1.3rem}.post-content__read-more,.post-content a,.post-header a{color:var(--aqua2);color:var(--primary-alt)}.post-content a:hover,.post-header a:hover{color:var(--aqua1);color:var(--primary)}.post-tags{grid-gap:.9rem;display:flex;flex-wrap:wrap;gap:.9rem;margin:1rem 0}.post-tag{font-size:.9rem;line-height:1}.post-tag:before{content:"#"}.post-heading__anchor{display:none}h1:hover .post-heading__anchor,h2:hover .post-heading__anchor,h3:hover .post-heading__anchor,h4:hover .post-heading__anchor,h5:hover .post-heading__anchor{display:inline-block}.jr__item-meta{flex-direction:column}.jr-basics__image,.jr-basics__item,.jr-basics__profile-icon,.jr-basics__profile-item,.jr__item-meta{align-items:center;display:flex}.jr-basics__name,.jr-projects__roles,.jr-work__position{font-size:1.125rem;font-weight:700}.jr-basics__item{flex-direction:column;text-align:center}.jr-basics__item hr{margin:1.5rem auto}.jr-basics__image{border-radius:50%;height:250px;justify-content:center;overflow:hidden;width:250px}.jr-basics__description,.jr-basics__label,.jr-basics__name{margin-top:.75rem}.jr-basics__profile svg{height:24px;width:24px}.jr-basics__profile,.jr-basics__profile-item{display:flex}.jr-basics__profile-item{display:flex;padding:.2rem}.jr-basics__profile--col{flex-direction:column}.jr-basics__profile--row{flex-wrap:wrap;justify-content:space-evenly}.jr-basics__profile-icon{padding:0 .75rem}.jr__item-meta{align-items:start;flex-flow:column;font-family:Fira Code,Lucida Console,Monaco,monospace;font-family:var(--font-monospace)}@media (min-width:768px){.jr__item-meta{align-items:center;flex-flow:row wrap}.jr-work__location,.jr__date-range{flex-grow:1;text-align:right}}#cookie-consent{-webkit-animation:fadeIn .75s;animation:fadeIn .75s;background:var(--bg);border-radius:.2rem;bottom:1rem;box-shadow:0 -.5rem 1rem var(--bg1);font-family:Fira Code,Lucida Console,Monaco,monospace;font-family:var(--font-monospace);left:1rem;padding:1rem;position:fixed;right:1rem;z-index:2000}@media (min-width:768px){#cookie-consent{padding:2.5rem}}#cookie-consent button{background:none;border:none;color:var(--aqua2);color:var(--primary-alt);font-size:1.125rem;margin:0 1rem;white-space:nowrap}#cookie-consent button:hover{color:var(--aqua1);color:var(--primary);cursor:pointer}.cookie-consent--hidden{display:none}.cli-prompt{display:flex;justify-content:center}.cli-prompt__cursor{-webkit-animation:blink 1s infinite;animation:blink 1s infinite}@keyframes fadeIn{0%{opacity:0}to{opacity:1}}</style>
<link rel=preload href="/css/non-critical.155ced3be007d4b3c136296f991c092874375053ed6707511d3928e521e1e391bb1f91ddb4fd02db4d9658229b36f12b9f17633d5795441362050df7014f0fec.css" as=style onload="this.onload=null,this.rel='stylesheet'" integrity="sha512-FVztO+AH1LPBNilvmRwJKHQ3UFPtZwdRHTko5SHh45G7H5HdtP0C202WWCKbNvErnxdjPVeVRBNiBQ33AU8P7A==">
<link id=prism-dark rel=prefetch href=/prism-themes/prism-gruvbox-dark.min.54aecc64074623a4f9898544dcbdab9e804f1560ef0b38f4cf8e10fcaaf72264e798cb407c601aca6ecd833ec4eb93d66535581f18d45ba202cf848b70dbc332.css as=style onload="this.onload=null,this.rel='stylesheet'" integrity="sha512-VK7MZAdGI6T5iYVE3L2rnoBPFWDvCzj0z44Q/Kr3ImTnmMtAfGAaym7Ngz7E65PWZTVYHxjUW6ICz4SLcNvDMg==">
<link id=prism-light rel=prefetch href=/prism-themes/prism-gruvbox-light.min.42a221741efe997fcc94187c39d63c555560678789ac9ca856c74a5f0ddb2aa6c50d38b2ffbecc7a99038cbbd2efa99746e862267f781c559e0cfec10b88a5fc.css as=style onload="this.onload=null,this.rel='stylesheet'" integrity="sha512-QqIhdB7+mX/MlBh8OdY8VVVgZ4eJrJyoVsdKXw3bKqbFDTiy/77MepkDjLvS76mXRuhiJn94HFWeDP7BC4il/A==" disabled>
<noscript>
<link rel=stylesheet href=/prism-themes/prism-gruvbox-dark.min.54aecc64074623a4f9898544dcbdab9e804f1560ef0b38f4cf8e10fcaaf72264e798cb407c601aca6ecd833ec4eb93d66535581f18d45ba202cf848b70dbc332.css integrity="sha512-VK7MZAdGI6T5iYVE3L2rnoBPFWDvCzj0z44Q/Kr3ImTnmMtAfGAaym7Ngz7E65PWZTVYHxjUW6ICz4SLcNvDMg==">
<link rel=stylesheet href="/css/non-critical.155ced3be007d4b3c136296f991c092874375053ed6707511d3928e521e1e391bb1f91ddb4fd02db4d9658229b36f12b9f17633d5795441362050df7014f0fec.css" integrity="sha512-FVztO+AH1LPBNilvmRwJKHQ3UFPtZwdRHTko5SHh45G7H5HdtP0C202WWCKbNvErnxdjPVeVRBNiBQ33AU8P7A==">
</noscript>
<script>(()=>{function c(){if(localStorage&&localStorage.getItem("theme"))return localStorage.getItem("theme");if(window.matchMedia)return window.matchMedia("(prefers-color-scheme: light)").matches?"light":"dark"}function a(a){document.documentElement.setAttribute("theme",a);let b=document.getElementById("prism-dark"),c=document.getElementById("prism-light");b.toggleAttribute("disabled",a==="light"),c.toggleAttribute("disabled",a==="dark"),localStorage.setItem("theme",a)}var b=c();b&&a(b);function d(b){let c=b.currentTarget.classList.contains("light--hidden")?"light":"dark";a(c)}document.addEventListener("DOMContentLoaded",function(){document.querySelectorAll(".theme__toggle").forEach(a=>{a.addEventListener("click",d)})})})()</script>
<link rel=apple-touch-icon sizes=180x180 href=/apple-touch-icon.png>
<link rel=icon type=image/png sizes=32x32 href=/favicon-32x32.png>
<link rel=icon type=image/png sizes=16x16 href=/favicon-16x16.png>
<link rel=manifest href=/site.webmanifest>
<meta name=msapplication-TileColor content="#282828">
<meta name=theme-color content="#282828">
</head>
<body>
<div class=layout>
<header>
<a class=logo href=/>
<div class=logo__text>schnerring.net</div>
<div class=logo__chevron>></div>
<div class=logo__cursor>█</div>
</a>
<div class=search>
<input id=search__text type=search placeholder=Search... aria-label=Search autocomplete=off>
<div id=search__suggestions class=search__suggestions--hidden></div>
</div>
<nav id=menu>
<ul class=menu--horizontal>
<li class=menu__item>
<a href=/blog>Blog</a>
</li>
<li class=menu__item>
<a href=/cv>CV</a>
</li>
<li class=menu__item>
<a href=/about>About</a>
</li>
<li class=menu__item>
<a href=/stats>Stats</a>
</li>
</ul>
<div class=menu__burger>
<input class=menu__item type=checkbox aria-label="Open main menu"><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-menu-2" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><line x1="4" y1="6" x2="20" y2="6"/><line x1="4" y1="12" x2="20" y2="12"/><line x1="4" y1="18" x2="20" y2="18"/></svg>
<ul class=menu--vertical>
<li>
<a class=menu__item href=/blog>Blog</a>
</li>
<li>
<a class=menu__item href=/cv>CV</a>
</li>
<li>
<a class=menu__item href=/about>About</a>
</li>
<li>
<a class=menu__item href=/stats>Stats</a>
</li>
</ul>
</div>
</nav>
<button class="theme__toggle light--hidden" aria-label="Toggle light mode"><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-sun" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><circle cx="12" cy="12" r="4"/><path d="M3 12h1m8-9v1m8 8h1m-9 8v1M5.6 5.6l.7.7m12.1-.7-.7.7m0 11.4.7.7m-12.1-.7-.7.7"/></svg>
</button>
<button class="theme__toggle dark--hidden" aria-label="Toggle dark mode"><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-moon" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M12 3c.132.0.263.0.393.0a7.5 7.5.0 007.92 12.446A9 9 0 1112 2.992z"/></svg>
</button>
</header>
<main>
<div class=content>
<article class=post>
<div class=post-header>
<h1>
<a href=/blog/opnsense-baseline-guide-with-vpn-guest-and-vlan-support/>OPNsense Baseline Guide with Mullvad VPN Multi-WAN, Guest, and VLAN Support</a>
</h1>
<div class=post-meta>
<span>2021-11-17</span>
<div class=post-tags>
<a class=post-tag href=https://schnerring.net/tags/dns>dns</a>
<a class=post-tag href=https://schnerring.net/tags/dnsmasq>dnsmasq</a>
<a class=post-tag href=https://schnerring.net/tags/firewall>firewall</a>
<a class=post-tag href=https://schnerring.net/tags/homelab>homelab</a>
<a class=post-tag href=https://schnerring.net/tags/lets-encrypt>lets&#8209;encrypt</a>
<a class=post-tag href=https://schnerring.net/tags/mullvad>mullvad</a>
<a class=post-tag href=https://schnerring.net/tags/network>network</a>
<a class=post-tag href=https://schnerring.net/tags/opnsense>opnsense</a>
<a class=post-tag href=https://schnerring.net/tags/router>router</a>
<a class=post-tag href=https://schnerring.net/tags/self-host>self&#8209;host</a>
<a class=post-tag href=https://schnerring.net/tags/unbound>unbound</a>
<a class=post-tag href=https://schnerring.net/tags/vlan>vlan</a>
<a class=post-tag href=https://schnerring.net/tags/vpn>vpn</a>
<a class=post-tag href=https://schnerring.net/tags/wireguard>wireguard</a>
</div>
<picture>
<source srcset="/blog/opnsense-baseline-guide-with-vpn-guest-and-vlan-support/cover_hu8fd936697ab2ceae671766b2eeea7837_87332_300x0_resize_q90_h2_box_3.webp 300w,/blog/opnsense-baseline-guide-with-vpn-guest-and-vlan-support/cover_hu8fd936697ab2ceae671766b2eeea7837_87332_400x0_resize_q90_h2_box_3.webp 400w,/blog/opnsense-baseline-guide-with-vpn-guest-and-vlan-support/cover_hu8fd936697ab2ceae671766b2eeea7837_87332_500x0_resize_q90_h2_box_3.webp 500w,/blog/opnsense-baseline-guide-with-vpn-guest-and-vlan-support/cover_hu8fd936697ab2ceae671766b2eeea7837_87332_600x0_resize_q90_h2_box_3.webp 600w,/blog/opnsense-baseline-guide-with-vpn-guest-and-vlan-support/cover_hu8fd936697ab2ceae671766b2eeea7837_87332_617x0_resize_q90_h2_box_3.webp 617w">
<img src=/blog/opnsense-baseline-guide-with-vpn-guest-and-vlan-support/cover.png srcset="/blog/opnsense-baseline-guide-with-vpn-guest-and-vlan-support/cover_hu8fd936697ab2ceae671766b2eeea7837_87332_300x0_resize_box_3.png 300w,/blog/opnsense-baseline-guide-with-vpn-guest-and-vlan-support/cover_hu8fd936697ab2ceae671766b2eeea7837_87332_400x0_resize_box_3.png 400w,/blog/opnsense-baseline-guide-with-vpn-guest-and-vlan-support/cover_hu8fd936697ab2ceae671766b2eeea7837_87332_500x0_resize_box_3.png 500w,/blog/opnsense-baseline-guide-with-vpn-guest-and-vlan-support/cover_hu8fd936697ab2ceae671766b2eeea7837_87332_600x0_resize_box_3.png 600w,/blog/opnsense-baseline-guide-with-vpn-guest-and-vlan-support/cover_hu8fd936697ab2ceae671766b2eeea7837_87332_617x0_resize_box_3.png 617w" alt loading=lazy width=617 height=976>
</picture>
</div>
</div>
<div class=post-content>
<p>This beginner-friendly, step-by-step guide walks you through the initial configuration of your OPNsense firewall. The title of this guide is an homage to the <a href=https://nguvu.org/pfsense/pfsense-baseline-setup class=link--external target=_blank rel=noreferrer>pfSense baseline guide with VPN, Guest, and VLAN support</a> that some of you guys might know, and this is an <a href=https://opnsense.org class=link--external target=_blank rel=noreferrer>OPNsense</a> migration of it. I found that guide two years ago and immediately fell in love with the network setup. After researching for weeks, I decided to use OPNsense instead of pfSense. I bit the bullet and bought the <a href=https://www.deciso.com/product-catalog/dec630/ class=link--external target=_blank rel=noreferrer>Deciso DEC630</a> appliance. Albeit expensive and possibly overkill for my needs, I&rsquo;m happy to support the open-source mission of Deciso, the maintainers of OPNsense. The only thing I regret about the purchase is that I now can&rsquo;t afford the sexier-looking successor model, the <a href=https://shop.opnsense.com/dec600-series-opnsense-desktop-security-appliances/ class=link--external target=_blank rel=noreferrer>DEC690</a>.</p>
<p>To configure OPNsense, I followed the instructions of the pfSense guide, taking notes on the differences. Some options moved to different menus or changed. As my notes grew, I decided to publish them as a guide on my website.</p>
<p>My goal was to create a comprehensive guide that&rsquo;s easy to follow. But I tried to strike a different balance regarding the brevity of the instructions compared to the pfSense guide. It&rsquo;s a matter of personal taste, but I find the instructions in that guide too verbose. I intentionally omit most of the repetitive &ldquo;click save and apply&rdquo; instructions and only list configuration changes deviating from defaults, making exceptions for important settings. I consider the OPNsense defaults stable enough for this approach in the hope of keeping the effort required to maintain this guide to a minimum.</p>
<p>I&rsquo;m a homelab hobbyist, so be warned that this guide likely contains errors. Please, verify the steps yourself and do your research. I hope this guide is as helpful and inspiring to you as the pfSense guide was to me. Your feedback is always welcome and very much appreciated.</p>
<h2 id=overview>
Overview
<a href=#overview class=post-heading__anchor aria-hidden=true>#</a>
</h2>
<h3 id=wan>
WAN
<a href=#wan class=post-heading__anchor aria-hidden=true>#</a>
</h3>
<ul>
<li>DHCP WAN from a single Internet Service Provider (ISP)</li>
<li><a href=https://mullvad.net class=link--external target=_blank rel=noreferrer>Mullvad VPN</a> multi-WAN with gateway groups</li>
</ul>
<h3 id=lan>
LAN
<a href=#lan class=post-heading__anchor aria-hidden=true>#</a>
</h3>
<p>We segregate the local network into several areas with different requirements.</p>
<h4 id=management-network-vlan-10>
Management Network (VLAN 10)
<a href=#management-network-vlan-10 class=post-heading__anchor aria-hidden=true>#</a>
</h4>
<p>The Management network connects native management interfaces like WiFi access points and IPMI interfaces.</p>
<h4 id=vpn-network-vlan-20>
VPN Network (VLAN 20)
<a href=#vpn-network-vlan-20 class=post-heading__anchor aria-hidden=true>#</a>
</h4>
<p>The primary LAN network uses the WireGuard VPN tunnels for outbound connections, maximizing privacy and security. If the VPN tunnels fail, outbound connections won&rsquo;t be possible. Exceptions to selectively route traffic through the ISP WAN gateway are possible.</p>
<h4 id=clear-network-vlan-30>
&ldquo;Clear&rdquo; Network (VLAN 30)
<a href=#clear-network-vlan-30 class=post-heading__anchor aria-hidden=true>#</a>
</h4>
<p>General-purpose web access network that doesn&rsquo;t use VPN tunnels. All outgoing connections leave through the ISP WAN gateway. It serves as a backup network in case the VPN tunnels fail.</p>
<h4 id=guest-network-vlan-40>
Guest Network (VLAN 40)
<a href=#guest-network-vlan-40 class=post-heading__anchor aria-hidden=true>#</a>
</h4>
<p>The network that visitors use. It allows unrestricted internet access. Local networks aren&rsquo;t accessible.</p>
<h4 id=lan-network>
LAN Network
<a href=#lan-network class=post-heading__anchor aria-hidden=true>#</a>
</h4>
<p>&ldquo;Native&rdquo; VLAN, used to debug and test new configurations.</p>
<h3 id=dns-services>
DNS Services
<a href=#dns-services class=post-heading__anchor aria-hidden=true>#</a>
</h3>
<p>We&rsquo;ll configure a DNS resolver (Unbound), as well as a DNS forwarder (Dnsmasq) in OPNsense. Management and VPN networks will use the resolver, the Clear network will use the forwarder, and the Guest network will use Cloudflare as an external DNS resolver. <a href=#dns>We&rsquo;ll dig into the details later</a>.</p>
<h2 id=hardware-selection-and-installation>
Hardware Selection and Installation
<a href=#hardware-selection-and-installation class=post-heading__anchor aria-hidden=true>#</a>
</h2>
<p>The original pfSense guide features a <a href=https://nguvu.org/pfsense/pfsense-baseline-setup/#Hardware%20selection class=link--external target=_blank rel=noreferrer>large section of hardware recommendations</a> and <a href=https://nguvu.org/pfsense/pfsense-baseline-setup/#Install%20pfSense class=link--external target=_blank rel=noreferrer>installation instructions</a>.</p>
<p>As mentioned earlier, I bought the <a href=https://www.deciso.com/product-catalog/dec630/ class=link--external target=_blank rel=noreferrer>Deciso DEC630</a> appliance, which is why I&rsquo;m not advising on hardware choices. Have a look at the <a href=https://docs.opnsense.org/manual/hardware.html class=link--external target=_blank rel=noreferrer>official hardware sizing & setup guidelines</a> for more information. See also <a href=https://docs.opnsense.org/manual/install.html class=link--external target=_blank rel=noreferrer>Initial Installation & Configuration</a>.</p>
<p>I verified this guide with a clean install of OPNsense version <code>21.7.5</code>.</p>
<h2 id=wizard>
Wizard
<a href=#wizard class=post-heading__anchor aria-hidden=true>#</a>
</h2>
<p>Navigate to <code>192.168.1.1</code> in your browser and login with default credentials:</p>
<ul>
<li><strong>Username</strong>: <code>root</code></li>
<li><strong>Password</strong>: <code>opnsense</code></li>
</ul>
<p>Click <code>Next</code> to leave the welcome screen and get started with the initial wizard configuration.</p>
<h3 id=general-information>
General Information
<a href=#general-information class=post-heading__anchor aria-hidden=true>#</a>
</h3>
<p>
<picture>
<source srcset="/blog/opnsense-baseline-guide-with-vpn-guest-and-vlan-support/wizard-general-config_hu8b83ac7146e2cadaaffbf6e12a6d6fa5_9543_300x0_resize_q90_h2_box_3.webp 300w,/blog/opnsense-baseline-guide-with-vpn-guest-and-vlan-support/wizard-general-config_hu8b83ac7146e2cadaaffbf6e12a6d6fa5_9543_400x0_resize_q90_h2_box_3.webp 400w,/blog/opnsense-baseline-guide-with-vpn-guest-and-vlan-support/wizard-general-config_hu8b83ac7146e2cadaaffbf6e12a6d6fa5_9543_500x0_resize_q90_h2_box_3.webp 500w,/blog/opnsense-baseline-guide-with-vpn-guest-and-vlan-support/wizard-general-config_hu8b83ac7146e2cadaaffbf6e12a6d6fa5_9543_507x0_resize_q90_h2_box_3.webp 507w">
<img src=/blog/opnsense-baseline-guide-with-vpn-guest-and-vlan-support/wizard-general-config.png srcset="/blog/opnsense-baseline-guide-with-vpn-guest-and-vlan-support/wizard-general-config_hu8b83ac7146e2cadaaffbf6e12a6d6fa5_9543_300x0_resize_box_3.png 300w,/blog/opnsense-baseline-guide-with-vpn-guest-and-vlan-support/wizard-general-config_hu8b83ac7146e2cadaaffbf6e12a6d6fa5_9543_400x0_resize_box_3.png 400w,/blog/opnsense-baseline-guide-with-vpn-guest-and-vlan-support/wizard-general-config_hu8b83ac7146e2cadaaffbf6e12a6d6fa5_9543_500x0_resize_box_3.png 500w,/blog/opnsense-baseline-guide-with-vpn-guest-and-vlan-support/wizard-general-config_hu8b83ac7146e2cadaaffbf6e12a6d6fa5_9543_507x0_resize_box_3.png 507w" alt="Screenshot of the general wizard settings" loading=lazy width=507 height=584>
</picture>
</p>
<p>I prefer using the DNS servers of <a href=https://quad9.org/ class=link--external target=_blank rel=noreferrer>Quad9</a> over the ones of my ISP. Only the Clear network will use these anyway, as secured networks use Unbound instead. The Guest network will use Cloudflare DNS servers.</p>
<p>For the domain, I prefer to use a subdomain of a domain name I own, like <code>corp.example.com</code>. I only use this subdomain internally. I consider the <code>local.lan</code> pattern a relic of the past. To prevent our local network structure from leaking to the outside world, we&rsquo;ll later configure Unbound and Dnsmasq to treat the domain as private.</p>
<table>
<thead>
<tr>
<th></th>
<th></th>
</tr>
</thead>
<tbody>
<tr>
<td>Domain</td>
<td><code>corp.example.com</code></td>
</tr>
<tr>
<td>Primary DNS Server</td>
<td><code>9.9.9.9</code></td>
</tr>
<tr>
<td>Secondary DNS Server</td>
<td><code>149.112.112.112</code></td>
</tr>
<tr>
<td>Override DNS</td>
<td><code>unchecked</code></td>
</tr>
<tr>
<td>Enable DNSSEC Support</td>
<td><code>checked</code></td>
</tr>
<tr>
<td>Harden DNSSEC data</td>
<td><code>checked</code></td>
</tr>
</tbody>
</table>
<p>If you prefer using your ISP&rsquo;s DNS servers, leave the <strong>Override DNS</strong> option checked.</p>
<h3 id=time-server-information>
Time Server Information
<a href=#time-server-information class=post-heading__anchor aria-hidden=true>#</a>
</h3>
<p>Choose the NTP servers geographically closest to your location. I live in Switzerland, which makes the <a href=https://www.pool.ntp.org/zone/ch class=link--external target=_blank rel=noreferrer>servers from the <code>ch.pool.ntp.org</code> pool</a> the natural choice.</p>
<table>
<thead>
<tr>
<th></th>
<th></th>
</tr>
</thead>
<tbody>
<tr>
<td>Time server hostname</td>
<td><code>0.ch.pool.ntp.org 1.ch.pool.ntp.org 2.ch.pool.ntp.org 3.ch.pool.ntp.org</code></td>
</tr>
<tr>
<td>Timezone</td>
<td><code>Europe/Zurich</code></td>
</tr>
</tbody>
</table>
<h3 id=configure-interfaces>
Configure Interfaces
<a href=#configure-interfaces class=post-heading__anchor aria-hidden=true>#</a>
</h3>
<p>By default, the WAN interface obtains an IP address from your ISP via DHCP. DHCP is also configured for the LAN interface by default and has the IP <code>192.168.1.1</code>. It works for most people, so we just keep the defaults.</p>
<h3 id=set-root-password>
Set Root Password
<a href=#set-root-password class=post-heading__anchor aria-hidden=true>#</a>
</h3>
<p>Choose a strong root password and complete the wizard.</p>
<h2 id=general-settings>
General Settings
<a href=#general-settings class=post-heading__anchor aria-hidden=true>#</a>
</h2>
<h3 id=access>
Access
<a href=#access class=post-heading__anchor aria-hidden=true>#</a>
</h3>
<p>Navigate to <strong>System</strong><span> → </span>
<strong>Settings</strong><span> → </span>
<strong>Administration</strong>.</p>
<table>
<thead>
<tr>
<th>HTTP Redirect</th>
<th></th>
</tr>
</thead>
<tbody>
<tr>
<td>Disable web GUI redirect rule</td>
<td><code>checked</code></td>
</tr>
</tbody>
</table>
<p>Permitting root user login and password login is a quick and dirty way of enabling SSH access, but I strongly discourage you from doing it. They are disabled for security reasons. I highly recommend using certificate- or <a href=https://www.digitalocean.com/community/tutorials/how-to-configure-ssh-key-based-authentication-on-a-linux-server class=link--external target=_blank rel=noreferrer>key-based authentication</a>. If your device has a serial console port, like the Deciso DEC630, enabling SSH is not required.</p>
<table>
<thead>
<tr>
<th>Secure Shell</th>
<th></th>
<th></th>
</tr>
</thead>
<tbody>
<tr>
<td>Secure Shell Server</td>
<td><code>checked</code></td>
<td></td>
</tr>
</tbody>
</table>
<table>
<thead>
<tr>
<th>Authentication</th>
<th></th>
<th></th>
</tr>
</thead>
<tbody>
<tr>
<td>Sudo</td>
<td><code>Ask password</code></td>
<td>Permit sudo usage for administrators with shell access.</td>
</tr>
</tbody>
</table>
<p>Navigate to <strong>System</strong><span> → </span>
<strong>Access</strong><span> → </span>
<strong>Users</strong> and add a new user.</p>
<table>
<thead>
<tr>
<th></th>
<th></th>
</tr>
</thead>
<tbody>
<tr>
<td>Username</td>
<td><code>&lt;choose a username></code></td>
</tr>
<tr>
<td>Password</td>
<td><code>&lt;choose a secure password></code></td>
</tr>
<tr>
<td>Login shell</td>
<td><code>/bin/csh</code></td>
</tr>
<tr>
<td>Group Memberships</td>
<td><code>admins</code></td>
</tr>
<tr>
<td>Authorized keys</td>
<td><code>&lt;valid SSH public key></code></td>
</tr>
</tbody>
</table>
<p>Configuring the SSH client and generating keys is out of scope for this guide, so I&rsquo;ll just recommend this <a href=https://www.digitalocean.com/community/tutorials/ssh-essentials-working-with-ssh-servers-clients-and-keys class=link--external target=_blank rel=noreferrer>DigitalOcean tutorial covering SSH essentials</a>.</p>
<h3 id=miscellaneous>
Miscellaneous
<a href=#miscellaneous class=post-heading__anchor aria-hidden=true>#</a>
</h3>
<p>Navigate to <strong>System</strong><span> → </span>
<strong>Settings</strong><span> → </span>
<strong>Miscellaneous</strong>.</p>
<table>
<thead>
<tr>
<th>Power Savings</th>
<th></th>
</tr>
</thead>
<tbody>
<tr>
<td>Use PowerD</td>
<td><code>checked</code></td>
</tr>
<tr>
<td>Power Mode</td>
<td><code>Hiadaptive</code></td>
</tr>
</tbody>
</table>
<p>Choose <strong>Cryptography settings</strong> and <strong>Thermal Sensors</strong> settings compatible with your hardware.</p>
<h3 id=firewall-settings>
Firewall Settings
<a href=#firewall-settings class=post-heading__anchor aria-hidden=true>#</a>
</h3>
<p>Navigate to <strong>Firewall</strong><span> → </span>
<strong>Settings</strong><span> → </span>
<strong>Advanced</strong>.</p>
<p>Although IPv6 is something I want to use, it&rsquo;s out of scope for this guide, so we uncheck the following.</p>
<table>
<thead>
<tr>
<th></th>
<th></th>
</tr>
</thead>
<tbody>
<tr>
<td>Allow IPv6</td>
<td><code>unchecked</code></td>
</tr>
</tbody>
</table>
<p>When a rule uses a specific gateway and goes down, a rule gets created, sending traffic to the default gateway. Checking this option skips the creation of this rule.</p>
<table>
<thead>
<tr>
<th>Gateway Monitoring</th>
<th></th>
</tr>
</thead>
<tbody>
<tr>
<td>Skip rules</td>
<td><code>checked</code></td>
</tr>
</tbody>
</table>
<p>Depending on your hardware, you might want to tweak the following settings to improve performance.</p>
<table>
<thead>
<tr>
<th>Miscellaneous</th>
<th></th>
<th></th>
</tr>
</thead>
<tbody>
<tr>
<td>Firewall Optimization</td>
<td><code>conservative</code></td>
<td>Tries to avoid dropping any legitimate idle connections at the expense of increased memory usage and CPU utilization.</td>
</tr>
<tr>
<td>Firewall Maximum Table Entries</td>
<td><code>2000000</code></td>
<td>default is 1'000'000</td>
</tr>
</tbody>
</table>
<p>We disable the auto-generated anti-lockout rule because we&rsquo;ll define it manually later.</p>
<table>
<thead>
<tr>
<th></th>
<th></th>
</tr>
</thead>
<tbody>
<tr>
<td>Disable anti-lockout</td>
<td><code>checked</code></td>
</tr>
</tbody>
</table>
<h3 id=checksum-offloading>
Checksum Offloading
<a href=#checksum-offloading class=post-heading__anchor aria-hidden=true>#</a>
</h3>
<p>For some hardware, checksum offloading doesn&rsquo;t work, particularly some Realtek cards. Rarely, drivers may have problems with checksum offloading and some specific NICs. If your hardware is incompatible with checksum offloading, disable it.</p>
<p>Navigate to <strong>Interfaces</strong><span> → </span>
<strong>Settings</strong>.</p>
<table>
<thead>
<tr>
<th></th>
<th></th>
<th></th>
</tr>
</thead>
<tbody>
<tr>
<td>Hardware CRC</td>
<td><code>unchecked</code></td>
<td>Disable hardware checksum offload</td>
</tr>
</tbody>
</table>
<h2 id=vlans>
VLANs
<a href=#vlans class=post-heading__anchor aria-hidden=true>#</a>
</h2>
<h3 id=switch-choice>
Switch Choice
<a href=#switch-choice class=post-heading__anchor aria-hidden=true>#</a>
</h3>
<p>A 802.1Q-capable switch with properly configured VLANs is required. Check my <a href=/posts/router-on-a-stick-vlan-configuration-with-swos-on-the-mikrotik-crs328-24p-4s+rm-switch>router on a stick VLAN configuration guide</a> to see an example setup with a <a href=https://mikrotik.com/ class=link--external target=_blank rel=noreferrer>Mikrotik</a> switch.</p>
<h3 id=vlan-definitions>
VLAN Definitions
<a href=#vlan-definitions class=post-heading__anchor aria-hidden=true>#</a>
</h3>
<p>Typically, the <code>LAN</code> port also carries the VLAN traffic and functions as <a href=https://www.techopedia.com/definition/27008/trunk-port class=link--external target=_blank rel=noreferrer>trunk port</a>. For me, the default is the <code>igb0</code> port. I chose it as the parent interface for all VLANs in the following steps.</p>
<p>
<picture>
<source srcset="/blog/opnsense-baseline-guide-with-vpn-guest-and-vlan-support/vlan-configuration_hub6ce23d0e7de40666aba4cfb90600a35_5323_300x0_resize_q90_h2_box_3.webp 300w,/blog/opnsense-baseline-guide-with-vpn-guest-and-vlan-support/vlan-configuration_hub6ce23d0e7de40666aba4cfb90600a35_5323_400x0_resize_q90_h2_box_3.webp 400w,/blog/opnsense-baseline-guide-with-vpn-guest-and-vlan-support/vlan-configuration_hub6ce23d0e7de40666aba4cfb90600a35_5323_500x0_resize_q90_h2_box_3.webp 500w,/blog/opnsense-baseline-guide-with-vpn-guest-and-vlan-support/vlan-configuration_hub6ce23d0e7de40666aba4cfb90600a35_5323_600x0_resize_q90_h2_box_3.webp 600w,/blog/opnsense-baseline-guide-with-vpn-guest-and-vlan-support/vlan-configuration_hub6ce23d0e7de40666aba4cfb90600a35_5323_618x0_resize_q90_h2_box_3.webp 618w">
<img src=/blog/opnsense-baseline-guide-with-vpn-guest-and-vlan-support/vlan-configuration.png srcset="/blog/opnsense-baseline-guide-with-vpn-guest-and-vlan-support/vlan-configuration_hub6ce23d0e7de40666aba4cfb90600a35_5323_300x0_resize_box_3.png 300w,/blog/opnsense-baseline-guide-with-vpn-guest-and-vlan-support/vlan-configuration_hub6ce23d0e7de40666aba4cfb90600a35_5323_400x0_resize_box_3.png 400w,/blog/opnsense-baseline-guide-with-vpn-guest-and-vlan-support/vlan-configuration_hub6ce23d0e7de40666aba4cfb90600a35_5323_500x0_resize_box_3.png 500w,/blog/opnsense-baseline-guide-with-vpn-guest-and-vlan-support/vlan-configuration_hub6ce23d0e7de40666aba4cfb90600a35_5323_600x0_resize_box_3.png 600w,/blog/opnsense-baseline-guide-with-vpn-guest-and-vlan-support/vlan-configuration_hub6ce23d0e7de40666aba4cfb90600a35_5323_618x0_resize_box_3.png 618w" alt="Screenshot of VLAN configurations" loading=lazy width=618 height=210>
</picture>
</p>
<p>Navigate to <strong>Interfaces</strong><span> → </span>
<strong>Other Types</strong><span> → </span>
<strong>VLAN</strong> and add the VLANs.</p>
<h4 id=management-vlan>
Management VLAN
<a href=#management-vlan class=post-heading__anchor aria-hidden=true>#</a>
</h4>
<table>
<thead>
<tr>
<th></th>
<th></th>
</tr>
</thead>
<tbody>
<tr>
<td>Parent Interface</td>
<td><code>igb0</code></td>
</tr>
<tr>
<td>VLAN tag</td>
<td><code>10</code></td>
</tr>
<tr>
<td>Description</td>
<td><code>VLAN10_MANAGE</code></td>
</tr>
</tbody>
</table>
<h4 id=vpn-vlan>
VPN VLAN
<a href=#vpn-vlan class=post-heading__anchor aria-hidden=true>#</a>
</h4>
<table>
<thead>
<tr>
<th></th>
<th></th>
</tr>
</thead>
<tbody>
<tr>
<td>Parent Interface</td>
<td><code>igb0</code></td>
</tr>
<tr>
<td>VLAN tag</td>
<td><code>20</code></td>
</tr>
<tr>
<td>Description</td>
<td><code>VLAN20_VPN</code></td>
</tr>
</tbody>
</table>
<h4 id=clear-vlan>
Clear VLAN
<a href=#clear-vlan class=post-heading__anchor aria-hidden=true>#</a>
</h4>
<table>
<thead>
<tr>
<th></th>
<th></th>
</tr>
</thead>
<tbody>
<tr>
<td>Parent Interface</td>
<td><code>igb0</code></td>
</tr>
<tr>
<td>VLAN tag</td>
<td><code>30</code></td>
</tr>
<tr>
<td>Description</td>
<td><code>VLAN30_CLEAR</code></td>
</tr>
</tbody>
</table>
<h4 id=guest-vlan>
Guest VLAN
<a href=#guest-vlan class=post-heading__anchor aria-hidden=true>#</a>
</h4>
<table>
<thead>
<tr>
<th></th>
<th></th>
</tr>
</thead>
<tbody>
<tr>
<td>Parent Interface</td>
<td><code>igb0</code></td>
</tr>
<tr>
<td>VLAN tag</td>
<td><code>40</code></td>
</tr>
<tr>
<td>Description</td>
<td><code>VLAN40_GUEST</code></td>
</tr>
</tbody>
</table>
<h3 id=vlan-interfaces>
VLAN Interfaces
<a href=#vlan-interfaces class=post-heading__anchor aria-hidden=true>#</a>
</h3>
<p>We add an interface for each VLAN. Navigate to <strong>Interfaces</strong><span> → </span>
<strong>Assignments</strong>.</p>
<p>
<picture>
<source srcset="/blog/opnsense-baseline-guide-with-vpn-guest-and-vlan-support/interface-assignments_hu6d5e11eb3afc358d6e73608601dc3f13_24138_300x0_resize_q90_h2_box_3.webp 300w,/blog/opnsense-baseline-guide-with-vpn-guest-and-vlan-support/interface-assignments_hu6d5e11eb3afc358d6e73608601dc3f13_24138_400x0_resize_q90_h2_box_3.webp 400w,/blog/opnsense-baseline-guide-with-vpn-guest-and-vlan-support/interface-assignments_hu6d5e11eb3afc358d6e73608601dc3f13_24138_500x0_resize_q90_h2_box_3.webp 500w,/blog/opnsense-baseline-guide-with-vpn-guest-and-vlan-support/interface-assignments_hu6d5e11eb3afc358d6e73608601dc3f13_24138_600x0_resize_q90_h2_box_3.webp 600w,/blog/opnsense-baseline-guide-with-vpn-guest-and-vlan-support/interface-assignments_hu6d5e11eb3afc358d6e73608601dc3f13_24138_700x0_resize_q90_h2_box_3.webp 700w">
<img src=/blog/opnsense-baseline-guide-with-vpn-guest-and-vlan-support/interface-assignments.png srcset="/blog/opnsense-baseline-guide-with-vpn-guest-and-vlan-support/interface-assignments_hu6d5e11eb3afc358d6e73608601dc3f13_24138_300x0_resize_box_3.png 300w,/blog/opnsense-baseline-guide-with-vpn-guest-and-vlan-support/interface-assignments_hu6d5e11eb3afc358d6e73608601dc3f13_24138_400x0_resize_box_3.png 400w,/blog/opnsense-baseline-guide-with-vpn-guest-and-vlan-support/interface-assignments_hu6d5e11eb3afc358d6e73608601dc3f13_24138_500x0_resize_box_3.png 500w,/blog/opnsense-baseline-guide-with-vpn-guest-and-vlan-support/interface-assignments_hu6d5e11eb3afc358d6e73608601dc3f13_24138_600x0_resize_box_3.png 600w,/blog/opnsense-baseline-guide-with-vpn-guest-and-vlan-support/interface-assignments_hu6d5e11eb3afc358d6e73608601dc3f13_24138_700x0_resize_box_3.png 700w" alt="Screenshot of interface assignments" loading=lazy width=706 height=488>
</picture>
</p>
<ul>
<li>Select <code>vlan 10</code>, enter the description <code>VLAN10_MANAGE</code>, and click <code>+</code></li>
<li>Select <code>vlan 20</code>, enter the description <code>VLAN20_VPN</code>, and click <code>+</code></li>
<li>Select <code>vlan 30</code>, enter the description <code>VLAN30_CLEAR</code>, and click <code>+</code></li>
<li>Select <code>vlan 40</code>, enter the description <code>VLAN40_GUEST</code>, and click <code>+</code></li>
</ul>
<p>Click <code>Save</code>.</p>
<h3 id=vlan-interface-ips>
VLAN Interface IPs
<a href=#vlan-interface-ips class=post-heading__anchor aria-hidden=true>#</a>
</h3>
<p>To easier remember which IP range belongs to which VLAN, I like the convention of matching the third octet of the IP with the VLAN ID. I.e., assigning the VLAN with the ID <strong>10</strong> the address 192.168.<strong>10</strong>.0/24.</p>
<p>
<picture>
<source srcset="/blog/opnsense-baseline-guide-with-vpn-guest-and-vlan-support/interface-ip-config_hu15b6ea6fa19c9cf997331864e07b7a23_32492_300x0_resize_q90_h2_box_3.webp 300w,/blog/opnsense-baseline-guide-with-vpn-guest-and-vlan-support/interface-ip-config_hu15b6ea6fa19c9cf997331864e07b7a23_32492_400x0_resize_q90_h2_box_3.webp 400w,/blog/opnsense-baseline-guide-with-vpn-guest-and-vlan-support/interface-ip-config_hu15b6ea6fa19c9cf997331864e07b7a23_32492_500x0_resize_q90_h2_box_3.webp 500w,/blog/opnsense-baseline-guide-with-vpn-guest-and-vlan-support/interface-ip-config_hu15b6ea6fa19c9cf997331864e07b7a23_32492_600x0_resize_q90_h2_box_3.webp 600w,/blog/opnsense-baseline-guide-with-vpn-guest-and-vlan-support/interface-ip-config_hu15b6ea6fa19c9cf997331864e07b7a23_32492_636x0_resize_q90_h2_box_3.webp 636w">
<img src=/blog/opnsense-baseline-guide-with-vpn-guest-and-vlan-support/interface-ip-config.png srcset="/blog/opnsense-baseline-guide-with-vpn-guest-and-vlan-support/interface-ip-config_hu15b6ea6fa19c9cf997331864e07b7a23_32492_300x0_resize_box_3.png 300w,/blog/opnsense-baseline-guide-with-vpn-guest-and-vlan-support/interface-ip-config_hu15b6ea6fa19c9cf997331864e07b7a23_32492_400x0_resize_box_3.png 400w,/blog/opnsense-baseline-guide-with-vpn-guest-and-vlan-support/interface-ip-config_hu15b6ea6fa19c9cf997331864e07b7a23_32492_500x0_resize_box_3.png 500w,/blog/opnsense-baseline-guide-with-vpn-guest-and-vlan-support/interface-ip-config_hu15b6ea6fa19c9cf997331864e07b7a23_32492_600x0_resize_box_3.png 600w,/blog/opnsense-baseline-guide-with-vpn-guest-and-vlan-support/interface-ip-config_hu15b6ea6fa19c9cf997331864e07b7a23_32492_636x0_resize_box_3.png 636w" alt="Screenshot of VLAN logical interface configuration" loading=lazy width=636 height=978>
</picture>
</p>
<h4 id=interface-vlan10_manage>
Interface: VLAN10_MANAGE
<a href=#interface-vlan10_manage class=post-heading__anchor aria-hidden=true>#</a>
</h4>
<p>Select the <code>VLAN10_MANAGE</code> interface.</p>
<table>
<thead>
<tr>
<th></th>
<th></th>
</tr>
</thead>
<tbody>
<tr>
<td>Enable Interface</td>
<td><code>checked</code></td>
</tr>
<tr>
<td>IPv4 Configuration Type</td>
<td><code>Static IPv4</code></td>
</tr>
<tr>
<td>IPv4 Address</td>
<td><code>192.168.10.1/24</code></td>
</tr>
</tbody>
</table>
<p>Click <code>Save</code>.</p>
<h4 id=interface-vlan20_vpn>
Interface: VLAN20_VPN
<a href=#interface-vlan20_vpn class=post-heading__anchor aria-hidden=true>#</a>
</h4>
<table>
<thead>
<tr>
<th></th>
<th></th>
</tr>
</thead>
<tbody>
<tr>
<td>Enable Interface</td>
<td><code>checked</code></td>
</tr>
<tr>
<td>IPv4 Configuration Type</td>
<td><code>Static IPv4</code></td>
</tr>
<tr>
<td>IPv4 Address</td>
<td><code>192.168.20.1/24</code></td>
</tr>
</tbody>
</table>
<h4 id=interface-vlan30_clear>
Interface: VLAN30_CLEAR
<a href=#interface-vlan30_clear class=post-heading__anchor aria-hidden=true>#</a>
</h4>
<table>
<thead>
<tr>
<th></th>
<th></th>
</tr>
</thead>
<tbody>
<tr>
<td>Enable Interface</td>
<td><code>checked</code></td>
</tr>
<tr>
<td>IPv4 Configuration Type</td>
<td><code>Static IPv4</code></td>
</tr>
<tr>
<td>IPv4 Address</td>
<td><code>192.168.30.1/24</code></td>
</tr>
</tbody>
</table>
<h4 id=interface-vlan40_guest>
Interface: VLAN40_GUEST
<a href=#interface-vlan40_guest class=post-heading__anchor aria-hidden=true>#</a>
</h4>
<table>
<thead>
<tr>
<th></th>
<th></th>
</tr>
</thead>
<tbody>
<tr>
<td>Enable Interface</td>
<td><code>checked</code></td>
</tr>
<tr>
<td>IPv4 Configuration Type</td>
<td><code>Static IPv4</code></td>
</tr>
<tr>
<td>IPv4 Address</td>
<td><code>192.168.40.1/24</code></td>
</tr>
</tbody>
</table>
<h3 id=vlan-interface-dhcp>
VLAN Interface DHCP
<a href=#vlan-interface-dhcp class=post-heading__anchor aria-hidden=true>#</a>
</h3>
<p>We need to configure DHCP for each VLAN we created. I use <code>x.x.x.100-199</code> for dynamic and <code>x.x.x.10.10-99</code> for static IP address assignments. You might want to amend these ranges to your requirements.</p>
<p>
<picture>
<source srcset="/blog/opnsense-baseline-guide-with-vpn-guest-and-vlan-support/interface-dhcp-config_hua5fb2eeb16211aa7d76fb3198b1a3fb7_13660_300x0_resize_q90_h2_box_3.webp 300w,/blog/opnsense-baseline-guide-with-vpn-guest-and-vlan-support/interface-dhcp-config_hua5fb2eeb16211aa7d76fb3198b1a3fb7_13660_400x0_resize_q90_h2_box_3.webp 400w,/blog/opnsense-baseline-guide-with-vpn-guest-and-vlan-support/interface-dhcp-config_hua5fb2eeb16211aa7d76fb3198b1a3fb7_13660_500x0_resize_q90_h2_box_3.webp 500w,/blog/opnsense-baseline-guide-with-vpn-guest-and-vlan-support/interface-dhcp-config_hua5fb2eeb16211aa7d76fb3198b1a3fb7_13660_600x0_resize_q90_h2_box_3.webp 600w,/blog/opnsense-baseline-guide-with-vpn-guest-and-vlan-support/interface-dhcp-config_hua5fb2eeb16211aa7d76fb3198b1a3fb7_13660_665x0_resize_q90_h2_box_3.webp 665w">
<img src=/blog/opnsense-baseline-guide-with-vpn-guest-and-vlan-support/interface-dhcp-config.png srcset="/blog/opnsense-baseline-guide-with-vpn-guest-and-vlan-support/interface-dhcp-config_hua5fb2eeb16211aa7d76fb3198b1a3fb7_13660_300x0_resize_box_3.png 300w,/blog/opnsense-baseline-guide-with-vpn-guest-and-vlan-support/interface-dhcp-config_hua5fb2eeb16211aa7d76fb3198b1a3fb7_13660_400x0_resize_box_3.png 400w,/blog/opnsense-baseline-guide-with-vpn-guest-and-vlan-support/interface-dhcp-config_hua5fb2eeb16211aa7d76fb3198b1a3fb7_13660_500x0_resize_box_3.png 500w,/blog/opnsense-baseline-guide-with-vpn-guest-and-vlan-support/interface-dhcp-config_hua5fb2eeb16211aa7d76fb3198b1a3fb7_13660_600x0_resize_box_3.png 600w,/blog/opnsense-baseline-guide-with-vpn-guest-and-vlan-support/interface-dhcp-config_hua5fb2eeb16211aa7d76fb3198b1a3fb7_13660_665x0_resize_box_3.png 665w" alt="Screenshot of VLAN interface DHCP configuration" loading=lazy width=665 height=352>
</picture>
</p>
<p>Navigate to <strong>Services</strong><span> → </span>
<strong>DHCPv4</strong>.</p>
<h4 id=dhcp-vlan10_manage>
DHCP: VLAN10_MANAGE
<a href=#dhcp-vlan10_manage class=post-heading__anchor aria-hidden=true>#</a>
</h4>
<p>Select <code>VLAN10_MANAGE</code>.</p>
<table>
<thead>
<tr>
<th></th>
<th></th>
</tr>
</thead>
<tbody>
<tr>
<td>Enable</td>
<td><code>checked</code></td>
</tr>
<tr>
<td>Range</td>
<td>from <code>192.168.10.100</code> to <code>192.168.10.199</code></td>
</tr>
</tbody>
</table>
<p>Click <code>Save</code>.</p>
<h4 id=dhcp-vlan20_vpn>
DHCP: VLAN20_VPN
<a href=#dhcp-vlan20_vpn class=post-heading__anchor aria-hidden=true>#</a>
</h4>
<table>
<thead>
<tr>
<th></th>
<th></th>
</tr>
</thead>
<tbody>
<tr>
<td>Enable</td>
<td><code>checked</code></td>
</tr>
<tr>
<td>Range</td>
<td>from <code>192.168.20.100</code> to <code>192.168.20.199</code></td>
</tr>
</tbody>
</table>
<h4 id=dhcp-vlan30_clear>
DHCP: VLAN30_CLEAR
<a href=#dhcp-vlan30_clear class=post-heading__anchor aria-hidden=true>#</a>
</h4>
<table>
<thead>
<tr>
<th></th>
<th></th>
</tr>
</thead>
<tbody>
<tr>
<td>Enable</td>
<td><code>checked</code></td>
</tr>
<tr>
<td>Range</td>
<td>from <code>192.168.30.100</code> to <code>192.168.30.199</code></td>
</tr>
</tbody>
</table>
<h4 id=dhcp-vlan40_guest>
DHCP: VLAN40_GUEST
<a href=#dhcp-vlan40_guest class=post-heading__anchor aria-hidden=true>#</a>
</h4>
<table>
<thead>
<tr>
<th></th>
<th></th>
</tr>
</thead>
<tbody>
<tr>
<td>Enable</td>
<td><code>checked</code></td>
</tr>
<tr>
<td>Range</td>
<td>from <code>192.168.40.100</code> to <code>192.168.40.199</code></td>
</tr>
<tr>
<td>DNS servers</td>
<td><code>1.1.1.1</code> <code>1.0.0.1</code></td>
</tr>
</tbody>
</table>
<h4 id=dhcp-lan>
DHCP: LAN
<a href=#dhcp-lan class=post-heading__anchor aria-hidden=true>#</a>
</h4>
<table>
<thead>
<tr>
<th></th>
<th></th>
</tr>
</thead>
<tbody>
<tr>
<td>Range</td>
<td>from <code>192.168.1.100</code> to <code>192.168.1.199</code></td>
</tr>
</tbody>
</table>
<h2 id=wireguard-vpn-with-mullvad>
WireGuard VPN with Mullvad
<a href=#wireguard-vpn-with-mullvad class=post-heading__anchor aria-hidden=true>#</a>
</h2>
<p>In recent years, <a href=https://mullvad.net/ class=link--external target=_blank rel=noreferrer>Mullvad</a> has been my VPN provider of choice. When <em>That One Privacy Site</em> was still a thing, Mullvad was one of the top recommendations there. After reading the review, I decided to try it out and haven&rsquo;t looked back since. No personally identifiable information is required to register, and paying cash via mail works perfectly.</p>
<p>I decided to go with <a href=https://www.wireguard.com/ class=link--external target=_blank rel=noreferrer>WireGuard</a> because I&rsquo;m fine riding the bleeding edge. 😎 For more detailed steps, check the official OPNsense documentation on setting up <a href=https://docs.opnsense.org/manual/how-tos/wireguard-client-mullvad.html class=link--external target=_blank rel=noreferrer>WireGuard with Mullvad</a> and <a href=https://docs.opnsense.org/manual/how-tos/wireguard-selective-routing.html class=link--external target=_blank rel=noreferrer>WireGuard selective routing</a>.</p>
<p>Please note that the FreeBSD kernel does not (yet) natively support WireGuard, so you must install it as a plugin. Possibly, this doesn&rsquo;t meet your stability, security, or performance requirements.</p>
<p>By default, the OPNsense plugin uses the Go implementation of WireGuard. But I couldn&rsquo;t get multi-WAN working with it. However, with the experimental WireGuard kernel module <code>wireguard-kmod</code>, it works. I only managed to get failover working, though. Load balancing doesn&rsquo;t seem to be supported yet.</p>
<p>Navigate to <strong>System</strong><span> → </span>
<strong>Firmware</strong><span> → </span>
<strong>Plugins</strong> and install <code>os-wireguard</code>. Refresh the browser and navigate to <strong>VPN</strong><span> → </span>
<strong>WireGuard</strong>. Then SSH into OPNsense, run <code>pkg install wireguard-kmod</code>, and reboot.</p>
<h3 id=remote-peers>
Remote Peers
<a href=#remote-peers class=post-heading__anchor aria-hidden=true>#</a>
</h3>
<p>Select your preferred WireGuard servers from the <a href=https://mullvad.net/en/servers/ class=link--external target=_blank rel=noreferrer>Mullvad&rsquo;s server list</a> and take note of their names and public keys. It&rsquo;s worth spending some time to benchmark server performance before making a choice.</p>
<p>
<picture>
<source srcset="/blog/opnsense-baseline-guide-with-vpn-guest-and-vlan-support/wireguard-remote-peers_hu42a8cbadced034d33f241606b47de4bf_3144_300x0_resize_q90_h2_box_3.webp 300w,/blog/opnsense-baseline-guide-with-vpn-guest-and-vlan-support/wireguard-remote-peers_hu42a8cbadced034d33f241606b47de4bf_3144_400x0_resize_q90_h2_box_3.webp 400w,/blog/opnsense-baseline-guide-with-vpn-guest-and-vlan-support/wireguard-remote-peers_hu42a8cbadced034d33f241606b47de4bf_3144_500x0_resize_q90_h2_box_3.webp 500w,/blog/opnsense-baseline-guide-with-vpn-guest-and-vlan-support/wireguard-remote-peers_hu42a8cbadced034d33f241606b47de4bf_3144_600x0_resize_q90_h2_box_3.webp 600w,/blog/opnsense-baseline-guide-with-vpn-guest-and-vlan-support/wireguard-remote-peers_hu42a8cbadced034d33f241606b47de4bf_3144_643x0_resize_q90_h2_box_3.webp 643w">
<img src=/blog/opnsense-baseline-guide-with-vpn-guest-and-vlan-support/wireguard-remote-peers.png srcset="/blog/opnsense-baseline-guide-with-vpn-guest-and-vlan-support/wireguard-remote-peers_hu42a8cbadced034d33f241606b47de4bf_3144_300x0_resize_box_3.png 300w,/blog/opnsense-baseline-guide-with-vpn-guest-and-vlan-support/wireguard-remote-peers_hu42a8cbadced034d33f241606b47de4bf_3144_400x0_resize_box_3.png 400w,/blog/opnsense-baseline-guide-with-vpn-guest-and-vlan-support/wireguard-remote-peers_hu42a8cbadced034d33f241606b47de4bf_3144_500x0_resize_box_3.png 500w,/blog/opnsense-baseline-guide-with-vpn-guest-and-vlan-support/wireguard-remote-peers_hu42a8cbadced034d33f241606b47de4bf_3144_600x0_resize_box_3.png 600w,/blog/opnsense-baseline-guide-with-vpn-guest-and-vlan-support/wireguard-remote-peers_hu42a8cbadced034d33f241606b47de4bf_3144_643x0_resize_box_3.png 643w" alt="Screenshot of WireGuard Endpoint configurations" loading=lazy width=643 height=119>
</picture>
</p>
<p>Select the <strong>Endpoints</strong> tab and click <strong>Add</strong>. Here is the configuration for the remote <code>ch5-wireguard</code> Mullvad endpoint.</p>
<table>
<thead>
<tr>
<th></th>
<th></th>
</tr>
</thead>
<tbody>
<tr>
<td>Name</td>
<td><code>mullvad-ch5-wireguard</code></td>
</tr>
<tr>
<td>Public key</td>
<td><code>/iivwlyqWqxQ0BVWmJRhcXIFdJeo0WbHQ/hZwuXaN3g=</code></td>
</tr>
<tr>
<td>Allowed IPs</td>
<td><code>0.0.0.0/0</code></td>
</tr>
<tr>
<td>Endpoint Address</td>
<td><code>193.32.127.66</code></td>
</tr>
<tr>
<td>Endpoint Port</td>
<td><code>51820</code></td>
</tr>
<tr>
<td>Keepalive</td>
<td><code>25</code></td>
</tr>
</tbody>
</table>
<p>To mitigate risks against DNS poisoning, resolve the server&rsquo;s hostname and enter its IP as <strong>Endpoint Address</strong>. You can do this by running <code>nslookup ch5-wireguard.mullvad.net</code> in a shell.</p>
<p>Repeat the steps above to add another server, e.g., <code>ch6-wireguard</code>. Note that for all endpoint configurations, the <strong>Endpoint Port</strong> is <code>51820</code>.</p>
<h3 id=local-peers>
Local Peers
<a href=#local-peers class=post-heading__anchor aria-hidden=true>#</a>
</h3>
<p>Select the <strong>Local</strong> tab, click <code>Add</code>, and enable the <code>advanced mode</code>.</p>
<table>
<thead>
<tr>
<th></th>
<th></th>
</tr>
</thead>
<tbody>
<tr>
<td>Name</td>
<td><code>mullvad0</code></td>
</tr>
<tr>
<td>Listen Port</td>
<td><code>51820</code></td>
</tr>
<tr>
<td>Tunnel Address</td>
<td><code>&lt;LEAVE EMPTY></code></td>
</tr>
<tr>
<td>Peers</td>
<td><code>ch5-wireguard</code></td>
</tr>
<tr>
<td>Disable Routes</td>
<td><code>checked</code></td>
</tr>
<tr>
<td>Gateway</td>
<td><code>&lt;LEAVE EMPTY></code></td>
</tr>
</tbody>
</table>
<p>Click <code>Save</code> to generate the WireGuard key pair. Click <code>Edit</code> and copy the generated <strong>Public Key</strong>. Next, run the following shell command.</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell>curl -sSL https://api.mullvad.net/app/v1/wireguard-keys <span style=color:#ae81ff>\
</span><span style=color:#ae81ff></span>  -H <span style=color:#e6db74>&#34;Content-Type: application/json&#34;</span> <span style=color:#ae81ff>\
</span><span style=color:#ae81ff></span>  -H <span style=color:#e6db74>&#34;Authorization: Token &lt;Mullvad account number&gt;&#34;</span> <span style=color:#ae81ff>\
</span><span style=color:#ae81ff></span>  -d <span style=color:#e6db74>&#39;{&#34;pubkey&#34;:&#34;&lt;generated public key&gt;&#34;}&#39;</span>
</code></pre></div><p>This command returns a JSON response containing IPs without DNS hijacking enabled. I cover the snippet above and Mullvad&rsquo;s DNS hijacking in another post: <a href=/posts/use-custom-dns-servers-with-mullvad-and-any-wireguard-client>Use Custom DNS Servers With Mullvad And Any WireGuard Client</a>.</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-json data-lang=json>{
  <span style=color:#f92672>&#34;id&#34;</span>: <span style=color:#e6db74>&#34;ufO5jCni55uvioHM%2FeLBgyrrUMocEXsADPc2OvYhF3k%3D&#34;</span>,
  <span style=color:#f92672>&#34;pubkey&#34;</span>: <span style=color:#e6db74>&#34;ufO5jCni55uvioHM/eLBgyrrUMocEXsADPc2OvYhF3k=&#34;</span>,
  <span style=color:#f92672>&#34;ipv4_address&#34;</span>: <span style=color:#e6db74>&#34;10.105.248.51/32&#34;</span>,
  <span style=color:#f92672>&#34;ipv6_address&#34;</span>: <span style=color:#e6db74>&#34;fc00:bbbb:bbbb:bb01::2a:f832/128&#34;</span>
}
</code></pre></div><p>Copy the IPv4 IP address to the <strong>Tunnel Address</strong> field of the local peer. Subtract one from the <strong>Tunnel Address</strong> and enter the result as <strong>Gateway</strong> IP. E.g., <code>10.105.248.50</code> for the example above. It&rsquo;s just a convention I like, but you can use any arbitrary, unused <a href=https://datatracker.ietf.org/doc/html/rfc1918 class=link--external target=_blank rel=noreferrer>private RFC1918 IP</a>.</p>
<p>
<picture>
<source srcset="/blog/opnsense-baseline-guide-with-vpn-guest-and-vlan-support/wireguard-local-peer_hu001d62081d26dc64de14454693b5606b_11437_300x0_resize_q90_h2_box_3.webp 300w,/blog/opnsense-baseline-guide-with-vpn-guest-and-vlan-support/wireguard-local-peer_hu001d62081d26dc64de14454693b5606b_11437_400x0_resize_q90_h2_box_3.webp 400w,/blog/opnsense-baseline-guide-with-vpn-guest-and-vlan-support/wireguard-local-peer_hu001d62081d26dc64de14454693b5606b_11437_500x0_resize_q90_h2_box_3.webp 500w,/blog/opnsense-baseline-guide-with-vpn-guest-and-vlan-support/wireguard-local-peer_hu001d62081d26dc64de14454693b5606b_11437_550x0_resize_q90_h2_box_3.webp 550w">
<img src=/blog/opnsense-baseline-guide-with-vpn-guest-and-vlan-support/wireguard-local-peer.png srcset="/blog/opnsense-baseline-guide-with-vpn-guest-and-vlan-support/wireguard-local-peer_hu001d62081d26dc64de14454693b5606b_11437_300x0_resize_box_3.png 300w,/blog/opnsense-baseline-guide-with-vpn-guest-and-vlan-support/wireguard-local-peer_hu001d62081d26dc64de14454693b5606b_11437_400x0_resize_box_3.png 400w,/blog/opnsense-baseline-guide-with-vpn-guest-and-vlan-support/wireguard-local-peer_hu001d62081d26dc64de14454693b5606b_11437_500x0_resize_box_3.png 500w,/blog/opnsense-baseline-guide-with-vpn-guest-and-vlan-support/wireguard-local-peer_hu001d62081d26dc64de14454693b5606b_11437_550x0_resize_box_3.png 550w" alt="Screenshot of WireGuard Local Peer configuration" loading=lazy width=550 height=602>
</picture>
</p>
<p>Repeat the steps above to create a second local peer named <code>mullvad1</code>. Remember to use a <em>different</em> <strong>Listen Port</strong> (e.g., <code>51821</code>).</p>
<p>
<picture>
<source srcset="/blog/opnsense-baseline-guide-with-vpn-guest-and-vlan-support/wireguard-local-peers_huca3ad74aa7110aacf4ed870d0cf4e507_2655_300x0_resize_q90_h2_box_3.webp 300w,/blog/opnsense-baseline-guide-with-vpn-guest-and-vlan-support/wireguard-local-peers_huca3ad74aa7110aacf4ed870d0cf4e507_2655_400x0_resize_q90_h2_box_3.webp 400w,/blog/opnsense-baseline-guide-with-vpn-guest-and-vlan-support/wireguard-local-peers_huca3ad74aa7110aacf4ed870d0cf4e507_2655_500x0_resize_q90_h2_box_3.webp 500w,/blog/opnsense-baseline-guide-with-vpn-guest-and-vlan-support/wireguard-local-peers_huca3ad74aa7110aacf4ed870d0cf4e507_2655_519x0_resize_q90_h2_box_3.webp 519w">
<img src=/blog/opnsense-baseline-guide-with-vpn-guest-and-vlan-support/wireguard-local-peers.png srcset="/blog/opnsense-baseline-guide-with-vpn-guest-and-vlan-support/wireguard-local-peers_huca3ad74aa7110aacf4ed870d0cf4e507_2655_300x0_resize_box_3.png 300w,/blog/opnsense-baseline-guide-with-vpn-guest-and-vlan-support/wireguard-local-peers_huca3ad74aa7110aacf4ed870d0cf4e507_2655_400x0_resize_box_3.png 400w,/blog/opnsense-baseline-guide-with-vpn-guest-and-vlan-support/wireguard-local-peers_huca3ad74aa7110aacf4ed870d0cf4e507_2655_500x0_resize_box_3.png 500w,/blog/opnsense-baseline-guide-with-vpn-guest-and-vlan-support/wireguard-local-peers_huca3ad74aa7110aacf4ed870d0cf4e507_2655_519x0_resize_box_3.png 519w" alt="Screenshot of WireGuard Local Peer configurations" loading=lazy width=519 height=118>
</picture>
</p>
<p>When you finish, select the <code>General</code> tab. Check <strong>Enable WireGuard</strong>. You should see a handshake for the <code>wg0</code> and <code>wg1</code> tunnels on the <strong>Handshakes</strong> tab.</p>
<h3 id=wireguard-interfaces>
WireGuard Interfaces
<a href=#wireguard-interfaces class=post-heading__anchor aria-hidden=true>#</a>
</h3>
<p>Navigate to <strong>Interfaces</strong><span> → </span>
<strong>Assignments</strong>.</p>
<ul>
<li>Select <code>wg0</code>, add the description <code>WAN_VPN0</code>, and click <code>+</code></li>
<li>Select <code>wg1</code>, add the description <code>WAN_VPN1</code>, and click <code>+</code></li>
</ul>
<p>Enable the newly created interfaces and restart the WireGuard service after. It ensures the interfaces get an IP address from WireGuard.</p>
<h3 id=vpn-gateways>
VPN Gateways
<a href=#vpn-gateways class=post-heading__anchor aria-hidden=true>#</a>
</h3>
<p>
<picture>
<source srcset="/blog/opnsense-baseline-guide-with-vpn-guest-and-vlan-support/gateway-config_hu5b6e99cc90a765a2bd7cd35f03b2cb89_9164_300x0_resize_q90_h2_box_3.webp 300w,/blog/opnsense-baseline-guide-with-vpn-guest-and-vlan-support/gateway-config_hu5b6e99cc90a765a2bd7cd35f03b2cb89_9164_400x0_resize_q90_h2_box_3.webp 400w,/blog/opnsense-baseline-guide-with-vpn-guest-and-vlan-support/gateway-config_hu5b6e99cc90a765a2bd7cd35f03b2cb89_9164_500x0_resize_q90_h2_box_3.webp 500w,/blog/opnsense-baseline-guide-with-vpn-guest-and-vlan-support/gateway-config_hu5b6e99cc90a765a2bd7cd35f03b2cb89_9164_600x0_resize_q90_h2_box_3.webp 600w,/blog/opnsense-baseline-guide-with-vpn-guest-and-vlan-support/gateway-config_hu5b6e99cc90a765a2bd7cd35f03b2cb89_9164_700x0_resize_q90_h2_box_3.webp 700w">
<img src=/blog/opnsense-baseline-guide-with-vpn-guest-and-vlan-support/gateway-config.png srcset="/blog/opnsense-baseline-guide-with-vpn-guest-and-vlan-support/gateway-config_hu5b6e99cc90a765a2bd7cd35f03b2cb89_9164_300x0_resize_box_3.png 300w,/blog/opnsense-baseline-guide-with-vpn-guest-and-vlan-support/gateway-config_hu5b6e99cc90a765a2bd7cd35f03b2cb89_9164_400x0_resize_box_3.png 400w,/blog/opnsense-baseline-guide-with-vpn-guest-and-vlan-support/gateway-config_hu5b6e99cc90a765a2bd7cd35f03b2cb89_9164_500x0_resize_box_3.png 500w,/blog/opnsense-baseline-guide-with-vpn-guest-and-vlan-support/gateway-config_hu5b6e99cc90a765a2bd7cd35f03b2cb89_9164_600x0_resize_box_3.png 600w,/blog/opnsense-baseline-guide-with-vpn-guest-and-vlan-support/gateway-config_hu5b6e99cc90a765a2bd7cd35f03b2cb89_9164_700x0_resize_box_3.png 700w" alt="Screenshot of gateway configuration overview" loading=lazy width=705 height=257>
</picture>
</p>
<p>Navigate to <strong>System</strong><span> → </span>
<strong>Gateways</strong><span> → </span>
<strong>Single</strong> and add the VPN gateways.</p>
<h4 id=wan_vpn0>
WAN_VPN0
<a href=#wan_vpn0 class=post-heading__anchor aria-hidden=true>#</a>
</h4>
<table>
<thead>
<tr>
<th></th>
<th></th>
</tr>
</thead>
<tbody>
<tr>
<td>Name</td>
<td><code>WAN_VPN0</code></td>
</tr>
<tr>
<td>Interface</td>
<td><code>WAN_VPN0</code></td>
</tr>
<tr>
<td>Address Family</td>
<td><code>IPv4</code></td>
</tr>
<tr>
<td>IP Address</td>
<td><code>10.105.248.50</code></td>
</tr>
<tr>
<td>Far Gateway</td>
<td><code>checked</code></td>
</tr>
<tr>
<td>Disable Gateway Monitoring</td>
<td><code>unchecked</code></td>
</tr>
<tr>
<td>Monitor IP</td>
<td><code>100.64.0.1</code></td>
</tr>
</tbody>
</table>
<h4 id=wan_vpn1>
WAN_VPN1
<a href=#wan_vpn1 class=post-heading__anchor aria-hidden=true>#</a>
</h4>
<table>
<thead>
<tr>
<th></th>
<th></th>
</tr>
</thead>
<tbody>
<tr>
<td>Name</td>
<td><code>WAN_VPN1</code></td>
</tr>
<tr>
<td>Interface</td>
<td><code>WAN_VPN1</code></td>
</tr>
<tr>
<td>Address Family</td>
<td><code>IPv4</code></td>
</tr>
<tr>
<td>IP Address</td>
<td><code>10.109.231.89</code></td>
</tr>
<tr>
<td>Far Gateway</td>
<td><code>checked</code></td>
</tr>
<tr>
<td>Disable Gateway Monitoring</td>
<td><code>unchecked</code></td>
</tr>
<tr>
<td>Monitor IP</td>
<td><code>100.64.0.2</code></td>
</tr>
</tbody>
</table>
<h4 id=monitoring-ips>
Monitoring IPs
<a href=#monitoring-ips class=post-heading__anchor aria-hidden=true>#</a>
</h4>
<p>Each VPN gateway requires a unique monitoring IP because setting a monitoring IP installs a static route. Optimally, the monitoring IP should be the least possible amount of hops away from the gateway. For Mullvad specifically, we can &ldquo;abuse&rdquo; the local infrastructure that&rsquo;s available through a Mullvad connection. Any of the following IPs are only <em>one</em> hop away from the tunnel exit.</p>
<ul>
<li><code>100.64.0.1</code> to <code>100.64.0.3</code> are <a href=https://mullvad.net/it/blog/2021/5/27/how-set-ad-blocking-our-app/ class=link--external target=_blank rel=noreferrer>Mullvad&rsquo;s ad-blocking and tracker-blocking DNS service servers</a></li>
<li><code>10.64.0.1</code> is the local Mullvad gateway</li>
</ul>
<p>You can easily verify the above by running <code>traceroute 100.64.0.1</code> from a host connected to Mullvad.</p>
<h4 id=add-static-ipv4-configuration-to-the-wireguard-interfaces>
Add Static IPv4 Configuration to the WireGuard Interfaces
<a href=#add-static-ipv4-configuration-to-the-wireguard-interfaces class=post-heading__anchor aria-hidden=true>#</a>
</h4>
<p>OPNsense versions newer than <code>21.7.3</code> require adding static IPv4 configuration to the WireGuard interface. Otherwise, Unbound will use the default route despite setting the <strong>Outgoing Network Interfaces</strong> option. Other solutions exist, but I&rsquo;m not sure which the &ldquo;best&rdquo; or most logical one is. As WireGuard integration matures, this section hopefully becomes obsolete. <a href=https://github.com/opnsense/core/issues/5329#issuecomment-958397043 class=link--external target=_blank rel=noreferrer>You can find more information regarding this issue on GitHub</a>.</p>
<p>Navigate to <strong>Interfaces</strong> and edit the WireGuard interfaces.</p>
<h5 id=ip-configuration-wan_vpn0>
IP Configuration: WAN_VPN0
<a href=#ip-configuration-wan_vpn0 class=post-heading__anchor aria-hidden=true>#</a>
</h5>
<table>
<thead>
<tr>
<th></th>
<th></th>
</tr>
</thead>
<tbody>
<tr>
<td>IPv4 Configuration Type</td>
<td><code>Static IPv4</code></td>
</tr>
<tr>
<td>IPv4 address</td>
<td><code>10.105.248.51/32</code></td>
</tr>
<tr>
<td>IPv4 Upstream Gateway</td>
<td><code>WAN_VPN0 - 10.105.248.50</code></td>
</tr>
</tbody>
</table>
<h5 id=ip-configuration-wan_vpn1>
IP Configuration: WAN_VPN1
<a href=#ip-configuration-wan_vpn1 class=post-heading__anchor aria-hidden=true>#</a>
</h5>
<table>
<thead>
<tr>
<th></th>
<th></th>
</tr>
</thead>
<tbody>
<tr>
<td>IPv4 Configuration Type</td>
<td><code>Static IPv4</code></td>
</tr>
<tr>
<td>IPv4 address</td>
<td><code>10.109.231.90/32</code></td>
</tr>
<tr>
<td>IPv4 Upstream Gateway</td>
<td><code>WAN_VPN1 - 10.109.231.89</code></td>
</tr>
</tbody>
</table>
<h4 id=gateway-group>
Gateway Group
<a href=#gateway-group class=post-heading__anchor aria-hidden=true>#</a>
</h4>
<p>Navigate to <strong>System</strong><span> → </span>
<strong>Gateways</strong><span> → </span>
<strong>Group</strong> and click <code>Add</code>.</p>
<table>
<thead>
<tr>
<th></th>
<th></th>
</tr>
</thead>
<tbody>
<tr>
<td>Group Name</td>
<td><code>WAN_VPN_GROUP</code></td>
</tr>
<tr>
<td>WAN_VPN0</td>
<td><code>Tier 1</code></td>
</tr>
<tr>
<td>WAN_VPN1</td>
<td><code>Tier 2</code> (failover)</td>
</tr>
<tr>
<td>Trigger Level</td>
<td><code>Packet Loss or High Latency</code></td>
</tr>
</tbody>
</table>
<p>It&rsquo;s also possible to configure failover or both.</p>
<h3 id=static-routes-optional>
Static Routes (Optional)
<a href=#static-routes-optional class=post-heading__anchor aria-hidden=true>#</a>
</h3>
<p>Defining static routes for the tunnel gateways is optional. It would be necessary, for example, if we want to consider the VPN gateways as default gateway candidates. It requires static routes to the ISP WAN gateway to keep the tunnel connections alive.</p>
<p>
<picture>
<source srcset="/blog/opnsense-baseline-guide-with-vpn-guest-and-vlan-support/static-routes-wireguard_hu13edb8979cafd08be329b538cadb8eeb_3185_300x0_resize_q90_h2_box_3.webp 300w,/blog/opnsense-baseline-guide-with-vpn-guest-and-vlan-support/static-routes-wireguard_hu13edb8979cafd08be329b538cadb8eeb_3185_400x0_resize_q90_h2_box_3.webp 400w,/blog/opnsense-baseline-guide-with-vpn-guest-and-vlan-support/static-routes-wireguard_hu13edb8979cafd08be329b538cadb8eeb_3185_500x0_resize_q90_h2_box_3.webp 500w,/blog/opnsense-baseline-guide-with-vpn-guest-and-vlan-support/static-routes-wireguard_hu13edb8979cafd08be329b538cadb8eeb_3185_567x0_resize_q90_h2_box_3.webp 567w">
<img src=/blog/opnsense-baseline-guide-with-vpn-guest-and-vlan-support/static-routes-wireguard.png srcset="/blog/opnsense-baseline-guide-with-vpn-guest-and-vlan-support/static-routes-wireguard_hu13edb8979cafd08be329b538cadb8eeb_3185_300x0_resize_box_3.png 300w,/blog/opnsense-baseline-guide-with-vpn-guest-and-vlan-support/static-routes-wireguard_hu13edb8979cafd08be329b538cadb8eeb_3185_400x0_resize_box_3.png 400w,/blog/opnsense-baseline-guide-with-vpn-guest-and-vlan-support/static-routes-wireguard_hu13edb8979cafd08be329b538cadb8eeb_3185_500x0_resize_box_3.png 500w,/blog/opnsense-baseline-guide-with-vpn-guest-and-vlan-support/static-routes-wireguard_hu13edb8979cafd08be329b538cadb8eeb_3185_567x0_resize_box_3.png 567w" alt="Screenshot of the static routes for WireGuard tunnel" loading=lazy width=567 height=118>
</picture>
</p>
<p>Navigate to <strong>System</strong><span> → </span>
<strong>Routes</strong><span> → </span>
<strong>Configuration</strong> and click <code>Add</code>.</p>
<table>
<thead>
<tr>
<th></th>
<th></th>
</tr>
</thead>
<tbody>
<tr>
<td>Network Address</td>
<td><code>193.32.127.66/32</code></td>
</tr>
<tr>
<td>Gateway</td>
<td><code>WAN_DHCP</code></td>
</tr>
<tr>
<td>Description</td>
<td><code>Keep tunnels to mullvad-ch5-wireguard alive</code></td>
</tr>
</tbody>
</table>
<table>
<thead>
<tr>
<th></th>
<th></th>
</tr>
</thead>
<tbody>
<tr>
<td>Network Address</td>
<td><code>193.32.127.67/32</code></td>
</tr>
<tr>
<td>Gateway</td>
<td><code>WAN_DHCP</code></td>
</tr>
<tr>
<td>Description</td>
<td><code>Keep tunnels to mullvad-ch6-wireguard alive</code></td>
</tr>
</tbody>
</table>
<h2 id=dns>
DNS
<a href=#dns class=post-heading__anchor aria-hidden=true>#</a>
</h2>
<p>
<picture>
<source srcset="/blog/opnsense-baseline-guide-with-vpn-guest-and-vlan-support/dns-architecture_huec80a2b82eccc2a1c77e393fa36f2b51_78480_300x0_resize_q90_h2_box_3.webp 300w,/blog/opnsense-baseline-guide-with-vpn-guest-and-vlan-support/dns-architecture_huec80a2b82eccc2a1c77e393fa36f2b51_78480_400x0_resize_q90_h2_box_3.webp 400w,/blog/opnsense-baseline-guide-with-vpn-guest-and-vlan-support/dns-architecture_huec80a2b82eccc2a1c77e393fa36f2b51_78480_500x0_resize_q90_h2_box_3.webp 500w,/blog/opnsense-baseline-guide-with-vpn-guest-and-vlan-support/dns-architecture_huec80a2b82eccc2a1c77e393fa36f2b51_78480_600x0_resize_q90_h2_box_3.webp 600w,/blog/opnsense-baseline-guide-with-vpn-guest-and-vlan-support/dns-architecture_huec80a2b82eccc2a1c77e393fa36f2b51_78480_692x0_resize_q90_h2_box_3.webp 692w">
<img src=/blog/opnsense-baseline-guide-with-vpn-guest-and-vlan-support/dns-architecture.png srcset="/blog/opnsense-baseline-guide-with-vpn-guest-and-vlan-support/dns-architecture_huec80a2b82eccc2a1c77e393fa36f2b51_78480_300x0_resize_box_3.png 300w,/blog/opnsense-baseline-guide-with-vpn-guest-and-vlan-support/dns-architecture_huec80a2b82eccc2a1c77e393fa36f2b51_78480_400x0_resize_box_3.png 400w,/blog/opnsense-baseline-guide-with-vpn-guest-and-vlan-support/dns-architecture_huec80a2b82eccc2a1c77e393fa36f2b51_78480_500x0_resize_box_3.png 500w,/blog/opnsense-baseline-guide-with-vpn-guest-and-vlan-support/dns-architecture_huec80a2b82eccc2a1c77e393fa36f2b51_78480_600x0_resize_box_3.png 600w,/blog/opnsense-baseline-guide-with-vpn-guest-and-vlan-support/dns-architecture_huec80a2b82eccc2a1c77e393fa36f2b51_78480_692x0_resize_box_3.png 692w" alt="Diagram of DNS architecture" loading=lazy width=692 height=715>
</picture>
</p>
<p>OPNsense includes a DNS <em>resolver</em> (Unbound) and a DNS <em>forwarder</em> (Dnsmasq / Unbound in forwarding mode). Simple setups usually use one of either, but we&rsquo;ll use both. Because we&rsquo;ll also use Unbound and Dnsmasq for internal DNS resolution, we don&rsquo;t want to use them for the Guest network, as this would expose our internal network structure. That&rsquo;s the reason why we earlier configured it to use Cloudflare DNS servers instead.</p>
<p>Like the name suggests, a DNS forwarder forwards DNS requests to an external DNS resolver of an ISP, Quad9, Cloudflare, or similar service provider. We&rsquo;ll configure the forwarder for the Clear network. In case the primary, secured networks lose connectivity, the Clear network can serve as a backup.</p>
<p>One of the advantages of self-hosting a DNS resolver is improved privacy. A resolver iteratively queries a chain of one or more DNS servers to resolve a request, so there isn&rsquo;t a single instance knowing all your DNS requests. It comes at the cost of speed when resolving a hostname for the first time. As Unbound&rsquo;s cache grows, the cost diminishes. We&rsquo;ll configure our primary networks to use Unbound.</p>
<p>We&rsquo;ll also keep DNS traffic from Unbound within the VPN tunnels. In the rare case of a VPN outage, we&rsquo;ll want local DNS services to fail and not leak through the ISP WAN. The reason for this isn&rsquo;t improved privacy as you might think. In some cases, this might even hurt your privacy. Why? Either your ISP or your VPN provider will see the iterative DNS requests Unbound sends. So it becomes a question of who you rather entrust with this data. But if there are no privacy benefits, why do it? Honestly, I don&rsquo;t require such a setup. I configured it for educational purposes and fun. Other reasons that don&rsquo;t affect me but other users are.</p>
<ul>
<li>ISP selling user data</li>
<li>ISP enforcing censorship</li>
<li>ISP hijacking DNS traffic to redirect it to their DNS resolver; this makes self-hosting a DNS resolver impossible</li>
</ul>
<p>Let&rsquo;s summarize our goals.</p>
<ul>
<li>Use a DNS resolver for the management and VPN networks</li>
<li>Resolve private domain hostnames for management and VPN networks</li>
<li>Prevent DNS leaks from Unbound through the ISP WAN gateway</li>
<li>Use DNS forwarding for the Clear network</li>
<li>Use external DNS resolvers for the Guest network</li>
</ul>
<h3 id=resolver-unbound>
Resolver (Unbound)
<a href=#resolver-unbound class=post-heading__anchor aria-hidden=true>#</a>
</h3>
<p>Navigate to <strong>Services</strong><span> → </span>
<strong>Unbound DNS</strong><span> → </span>
<strong>General</strong>.</p>
<table>
<thead>
<tr>
<th></th>
<th></th>
</tr>
</thead>
<tbody>
<tr>
<td>Network Interfaces</td>
<td><code>LAN</code> <code>VLAN10_MANAGE</code> <code>VLAN20_VPN</code></td>
</tr>
<tr>
<td>DNSSEC</td>
<td><code>checked</code></td>
</tr>
<tr>
<td>DHCP registration</td>
<td><code>checked</code></td>
</tr>
<tr>
<td>DHCP static mappings</td>
<td><code>checked</code></td>
</tr>
<tr>
<td>Local Zone Type</td>
<td><code>static</code></td>
</tr>
<tr>
<td>Outgoing Network Interfaces</td>
<td><code>WAN_VPN0</code> <code>WAN_VPN1</code></td>
</tr>
</tbody>
</table>
<p>Navigate to <strong>Services</strong><span> → </span>
<strong>Unbound DNS</strong><span> → </span>
<strong>Advanced</strong>.</p>
<table>
<thead>
<tr>
<th></th>
<th></th>
</tr>
</thead>
<tbody>
<tr>
<td>Hide Identity</td>
<td><code>checked</code></td>
</tr>
<tr>
<td>Hide Version</td>
<td><code>checked</code></td>
</tr>
<tr>
<td>Prefetch Support</td>
<td><code>checked</code></td>
</tr>
<tr>
<td>Prefetch DNS Key Support</td>
<td><code>checked</code></td>
</tr>
<tr>
<td>Harden DNSSEC data</td>
<td><code>checked</code></td>
</tr>
</tbody>
</table>
<p>The final step is to add a custom <a href=https://www.cloudflare.com/learning/dns/dns-records/dns-soa-record/ class=link--external target=_blank rel=noreferrer>SOA record</a> to the local zone making Unbound the authoritative name server for <code>corp.example.com</code>. This way, we prevent Unbound from querying external name servers for the internal domain and exposing our network structure to the outside world. For <a href=https://docs.opnsense.org/manual/unbound.html#advanced-configurations class=link--external target=_blank rel=noreferrer>advanced Unbound configuration like this</a>, we use <a href=https://docs.opnsense.org/development/backend/templates.html class=link--external target=_blank rel=noreferrer>Templates</a>.</p>
<p>Connect to OPNsense via serial console or SSH and add a <code>+TARGETS</code> file by running <code>sudo vi /usr/local/opnsense/service/templates/OPNsense/Unbound/+TARGETS</code> containing:</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-text data-lang=text>private_domains.conf:/usr/local/etc/unbound.opnsense.d/private_domains.conf
</code></pre></div><p>Add the template file by running <code>sudo vi /usr/local/opnsense/service/templates/OPNsense/Unbound/private_domains.conf</code> containing:</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-text data-lang=text>server:
  local-data: &#34;corp.example.com. 3600 IN SOA opnsense.corp.example.com. root.example.com. 2021110201 86400 7200 3600000 3600&#34;
</code></pre></div><p>Here is a translation of what the SOA record means.</p>
<table>
<thead>
<tr>
<th></th>
<th></th>
</tr>
</thead>
<tbody>
<tr>
<td>Name</td>
<td><code>corp.example.com</code></td>
</tr>
<tr>
<td>Record Type</td>
<td><code>SOA</code></td>
</tr>
<tr>
<td>Primary Name Server</td>
<td><code>opnsense.corp.example.com</code></td>
</tr>
<tr>
<td>Administrator Email</td>
<td><code>root@example.com</code></td>
</tr>
<tr>
<td>Serial</td>
<td><code>2021110201</code> (YYMMDDnn)</td>
</tr>
<tr>
<td>Refresh</td>
<td><code>86400</code> (24 hours)</td>
</tr>
<tr>
<td>Retry</td>
<td><code>7200</code> (2 hours)</td>
</tr>
<tr>
<td>Expire</td>
<td><code>3600000</code> (1000 hours)</td>
</tr>
<tr>
<td>TTL</td>
<td><code>3600</code> (1 hour)</td>
</tr>
</tbody>
</table>
<p>Run the following to verify the configuration.</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=color:#75715e># generate template</span>
configctl template reload OPNsense/Unbound
<span style=color:#75715e># show generated file</span>
cat /usr/local/etc/unbound.opnsense.d/private_domains.conf
<span style=color:#75715e># check if configuration is valid</span>
configctl unbound check
</code></pre></div><h3 id=forwarder-dnsmasq>
Forwarder (Dnsmasq)
<a href=#forwarder-dnsmasq class=post-heading__anchor aria-hidden=true>#</a>
</h3>
<p>Dnsmasq will forward DNS requests to the configured system DNS servers and <code>127.0.0.1</code> (Unbound). Earlier, you either explicitly configured them or decided to receive the DNS servers via DHCP from your ISP. Because Unbound already uses port 53, we&rsquo;ll use port 5335 for Dnsmasq. We&rsquo;ll later create rules to port forward DNS traffic to this port.</p>
<p>Navigate to <strong>Services</strong><span> → </span>
<strong>Dnsmasq DNS</strong><span> → </span>
<strong>Settings</strong>.</p>
<table>
<thead>
<tr>
<th></th>
<th></th>
</tr>
</thead>
<tbody>
<tr>
<td>Enable</td>
<td><code>checked</code></td>
</tr>
<tr>
<td>Listen Port</td>
<td><code>5335</code></td>
</tr>
<tr>
<td>Do not forward private reverse lookups</td>
<td><code>checked</code></td>
</tr>
</tbody>
</table>
<p>Forward reverse DNS lookups in the <code>192.168.0.0/16</code> range to Unbound by adding the following <strong>Domain Override</strong>s. We additionally make Unbound the authoritative DNS server for <code>corp.example.com</code>.</p>
<table>
<thead>
<tr>
<th>Domain</th>
<th>IP</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>168.192.in-addr.arpa</code></td>
<td><code>192.168.20.1</code></td>
<td>Forward reverse lookups of private IP addresses to Unbound</td>
</tr>
<tr>
<td><code>corp.example.com</code></td>
<td><code>192.168.20.1</code></td>
<td>Make Unbound the authoritative DNS server for private domain</td>
</tr>
</tbody>
</table>
<h2 id=firewall>
Firewall
<a href=#firewall class=post-heading__anchor aria-hidden=true>#</a>
</h2>
<p>Here is an overview of what we want to implement with firewall rules.</p>
<ul>
<li>Allow internet access for specific ports through WAN and VPN</li>
<li>Allow intranet communications</li>
<li>Redirect outbound DNS traffic to either Unbound or Dnsmasq</li>
<li>Redirect NTP traffic to OPNsense</li>
<li>Block intranet access for the Guest network</li>
</ul>
<table>
<thead>
<tr>
<th></th>
<th>VLAN10</th>
<th>VLAN20</th>
<th>VLAN30</th>
<th>VLAN40</th>
<th>LAN</th>
</tr>
</thead>
<tbody>
<tr>
<td><strong>Internet</strong></td>
<td>WAN</td>
<td>VPN + selective WAN</td>
<td>WAN</td>
<td>WAN</td>
<td>WAN</td>
</tr>
<tr>
<td><strong>Intranet</strong></td>
<td>pass</td>
<td>pass</td>
<td>pass</td>
<td>block</td>
<td>pass</td>
</tr>
<tr>
<td><strong>ICMP</strong></td>
<td>pass</td>
<td>pass</td>
<td>pass</td>
<td>pass</td>
<td>pass</td>
</tr>
<tr>
<td><strong>Anti-lockout</strong></td>
<td>yes</td>
<td>no</td>
<td>no</td>
<td>no</td>
<td>yes</td>
</tr>
<tr>
<td><strong>DNS</strong></td>
<td>Unbound</td>
<td>Unbound</td>
<td>Dnsmasq</td>
<td>external</td>
<td>Unbound</td>
</tr>
<tr>
<td><strong>NTP</strong></td>
<td>local</td>
<td>local</td>
<td>local</td>
<td>external</td>
<td>external</td>
</tr>
</tbody>
</table>
<h3 id=interface-groups>
Interface Groups
<a href=#interface-groups class=post-heading__anchor aria-hidden=true>#</a>
</h3>
<p>We use <a href=https://docs.opnsense.org/manual/firewall_groups.html class=link--external target=_blank rel=noreferrer>interface groups</a> to apply policies to multiple interfaces at once and reduce the number of required firewall rules significantly. Do not use them for WAN interfaces because they don&rsquo;t use the <code>reply-to</code> directive!</p>
<p>I&rsquo;m honestly not sure if I went overboard with interface groups and over-abstracted things. Currently, I&rsquo;m happy with the configuration, and I guess only time will tell how maintainable this approach is. I&rsquo;d like to know what you think and would very much appreciate your feedback.</p>
<p>
<picture>
<source srcset="/blog/opnsense-baseline-guide-with-vpn-guest-and-vlan-support/firewall-interface-groups_hu0db1caeb7e5726ca90b8720aefc56bb4_14263_300x0_resize_q90_h2_box_3.webp 300w,/blog/opnsense-baseline-guide-with-vpn-guest-and-vlan-support/firewall-interface-groups_hu0db1caeb7e5726ca90b8720aefc56bb4_14263_400x0_resize_q90_h2_box_3.webp 400w,/blog/opnsense-baseline-guide-with-vpn-guest-and-vlan-support/firewall-interface-groups_hu0db1caeb7e5726ca90b8720aefc56bb4_14263_500x0_resize_q90_h2_box_3.webp 500w,/blog/opnsense-baseline-guide-with-vpn-guest-and-vlan-support/firewall-interface-groups_hu0db1caeb7e5726ca90b8720aefc56bb4_14263_560x0_resize_q90_h2_box_3.webp 560w">
<img src=/blog/opnsense-baseline-guide-with-vpn-guest-and-vlan-support/firewall-interface-groups.png srcset="/blog/opnsense-baseline-guide-with-vpn-guest-and-vlan-support/firewall-interface-groups_hu0db1caeb7e5726ca90b8720aefc56bb4_14263_300x0_resize_box_3.png 300w,/blog/opnsense-baseline-guide-with-vpn-guest-and-vlan-support/firewall-interface-groups_hu0db1caeb7e5726ca90b8720aefc56bb4_14263_400x0_resize_box_3.png 400w,/blog/opnsense-baseline-guide-with-vpn-guest-and-vlan-support/firewall-interface-groups_hu0db1caeb7e5726ca90b8720aefc56bb4_14263_500x0_resize_box_3.png 500w,/blog/opnsense-baseline-guide-with-vpn-guest-and-vlan-support/firewall-interface-groups_hu0db1caeb7e5726ca90b8720aefc56bb4_14263_560x0_resize_box_3.png 560w" alt="Screenshot of firewall interface groups" loading=lazy width=560 height=444>
</picture>
</p>
<p>Navigate to <strong>Firewall</strong><span> → </span>
<strong>Groups</strong> and add the following interface groups.</p>
<h4 id=ig_local>
IG_LOCAL
<a href=#ig_local class=post-heading__anchor aria-hidden=true>#</a>
</h4>
<table>
<thead>
<tr>
<th></th>
<th></th>
</tr>
</thead>
<tbody>
<tr>
<td>Name</td>
<td><code>IG_LOCAL</code></td>
</tr>
<tr>
<td>Description</td>
<td><code>All local interfaces</code></td>
</tr>
<tr>
<td>Members</td>
<td><code>LAN</code> <code>VLAN10_MANAGE</code> <code>VLAN20_VPN</code> <code>VLAN30_CLEAR</code> <code>VLAN40_GUEST</code></td>
</tr>
</tbody>
</table>
<h4 id=ig_out_wan>
IG_OUT_WAN
<a href=#ig_out_wan class=post-heading__anchor aria-hidden=true>#</a>
</h4>
<table>
<thead>
<tr>
<th></th>
<th></th>
</tr>
</thead>
<tbody>
<tr>
<td>Name</td>
<td><code>IG_OUT_WAN</code></td>
</tr>
<tr>
<td>Description</td>
<td><code>Interfaces allowing outbound WAN traffic</code></td>
</tr>
<tr>
<td>Members</td>
<td><code>LAN</code> <code>VLAN10_MANAGE</code> <code>VLAN30_CLEAR</code> <code>VLAN40_GUEST</code></td>
</tr>
</tbody>
</table>
<h4 id=ig_out_vpn>
IG_OUT_VPN
<a href=#ig_out_vpn class=post-heading__anchor aria-hidden=true>#</a>
</h4>
<table>
<thead>
<tr>
<th></th>
<th></th>
</tr>
</thead>
<tbody>
<tr>
<td>Name</td>
<td><code>IG_OUT_VPN</code></td>
</tr>
<tr>
<td>Description</td>
<td><code>Interfaces allowing outbound VPN traffic and selective outbound WAN traffic</code></td>
</tr>
<tr>
<td>Members</td>
<td><code>VLAN20_VPN</code></td>
</tr>
</tbody>
</table>
<h4 id=ig_dns_resolve>
IG_DNS_RESOLVE
<a href=#ig_dns_resolve class=post-heading__anchor aria-hidden=true>#</a>
</h4>
<table>
<thead>
<tr>
<th></th>
<th></th>
</tr>
</thead>
<tbody>
<tr>
<td>Name</td>
<td><code>IG_DNS_RESOLVE</code></td>
</tr>
<tr>
<td>Description</td>
<td><code>Interfaces forced to use Unbound</code></td>
</tr>
<tr>
<td>Members</td>
<td><code>VLAN10_MANAGE</code> <code>VLAN20_VPN</code></td>
</tr>
</tbody>
</table>
<h4 id=ig_dns_forward>
IG_DNS_FORWARD
<a href=#ig_dns_forward class=post-heading__anchor aria-hidden=true>#</a>
</h4>
<table>
<thead>
<tr>
<th></th>
<th></th>
</tr>
</thead>
<tbody>
<tr>
<td>Name</td>
<td><code>IG_DNS_FORWARD</code></td>
</tr>
<tr>
<td>Description</td>
<td><code>Interfaces forced to use Dnsmasq</code></td>
</tr>
<tr>
<td>Members</td>
<td><code>VLAN30_CLEAR</code></td>
</tr>
</tbody>
</table>
<h4 id=ig_ntp>
IG_NTP
<a href=#ig_ntp class=post-heading__anchor aria-hidden=true>#</a>
</h4>
<table>
<thead>
<tr>
<th></th>
<th></th>
</tr>
</thead>
<tbody>
<tr>
<td>Name</td>
<td><code>IG_NTP</code></td>
</tr>
<tr>
<td>Description</td>
<td><code>Interfaces forced to use OPNsense as NTP server</code></td>
</tr>
<tr>
<td>Members</td>
<td><code>VLAN10_MANAGE</code> <code>VLAN20_VPN</code> <code>VLAN30_CLEAR</code></td>
</tr>
</tbody>
</table>
<h3 id=aliases>
Aliases
<a href=#aliases class=post-heading__anchor aria-hidden=true>#</a>
</h3>
<p>We define a few reusable <a href=https://docs.opnsense.org/manual/aliases.html class=link--external target=_blank rel=noreferrer>aliases</a> that help us condense our firewall rules. Some of them might become hard to maintain as they grow, in which case you might want to consider nesting aliases.</p>
<p>
<picture>
<source srcset="/blog/opnsense-baseline-guide-with-vpn-guest-and-vlan-support/firewall-aliases_hudf816a4eb07591b73b52b42c34e57428_8330_300x0_resize_q90_h2_box_3.webp 300w,/blog/opnsense-baseline-guide-with-vpn-guest-and-vlan-support/firewall-aliases_hudf816a4eb07591b73b52b42c34e57428_8330_400x0_resize_q90_h2_box_3.webp 400w,/blog/opnsense-baseline-guide-with-vpn-guest-and-vlan-support/firewall-aliases_hudf816a4eb07591b73b52b42c34e57428_8330_500x0_resize_q90_h2_box_3.webp 500w,/blog/opnsense-baseline-guide-with-vpn-guest-and-vlan-support/firewall-aliases_hudf816a4eb07591b73b52b42c34e57428_8330_600x0_resize_q90_h2_box_3.webp 600w,/blog/opnsense-baseline-guide-with-vpn-guest-and-vlan-support/firewall-aliases_hudf816a4eb07591b73b52b42c34e57428_8330_700x0_resize_q90_h2_box_3.webp 700w">
<img src=/blog/opnsense-baseline-guide-with-vpn-guest-and-vlan-support/firewall-aliases.png srcset="/blog/opnsense-baseline-guide-with-vpn-guest-and-vlan-support/firewall-aliases_hudf816a4eb07591b73b52b42c34e57428_8330_300x0_resize_box_3.png 300w,/blog/opnsense-baseline-guide-with-vpn-guest-and-vlan-support/firewall-aliases_hudf816a4eb07591b73b52b42c34e57428_8330_400x0_resize_box_3.png 400w,/blog/opnsense-baseline-guide-with-vpn-guest-and-vlan-support/firewall-aliases_hudf816a4eb07591b73b52b42c34e57428_8330_500x0_resize_box_3.png 500w,/blog/opnsense-baseline-guide-with-vpn-guest-and-vlan-support/firewall-aliases_hudf816a4eb07591b73b52b42c34e57428_8330_600x0_resize_box_3.png 600w,/blog/opnsense-baseline-guide-with-vpn-guest-and-vlan-support/firewall-aliases_hudf816a4eb07591b73b52b42c34e57428_8330_700x0_resize_box_3.png 700w" alt="Screenshot of firewall aliases" loading=lazy width=814 height=163>
</picture>
</p>
<p>Navigate to <strong>Firewall</strong><span> → </span>
<strong>Aliases</strong> and create the following aliases.</p>
<h4 id=selective-routing-addresses>
Selective Routing Addresses
<a href=#selective-routing-addresses class=post-heading__anchor aria-hidden=true>#</a>
</h4>
<p>Services like banks might object to traffic originating from known VPN endpoints. We selectively route traffic from the VPN VLAN through the default WAN gateway.</p>
<table>
<thead>
<tr>
<th></th>
<th></th>
</tr>
</thead>
<tbody>
<tr>
<td>Name</td>
<td><code>SELECTIVE_ROUTING</code></td>
</tr>
<tr>
<td>Type</td>
<td><code>Host(s)</code></td>
</tr>
<tr>
<td>Description</td>
<td><code>External hosts reachable from IG_OUT_VPN networks through WAN</code></td>
</tr>
</tbody>
</table>
<p>If you&rsquo;re having issues with a service not working due to VPN, add the hostname to this alias, e.g., <code>netflix.com</code>.</p>
<h4 id=admin--anti-lockout-ports>
Admin / Anti-lockout Ports
<a href=#admin--anti-lockout-ports class=post-heading__anchor aria-hidden=true>#</a>
</h4>
<table>
<thead>
<tr>
<th></th>
<th></th>
</tr>
</thead>
<tbody>
<tr>
<td>Name</td>
<td><code>PORTS_ANTI_LOCKOUT</code></td>
</tr>
<tr>
<td>Type</td>
<td><code>Port(s)</code></td>
</tr>
<tr>
<td>Content</td>
<td><code>443</code> (Web GUI) <code>22</code> (SSH)</td>
</tr>
<tr>
<td>Description</td>
<td><code>OPNsense admin ports</code></td>
</tr>
</tbody>
</table>
<h4 id=ports-allowed-to-communicate-between-vlans>
Ports Allowed To Communicate Between VLANs
<a href=#ports-allowed-to-communicate-between-vlans class=post-heading__anchor aria-hidden=true>#</a>
</h4>
<p>Allowed ports for intranet traffic. Amend the list depending on your needs.</p>
<table>
<thead>
<tr>
<th></th>
<th></th>
</tr>
</thead>
<tbody>
<tr>
<td>Name</td>
<td><code>PORTS_OUT_LAN</code></td>
</tr>
<tr>
<td>Type</td>
<td><code>Port(s)</code></td>
</tr>
<tr>
<td>Description</td>
<td><code>Ports allowed for intranet</code></td>
</tr>
</tbody>
</table>
<p>Content:</p>
<ul>
<li><code>53</code> DNS</li>
<li><code>5353:5354</code> mDNS</li>
<li><code>123</code> NTP</li>
<li><code>21</code> FTP</li>
<li><code>22</code> SSH</li>
<li><code>161</code> SNMP</li>
<li><code>80</code> HTTP</li>
<li><code>8080</code>: HTTP alt / UniFi device and application communication</li>
<li><code>443</code> HTTPS</li>
<li><code>8443</code> HTTPS alt / UniFi application GUI/API as seen in a web browser</li>
<li><code>8880</code> UniFi HTTP portal redirection</li>
<li><code>10001</code> UniFi device discovery</li>
<li><code>5001</code> iPerf</li>
<li><code>623</code> IPMI</li>
<li><code>5900</code> VNC</li>
<li><code>3389</code> RDP</li>
<li><code>49152:65535</code> ephemeral ports</li>
</ul>
<h4 id=ports-allowed-to-communicate-with-the-internet>
Ports Allowed to Communicate with the Internet
<a href=#ports-allowed-to-communicate-with-the-internet class=post-heading__anchor aria-hidden=true>#</a>
</h4>
<p>Allow ports for <em>egress</em> internet traffic. Amend the list depending on your needs.</p>
<table>
<thead>
<tr>
<th></th>
<th></th>
</tr>
</thead>
<tbody>
<tr>
<td>Name</td>
<td><code>PORTS_OUT_WAN</code></td>
</tr>
<tr>
<td>Type</td>
<td><code>Port(s)</code></td>
</tr>
<tr>
<td>Description</td>
<td><code>Ports allowed for internet</code></td>
</tr>
</tbody>
</table>
<p>Content:</p>
<ul>
<li><code>21</code> FTP</li>
<li><code>22</code> SSH</li>
<li><code>80</code> HTTP</li>
<li><code>8080</code> HTTP alt</li>
<li><code>443</code> HTTPS</li>
<li><code>8443</code> HTTPS alt</li>
<li><code>465</code> SMTPS</li>
<li><code>587</code>: SMTPS</li>
<li><code>993</code>: IMAPS</li>
<li><code>49152:65535</code> ephemeral ports</li>
</ul>
<h3 id=nat>
NAT
<a href=#nat class=post-heading__anchor aria-hidden=true>#</a>
</h3>
<p>Network Address Translation (NAT) is required to translate private to public IP addresses. We have the following requirements.</p>
<ul>
<li>Translate <code>IG_OUT_WAN</code> and <code>IG_OUT_VPN</code> network addresses to the <code>WAN</code> address range. Translating <code>IG_OUT_VPN</code> to <code>WAN</code> allows selective routing.</li>
<li>Translate <code>IG_OUT_VPN</code> network addresses to the <code>WAN_VPN0</code> address range.</li>
</ul>
<p>
<picture>
<source srcset="/blog/opnsense-baseline-guide-with-vpn-guest-and-vlan-support/firewall-nat_hu1b3c591074d7c0edea425fb3d57d601c_8949_300x0_resize_q90_h2_box_3.webp 300w,/blog/opnsense-baseline-guide-with-vpn-guest-and-vlan-support/firewall-nat_hu1b3c591074d7c0edea425fb3d57d601c_8949_400x0_resize_q90_h2_box_3.webp 400w,/blog/opnsense-baseline-guide-with-vpn-guest-and-vlan-support/firewall-nat_hu1b3c591074d7c0edea425fb3d57d601c_8949_500x0_resize_q90_h2_box_3.webp 500w,/blog/opnsense-baseline-guide-with-vpn-guest-and-vlan-support/firewall-nat_hu1b3c591074d7c0edea425fb3d57d601c_8949_600x0_resize_q90_h2_box_3.webp 600w,/blog/opnsense-baseline-guide-with-vpn-guest-and-vlan-support/firewall-nat_hu1b3c591074d7c0edea425fb3d57d601c_8949_608x0_resize_q90_h2_box_3.webp 608w">
<img src=/blog/opnsense-baseline-guide-with-vpn-guest-and-vlan-support/firewall-nat.png srcset="/blog/opnsense-baseline-guide-with-vpn-guest-and-vlan-support/firewall-nat_hu1b3c591074d7c0edea425fb3d57d601c_8949_300x0_resize_box_3.png 300w,/blog/opnsense-baseline-guide-with-vpn-guest-and-vlan-support/firewall-nat_hu1b3c591074d7c0edea425fb3d57d601c_8949_400x0_resize_box_3.png 400w,/blog/opnsense-baseline-guide-with-vpn-guest-and-vlan-support/firewall-nat_hu1b3c591074d7c0edea425fb3d57d601c_8949_500x0_resize_box_3.png 500w,/blog/opnsense-baseline-guide-with-vpn-guest-and-vlan-support/firewall-nat_hu1b3c591074d7c0edea425fb3d57d601c_8949_600x0_resize_box_3.png 600w,/blog/opnsense-baseline-guide-with-vpn-guest-and-vlan-support/firewall-nat_hu1b3c591074d7c0edea425fb3d57d601c_8949_608x0_resize_box_3.png 608w" alt="Screenshot of NAT rules overview" loading=lazy width=608 height=267>
</picture>
</p>
<p>Navigate to <strong>Firewall</strong><span> → </span>
<strong>NAT</strong><span> → </span>
<strong>Outbound</strong>.</p>
<p>Select <code>Manual outbound NAT rule generation</code> and add the following rules.</p>
<h4 id=ig_out_wan-to-wan>
IG_OUT_WAN to WAN
<a href=#ig_out_wan-to-wan class=post-heading__anchor aria-hidden=true>#</a>
</h4>
<table>
<thead>
<tr>
<th></th>
<th></th>
</tr>
</thead>
<tbody>
<tr>
<td>Interface</td>
<td><code>WAN</code></td>
</tr>
<tr>
<td>Source address</td>
<td><code>IG_OUT_WAN net</code></td>
</tr>
<tr>
<td>Description</td>
<td><code>IG_OUT_WAN to WAN</code></td>
</tr>
</tbody>
</table>
<h4 id=ig_out_vpn-to-wan>
IG_OUT_VPN to WAN
<a href=#ig_out_vpn-to-wan class=post-heading__anchor aria-hidden=true>#</a>
</h4>
<table>
<thead>
<tr>
<th></th>
<th></th>
</tr>
</thead>
<tbody>
<tr>
<td>Interface</td>
<td><code>WAN</code></td>
</tr>
<tr>
<td>Source address</td>
<td><code>IG_OUT_VPN net</code></td>
</tr>
<tr>
<td>Description</td>
<td><code>IG_OUT_VPN to WAN</code></td>
</tr>
</tbody>
</table>
<h4 id=ig_out_vpn-to-wan_vpn0>
IG_OUT_VPN to WAN_VPN0
<a href=#ig_out_vpn-to-wan_vpn0 class=post-heading__anchor aria-hidden=true>#</a>
</h4>
<table>
<thead>
<tr>
<th></th>
<th></th>
</tr>
</thead>
<tbody>
<tr>
<td>Interface</td>
<td><code>WAN_VPN0</code></td>
</tr>
<tr>
<td>Source address</td>
<td><code>IG_OUT_VPN net</code></td>
</tr>
<tr>
<td>Description</td>
<td><code>IG_OUT_VPN to WAN_VPN0</code></td>
</tr>
</tbody>
</table>
<h4 id=ig_out_vpn-to-wan_vpn1>
IG_OUT_VPN to WAN_VPN1
<a href=#ig_out_vpn-to-wan_vpn1 class=post-heading__anchor aria-hidden=true>#</a>
</h4>
<table>
<thead>
<tr>
<th></th>
<th></th>
</tr>
</thead>
<tbody>
<tr>
<td>Interface</td>
<td><code>WAN_VPN1</code></td>
</tr>
<tr>
<td>Source address</td>
<td><code>IG_OUT_VPN net</code></td>
</tr>
<tr>
<td>Description</td>
<td><code>IG_OUT_VPN to WAN_VPN1</code></td>
</tr>
</tbody>
</table>
<h3 id=rules>
Rules
<a href=#rules class=post-heading__anchor aria-hidden=true>#</a>
</h3>
<p>Navigate to <strong>Firewall</strong><span> → </span>
<strong>Rules</strong>.</p>
<h4 id=anti-lockout>
Anti-Lockout
<a href=#anti-lockout class=post-heading__anchor aria-hidden=true>#</a>
</h4>
<p>Before adding any other rules, we add the anti-lockout ones on the <code>VLAN10_MANAGE</code> and <code>LAN</code> networks, so we can&rsquo;t lock ourselves out. 😅</p>
<p>
<picture>
<source srcset="/blog/opnsense-baseline-guide-with-vpn-guest-and-vlan-support/firewall-rules-anti-lockout_hu330dfe5840c581851e9ad0095d871d8f_3010_300x0_resize_q90_h2_box_3.webp 300w,/blog/opnsense-baseline-guide-with-vpn-guest-and-vlan-support/firewall-rules-anti-lockout_hu330dfe5840c581851e9ad0095d871d8f_3010_400x0_resize_q90_h2_box_3.webp 400w,/blog/opnsense-baseline-guide-with-vpn-guest-and-vlan-support/firewall-rules-anti-lockout_hu330dfe5840c581851e9ad0095d871d8f_3010_500x0_resize_q90_h2_box_3.webp 500w,/blog/opnsense-baseline-guide-with-vpn-guest-and-vlan-support/firewall-rules-anti-lockout_hu330dfe5840c581851e9ad0095d871d8f_3010_600x0_resize_q90_h2_box_3.webp 600w,/blog/opnsense-baseline-guide-with-vpn-guest-and-vlan-support/firewall-rules-anti-lockout_hu330dfe5840c581851e9ad0095d871d8f_3010_640x0_resize_q90_h2_box_3.webp 640w">
<img src=/blog/opnsense-baseline-guide-with-vpn-guest-and-vlan-support/firewall-rules-anti-lockout.png srcset="/blog/opnsense-baseline-guide-with-vpn-guest-and-vlan-support/firewall-rules-anti-lockout_hu330dfe5840c581851e9ad0095d871d8f_3010_300x0_resize_box_3.png 300w,/blog/opnsense-baseline-guide-with-vpn-guest-and-vlan-support/firewall-rules-anti-lockout_hu330dfe5840c581851e9ad0095d871d8f_3010_400x0_resize_box_3.png 400w,/blog/opnsense-baseline-guide-with-vpn-guest-and-vlan-support/firewall-rules-anti-lockout_hu330dfe5840c581851e9ad0095d871d8f_3010_500x0_resize_box_3.png 500w,/blog/opnsense-baseline-guide-with-vpn-guest-and-vlan-support/firewall-rules-anti-lockout_hu330dfe5840c581851e9ad0095d871d8f_3010_600x0_resize_box_3.png 600w,/blog/opnsense-baseline-guide-with-vpn-guest-and-vlan-support/firewall-rules-anti-lockout_hu330dfe5840c581851e9ad0095d871d8f_3010_640x0_resize_box_3.png 640w" alt="Screenshot of anti-lockout rule" loading=lazy width=640 height=97>
</picture>
</p>
<p>Select <strong>Floating</strong> and add the following rule.</p>
<table>
<thead>
<tr>
<th></th>
<th></th>
</tr>
</thead>
<tbody>
<tr>
<td>Action</td>
<td><code>Pass</code></td>
</tr>
<tr>
<td>Interface</td>
<td><code>LAN</code> <code>VLAN10_MANAGE</code></td>
</tr>
<tr>
<td>Protocol</td>
<td><code>TCP/UDP</code></td>
</tr>
<tr>
<td>Source</td>
<td><code>any</code></td>
</tr>
<tr>
<td>Destination</td>
<td><code>This Firewall</code></td>
</tr>
<tr>
<td>Destination port range</td>
<td><code>PORTS_ANTI_LOCKOUT</code></td>
</tr>
<tr>
<td>Description</td>
<td><code>Anti-lockout</code></td>
</tr>
</tbody>
</table>
<p><code>This Firewall</code> is a pre-defined alias representing all interface addresses of OPNsense.</p>
<h4 id=allow-intranet-pings>
Allow Intranet Pings
<a href=#allow-intranet-pings class=post-heading__anchor aria-hidden=true>#</a>
</h4>
<p>We allow ICMP pings for the entire local network. Pings are maliciously abusable, so you may want to put stricter rules into place if required.</p>
<p>
<picture>
<source srcset="/blog/opnsense-baseline-guide-with-vpn-guest-and-vlan-support/firewall-rules-intranet_hua6404747b1f0fe7f6bf23b65ed4a5415_8342_300x0_resize_q90_h2_box_3.webp 300w,/blog/opnsense-baseline-guide-with-vpn-guest-and-vlan-support/firewall-rules-intranet_hua6404747b1f0fe7f6bf23b65ed4a5415_8342_400x0_resize_q90_h2_box_3.webp 400w,/blog/opnsense-baseline-guide-with-vpn-guest-and-vlan-support/firewall-rules-intranet_hua6404747b1f0fe7f6bf23b65ed4a5415_8342_500x0_resize_q90_h2_box_3.webp 500w,/blog/opnsense-baseline-guide-with-vpn-guest-and-vlan-support/firewall-rules-intranet_hua6404747b1f0fe7f6bf23b65ed4a5415_8342_600x0_resize_q90_h2_box_3.webp 600w,/blog/opnsense-baseline-guide-with-vpn-guest-and-vlan-support/firewall-rules-intranet_hua6404747b1f0fe7f6bf23b65ed4a5415_8342_657x0_resize_q90_h2_box_3.webp 657w">
<img src=/blog/opnsense-baseline-guide-with-vpn-guest-and-vlan-support/firewall-rules-intranet.png srcset="/blog/opnsense-baseline-guide-with-vpn-guest-and-vlan-support/firewall-rules-intranet_hua6404747b1f0fe7f6bf23b65ed4a5415_8342_300x0_resize_box_3.png 300w,/blog/opnsense-baseline-guide-with-vpn-guest-and-vlan-support/firewall-rules-intranet_hua6404747b1f0fe7f6bf23b65ed4a5415_8342_400x0_resize_box_3.png 400w,/blog/opnsense-baseline-guide-with-vpn-guest-and-vlan-support/firewall-rules-intranet_hua6404747b1f0fe7f6bf23b65ed4a5415_8342_500x0_resize_box_3.png 500w,/blog/opnsense-baseline-guide-with-vpn-guest-and-vlan-support/firewall-rules-intranet_hua6404747b1f0fe7f6bf23b65ed4a5415_8342_600x0_resize_box_3.png 600w,/blog/opnsense-baseline-guide-with-vpn-guest-and-vlan-support/firewall-rules-intranet_hua6404747b1f0fe7f6bf23b65ed4a5415_8342_657x0_resize_box_3.png 657w" alt="Screenshot of intranet firewall rules" loading=lazy width=657 height=131>
</picture>
</p>
<p>Select <strong>IG_LOCAL</strong> and add the following rule.</p>
<table>
<thead>
<tr>
<th></th>
<th></th>
</tr>
</thead>
<tbody>
<tr>
<td>Action</td>
<td><code>Pass</code></td>
</tr>
<tr>
<td>Interface</td>
<td><code>IG_LOCAL</code></td>
</tr>
<tr>
<td>TCP/IP Version</td>
<td><code>IPv4</code></td>
</tr>
<tr>
<td>Protocol</td>
<td><code>ICMP</code></td>
</tr>
<tr>
<td>ICMP type</td>
<td><code>Echo Request</code></td>
</tr>
<tr>
<td>Source</td>
<td><code>IG_LOCAL net</code></td>
</tr>
<tr>
<td>Description</td>
<td><code>Allow intranet pings</code></td>
</tr>
</tbody>
</table>
<h4 id=reject-intranet-traffic-by-default>
Reject Intranet Traffic By Default
<a href=#reject-intranet-traffic-by-default class=post-heading__anchor aria-hidden=true>#</a>
</h4>
<p>By default, we <em>reject</em> traffic on local interfaces instead of <em>blocking</em> it. <em>Block</em> drops packets silently. <em>Reject</em> returns a &ldquo;friendly&rdquo; response to the sender. To be able to override this rule, unchecking <strong>Quick</strong> is crucial! To use <a href=https://docs.opnsense.org/manual/logging_firewall.html class=link--external target=_blank rel=noreferrer>Firewall Logs</a> to review blocked ports and amend our port list alias if necessary, we enable logging on this rule.</p>
<p>Select <strong>IG_LOCAL</strong> and add the following rule.</p>
<table>
<thead>
<tr>
<th></th>
<th></th>
</tr>
</thead>
<tbody>
<tr>
<td>Action</td>
<td><code>Reject</code></td>
</tr>
<tr>
<td><strong>Quick</strong></td>
<td><code>unchecked</code></td>
</tr>
<tr>
<td>Interface</td>
<td><code>IG_LOCAL</code></td>
</tr>
<tr>
<td>TCP/IP Version</td>
<td><code>IPv4+IPv6</code></td>
</tr>
<tr>
<td>Protocol</td>
<td><code>any</code></td>
</tr>
<tr>
<td>Source</td>
<td><code>IG_LOCAL net</code></td>
</tr>
<tr>
<td>Log</td>
<td><code>checked</code></td>
</tr>
<tr>
<td>Description</td>
<td><code>Reject intranet traffic by default</code></td>
</tr>
</tbody>
</table>
<h4 id=allow-intranet-traffic>
Allow Intranet Traffic
<a href=#allow-intranet-traffic class=post-heading__anchor aria-hidden=true>#</a>
</h4>
<p>We only allow intranet traffic on the ports defined in the <code>PORTS_OUT_LAN</code> alias. We&rsquo;ll override this rule for the <code>VLAN40_GUEST</code> network later, so we must uncheck the <strong>Quick</strong> option again. For the Management network, you might want to consider stricter rules, as well.</p>
<p>Select <strong>IG_LOCAL</strong> and add the following rule.</p>
<table>
<thead>
<tr>
<th></th>
<th></th>
</tr>
</thead>
<tbody>
<tr>
<td>Action</td>
<td><code>Pass</code></td>
</tr>
<tr>
<td><strong>Quick</strong></td>
<td><code>unchecked</code></td>
</tr>
<tr>
<td>Interface</td>
<td><code>IG_LOCAL</code></td>
</tr>
<tr>
<td>Protocol</td>
<td><code>TCP/UDP</code></td>
</tr>
<tr>
<td>Source</td>
<td><code>IG_LOCAL net</code></td>
</tr>
<tr>
<td>Destination</td>
<td><code>IG_LOCAL net</code></td>
</tr>
<tr>
<td>Destination port range</td>
<td><code>PORTS_OUT_LAN</code></td>
</tr>
<tr>
<td>Description</td>
<td><code>Allow intranet traffic</code></td>
</tr>
</tbody>
</table>
<h4 id=allow-internet-traffic>
Allow Internet Traffic
<a href=#allow-internet-traffic class=post-heading__anchor aria-hidden=true>#</a>
</h4>
<p>We allow internet traffic on <code>PORTS_OUT_WAN</code> for <code>IG_OUT_WAN</code> networks.</p>
<p>
<picture>
<source srcset="/blog/opnsense-baseline-guide-with-vpn-guest-and-vlan-support/firewall-rules-out-wan_hu1b82aa596cf86ce634c1df767449f57c_3165_300x0_resize_q90_h2_box_3.webp 300w,/blog/opnsense-baseline-guide-with-vpn-guest-and-vlan-support/firewall-rules-out-wan_hu1b82aa596cf86ce634c1df767449f57c_3165_400x0_resize_q90_h2_box_3.webp 400w,/blog/opnsense-baseline-guide-with-vpn-guest-and-vlan-support/firewall-rules-out-wan_hu1b82aa596cf86ce634c1df767449f57c_3165_500x0_resize_q90_h2_box_3.webp 500w,/blog/opnsense-baseline-guide-with-vpn-guest-and-vlan-support/firewall-rules-out-wan_hu1b82aa596cf86ce634c1df767449f57c_3165_600x0_resize_q90_h2_box_3.webp 600w,/blog/opnsense-baseline-guide-with-vpn-guest-and-vlan-support/firewall-rules-out-wan_hu1b82aa596cf86ce634c1df767449f57c_3165_680x0_resize_q90_h2_box_3.webp 680w">
<img src=/blog/opnsense-baseline-guide-with-vpn-guest-and-vlan-support/firewall-rules-out-wan.png srcset="/blog/opnsense-baseline-guide-with-vpn-guest-and-vlan-support/firewall-rules-out-wan_hu1b82aa596cf86ce634c1df767449f57c_3165_300x0_resize_box_3.png 300w,/blog/opnsense-baseline-guide-with-vpn-guest-and-vlan-support/firewall-rules-out-wan_hu1b82aa596cf86ce634c1df767449f57c_3165_400x0_resize_box_3.png 400w,/blog/opnsense-baseline-guide-with-vpn-guest-and-vlan-support/firewall-rules-out-wan_hu1b82aa596cf86ce634c1df767449f57c_3165_500x0_resize_box_3.png 500w,/blog/opnsense-baseline-guide-with-vpn-guest-and-vlan-support/firewall-rules-out-wan_hu1b82aa596cf86ce634c1df767449f57c_3165_600x0_resize_box_3.png 600w,/blog/opnsense-baseline-guide-with-vpn-guest-and-vlan-support/firewall-rules-out-wan_hu1b82aa596cf86ce634c1df767449f57c_3165_680x0_resize_box_3.png 680w" alt="Screenshot of IG_OUT_WAN firewall rules" loading=lazy width=680 height=60>
</picture>
</p>
<p>Select <strong>IG_OUT_WAN</strong> and add the following rule.</p>
<table>
<thead>
<tr>
<th></th>
<th></th>
</tr>
</thead>
<tbody>
<tr>
<td>Action</td>
<td><code>Pass</code></td>
</tr>
<tr>
<td><strong>Quick</strong></td>
<td><code>unchecked</code></td>
</tr>
<tr>
<td>Interface</td>
<td><code>IG_OUT_WAN</code></td>
</tr>
<tr>
<td>Protocol</td>
<td><code>TCP/UDP</code></td>
</tr>
<tr>
<td>Source</td>
<td><code>IG_OUT_WAN net</code></td>
</tr>
<tr>
<td>Destination / Invert</td>
<td><code>checked</code></td>
</tr>
<tr>
<td>Destination</td>
<td><code>IG_LOCAL net</code></td>
</tr>
<tr>
<td>Destination port range</td>
<td><code>PORTS_OUT_WAN</code></td>
</tr>
<tr>
<td>Description</td>
<td><code>Allow internet traffic through WAN</code></td>
</tr>
</tbody>
</table>
<p>We later want to enable unrestricted internet access on the Guest network, so make sure to uncheck the <strong>Quick</strong> option!</p>
<p>Next, we allow internet traffic on <code>PORTS_OUT_WAN</code> for the <code>IG_OUT_VPN</code> networks.</p>
<p>
<picture>
<source srcset="/blog/opnsense-baseline-guide-with-vpn-guest-and-vlan-support/firewall-rules-out-vpn_hu3ced312203a1027a64c890e0f751e15c_9495_300x0_resize_q90_h2_box_3.webp 300w,/blog/opnsense-baseline-guide-with-vpn-guest-and-vlan-support/firewall-rules-out-vpn_hu3ced312203a1027a64c890e0f751e15c_9495_400x0_resize_q90_h2_box_3.webp 400w,/blog/opnsense-baseline-guide-with-vpn-guest-and-vlan-support/firewall-rules-out-vpn_hu3ced312203a1027a64c890e0f751e15c_9495_500x0_resize_q90_h2_box_3.webp 500w,/blog/opnsense-baseline-guide-with-vpn-guest-and-vlan-support/firewall-rules-out-vpn_hu3ced312203a1027a64c890e0f751e15c_9495_600x0_resize_q90_h2_box_3.webp 600w,/blog/opnsense-baseline-guide-with-vpn-guest-and-vlan-support/firewall-rules-out-vpn_hu3ced312203a1027a64c890e0f751e15c_9495_700x0_resize_q90_h2_box_3.webp 700w">
<img src=/blog/opnsense-baseline-guide-with-vpn-guest-and-vlan-support/firewall-rules-out-vpn.png srcset="/blog/opnsense-baseline-guide-with-vpn-guest-and-vlan-support/firewall-rules-out-vpn_hu3ced312203a1027a64c890e0f751e15c_9495_300x0_resize_box_3.png 300w,/blog/opnsense-baseline-guide-with-vpn-guest-and-vlan-support/firewall-rules-out-vpn_hu3ced312203a1027a64c890e0f751e15c_9495_400x0_resize_box_3.png 400w,/blog/opnsense-baseline-guide-with-vpn-guest-and-vlan-support/firewall-rules-out-vpn_hu3ced312203a1027a64c890e0f751e15c_9495_500x0_resize_box_3.png 500w,/blog/opnsense-baseline-guide-with-vpn-guest-and-vlan-support/firewall-rules-out-vpn_hu3ced312203a1027a64c890e0f751e15c_9495_600x0_resize_box_3.png 600w,/blog/opnsense-baseline-guide-with-vpn-guest-and-vlan-support/firewall-rules-out-vpn_hu3ced312203a1027a64c890e0f751e15c_9495_700x0_resize_box_3.png 700w" alt="Screenshot of IG_OUT_VPN firewall rules" loading=lazy width=702 height=213>
</picture>
</p>
<p>Select <strong>IG_OUT_VPN</strong> and add the following rules to configure selective routing.</p>
<table>
<thead>
<tr>
<th></th>
<th></th>
</tr>
</thead>
<tbody>
<tr>
<td>Action</td>
<td><code>Pass</code></td>
</tr>
<tr>
<td>Interface</td>
<td><code>IG_OUT_VPN</code></td>
</tr>
<tr>
<td>Protocol</td>
<td><code>TCP/UDP</code></td>
</tr>
<tr>
<td>Source</td>
<td><code>IG_OUT_VPN net</code></td>
</tr>
<tr>
<td>Destination</td>
<td><code>SELECTIVE_ROUTING</code></td>
</tr>
<tr>
<td>Destination port range</td>
<td><code>PORTS_OUT_WAN</code></td>
</tr>
<tr>
<td>Description</td>
<td><code>Allow selected internet traffic through WAN</code></td>
</tr>
</tbody>
</table>
<table>
<thead>
<tr>
<th></th>
<th></th>
</tr>
</thead>
<tbody>
<tr>
<td>Action</td>
<td><code>Pass</code></td>
</tr>
<tr>
<td>Protocol</td>
<td><code>TCP/UDP</code></td>
</tr>
<tr>
<td>Source</td>
<td><code>IG_OUT_VPN net</code></td>
</tr>
<tr>
<td>Destination / Invert</td>
<td><code>checked</code></td>
</tr>
<tr>
<td>Destination</td>
<td><code>IG_LOCAL net</code></td>
</tr>
<tr>
<td>Destination port range</td>
<td><code>PORTS_OUT_WAN</code></td>
</tr>
<tr>
<td>Description</td>
<td><code>Allow internet traffic through WAN_VPN0</code></td>
</tr>
<tr>
<td>Gateway</td>
<td><code>WAN_VPN_GROUP</code></td>
</tr>
</tbody>
</table>
<h4 id=restrict-guest-network>
Restrict Guest Network
<a href=#restrict-guest-network class=post-heading__anchor aria-hidden=true>#</a>
</h4>
<p>Select <strong>VLAN40_GUEST</strong> and add the following rules.</p>
<p>
<picture>
<source srcset="/blog/opnsense-baseline-guide-with-vpn-guest-and-vlan-support/firewall-rules-guest_hufb2829afaffb41b7f36d672a016a2c8c_10398_300x0_resize_q90_h2_box_3.webp 300w,/blog/opnsense-baseline-guide-with-vpn-guest-and-vlan-support/firewall-rules-guest_hufb2829afaffb41b7f36d672a016a2c8c_10398_400x0_resize_q90_h2_box_3.webp 400w,/blog/opnsense-baseline-guide-with-vpn-guest-and-vlan-support/firewall-rules-guest_hufb2829afaffb41b7f36d672a016a2c8c_10398_500x0_resize_q90_h2_box_3.webp 500w,/blog/opnsense-baseline-guide-with-vpn-guest-and-vlan-support/firewall-rules-guest_hufb2829afaffb41b7f36d672a016a2c8c_10398_600x0_resize_q90_h2_box_3.webp 600w,/blog/opnsense-baseline-guide-with-vpn-guest-and-vlan-support/firewall-rules-guest_hufb2829afaffb41b7f36d672a016a2c8c_10398_700x0_resize_q90_h2_box_3.webp 700w">
<img src=/blog/opnsense-baseline-guide-with-vpn-guest-and-vlan-support/firewall-rules-guest.png srcset="/blog/opnsense-baseline-guide-with-vpn-guest-and-vlan-support/firewall-rules-guest_hufb2829afaffb41b7f36d672a016a2c8c_10398_300x0_resize_box_3.png 300w,/blog/opnsense-baseline-guide-with-vpn-guest-and-vlan-support/firewall-rules-guest_hufb2829afaffb41b7f36d672a016a2c8c_10398_400x0_resize_box_3.png 400w,/blog/opnsense-baseline-guide-with-vpn-guest-and-vlan-support/firewall-rules-guest_hufb2829afaffb41b7f36d672a016a2c8c_10398_500x0_resize_box_3.png 500w,/blog/opnsense-baseline-guide-with-vpn-guest-and-vlan-support/firewall-rules-guest_hufb2829afaffb41b7f36d672a016a2c8c_10398_600x0_resize_box_3.png 600w,/blog/opnsense-baseline-guide-with-vpn-guest-and-vlan-support/firewall-rules-guest_hufb2829afaffb41b7f36d672a016a2c8c_10398_700x0_resize_box_3.png 700w" alt="Screenshot of Guest network firewall rules" loading=lazy width=708 height=163>
</picture>
</p>
<p>To block Web GUI and SSH access from the Guest network, we block traffic to any OPNsense interface on the <code>PORTS_ANTI_LOCKOUT</code> ports. We enable logging for this rule to be able to see if any guests try to access OPNsense.</p>
<table>
<thead>
<tr>
<th></th>
<th></th>
</tr>
</thead>
<tbody>
<tr>
<td>Action</td>
<td><code>Block</code></td>
</tr>
<tr>
<td>Interface</td>
<td><code>VLAN40_GUEST</code></td>
</tr>
<tr>
<td>Protocol</td>
<td><code>TCP/UDP</code></td>
</tr>
<tr>
<td>Source</td>
<td><code>VLAN40_GUEST net</code></td>
</tr>
<tr>
<td>Destination</td>
<td><code>This Firewall</code></td>
</tr>
<tr>
<td>Destination port range</td>
<td><code>PORTS_ANTI_LOCKOUT</code></td>
</tr>
<tr>
<td>Log</td>
<td><code>checked</code></td>
</tr>
<tr>
<td>Description</td>
<td><code>Block admin ports</code></td>
</tr>
</tbody>
</table>
<p>We block access to other local networks and also enable logging for the rule.</p>
<table>
<thead>
<tr>
<th></th>
<th></th>
</tr>
</thead>
<tbody>
<tr>
<td>Action</td>
<td><code>Block</code></td>
</tr>
<tr>
<td>Interface</td>
<td><code>VLAN40_GUEST</code></td>
</tr>
<tr>
<td>Protocol</td>
<td><code>TCP/UDP</code></td>
</tr>
<tr>
<td>Source</td>
<td><code>VLAN40_GUEST net</code></td>
</tr>
<tr>
<td>Destination</td>
<td><code>IG_LOCAL net</code></td>
</tr>
<tr>
<td>Log</td>
<td><code>checked</code></td>
</tr>
<tr>
<td>Description</td>
<td><code>Block traffic to local networks</code></td>
</tr>
</tbody>
</table>
<p>Finally, we enable unrestricted internet access on Guest networks.</p>
<table>
<thead>
<tr>
<th></th>
<th></th>
</tr>
</thead>
<tbody>
<tr>
<td>Action</td>
<td><code>Pass</code></td>
</tr>
<tr>
<td>Interface</td>
<td><code>VLAN40_GUEST</code></td>
</tr>
<tr>
<td>Protocol</td>
<td><code>TCP/UDP</code></td>
</tr>
<tr>
<td>Source</td>
<td><code>VLAN40_GUEST net</code></td>
</tr>
<tr>
<td>Destination / Invert</td>
<td><code>checked</code></td>
</tr>
<tr>
<td>Destination</td>
<td><code>IG_LOCAL net</code></td>
</tr>
<tr>
<td>Description</td>
<td><code>Unrestricted internet access</code></td>
</tr>
</tbody>
</table>
<h4 id=lan-network-for-testing-and-debugging>
LAN Network For Testing And Debugging
<a href=#lan-network-for-testing-and-debugging class=post-heading__anchor aria-hidden=true>#</a>
</h4>
<p>I just keep the pre-defined &ldquo;LAN to any&rdquo; rules. I periodically reconfigure this network for testing and debugging and don&rsquo;t use it for anything else.</p>
<p>
<picture>
<source srcset="/blog/opnsense-baseline-guide-with-vpn-guest-and-vlan-support/firewall-rules-lan_hubc965766b534656144722876a8989f32_10151_300x0_resize_q90_h2_box_3.webp 300w,/blog/opnsense-baseline-guide-with-vpn-guest-and-vlan-support/firewall-rules-lan_hubc965766b534656144722876a8989f32_10151_400x0_resize_q90_h2_box_3.webp 400w,/blog/opnsense-baseline-guide-with-vpn-guest-and-vlan-support/firewall-rules-lan_hubc965766b534656144722876a8989f32_10151_500x0_resize_q90_h2_box_3.webp 500w,/blog/opnsense-baseline-guide-with-vpn-guest-and-vlan-support/firewall-rules-lan_hubc965766b534656144722876a8989f32_10151_600x0_resize_q90_h2_box_3.webp 600w,/blog/opnsense-baseline-guide-with-vpn-guest-and-vlan-support/firewall-rules-lan_hubc965766b534656144722876a8989f32_10151_700x0_resize_q90_h2_box_3.webp 700w">
<img src=/blog/opnsense-baseline-guide-with-vpn-guest-and-vlan-support/firewall-rules-lan.png srcset="/blog/opnsense-baseline-guide-with-vpn-guest-and-vlan-support/firewall-rules-lan_hubc965766b534656144722876a8989f32_10151_300x0_resize_box_3.png 300w,/blog/opnsense-baseline-guide-with-vpn-guest-and-vlan-support/firewall-rules-lan_hubc965766b534656144722876a8989f32_10151_400x0_resize_box_3.png 400w,/blog/opnsense-baseline-guide-with-vpn-guest-and-vlan-support/firewall-rules-lan_hubc965766b534656144722876a8989f32_10151_500x0_resize_box_3.png 500w,/blog/opnsense-baseline-guide-with-vpn-guest-and-vlan-support/firewall-rules-lan_hubc965766b534656144722876a8989f32_10151_600x0_resize_box_3.png 600w,/blog/opnsense-baseline-guide-with-vpn-guest-and-vlan-support/firewall-rules-lan_hubc965766b534656144722876a8989f32_10151_700x0_resize_box_3.png 700w" alt="Screenshot of LAN rules" loading=lazy width=730 height=182>
</picture>
</p>
<h4 id=redirect-outbound-dns-traffic>
Redirect Outbound DNS Traffic
<a href=#redirect-outbound-dns-traffic class=post-heading__anchor aria-hidden=true>#</a>
</h4>
<p>To prevent clients from explicitly querying outbound DNS and leaking information to the outside, we redirect any outbound DNS traffic to Unbound or Dnsmasq.</p>
<p>
<picture>
<source srcset="/blog/opnsense-baseline-guide-with-vpn-guest-and-vlan-support/firewall-port-forward-dns_huc76d4d507933e9efe82e1347da3c9709_5683_300x0_resize_q90_h2_box_3.webp 300w,/blog/opnsense-baseline-guide-with-vpn-guest-and-vlan-support/firewall-port-forward-dns_huc76d4d507933e9efe82e1347da3c9709_5683_400x0_resize_q90_h2_box_3.webp 400w,/blog/opnsense-baseline-guide-with-vpn-guest-and-vlan-support/firewall-port-forward-dns_huc76d4d507933e9efe82e1347da3c9709_5683_500x0_resize_q90_h2_box_3.webp 500w,/blog/opnsense-baseline-guide-with-vpn-guest-and-vlan-support/firewall-port-forward-dns_huc76d4d507933e9efe82e1347da3c9709_5683_600x0_resize_q90_h2_box_3.webp 600w,/blog/opnsense-baseline-guide-with-vpn-guest-and-vlan-support/firewall-port-forward-dns_huc76d4d507933e9efe82e1347da3c9709_5683_700x0_resize_q90_h2_box_3.webp 700w">
<img src=/blog/opnsense-baseline-guide-with-vpn-guest-and-vlan-support/firewall-port-forward-dns.png srcset="/blog/opnsense-baseline-guide-with-vpn-guest-and-vlan-support/firewall-port-forward-dns_huc76d4d507933e9efe82e1347da3c9709_5683_300x0_resize_box_3.png 300w,/blog/opnsense-baseline-guide-with-vpn-guest-and-vlan-support/firewall-port-forward-dns_huc76d4d507933e9efe82e1347da3c9709_5683_400x0_resize_box_3.png 400w,/blog/opnsense-baseline-guide-with-vpn-guest-and-vlan-support/firewall-port-forward-dns_huc76d4d507933e9efe82e1347da3c9709_5683_500x0_resize_box_3.png 500w,/blog/opnsense-baseline-guide-with-vpn-guest-and-vlan-support/firewall-port-forward-dns_huc76d4d507933e9efe82e1347da3c9709_5683_600x0_resize_box_3.png 600w,/blog/opnsense-baseline-guide-with-vpn-guest-and-vlan-support/firewall-port-forward-dns_huc76d4d507933e9efe82e1347da3c9709_5683_700x0_resize_box_3.png 700w" alt="Screenshot of DNS port forwarding configuration" loading=lazy width=718 height=127>
</picture>
</p>
<p>Navigate to <strong>Firewall</strong><span> → </span>
<strong>NAT</strong><span> → </span>
<strong>Port Forward</strong> and add the following rules.</p>
<table>
<thead>
<tr>
<th></th>
<th></th>
</tr>
</thead>
<tbody>
<tr>
<td>Interface</td>
<td><code>IG_DNS_FORWARD</code></td>
</tr>
<tr>
<td>Protocol</td>
<td><code>TCP/UDP</code></td>
</tr>
<tr>
<td>Source</td>
<td><code>IG_DNS_FORWARD net</code></td>
</tr>
<tr>
<td>Destination</td>
<td><code>any</code></td>
</tr>
<tr>
<td>Destination port range</td>
<td><code>DNS</code></td>
</tr>
<tr>
<td>Redirect target IP</td>
<td><code>127.0.0.1</code></td>
</tr>
<tr>
<td>Redirect target port</td>
<td><code>5335</code></td>
</tr>
<tr>
<td>Description</td>
<td><code>Redirect any DNS traffic to Dnsmasq</code></td>
</tr>
</tbody>
</table>
<table>
<thead>
<tr>
<th></th>
<th></th>
</tr>
</thead>
<tbody>
<tr>
<td>Interface</td>
<td><code>IG_DNS_RESOLVE</code></td>
</tr>
<tr>
<td>Protocol</td>
<td><code>TCP/UDP</code></td>
</tr>
<tr>
<td>Source</td>
<td><code>IG_DNS_RESOLVE net</code></td>
</tr>
<tr>
<td>Destination / Invert</td>
<td><code>checked</code></td>
</tr>
<tr>
<td>Destination</td>
<td><code>IG_DNS_RESOLVE net</code></td>
</tr>
<tr>
<td>Destination port range</td>
<td><code>DNS</code></td>
</tr>
<tr>
<td>Redirect target IP</td>
<td><code>127.0.0.1</code></td>
</tr>
<tr>
<td>Redirect target port</td>
<td><code>DNS</code></td>
</tr>
<tr>
<td>Description</td>
<td><code>Redirect outbound DNS traffic to Unbound</code></td>
</tr>
</tbody>
</table>
<h4 id=redirect-outbound-ntp-traffic>
Redirect Outbound NTP Traffic
<a href=#redirect-outbound-ntp-traffic class=post-heading__anchor aria-hidden=true>#</a>
</h4>
<p>To sync the time of all our devices on the network to OPNsense, we redirect all NTP traffic.</p>
<p>
<picture>
<source srcset="/blog/opnsense-baseline-guide-with-vpn-guest-and-vlan-support/firewall-port-forward-ntp_hu5e4b50b264007597de7a075b5e4bc491_1603_300x0_resize_q90_h2_box_3.webp 300w,/blog/opnsense-baseline-guide-with-vpn-guest-and-vlan-support/firewall-port-forward-ntp_hu5e4b50b264007597de7a075b5e4bc491_1603_400x0_resize_q90_h2_box_3.webp 400w,/blog/opnsense-baseline-guide-with-vpn-guest-and-vlan-support/firewall-port-forward-ntp_hu5e4b50b264007597de7a075b5e4bc491_1603_500x0_resize_q90_h2_box_3.webp 500w,/blog/opnsense-baseline-guide-with-vpn-guest-and-vlan-support/firewall-port-forward-ntp_hu5e4b50b264007597de7a075b5e4bc491_1603_600x0_resize_q90_h2_box_3.webp 600w,/blog/opnsense-baseline-guide-with-vpn-guest-and-vlan-support/firewall-port-forward-ntp_hu5e4b50b264007597de7a075b5e4bc491_1603_700x0_resize_q90_h2_box_3.webp 700w">
<img src=/blog/opnsense-baseline-guide-with-vpn-guest-and-vlan-support/firewall-port-forward-ntp.png srcset="/blog/opnsense-baseline-guide-with-vpn-guest-and-vlan-support/firewall-port-forward-ntp_hu5e4b50b264007597de7a075b5e4bc491_1603_300x0_resize_box_3.png 300w,/blog/opnsense-baseline-guide-with-vpn-guest-and-vlan-support/firewall-port-forward-ntp_hu5e4b50b264007597de7a075b5e4bc491_1603_400x0_resize_box_3.png 400w,/blog/opnsense-baseline-guide-with-vpn-guest-and-vlan-support/firewall-port-forward-ntp_hu5e4b50b264007597de7a075b5e4bc491_1603_500x0_resize_box_3.png 500w,/blog/opnsense-baseline-guide-with-vpn-guest-and-vlan-support/firewall-port-forward-ntp_hu5e4b50b264007597de7a075b5e4bc491_1603_600x0_resize_box_3.png 600w,/blog/opnsense-baseline-guide-with-vpn-guest-and-vlan-support/firewall-port-forward-ntp_hu5e4b50b264007597de7a075b5e4bc491_1603_700x0_resize_box_3.png 700w" alt="Screenshot of NTP port forwarding configuration" loading=lazy width=723 height=31>
</picture>
</p>
<p>Navigate to <strong>Firewall</strong><span> → </span>
<strong>NAT</strong><span> → </span>
<strong>Port Forward</strong> and add the following rule.</p>
<table>
<thead>
<tr>
<th></th>
<th></th>
</tr>
</thead>
<tbody>
<tr>
<td>Interface</td>
<td><code>IG_NTP</code></td>
</tr>
<tr>
<td>Protocol</td>
<td><code>UDP</code></td>
</tr>
<tr>
<td>Source</td>
<td><code>IG_NTP net</code></td>
</tr>
<tr>
<td>Destination / Invert</td>
<td><code>checked</code></td>
</tr>
<tr>
<td>Destination</td>
<td><code>IG_NTP net</code></td>
</tr>
<tr>
<td>Destination port range</td>
<td><code>NTP</code></td>
</tr>
<tr>
<td>Redirect target IP</td>
<td><code>127.0.0.1</code></td>
</tr>
<tr>
<td>Redirect target port</td>
<td><code>NTP</code></td>
</tr>
<tr>
<td>Description</td>
<td><code>Redirect outbound NTP traffic to OPNsense</code></td>
</tr>
</tbody>
</table>
<h2 id=test>
Test
<a href=#test class=post-heading__anchor aria-hidden=true>#</a>
</h2>
<p>Now would be a could time to reboot OPNsense to make sure all settings are applied.</p>
<h3 id=test-dhcp>
Test DHCP
<a href=#test-dhcp class=post-heading__anchor aria-hidden=true>#</a>
</h3>
<p>Connect to a host in each VLAN and verify it receives an IP inside the specified DHCP range. Here is the output of the <code>ip -4 addr show eth0</code> command from a Ubuntu host connected to the VPN VLAN.</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-text data-lang=text>8: eth0: &lt;BROADCAST,MULTICAST,UP&gt; mtu 1500 group default qlen 1
    inet 192.168.20.106/24 brd 192.168.20.255 scope global dynamic
       valid_lft 7196sec preferred_lft 7196sec
</code></pre></div><h3 id=test-dns>
Test DNS
<a href=#test-dns class=post-heading__anchor aria-hidden=true>#</a>
</h3>
<p>We have to verify the following functionality of our DNS architecture:</p>
<ul>
<li><code>VLAN20_VPN</code>
<ul>
<li>Unbound <em>resolves</em> remote and local hostname lookups</li>
<li>Redirect outbound DNS traffic to Unbound</li>
<li>Reverse lookups of private IPs</li>
<li>Don&rsquo;t leak lookups for the private <code>corp.example.com</code> domain</li>
</ul>
</li>
<li><code>VL30_CLEAR</code>
<ul>
<li>Dnsmasq <em>forwards</em> remote hostname lookups to the system DNS servers like Quad9 <em>and</em> Unbound</li>
<li>Forward local hostname lookups to Unbound</li>
<li>Redirect outbound DNS traffic to Dnsmasq</li>
<li>Forward local reverse lookups of private IPs to Unbound</li>
<li>Don&rsquo;t leak lookups for the private <code>corp.example.com</code> domain and forward them to Unbound</li>
</ul>
</li>
<li><code>VL40_GUEST</code>
<ul>
<li>Use external DNS resolvers</li>
<li>Allow for clients to override DNS</li>
<li>OPNsense lookups are blocked</li>
</ul>
</li>
</ul>
<p>We&rsquo;ll use the <code>dig</code> tool and the firewall logs under <strong>Firewall</strong><span> → </span>
<strong>Log Files</strong><span> → </span>
<strong>Live View</strong> for testing.</p>
<p>I&rsquo;ll also skip the Management network because it requires the same testing as the VPN network.</p>
<h4 id=vlan20_vpn-test-dns>
VLAN20_VPN: Test DNS
<a href=#vlan20_vpn-test-dns class=post-heading__anchor aria-hidden=true>#</a>
</h4>
<p>Connect to <code>VLAN20_VPN</code>.</p>
<h5 id=vlan20_vpn-remote-hostname-lookups>
VLAN20_VPN: Remote Hostname Lookups
<a href=#vlan20_vpn-remote-hostname-lookups class=post-heading__anchor aria-hidden=true>#</a>
</h5>
<p>Run <code>dig california.gov</code>:</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-text data-lang=text>; &lt;&lt;&gt;&gt; DiG 9.16.1-Ubuntu &lt;&lt;&gt;&gt; california.gov
;; global options: +cmd
;; Got answer:
;; -&gt;&gt;HEADER&lt;&lt;- opcode: QUERY, status: NOERROR, id: 41004
;; flags: qr rd ra ad; QUERY: 1, ANSWER: 1, AUTHORITY: 0, ADDITIONAL: 1

;; OPT PSEUDOSECTION:
; EDNS: version: 0, flags:; udp: 1232
;; QUESTION SECTION:
;california.gov.                        IN      A

;; ANSWER SECTION:
california.gov.         300     IN      A       63.196.102.29

;; Query time: 36 msec
;; SERVER: 192.168.20.1#53(192.168.20.1)
;; WHEN: Tue Nov 16 22:37:34 CET 2021
;; MSG SIZE  rcvd: 59
</code></pre></div><p>Here are the firewall logs showing the iterative DNS requests Unbound sends.</p>
<p>
<picture>
<source srcset="/blog/opnsense-baseline-guide-with-vpn-guest-and-vlan-support/verify-unbound-fw-logs-remote_hu140bb5447548d6195a6002e74f882ced_32941_300x0_resize_q90_h2_box_3.webp 300w,/blog/opnsense-baseline-guide-with-vpn-guest-and-vlan-support/verify-unbound-fw-logs-remote_hu140bb5447548d6195a6002e74f882ced_32941_400x0_resize_q90_h2_box_3.webp 400w,/blog/opnsense-baseline-guide-with-vpn-guest-and-vlan-support/verify-unbound-fw-logs-remote_hu140bb5447548d6195a6002e74f882ced_32941_445x0_resize_q90_h2_box_3.webp 445w">
<img src=/blog/opnsense-baseline-guide-with-vpn-guest-and-vlan-support/verify-unbound-fw-logs-remote.png srcset="/blog/opnsense-baseline-guide-with-vpn-guest-and-vlan-support/verify-unbound-fw-logs-remote_hu140bb5447548d6195a6002e74f882ced_32941_300x0_resize_box_3.png 300w,/blog/opnsense-baseline-guide-with-vpn-guest-and-vlan-support/verify-unbound-fw-logs-remote_hu140bb5447548d6195a6002e74f882ced_32941_400x0_resize_box_3.png 400w,/blog/opnsense-baseline-guide-with-vpn-guest-and-vlan-support/verify-unbound-fw-logs-remote_hu140bb5447548d6195a6002e74f882ced_32941_445x0_resize_box_3.png 445w" alt="Screenshot of firewall logs showing Unbound requests for remote hostnames" loading=lazy width=445 height=299>
</picture>
</p>
<h5 id=vlan20_vpn-local-hostname-lookups>
VLAN20_VPN: Local Hostname Lookups
<a href=#vlan20_vpn-local-hostname-lookups class=post-heading__anchor aria-hidden=true>#</a>
</h5>
<p>Run <code>dig opnsense.corp.example.com</code>:</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-text data-lang=text>; &lt;&lt;&gt;&gt; DiG 9.16.1-Ubuntu &lt;&lt;&gt;&gt; opnsense.corp.example.com
;; global options: +cmd
;; Got answer:
;; -&gt;&gt;HEADER&lt;&lt;- opcode: QUERY, status: NOERROR, id: 22291
;; flags: qr aa rd ra; QUERY: 1, ANSWER: 3, AUTHORITY: 0, ADDITIONAL: 1

;; OPT PSEUDOSECTION:
; EDNS: version: 0, flags:; udp: 1232
;; QUESTION SECTION:
;opnsense.corp.example.com.  IN      A

;; ANSWER SECTION:
opnsense.corp.example.com. 3600 IN   A       192.168.1.1
opnsense.corp.example.com. 3600 IN   A       192.168.10.1
opnsense.corp.example.com. 3600 IN   A       192.168.20.1

;; Query time: 0 msec
;; SERVER: 192.168.20.1#53(192.168.20.1)
;; WHEN: Tue Nov 16 21:48:19 CET 2021
;; MSG SIZE  rcvd: 105
</code></pre></div><h5 id=vlan20_vpn-redirect-outbound-dns-traffic>
VLAN20_VPN: Redirect Outbound DNS Traffic
<a href=#vlan20_vpn-redirect-outbound-dns-traffic class=post-heading__anchor aria-hidden=true>#</a>
</h5>
<p>Run <code>dig opnsense.org @8.8.8.8</code>:</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-text data-lang=text>; &lt;&lt;&gt;&gt; DiG 9.16.1-Ubuntu &lt;&lt;&gt;&gt; opnsense.org @8.8.8.8
;; global options: +cmd
;; Got answer:
;; -&gt;&gt;HEADER&lt;&lt;- opcode: QUERY, status: NOERROR, id: 17970
;; flags: qr rd ra ad; QUERY: 1, ANSWER: 1, AUTHORITY: 0, ADDITIONAL: 1

;; OPT PSEUDOSECTION:
; EDNS: version: 0, flags:; udp: 1232
;; QUESTION SECTION:
;opnsense.org.                  IN      A

;; ANSWER SECTION:
opnsense.org.           184     IN      A       178.162.131.118

;; Query time: 0 msec
;; SERVER: 8.8.8.8#53(8.8.8.8)
;; WHEN: Tue Nov 16 21:51:15 CET 2021
;; MSG SIZE  rcvd: 57
</code></pre></div><p><code>dig</code> can&rsquo;t tell that OPNsense hijacked the request and thus displays an incorrect <code>SERVER</code> value. If you check the firewall logs, you shouldn&rsquo;t see any requests to <code>8.8.8.8</code>. Instead, you should see iterative root server requests.</p>
<h5 id=vlan20_vpn-reverse-lookups-of-private-ips>
VLAN20_VPN: Reverse Lookups of Private IPs
<a href=#vlan20_vpn-reverse-lookups-of-private-ips class=post-heading__anchor aria-hidden=true>#</a>
</h5>
<p>Run <code>dig -x 192.168.20.1</code>:</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-text data-lang=text>; &lt;&lt;&gt;&gt; DiG 9.16.1-Ubuntu &lt;&lt;&gt;&gt; -x 192.168.20.1
;; global options: +cmd
;; Got answer:
;; -&gt;&gt;HEADER&lt;&lt;- opcode: QUERY, status: NOERROR, id: 9264
;; flags: qr aa rd ra; QUERY: 1, ANSWER: 1, AUTHORITY: 0, ADDITIONAL: 1

;; OPT PSEUDOSECTION:
; EDNS: version: 0, flags:; udp: 1232
;; QUESTION SECTION:
;1.20.168.192.in-addr.arpa.     IN      PTR

;; ANSWER SECTION:
1.20.168.192.in-addr.arpa. 3600 IN      PTR     OPNsense.corp.example.com.

;; Query time: 0 msec
;; SERVER: 192.168.20.1#53(192.168.20.1)
;; WHEN: Tue Nov 16 21:56:14 CET 2021
;; MSG SIZE  rcvd: 96
</code></pre></div><p>If you want, additionally reverse-lookup an IP that doesn&rsquo;t exist. The firewall logs mustn&rsquo;t contain requests to external DNS servers.</p>
<h5 id=vlan20_vpn-verify-corpexamplecom-is-private>
VLAN20_VPN: Verify <code>corp.example.com</code> Is Private
<a href=#vlan20_vpn-verify-corpexamplecom-is-private class=post-heading__anchor aria-hidden=true>#</a>
</h5>
<p>To test whether OPNsense is the authoritative server for <code>corp.example.com</code>, we lookup a non-existent hostname in that domain. <code>dig</code> should return an authoritative <code>NXDOMAIN</code> response with the SOA record we earlier defined earlier in the <code>AUTHORITY SECTION</code>.</p>
<p>Run <code>dig nowhere.corp.example.com</code>:</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-text data-lang=text>; &lt;&lt;&gt;&gt; DiG 9.16.1-Ubuntu &lt;&lt;&gt;&gt; nowhere.corp.example.com
;; global options: +cmd
;; Got answer:
;; -&gt;&gt;HEADER&lt;&lt;- opcode: QUERY, status: NXDOMAIN, id: 44590
;; flags: qr aa rd ra; QUERY: 1, ANSWER: 0, AUTHORITY: 1, ADDITIONAL: 1

;; OPT PSEUDOSECTION:
; EDNS: version: 0, flags:; udp: 1232
;; QUESTION SECTION:
;nowhere.corp.example.com.   IN      A

;; AUTHORITY SECTION:
corp.example.com.    3600    IN      SOA     opnsense.corp.example.com. root.example.com. 2021110201 86400 7200 3600000 3600

;; Query time: 0 msec
;; SERVER: 192.168.20.1#53(192.168.20.1)
;; WHEN: Tue Nov 16 21:59:58 CET 2021
;; MSG SIZE  rcvd: 110
</code></pre></div><h5 id=vlan20_vpn-dns-leak-test>
VLAN20_VPN: DNS Leak Test
<a href=#vlan20_vpn-dns-leak-test class=post-heading__anchor aria-hidden=true>#</a>
</h5>
<p>In your browser, navigate to <a href=https://dnsleaktest.com/ class=link--external target=_blank rel=noreferrer>dnsleaktest.com</a> or <a href=https://mullvad.net/en/check/ class=link--external target=_blank rel=noreferrer>mullvad.net/check</a>. We expect the &ldquo;leaked&rdquo; DNS server to match our Mullvad public Mullvad IP. The second leak is from the <strong>Outgoing Interface</strong> we configured for Unbound:</p>
<p>
<picture>
<source srcset="/blog/opnsense-baseline-guide-with-vpn-guest-and-vlan-support/verify-dns-leak-test-vpn_hu98cb4cbfc5bf8365cc700ece9f890d8f_37774_300x0_resize_q90_h2_box_3.webp 300w,/blog/opnsense-baseline-guide-with-vpn-guest-and-vlan-support/verify-dns-leak-test-vpn_hu98cb4cbfc5bf8365cc700ece9f890d8f_37774_400x0_resize_q90_h2_box_3.webp 400w,/blog/opnsense-baseline-guide-with-vpn-guest-and-vlan-support/verify-dns-leak-test-vpn_hu98cb4cbfc5bf8365cc700ece9f890d8f_37774_411x0_resize_q90_h2_box_3.webp 411w">
<img src=/blog/opnsense-baseline-guide-with-vpn-guest-and-vlan-support/verify-dns-leak-test-vpn.png srcset="/blog/opnsense-baseline-guide-with-vpn-guest-and-vlan-support/verify-dns-leak-test-vpn_hu98cb4cbfc5bf8365cc700ece9f890d8f_37774_300x0_resize_box_3.png 300w,/blog/opnsense-baseline-guide-with-vpn-guest-and-vlan-support/verify-dns-leak-test-vpn_hu98cb4cbfc5bf8365cc700ece9f890d8f_37774_400x0_resize_box_3.png 400w,/blog/opnsense-baseline-guide-with-vpn-guest-and-vlan-support/verify-dns-leak-test-vpn_hu98cb4cbfc5bf8365cc700ece9f890d8f_37774_411x0_resize_box_3.png 411w" alt="Screenshot of Mullvad DNS leak test for VPN network" loading=lazy width=411 height=575>
</picture>
</p>
<h4 id=vlan30_clear-test-dns>
VLAN30_CLEAR: Test DNS
<a href=#vlan30_clear-test-dns class=post-heading__anchor aria-hidden=true>#</a>
</h4>
<p>Connect to <code>VLAN30_CLEAR</code>.</p>
<h5 id=vlan30_clear-remote-hostname-lookups>
VLAN30_CLEAR: Remote Hostname Lookups
<a href=#vlan30_clear-remote-hostname-lookups class=post-heading__anchor aria-hidden=true>#</a>
</h5>
<p>Run <code>dig opnsense.org</code>:</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-text data-lang=text>; &lt;&lt;&gt;&gt; DiG 9.16.1-Ubuntu &lt;&lt;&gt;&gt; opnsense.org
;; global options: +cmd
;; Got answer:
;; -&gt;&gt;HEADER&lt;&lt;- opcode: QUERY, status: NOERROR, id: 65053
;; flags: qr rd ra; QUERY: 1, ANSWER: 1, AUTHORITY: 0, ADDITIONAL: 1

;; OPT PSEUDOSECTION:
; EDNS: version: 0, flags:; udp: 1232
;; QUESTION SECTION:
;opnsense.org.                  IN      A

;; ANSWER SECTION:
opnsense.org.           596     IN      A       178.162.131.118

;; Query time: 5 msec
;; SERVER: 192.168.30.1#53(192.168.30.1)
;; WHEN: Tue Nov 16 16:45:08 CET 2021
;; MSG SIZE  rcvd: 57
</code></pre></div><p>Check the firewall logs. Enable logging for the port forward rule if you want it to show up.</p>
<p>
<picture>
<source srcset="/blog/opnsense-baseline-guide-with-vpn-guest-and-vlan-support/verify-dnsmasq-fw-logs-remote_hu2912935c64a229b70592f447622c51c7_37652_300x0_resize_q90_h2_box_3.webp 300w,/blog/opnsense-baseline-guide-with-vpn-guest-and-vlan-support/verify-dnsmasq-fw-logs-remote_hu2912935c64a229b70592f447622c51c7_37652_400x0_resize_q90_h2_box_3.webp 400w,/blog/opnsense-baseline-guide-with-vpn-guest-and-vlan-support/verify-dnsmasq-fw-logs-remote_hu2912935c64a229b70592f447622c51c7_37652_477x0_resize_q90_h2_box_3.webp 477w">
<img src=/blog/opnsense-baseline-guide-with-vpn-guest-and-vlan-support/verify-dnsmasq-fw-logs-remote.png srcset="/blog/opnsense-baseline-guide-with-vpn-guest-and-vlan-support/verify-dnsmasq-fw-logs-remote_hu2912935c64a229b70592f447622c51c7_37652_300x0_resize_box_3.png 300w,/blog/opnsense-baseline-guide-with-vpn-guest-and-vlan-support/verify-dnsmasq-fw-logs-remote_hu2912935c64a229b70592f447622c51c7_37652_400x0_resize_box_3.png 400w,/blog/opnsense-baseline-guide-with-vpn-guest-and-vlan-support/verify-dnsmasq-fw-logs-remote_hu2912935c64a229b70592f447622c51c7_37652_477x0_resize_box_3.png 477w" alt="Screenshot of firewall logs showing Dnsmasq redirect for remote hostname requests" loading=lazy width=477 height=357>
</picture>
</p>
<p>You can see that Dnsmasq forwards to the DNS servers defined under <strong>System</strong><span> → </span>
<strong>Settings</strong><span> → </span>
<strong>General</strong> <em>and</em> Unbound.</p>
<h5 id=vlan30_clear-local-hostname-lookups>
VLAN30_CLEAR: Local Hostname Lookups
<a href=#vlan30_clear-local-hostname-lookups class=post-heading__anchor aria-hidden=true>#</a>
</h5>
<p>Run <code>dig opnsense.corp.example.com</code>:</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-text data-lang=text>; &lt;&lt;&gt;&gt; DiG 9.16.1-Ubuntu &lt;&lt;&gt;&gt; opnsense.corp.example.com
;; global options: +cmd
;; Got answer:
;; -&gt;&gt;HEADER&lt;&lt;- opcode: QUERY, status: NOERROR, id: 61385
;; flags: qr aa rd ra; QUERY: 1, ANSWER: 1, AUTHORITY: 0, ADDITIONAL: 1

;; OPT PSEUDOSECTION:
; EDNS: version: 0, flags:; udp: 4096
;; QUESTION SECTION:
;opnsense.corp.example.com.  IN      A

;; ANSWER SECTION:
opnsense.corp.example.com. 1 IN      A       192.168.1.1

;; Query time: 0 msec
;; SERVER: 192.168.30.1#53(192.168.30.1)
;; WHEN: Wed Nov 17 00:45:49 CET 2021
;; MSG SIZE  rcvd: 73
</code></pre></div><h5 id=vlan30_clear-redirect-outbound-dns-traffic>
VLAN30_CLEAR: Redirect Outbound DNS Traffic
<a href=#vlan30_clear-redirect-outbound-dns-traffic class=post-heading__anchor aria-hidden=true>#</a>
</h5>
<p>Run <code>dig opnsense.org @8.8.8.8</code>:</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-text data-lang=text>; &lt;&lt;&gt;&gt; DiG 9.16.1-Ubuntu &lt;&lt;&gt;&gt; opnsense.org @8.8.8.8
;; global options: +cmd
;; Got answer:
;; -&gt;&gt;HEADER&lt;&lt;- opcode: QUERY, status: NOERROR, id: 34638
;; flags: qr rd ra; QUERY: 1, ANSWER: 1, AUTHORITY: 0, ADDITIONAL: 1

;; OPT PSEUDOSECTION:
; EDNS: version: 0, flags:; udp: 1232
;; QUESTION SECTION:
;opnsense.org.                  IN      A

;; ANSWER SECTION:
opnsense.org.           430     IN      A       178.162.131.118

;; Query time: 3 msec
;; SERVER: 8.8.8.8#53(8.8.8.8)
;; WHEN: Tue Nov 16 00:12:15 CET 2021
;; MSG SIZE  rcvd: 57
</code></pre></div><p>We confirm it works by looking at the firewall logs again:</p>
<p>
<picture>
<source srcset="/blog/opnsense-baseline-guide-with-vpn-guest-and-vlan-support/verify-dnsmasq-fw-logs-redirect_hu58ddd87676ecd3a0a13bee4ac715bca1_33740_300x0_resize_q90_h2_box_3.webp 300w,/blog/opnsense-baseline-guide-with-vpn-guest-and-vlan-support/verify-dnsmasq-fw-logs-redirect_hu58ddd87676ecd3a0a13bee4ac715bca1_33740_400x0_resize_q90_h2_box_3.webp 400w,/blog/opnsense-baseline-guide-with-vpn-guest-and-vlan-support/verify-dnsmasq-fw-logs-redirect_hu58ddd87676ecd3a0a13bee4ac715bca1_33740_479x0_resize_q90_h2_box_3.webp 479w">
<img src=/blog/opnsense-baseline-guide-with-vpn-guest-and-vlan-support/verify-dnsmasq-fw-logs-redirect.png srcset="/blog/opnsense-baseline-guide-with-vpn-guest-and-vlan-support/verify-dnsmasq-fw-logs-redirect_hu58ddd87676ecd3a0a13bee4ac715bca1_33740_300x0_resize_box_3.png 300w,/blog/opnsense-baseline-guide-with-vpn-guest-and-vlan-support/verify-dnsmasq-fw-logs-redirect_hu58ddd87676ecd3a0a13bee4ac715bca1_33740_400x0_resize_box_3.png 400w,/blog/opnsense-baseline-guide-with-vpn-guest-and-vlan-support/verify-dnsmasq-fw-logs-redirect_hu58ddd87676ecd3a0a13bee4ac715bca1_33740_479x0_resize_box_3.png 479w" alt="Screenshot of firewall logs showing Dnsmasq redirect for outbound DNS requests" loading=lazy width=479 height=360>
</picture>
</p>
<h5 id=vlan30_clear-forward-reverse-lookups-of-private-ips-to-unbound>
VLAN30_CLEAR: Forward Reverse Lookups of Private IPs to Unbound
<a href=#vlan30_clear-forward-reverse-lookups-of-private-ips-to-unbound class=post-heading__anchor aria-hidden=true>#</a>
</h5>
<p>Run <code>dig -x 192.168.20.1</code>:</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-text data-lang=text>; &lt;&lt;&gt;&gt; DiG 9.16.1-Ubuntu &lt;&lt;&gt;&gt; -x 192.168.20.1
;; global options: +cmd
;; Got answer:
;; -&gt;&gt;HEADER&lt;&lt;- opcode: QUERY, status: NOERROR, id: 20607
;; flags: qr aa rd ra; QUERY: 1, ANSWER: 1, AUTHORITY: 0, ADDITIONAL: 1

;; OPT PSEUDOSECTION:
; EDNS: version: 0, flags:; udp: 1232
;; QUESTION SECTION:
;1.20.168.192.in-addr.arpa.     IN      PTR

;; ANSWER SECTION:
1.20.168.192.in-addr.arpa. 3600 IN      PTR     OPNsense.home.schnerring.net.

;; Query time: 1 msec
;; SERVER: 192.168.30.1#53(192.168.30.1)
;; WHEN: Wed Nov 17 00:09:05 CET 2021
;; MSG SIZE  rcvd: 96
</code></pre></div><p>The firewall logs confirm it works.</p>
<p>
<picture>
<source srcset="/blog/opnsense-baseline-guide-with-vpn-guest-and-vlan-support/verify-dnsmasq-fw-logs-reverse_hu3c5a631eff6481430c5c9bfbc3255c35_4144_300x0_resize_q90_h2_box_3.webp 300w,/blog/opnsense-baseline-guide-with-vpn-guest-and-vlan-support/verify-dnsmasq-fw-logs-reverse_hu3c5a631eff6481430c5c9bfbc3255c35_4144_400x0_resize_q90_h2_box_3.webp 400w,/blog/opnsense-baseline-guide-with-vpn-guest-and-vlan-support/verify-dnsmasq-fw-logs-reverse_hu3c5a631eff6481430c5c9bfbc3255c35_4144_459x0_resize_q90_h2_box_3.webp 459w">
<img src=/blog/opnsense-baseline-guide-with-vpn-guest-and-vlan-support/verify-dnsmasq-fw-logs-reverse.png srcset="/blog/opnsense-baseline-guide-with-vpn-guest-and-vlan-support/verify-dnsmasq-fw-logs-reverse_hu3c5a631eff6481430c5c9bfbc3255c35_4144_300x0_resize_box_3.png 300w,/blog/opnsense-baseline-guide-with-vpn-guest-and-vlan-support/verify-dnsmasq-fw-logs-reverse_hu3c5a631eff6481430c5c9bfbc3255c35_4144_400x0_resize_box_3.png 400w,/blog/opnsense-baseline-guide-with-vpn-guest-and-vlan-support/verify-dnsmasq-fw-logs-reverse_hu3c5a631eff6481430c5c9bfbc3255c35_4144_459x0_resize_box_3.png 459w" alt="Screenshot of firewall logs showing Dnsmasq redirect for reverse lookups" loading=lazy width=459 height=128>
</picture>
</p>
<h5 id=vlan30_clear-verify-corpexamplecom-is-private>
VLAN30_CLEAR: Verify <code>corp.example.com</code> Is Private
<a href=#vlan30_clear-verify-corpexamplecom-is-private class=post-heading__anchor aria-hidden=true>#</a>
</h5>
<p>Run <code>dig nowhere.corp.example.com</code>:</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-text data-lang=text>; &lt;&lt;&gt;&gt; DiG 9.16.1-Ubuntu &lt;&lt;&gt;&gt; nowhere.corp.example.com
;; global options: +cmd
;; Got answer:
;; -&gt;&gt;HEADER&lt;&lt;- opcode: QUERY, status: NXDOMAIN, id: 7481
;; flags: qr aa rd ra; QUERY: 1, ANSWER: 0, AUTHORITY: 1, ADDITIONAL: 1

;; OPT PSEUDOSECTION:
; EDNS: version: 0, flags:; udp: 1232
;; QUESTION SECTION:
;nowhere.corp.example.com. IN      A

;; AUTHORITY SECTION:
corp.example.com.    3600    IN      SOA     opnsense.corp.example.com. root.example.com. 2021110201 86400 7200 3600000 3600

;; Query time: 0 msec
;; SERVER: 192.168.30.1#53(192.168.30.1)
;; WHEN: Tue Nov 16 20:44:35 CET 2021
;; MSG SIZE  rcvd: 112
</code></pre></div><p>This time, requests will only be forwarded to Unbound, but not external DNS resolvers.</p>
<p>
<picture>
<source srcset="/blog/opnsense-baseline-guide-with-vpn-guest-and-vlan-support/verify-dnsmasq-fw-logs-private_hue75ff9094c190cd4dd7eca8f3c96be48_22493_300x0_resize_q90_h2_box_3.webp 300w,/blog/opnsense-baseline-guide-with-vpn-guest-and-vlan-support/verify-dnsmasq-fw-logs-private_hue75ff9094c190cd4dd7eca8f3c96be48_22493_400x0_resize_q90_h2_box_3.webp 400w,/blog/opnsense-baseline-guide-with-vpn-guest-and-vlan-support/verify-dnsmasq-fw-logs-private_hue75ff9094c190cd4dd7eca8f3c96be48_22493_455x0_resize_q90_h2_box_3.webp 455w">
<img src=/blog/opnsense-baseline-guide-with-vpn-guest-and-vlan-support/verify-dnsmasq-fw-logs-private.png srcset="/blog/opnsense-baseline-guide-with-vpn-guest-and-vlan-support/verify-dnsmasq-fw-logs-private_hue75ff9094c190cd4dd7eca8f3c96be48_22493_300x0_resize_box_3.png 300w,/blog/opnsense-baseline-guide-with-vpn-guest-and-vlan-support/verify-dnsmasq-fw-logs-private_hue75ff9094c190cd4dd7eca8f3c96be48_22493_400x0_resize_box_3.png 400w,/blog/opnsense-baseline-guide-with-vpn-guest-and-vlan-support/verify-dnsmasq-fw-logs-private_hue75ff9094c190cd4dd7eca8f3c96be48_22493_455x0_resize_box_3.png 455w" alt="Screenshot of firewall logs showing Dnsmasq redirecting private domain requests to Unbound" loading=lazy width=455 height=171>
</picture>
</p>
<h5 id=vlan30_clear-dns-leak-test>
VLAN30_CLEAR: DNS Leak Test
<a href=#vlan30_clear-dns-leak-test class=post-heading__anchor aria-hidden=true>#</a>
</h5>
<p>As we saw earlier, we expect the Quad9 <em>and</em> the Mullvad public IPs to leak. Here is the result of an extended test from <a href=https://dnsleaktest.com/ class=link--external target=_blank rel=noreferrer>dnsleaktest.com</a>:</p>
<p>
<picture>
<source srcset="/blog/opnsense-baseline-guide-with-vpn-guest-and-vlan-support/verify-dns-leak-test-clear_hu4b78a6c1a9f5a9dd08ce22f5c8afd5a9_9015_300x0_resize_q90_h2_box_3.webp 300w,/blog/opnsense-baseline-guide-with-vpn-guest-and-vlan-support/verify-dns-leak-test-clear_hu4b78a6c1a9f5a9dd08ce22f5c8afd5a9_9015_400x0_resize_q90_h2_box_3.webp 400w,/blog/opnsense-baseline-guide-with-vpn-guest-and-vlan-support/verify-dns-leak-test-clear_hu4b78a6c1a9f5a9dd08ce22f5c8afd5a9_9015_500x0_resize_q90_h2_box_3.webp 500w,/blog/opnsense-baseline-guide-with-vpn-guest-and-vlan-support/verify-dns-leak-test-clear_hu4b78a6c1a9f5a9dd08ce22f5c8afd5a9_9015_501x0_resize_q90_h2_box_3.webp 501w">
<img src=/blog/opnsense-baseline-guide-with-vpn-guest-and-vlan-support/verify-dns-leak-test-clear.png srcset="/blog/opnsense-baseline-guide-with-vpn-guest-and-vlan-support/verify-dns-leak-test-clear_hu4b78a6c1a9f5a9dd08ce22f5c8afd5a9_9015_300x0_resize_box_3.png 300w,/blog/opnsense-baseline-guide-with-vpn-guest-and-vlan-support/verify-dns-leak-test-clear_hu4b78a6c1a9f5a9dd08ce22f5c8afd5a9_9015_400x0_resize_box_3.png 400w,/blog/opnsense-baseline-guide-with-vpn-guest-and-vlan-support/verify-dns-leak-test-clear_hu4b78a6c1a9f5a9dd08ce22f5c8afd5a9_9015_500x0_resize_box_3.png 500w,/blog/opnsense-baseline-guide-with-vpn-guest-and-vlan-support/verify-dns-leak-test-clear_hu4b78a6c1a9f5a9dd08ce22f5c8afd5a9_9015_501x0_resize_box_3.png 501w" alt="Screenshot of DNS leak test for Clear network" loading=lazy width=501 height=203>
</picture>
</p>
<h4 id=vlan40_guest-test-dns>
VLAN40_GUEST: Test DNS
<a href=#vlan40_guest-test-dns class=post-heading__anchor aria-hidden=true>#</a>
</h4>
<p>Connect to <code>VLAN40_GUEST</code>.</p>
<p>Verify that <code>dig opnsense.org @192.168.40.1</code> times out.</p>
<p>The Cloudflare DNS servers you configured in the DHCP settings of the Guest VLAN should show up when running the leak test:</p>
<p>
<picture>
<source srcset="/blog/opnsense-baseline-guide-with-vpn-guest-and-vlan-support/verify-dns-leak-test-guest_hu4b3aa3567f537688d34e95b4a165a5db_1543_300x0_resize_q90_h2_box_3.webp 300w,/blog/opnsense-baseline-guide-with-vpn-guest-and-vlan-support/verify-dns-leak-test-guest_hu4b3aa3567f537688d34e95b4a165a5db_1543_400x0_resize_q90_h2_box_3.webp 400w,/blog/opnsense-baseline-guide-with-vpn-guest-and-vlan-support/verify-dns-leak-test-guest_hu4b3aa3567f537688d34e95b4a165a5db_1543_500x0_resize_q90_h2_box_3.webp 500w,/blog/opnsense-baseline-guide-with-vpn-guest-and-vlan-support/verify-dns-leak-test-guest_hu4b3aa3567f537688d34e95b4a165a5db_1543_528x0_resize_q90_h2_box_3.webp 528w">
<img src=/blog/opnsense-baseline-guide-with-vpn-guest-and-vlan-support/verify-dns-leak-test-guest.png srcset="/blog/opnsense-baseline-guide-with-vpn-guest-and-vlan-support/verify-dns-leak-test-guest_hu4b3aa3567f537688d34e95b4a165a5db_1543_300x0_resize_box_3.png 300w,/blog/opnsense-baseline-guide-with-vpn-guest-and-vlan-support/verify-dns-leak-test-guest_hu4b3aa3567f537688d34e95b4a165a5db_1543_400x0_resize_box_3.png 400w,/blog/opnsense-baseline-guide-with-vpn-guest-and-vlan-support/verify-dns-leak-test-guest_hu4b3aa3567f537688d34e95b4a165a5db_1543_500x0_resize_box_3.png 500w,/blog/opnsense-baseline-guide-with-vpn-guest-and-vlan-support/verify-dns-leak-test-guest_hu4b3aa3567f537688d34e95b4a165a5db_1543_528x0_resize_box_3.png 528w" alt="Screenshot of Mullvad DNS leak test for Guest network" loading=lazy width=528 height=74>
</picture>
</p>
<h2 id=thanks-for-reading->
Thanks For Reading ❤️
<a href=#thanks-for-reading- class=post-heading__anchor aria-hidden=true>#</a>
</h2>
<p>If you&rsquo;re here, I thank you for reading all this! Any feedback is highly appreciated.</p>
<p>When I decided to write this guide, I didn&rsquo;t think it would take soooo long. I worked on it intensively for the better part of a month. I spent like a week configuring Unbound to use WireGuard tunnels, only to find out that <a href=https://github.com/opnsense/core/issues/5329 class=link--external target=_blank rel=noreferrer>I couldn&rsquo;t get it working due to a bug</a>. But it was all worth it and a fulfilling journey — I have learned so much OPNsense and networking. But I&rsquo;m also happy to be able to put this aside for a while. 🎉</p>
<p>So what&rsquo;s next?</p>
<p>Let&rsquo;s Encrypt certificates and <a href=https://docs.opnsense.org/manual/how-tos/haproxy.html class=link--external target=_blank rel=noreferrer>HAProxy</a> to secure self-hosted services. I imagine configuring it should be pretty straightforward.</p>
<p>Me and possibly others want to be able to access my home network from the outside via WireGuard. I have a dynamic IP, so I thought I&rsquo;d have to resort to <a href=https://docs.opnsense.org/manual/dynamic_dns.html class=link--external target=_blank rel=noreferrer>Dynamic DNS</a>. But I think <a href=https://mullvad.net/en/help/port-forwarding-and-mullvad/ class=link--external target=_blank rel=noreferrer>port forwarding with Mullvad</a> is the better solution and doesn&rsquo;t require me to associate my public IP address with a public DNS record.</p>
<p><a href=https://docs.opnsense.org/manual/shaping.html class=link--external target=_blank rel=noreferrer>Traffic shaping</a> and <a href=https://docs.opnsense.org/manual/ips.html class=link--external target=_blank rel=noreferrer>intrusion prevention</a> is something I want to look into, too.</p>
<p>So yeah, OPNsense and I will be friends for a while. 👫</p>
</div>
<div id=remark42></div>
<script>var remark_config={host:"https://remark42.schnerring.net",site_id:"schnerring.net",theme:localStorage.getItem("theme"),show_email_subscription:!1}</script>
<script>!function(d,b){for(var c=0,a,e,f;c<d.length;c++)a=b.createElement("script"),e=".js",f=b.head||b.body,"noModule"in a?(a.type="module",e=".mjs"):a.async=!0,a.defer=!0,a.src=remark_config.host+"/web/"+d[c]+e,f.appendChild(a)}(remark_config.components||["embed"],document)</script>
<script>const themeToggleLight=document.getElementsByClassName("theme__toggle light--hidden").item(0);themeToggleLight.addEventListener("click",()=>{setTimeout(()=>window.REMARK42.changeTheme("light"),10)});const themeToggleDark=document.getElementsByClassName("theme__toggle dark--hidden").item(0);themeToggleDark.addEventListener("click",()=>{setTimeout(()=>window.REMARK42.changeTheme("dark"),10)})</script>
<script>function cookieConsentClick(){localStorage.setItem("cookie-consent",!0);const a=document.getElementById("cookie-consent");a.classList.add("cookie-consent--hidden")}</script>
<div id=cookie-consent class=cookie-consent--hidden>
<div class=cli-prompt>
<div class=cli-prompt__chevron>>&nbsp;</div>
<div class=cli-prompt__text>
<span>When you participate in the comments, a cookie is used to keep you logged in.</span>
<span class=cli-prompt__cursor>█</span>
</div>
<button onclick=cookieConsentClick()>Got it!</button>
</div>
</div>
<script>const cookieConsentAccepted=localStorage&&localStorage.getItem("cookie-consent");if(!cookieConsentAccepted){const a=document.getElementById("cookie-consent");a.classList.remove("cookie-consent--hidden")}</script>
</article>
</div>
<div class=sidebar>
<aside class=toc>
<nav>
<p class=sidebar__heading>Table Of Contents</p>
<nav id=TableOfContents>
<ul>
<li><a href=#overview>Overview</a>
<ul>
<li><a href=#wan>WAN</a></li>
<li><a href=#lan>LAN</a></li>
<li><a href=#dns-services>DNS Services</a></li>
</ul>
</li>
<li><a href=#hardware-selection-and-installation>Hardware Selection and Installation</a></li>
<li><a href=#wizard>Wizard</a>
<ul>
<li><a href=#general-information>General Information</a></li>
<li><a href=#time-server-information>Time Server Information</a></li>
<li><a href=#configure-interfaces>Configure Interfaces</a></li>
<li><a href=#set-root-password>Set Root Password</a></li>
</ul>
</li>
<li><a href=#general-settings>General Settings</a>
<ul>
<li><a href=#access>Access</a></li>
<li><a href=#miscellaneous>Miscellaneous</a></li>
<li><a href=#firewall-settings>Firewall Settings</a></li>
<li><a href=#checksum-offloading>Checksum Offloading</a></li>
</ul>
</li>
<li><a href=#vlans>VLANs</a>
<ul>
<li><a href=#switch-choice>Switch Choice</a></li>
<li><a href=#vlan-definitions>VLAN Definitions</a></li>
<li><a href=#vlan-interfaces>VLAN Interfaces</a></li>
<li><a href=#vlan-interface-ips>VLAN Interface IPs</a></li>
<li><a href=#vlan-interface-dhcp>VLAN Interface DHCP</a></li>
</ul>
</li>
<li><a href=#wireguard-vpn-with-mullvad>WireGuard VPN with Mullvad</a>
<ul>
<li><a href=#remote-peers>Remote Peers</a></li>
<li><a href=#local-peers>Local Peers</a></li>
<li><a href=#wireguard-interfaces>WireGuard Interfaces</a></li>
<li><a href=#vpn-gateways>VPN Gateways</a></li>
<li><a href=#static-routes-optional>Static Routes (Optional)</a></li>
</ul>
</li>
<li><a href=#dns>DNS</a>
<ul>
<li><a href=#resolver-unbound>Resolver (Unbound)</a></li>
<li><a href=#forwarder-dnsmasq>Forwarder (Dnsmasq)</a></li>
</ul>
</li>
<li><a href=#firewall>Firewall</a>
<ul>
<li><a href=#interface-groups>Interface Groups</a></li>
<li><a href=#aliases>Aliases</a></li>
<li><a href=#nat>NAT</a></li>
<li><a href=#rules>Rules</a></li>
</ul>
</li>
<li><a href=#test>Test</a>
<ul>
<li><a href=#test-dhcp>Test DHCP</a></li>
<li><a href=#test-dns>Test DNS</a></li>
</ul>
</li>
<li><a href=#thanks-for-reading->Thanks For Reading ❤️</a></li>
</ul>
</nav>
</nav>
</aside>
<hr>
<aside class=bio>
<section class="jr__item jr-basics__item">
<div class=jr-basics__image>
<img src=https://schnerring.net/michael-schnerring.jpg alt="Picture of Michael Schnerring" width=250 height=250>
</div>
<div class=jr-basics__name>Michael Schnerring</div>
<div class=jr-basics__label>Software Engineer</div>
<div class=jr-basics__description>I've been a computer geek all my life. I'm passionate about open-source and digital privacy. I like video games and CrossFit. I'm also terrible at blogging.</div>
<hr>
<div class="jr-basics__profile jr-basics__profile--col">
<a href=https://github.com/schnerring>
<div class=jr-basics__profile-item>
<div class=jr-basics__profile-icon><svg role="img" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><title>GitHub</title><path d="M12 .297c-6.63.0-12 5.373-12 12 0 5.303 3.438 9.8 8.205 11.385.6.113.82-.258.82-.577.0-.285-.01-1.04-.015-2.04-3.338.724-4.042-1.61-4.042-1.61C4.422 18.07 3.633 17.7 3.633 17.7c-1.087-.744.084-.729.084-.729 1.205.084 1.838 1.236 1.838 1.236 1.07 1.835 2.809 1.305 3.495.998.108-.776.417-1.305.76-1.605-2.665-.3-5.466-1.332-5.466-5.93.0-1.31.465-2.38 1.235-3.22-.135-.303-.54-1.523.105-3.176.0.0 1.005-.322 3.3 1.23.96-.267 1.98-.399 3-.405 1.02.006 2.04.138 3 .405 2.28-1.552 3.285-1.23 3.285-1.23.645 1.653.24 2.873.12 3.176.765.84 1.23 1.91 1.23 3.22.0 4.61-2.805 5.625-5.475 5.92.42.36.81 1.096.81 2.22.0 1.606-.015 2.896-.015 3.286.0.315.21.69.825.57C20.565 22.092 24 17.592 24 12.297c0-6.627-5.373-12-12-12"/></svg>
</div>
<div class=jr-basics__profile-username>schnerring</div>
</div>
</a>
<div class=jr-basics__profile-item>
<div class=jr-basics__profile-icon><svg role="img" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><title>Matrix</title><path d="M.632.55v22.9H2.28V24H0V0h2.28v.55zm7.043 7.26v1.157h.033c.309-.443.683-.784 1.117-1.024.433-.245.936-.365 1.5-.365.54.0 1.033.107 1.481.314.448.208.785.582 1.02 1.108.254-.374.6-.706 1.034-.992.434-.287.95-.43 1.546-.43.453.0.872.056 1.26.167.388.11.716.286.993.53.276.245.489.559.646.951.152.392.23.863.23 1.417v5.728h-2.349V11.52c0-.286-.01-.559-.032-.812a1.755 1.755.0 00-.18-.66 1.106 1.106.0 00-.438-.448c-.194-.11-.457-.166-.785-.166-.332.0-.6.064-.803.189a1.38 1.38.0 00-.48.499 1.946 1.946.0 00-.231.696 5.56 5.56.0 00-.06.785v4.768h-2.35v-4.8c0-.254-.004-.503-.018-.752a2.074 2.074.0 00-.143-.688 1.052 1.052.0 00-.415-.503c-.194-.125-.476-.19-.854-.19-.111.0-.259.024-.439.074-.18.051-.36.143-.53.282-.171.138-.319.337-.439.595-.12.259-.18.6-.18 1.02v4.966H5.46V7.81zm15.693 15.64V.55H21.72V0H24v24h-2.28v-.55z"/></svg>
</div>
<div class=jr-basics__profile-username>@michael:schnerring.net</div>
</div>
</div>
<hr>
<div class="jr-basics__profile jr-basics__profile--row">
<a href=https://www.linkedin.com/in/schnerring>
<div class=jr-basics__profile-item>
<div class=jr-basics__profile-icon><svg role="img" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><title>LinkedIn</title><path d="M20.447 20.452h-3.554v-5.569c0-1.328-.027-3.037-1.852-3.037-1.853.0-2.136 1.445-2.136 2.939v5.667H9.351V9h3.414v1.561h.046c.477-.9 1.637-1.85 3.37-1.85 3.601.0 4.267 2.37 4.267 5.455v6.286zM5.337 7.433c-1.144.0-2.063-.926-2.063-2.065.0-1.138.92-2.063 2.063-2.063 1.14.0 2.064.925 2.064 2.063.0 1.139-.925 2.065-2.064 2.065zm1.782 13.019H3.555V9h3.564v11.452zM22.225.0H1.771C.792.0.0.774.0 1.729v20.542C0 23.227.792 24 1.771 24h20.451C23.2 24 24 23.227 24 22.271V1.729C24 .774 23.2.0 22.222.0h.003z"/></svg>
</div>
</div>
</a>
<a href=https://twitter.com/schnerringo>
<div class=jr-basics__profile-item>
<div class=jr-basics__profile-icon><svg role="img" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><title>Twitter</title><path d="M23.953 4.57a10 10 0 01-2.825.775 4.958 4.958.0 002.163-2.723c-.951.555-2.005.959-3.127 1.184A4.92 4.92.0 0011.78 8.288C7.69 8.095 4.067 6.13 1.64 3.162A4.822 4.822.0 00.974 5.637c0 1.71.87 3.213 2.188 4.096A4.904 4.904.0 01.934 9.117v.06a4.923 4.923.0 003.946 4.827 4.996 4.996.0 01-2.212.085 4.936 4.936.0 004.604 3.417A9.867 9.867.0 011.17 19.611c-.39.0-.779-.023-1.17-.067a13.995 13.995.0 007.557 2.209c9.053.0 13.998-7.496 13.998-13.985.0-.21.0-.42-.015-.63A9.935 9.935.0 0024 4.59z"/></svg>
</div>
</div>
</a>
<a href=https://stackoverflow.com/users/1154965/michael-schnerring>
<div class=jr-basics__profile-item>
<div class=jr-basics__profile-icon><svg role="img" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><title>Stack Overflow</title><path d="M15.725.0l-1.72 1.277 6.39 8.588 1.716-1.277L15.725.0zm-3.94 3.418-1.369 1.644 8.225 6.85 1.369-1.644-8.225-6.85zm-3.15 4.465-.905 1.94 9.702 4.517.904-1.94-9.701-4.517zm-1.85 4.86-.44 2.093 10.473 2.201.44-2.092-10.473-2.203zM1.89 15.47V24h19.19v-8.53h-2.133v6.397H4.021v-6.396H1.89zm4.265 2.133v2.13h10.66v-2.13H6.154z"/></svg>
</div>
</div>
</a>
</div>
</section>
</aside>
</div>
</main>
<footer>
<div class=copyright>
© 2020 Michael Schnerring
</div>
</footer>
<script type=text/javascript src=/js/main.07941426570c3f29ce826eb3a40437438c08ed970d117f62cfd361ba175908c57b2c2b7c68c33ca90f1f364a94dd11114c147f94a4967aa1d460f5e24087751e.js integrity="sha512-B5QUJlcMPynOgm6zpAQ3Q4wI7ZcNEX9iz9NhuhdZCMV7LCt8aMM8qQ8fNkqU3RERTBR/lKSWeqHUYPXiQId1Hg=="></script>
<script type=text/javascript src=/js/flexsearch.249ce0c4bdaeed4ff8c9dd3003018d9c28b0c53a65d2eadc2d61e8bdee012c89fe549572938790a8d5ba445769c79c449c7681c5dc8dea8dd57300fa7fd4686a.js integrity="sha512-JJzgxL2u7U/4yd0wAwGNnCiwxTpl0urcLWHove4BLIn+VJVyk4eQqNW6RFdpx5xEnHaBxdyN6o3VcwD6f9Roag=="></script>
</div>
</body>
</html>