<!doctype html><html lang=en data-theme=dark><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><link rel=preload as=font type=font/woff2 href=/fonts/roboto-slab-latin-400.woff2 crossorigin=anonymous><link rel=preload as=font type=font/woff2 href=/fonts/roboto-slab-latin-700.woff2 crossorigin=anonymous><link rel=preload as=font type=font/woff2 href=/fonts/fira-code-latin-300.woff2 crossorigin=anonymous><link rel=preload as=font type=font/woff2 href=/fonts/fira-code-latin-400.woff2 crossorigin=anonymous><link rel=preload as=font type=font/woff2 href=/fonts/fira-code-latin-700.woff2 crossorigin=anonymous><meta name=robots content="index, follow, max-snippet:-1, max-image-preview:large, max-video-preview:-1"><title>Automate Building Custom Windows Images For Azure Virtual Desktop With Packer And GitHub Actions</title>
<meta name=description content="One aspect of managing Azure Virtual Desktop (AVD) is keeping it up-to-date. One strategy is periodically building a &ldquo;golden&rdquo; image and re-deploying AVD session host VMs using the updated image. In this post, we&rsquo;ll use Packer and GitHub Actions to build a Windows 11 image and push it to Azure.
"><link rel=canonical href=https://schnerring.net/blog/automate-building-custom-windows-images-for-azure-virtual-desktop-with-packer-and-github-actions/><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="https://schnerring.net/blog/automate-building-custom-windows-images-for-azure-virtual-desktop-with-packer-and-github-actions/cover.jpg"><meta name=twitter:title content="Automate Building Custom Windows Images For Azure Virtual Desktop With Packer And GitHub Actions"><meta name=twitter:description content="One aspect of managing Azure Virtual Desktop (AVD) is keeping it up-to-date. One strategy is periodically building a “golden” image and re-deploying AVD session host VMs using the updated image. In this post, we’ll use Packer and GitHub Actions to build a Windows 11 image and push it to Azure."><meta property="og:url" content="https://schnerring.net/blog/automate-building-custom-windows-images-for-azure-virtual-desktop-with-packer-and-github-actions/"><meta property="og:site_name" content="Michael Schnerring"><meta property="og:title" content="Automate Building Custom Windows Images For Azure Virtual Desktop With Packer And GitHub Actions"><meta property="og:description" content="One aspect of managing Azure Virtual Desktop (AVD) is keeping it up-to-date. One strategy is periodically building a “golden” image and re-deploying AVD session host VMs using the updated image. In this post, we’ll use Packer and GitHub Actions to build a Windows 11 image and push it to Azure."><meta property="og:locale" content="en"><meta property="og:type" content="article"><meta property="article:section" content="blog"><meta property="article:published_time" content="2022-03-27T08:12:20+02:00"><meta property="article:modified_time" content="2024-09-02T01:06:03+02:00"><meta property="article:tag" content="AVD"><meta property="article:tag" content="Azure"><meta property="article:tag" content="Azure CLI"><meta property="article:tag" content="Azure Virtual Desktop"><meta property="article:tag" content="CI"><meta property="article:tag" content="Continuous Integration"><meta property="og:image" content="https://schnerring.net/blog/automate-building-custom-windows-images-for-azure-virtual-desktop-with-packer-and-github-actions/cover.jpg"><meta itemprop=name content="Automate Building Custom Windows Images For Azure Virtual Desktop With Packer And GitHub Actions"><meta itemprop=description content="One aspect of managing Azure Virtual Desktop (AVD) is keeping it up-to-date. One strategy is periodically building a “golden” image and re-deploying AVD session host VMs using the updated image. In this post, we’ll use Packer and GitHub Actions to build a Windows 11 image and push it to Azure."><meta itemprop=datePublished content="2022-03-27T08:12:20+02:00"><meta itemprop=dateModified content="2024-09-02T01:06:03+02:00"><meta itemprop=wordCount content="2693"><meta itemprop=image content="https://schnerring.net/blog/automate-building-custom-windows-images-for-azure-virtual-desktop-with-packer-and-github-actions/cover.jpg"><meta itemprop=keywords content="AVD,Azure,Azure CLI,Azure Virtual Desktop,CI,Continuous Integration,DevOps,GitHub Actions,IaC,Infrastructure as Code,Packer,Terraform"><script async defer data-domain=schnerring.net src=https://plausible.schnerring.net/js/plausible.js></script><style>@font-face{font-display:swap;font-family:Roboto Slab;font-style:normal;font-weight:100;src:local("Roboto Slab Thin "),local("Roboto Slab-Thin"),url(/fonts/roboto-slab-latin-100.woff2) format("woff2"),url(/fonts/roboto-slab-latin-100.woff) format("woff")}@font-face{font-display:swap;font-family:Roboto Slab;font-style:normal;font-weight:200;src:local("Roboto Slab Extra Light "),local("Roboto Slab-Extra Light"),url(/fonts/roboto-slab-latin-200.woff2) format("woff2"),url(/fonts/roboto-slab-latin-200.woff) format("woff")}@font-face{font-display:swap;font-family:Roboto Slab;font-style:normal;font-weight:300;src:local("Roboto Slab Light "),local("Roboto Slab-Light"),url(/fonts/roboto-slab-latin-300.woff2) format("woff2"),url(/fonts/roboto-slab-latin-300.woff) format("woff")}@font-face{font-display:swap;font-family:Roboto Slab;font-style:normal;font-weight:400;src:local("Roboto Slab Regular "),local("Roboto Slab-Regular"),url(/fonts/roboto-slab-latin-400.woff2) format("woff2"),url(/fonts/roboto-slab-latin-400.woff) format("woff")}@font-face{font-display:swap;font-family:Roboto Slab;font-style:normal;font-weight:500;src:local("Roboto Slab Medium "),local("Roboto Slab-Medium"),url(/fonts/roboto-slab-latin-500.woff2) format("woff2"),url(/fonts/roboto-slab-latin-500.woff) format("woff")}@font-face{font-display:swap;font-family:Roboto Slab;font-style:normal;font-weight:600;src:local("Roboto Slab SemiBold "),local("Roboto Slab-SemiBold"),url(/fonts/roboto-slab-latin-600.woff2) format("woff2"),url(/fonts/roboto-slab-latin-600.woff) format("woff")}@font-face{font-display:swap;font-family:Roboto Slab;font-style:normal;font-weight:700;src:local("Roboto Slab Bold "),local("Roboto Slab-Bold"),url(/fonts/roboto-slab-latin-700.woff2) format("woff2"),url(/fonts/roboto-slab-latin-700.woff) format("woff")}@font-face{font-display:swap;font-family:Roboto Slab;font-style:normal;font-weight:800;src:local("Roboto Slab ExtraBold "),local("Roboto Slab-ExtraBold"),url(/fonts/roboto-slab-latin-800.woff2) format("woff2"),url(/fonts/roboto-slab-latin-800.woff) format("woff")}@font-face{font-display:swap;font-family:Roboto Slab;font-style:normal;font-weight:900;src:local("Roboto Slab Black "),local("Roboto Slab-Black"),url(/fonts/roboto-slab-latin-900.woff2) format("woff2"),url(/fonts/roboto-slab-latin-900.woff) format("woff")}@font-face{font-display:swap;font-family:Fira Code;font-style:normal;font-weight:300;src:local("Fira Code Light "),local("Fira Code-Light"),url(/fonts/fira-code-latin-300.woff2) format("woff2"),url(/fonts/fira-code-latin-300.woff) format("woff")}@font-face{font-display:swap;font-family:Fira Code;font-style:normal;font-weight:400;src:local("Fira Code Regular "),local("Fira Code-Regular"),url(/fonts/fira-code-latin-400.woff2) format("woff2"),url(/fonts/fira-code-latin-400.woff) format("woff")}@font-face{font-display:swap;font-family:Fira Code;font-style:normal;font-weight:500;src:local("Fira Code Medium "),local("Fira Code-Medium"),url(/fonts/fira-code-latin-500.woff2) format("woff2"),url(/fonts/fira-code-latin-500.woff) format("woff")}@font-face{font-display:swap;font-family:Fira Code;font-style:normal;font-weight:600;src:local("Fira Code SemiBold "),local("Fira Code-SemiBold"),url(/fonts/fira-code-latin-600.woff2) format("woff2"),url(/fonts/fira-code-latin-600.woff) format("woff")}@font-face{font-display:swap;font-family:Fira Code;font-style:normal;font-weight:700;src:local("Fira Code Bold "),local("Fira Code-Bold"),url(/fonts/fira-code-latin-700.woff2) format("woff2"),url(/fonts/fira-code-latin-700.woff) format("woff")}

/*! normalize.css v8.0.1 | MIT License | github.com/necolas/normalize.css */html{line-height:1.15;-webkit-text-size-adjust:100%}body{margin:0}main{display:block}h1{font-size:2em;margin:.67em 0}hr{box-sizing:content-box;height:0;overflow:visible}pre{font-family:monospace,monospace;font-size:1em}a{background-color:transparent}abbr[title]{border-bottom:none;-webkit-text-decoration:underline;text-decoration:underline;-webkit-text-decoration:underline dotted;text-decoration:underline dotted}b,strong{font-weight:bolder}code,kbd,samp{font-family:monospace,monospace;font-size:1em}small{font-size:80%}sub,sup{font-size:75%;line-height:0;position:relative;vertical-align:baseline}sub{bottom:-.25em}sup{top:-.5em}img{border-style:none}button,input,optgroup,select,textarea{font-family:inherit;font-size:100%;line-height:1.15;margin:0}button,input{overflow:visible}button,select{text-transform:none}[type=button],[type=reset],[type=submit],button{-webkit-appearance:button}[type=button]::-moz-focus-inner,[type=reset]::-moz-focus-inner,[type=submit]::-moz-focus-inner,button::-moz-focus-inner{border-style:none;padding:0}[type=button]:-moz-focusring,[type=reset]:-moz-focusring,[type=submit]:-moz-focusring,button:-moz-focusring{outline:1px dotted ButtonText}fieldset{padding:.35em .75em .625em}legend{box-sizing:border-box;color:inherit;display:table;max-width:100%;padding:0;white-space:normal}progress{vertical-align:baseline}textarea{overflow:auto}[type=checkbox],[type=radio]{box-sizing:border-box;padding:0}[type=number]::-webkit-inner-spin-button,[type=number]::-webkit-outer-spin-button{height:auto}[type=search]{-webkit-appearance:textfield;outline-offset:-2px}[type=search]::-webkit-search-decoration{-webkit-appearance:none}::-webkit-file-upload-button{-webkit-appearance:button;font:inherit}details{display:block}summary{display:list-item}[hidden],template{display:none}

/*! CC BY-SA 3.0 License | https://stackoverflow.com/a/36118384/1154965 */@keyframes blink{50%{opacity:0}to{opacity:1}}

/*! MIT License | github.com/schnerring/hugo-theme-gruvbox */:root[data-theme=light]{--bg:var(--bg0_h);--bg0:#fbf1c7;--bg0_h:#f9f5d7;--bg0_s:#f2e5bc;--bg1:#ebdbb2;--bg2:#d5c4a1;--bg3:#bdae93;--bg4:#a89984;--fg:var(--fg1);--fg0:#282828;--fg1:#3c3836;--fg2:#504945;--fg3:#665c54;--fg4:#7c6f64;--gray1:var(--fg4);--gray2:#928374;--red1:#cc241d;--red2:#9d0006;--green1:#98971a;--green2:#797403;--yellow1:#d79921;--yellow2:#b57614;--blue1:#458588;--blue2:#076678;--purple1:#b16286;--purple2:#8f3f71;--aqua1:#689d6a;--aqua2:#427b58;--orange1:#d65d0e;--orange2:#af3a03}[data-theme=light]:root .light--hidden{display:none}:root[data-theme=dark]{--bg:var(--bg0_h);--bg0:#282828;--bg0_h:#1d2021;--bg0_s:#32302f;--bg1:#3c3836;--bg2:#504945;--bg3:#665c54;--bg4:#7c6f64;--fg:var(--fg1);--fg0:#fbf1c7;--fg1:#ebdbb2;--fg2:#d5c4a1;--fg3:#bdae93;--fg4:#a89984;--gray1:var(--fg4);--gray2:#928374;--red1:#cc241d;--red2:#fb4934;--green1:#98971a;--green2:#b8bb26;--yellow1:#d79921;--yellow2:#fabd2f;--blue1:#458588;--blue2:#83a598;--purple1:#b16286;--purple2:#d3869b;--aqua1:#689d6a;--aqua2:#8ec07c;--orange1:#d65d0e;--orange2:#fe8019}[data-theme=dark]:root .dark--hidden{display:none}:root{--primary:var(--aqua1);--primary-alt:var(--aqua2);--font-monospace:"Fira Code","Lucida Console",Monaco,monospace;--font-sans-serif:Verdana,Helvetica,sans-serif;--font-serif:"Roboto Slab",Georgia,serif}html{font-family:Roboto Slab,Georgia,serif;font-family:var(--font-serif);font-size:1rem;scroll-behavior:smooth}body{background:var(--bg);color:var(--fg);line-height:1.675;word-wrap:break-word}strong{letter-spacing:.35px}a{color:inherit;-webkit-text-decoration:none;text-decoration:none}a.link--external:after{content:"\2009↗"}img,video{border:2px solid var(--bg1);height:auto;max-width:100%}figure{display:inline-block}figcaption{color:var(--fg3);font-family:Roboto Slab,Georgia,serif;font-family:var(--font-serif);font-size:.9rem}::-moz-selection{background:var(--bg4);color:var(--fg0)}::selection{background:var(--bg4);color:var(--fg0)}h1,h2,h3,h4,h5{color:var(--fg0);font-family:Fira Code,Lucida Console,Monaco,monospace;font-family:var(--font-monospace);font-weight:300;line-height:1.4}h1 code,h2 code,h3 code,h4 code,h5 code{font-size:1em}h2,h3,h4,h5{border-bottom:1px solid var(--bg1)}h1,h2{font-weight:400}h1{font-size:1.875rem}h2{font-size:1.75rem}h3{font-size:1.625rem}@media (min-width:768px){h1{font-size:2.375rem}h2{font-size:2rem}h3{font-size:1.75rem}}h4{font-size:1.5rem}h5{font-size:1.375rem}table{border-collapse:collapse;margin:2rem 0;table-layout:fixed;width:100%}table,td,th{border:1px solid var(--bg1);padding:.5rem}hr{background:var(--bg1);border:none;height:1px;margin:3rem auto;width:80%}blockquote,code,pre{border-radius:.2rem;padding:0 .2em}pre code{padding:0}blockquote,code,pre,th{background:var(--bg1)}code,pre,th{font-family:Fira Code,Lucida Console,Monaco,monospace;font-family:var(--font-monospace)}code code{background:var(--bg2)}blockquote,pre{padding:1rem}pre{background:var(--bg1)!important;overflow:auto}pre code{background:none}blockquote{border-left:5px solid var(--primary-alt);margin:.5rem 0}blockquote:not(.does-not-exist) code{background:var(--bg2)}blockquote:not(.does-not-exist) p:first-of-type{margin-top:0}blockquote:not(.does-not-exist) p:last-of-type{margin-bottom:0}pre::-webkit-scrollbar{height:.5rem;scrollbar-width:auto}pre::-webkit-scrollbar-track{background:var(--bg2);border-radius:.2rem}pre::-webkit-scrollbar-thumb{background:var(--bg4);border-radius:.2rem}.layout{display:grid;grid-template-areas:"header" "main" "footer";grid-template-rows:auto 1fr auto;height:100vh}main{align-items:start;display:grid;grid-area:main;grid-template-areas:"empty content sidebar";grid-template-columns:1fr minmax(0,650px) 4fr}header{background:var(--bg1);grid-area:header}footer{grid-area:footer}footer,main{margin:.5em 1.1em}.content{grid-area:content}.sidebar{display:none;flex-direction:column;grid-area:sidebar;margin-top:3rem;position:sticky;top:2rem}@media (min-width:992px){.sidebar{display:flex}}header{display:grid;font-family:Fira Code,Lucida Console,Monaco,monospace;font-family:var(--font-monospace);font-size:1.125rem;grid-template-areas:"heading search nav theme-toggle";grid-template-columns:auto auto 1fr auto;padding:.75rem}.logo{color:var(--fg0);display:flex;font-weight:700;grid-area:heading}.logo:hover .logo__cursor{animation:blink 1s infinite;opacity:1}.logo__chevron,.logo__cursor{margin-left:.5rem}.logo__cursor{opacity:0}.logo__text{display:none}@media (min-width:768px){.logo__text{display:block}}.search{display:flex;grid-area:search;margin:0 1rem}#search__text{background:var(--bg2);border:1px solid var(--bg2);border-radius:.2rem;caret-color:var(--fg);color:var(--fg);outline:none;padding:0 .5rem;width:100%}#search__text:hover{border-color:var(--bg3)}#search__text:focus{border-color:var(--bg4)}#search__text::-moz-placeholder{color:var(--fg3)}#search__text::placeholder{color:var(--fg3)}#search__text[type=search]::-webkit-search-cancel-button{-webkit-appearance:none;appearance:none}#search__suggestions{background:var(--bg);border-radius:.2rem;box-shadow:0 .5rem 1rem var(--bg1);font-family:Roboto Slab,Georgia,serif;font-family:var(--font-serif);left:0;margin-top:2rem;position:absolute;width:95vw;z-index:1000}@media (min-width:768px){.search{position:relative}#search__suggestions{width:60vw}}.search__suggestions--hidden{display:none}.search__suggestion-item{border-bottom:1px dashed var(--bg2);display:grid;grid-template-columns:1fr 2fr}.search__suggestion-item:focus,.search__suggestion-item:focus-visible,.search__suggestion-item:hover{background:var(--bg1);cursor:pointer;outline:none}.search__suggestion-item:last-child{border:none}.search__suggestion-description,.search__suggestion-title{margin:1rem 0;padding:0 1rem}.search__suggestion-title{font-weight:700}.search__suggestion-description{border-left:1px solid var(--bg2)}.search__no-results{padding:.75rem}.theme__toggle{align-items:center;background:none;border:none;color:var(--yellow1);cursor:pointer;display:flex;grid-area:theme-toggle;margin:0 1rem}.theme__toggle:hover{color:var(--yellow2)}.theme__toggle svg{height:28px;width:28px}nav#menu{align-items:center;display:flex;grid-area:nav;justify-content:flex-end}nav#menu .menu__item{color:var(--fg)}nav#menu .menu__item:hover{color:var(--fg3);cursor:pointer}nav#menu ul{list-style:none;margin:0;padding:0}nav#menu ul.menu--horizontal{align-items:center;display:none}nav#menu ul.menu--horizontal li{display:inline-block;margin:0 .75rem}@media (min-width:768px){nav#menu ul.menu--horizontal{display:flex}}nav#menu ul.menu--vertical{background:var(--fg0);bottom:0;margin:0;padding:3rem;position:fixed;right:0;top:0;transform:translate(100%);transition:transform .5s cubic-bezier(.9,0,.1,1);width:50%;z-index:10}nav#menu ul.menu--vertical .menu__item{color:var(--bg1)}nav#menu ul.menu--vertical .menu__item:hover{color:var(--bg4)}nav#menu .menu__burger{display:flex;height:24px;width:24px}nav#menu .menu__burger>*{position:absolute}nav#menu .menu__burger svg{height:inherit;width:inherit;z-index:20}nav#menu .menu__burger svg line{transition-duration:.5s;transition-property:stroke,opacity,transform;transition-timing-function:cubic-bezier(.9,0,.1,1)}nav#menu .menu__burger svg line:first-of-type{transform-origin:center 6px}nav#menu .menu__burger svg line:nth-of-type(2){transform-origin:center 12px}nav#menu .menu__burger svg line:nth-of-type(3){transform-origin:center 18px}nav#menu .menu__burger input{height:inherit;opacity:0;width:inherit;z-index:30}nav#menu .menu__burger input:checked~ul.menu--vertical{transform:none}nav#menu .menu__burger input:checked~svg{stroke:var(--bg1)}nav#menu .menu__burger input:checked~svg line:first-of-type{transform:translateY(6px) rotate(45deg)}nav#menu .menu__burger input:checked~svg line:nth-of-type(2){opacity:0;transform:scale(.2)}nav#menu .menu__burger input:checked~svg line:nth-of-type(3){transform:translateY(-6px) rotate(-45deg)}@media (min-width:768px){nav#menu .menu__burger{display:none}}.sidebar{font-family:Fira Code,Lucida Console,Monaco,monospace;font-family:var(--font-monospace);margin-left:auto;margin-right:auto;max-width:350px;padding-left:2.5rem}.sidebar hr{margin:1.5rem auto}.sidebar svg{fill:var(--fg)}.sidebar__heading{font-size:1.3rem}aside.toc a{color:var(--primary-alt)}aside.toc a:hover{color:var(--primary)}aside.toc ul{list-style:none;margin:0;padding:0}aside.toc ul ul{font-size:.9rem;margin-left:.5rem}aside.toc ul li{line-height:1.1}aside.toc ul li a{display:block;padding:.2rem 0}.jr-basics__image{background:var(--bg1);border:2px solid var(--bg2)}.jr-basics__summary{color:var(--fg3);font-family:Roboto Slab,Georgia,serif;font-family:var(--font-serif);margin:.75rem 0}.jr-basics__profile a:hover{color:var(--fg3)}.jr-basics__profile a:hover svg{fill:var(--fg3)}.content-section,.post{border-bottom:2px dotted var(--bg1);padding:2rem 0}.post figure,.post img:not(figure img),.post video:not(figure video){box-sizing:border-box;margin:.5rem 0}.post-content__read-more,.post-header{font-family:Fira Code,Lucida Console,Monaco,monospace;font-family:var(--font-monospace)}.post-content{margin:1.3rem 0}.post-content__read-more{color:var(--primary-alt);margin-top:1.3rem}.post-content a,.post-header a{color:var(--primary-alt)}.post-content a:hover,.post-header a:hover{color:var(--primary)}.post-tags{align-items:center;display:flex;flex-wrap:wrap;gap:.9rem;margin:1rem 0}.post-tag{font-size:.9rem;line-height:1}.post-tag:before{content:"#"}.post-heading__anchor{display:none}h1:hover .post-heading__anchor,h2:hover .post-heading__anchor,h3:hover .post-heading__anchor,h4:hover .post-heading__anchor,h5:hover .post-heading__anchor{display:inline-block}.jr__item-meta{flex-direction:column}.jr-basics__image,.jr-basics__item,.jr-basics__profile-icon,.jr-basics__profile-item,.jr__item-meta{align-items:center;display:flex}.jr-basics__name,.jr-projects__roles,.jr-work__position{font-size:1.125rem;font-weight:700}.jr-basics__item{flex-direction:column;text-align:center}.jr-basics__item hr{margin:1.5rem auto}.jr-basics__image{border-radius:50%;height:250px;justify-content:center;overflow:hidden;width:250px}.jr-basics__label,.jr-basics__name,.jr-basics__summary{margin-top:.75rem}.jr-basics__profile svg{height:24px;width:24px}.jr-basics__profile,.jr-basics__profile-item{display:flex}.jr-basics__profile-item{display:flex;padding:.2rem}.jr-basics__profile--row{flex-wrap:wrap;justify-content:space-evenly}.jr-basics__profile-icon{padding:0 .75rem}.jr__item-meta{align-items:start;flex-flow:column;font-family:Fira Code,Lucida Console,Monaco,monospace;font-family:var(--font-monospace)}@media (min-width:768px){.jr__item-meta{align-items:center;flex-flow:row wrap}.jr-work__location,.jr__date-range{flex-grow:1;text-align:right}}#cookie-consent{animation:fadeIn .75s;background:var(--fg0);border-radius:.2rem;bottom:1rem;box-shadow:0 -.5rem 1rem var(--bg1);color:var(--bg1);font-family:Fira Code,Lucida Console,Monaco,monospace;font-family:var(--font-monospace);left:1rem;padding:1rem;position:fixed;right:1rem;z-index:2000}@media (min-width:768px){#cookie-consent{padding:2.5rem}}#cookie-consent button{background:none;border:none;color:var(--primary);font-size:1.125rem;margin:0 1rem;white-space:nowrap}#cookie-consent button:hover{color:var(--primary-alt);cursor:pointer}.cookie-consent--hidden{display:none}.cli-prompt{display:flex;justify-content:center}.cli-prompt__cursor{animation:blink 1s infinite}@keyframes fadeIn{0%{opacity:0}to{opacity:1}}.social-share{align-items:center;border-top:2px dotted var(--bg1);display:flex;flex-wrap:wrap;gap:.9rem;margin:3rem 0;padding-top:3rem}.social-share svg{fill:var(--fg);height:24px;width:24px}.social-share svg.icon-tabler{fill:none;stroke:var(--fg)}.social-share__item{background:var(--bg1);display:flex;padding:.5rem}</style><link rel=preload href="/css/non-critical.337c8f4cb58340e40be13eb232f89e4e12c02a13f92b6cd3c29a31c1397a0b150922b6cf8f80cd3037768bdcf919626d3205923713ad33f8c502a973337d3d63.css" as=style onload='this.onload=null,this.rel="stylesheet"' integrity="sha512-M3yPTLWDQOQL4T6yMvieThLAKhP5K2zTwpoxwTl6CxUJIrbPj4DNMDd2i9z5GWJtMgWSNxOtM/jFAqlzM309Yw=="><link id=prism-dark rel=preload href=/prism-themes/prism-gruvbox-dark.min.54aecc64074623a4f9898544dcbdab9e804f1560ef0b38f4cf8e10fcaaf72264e798cb407c601aca6ecd833ec4eb93d66535581f18d45ba202cf848b70dbc332.css as=style onload='this.onload=null,this.rel="stylesheet"' integrity="sha512-VK7MZAdGI6T5iYVE3L2rnoBPFWDvCzj0z44Q/Kr3ImTnmMtAfGAaym7Ngz7E65PWZTVYHxjUW6ICz4SLcNvDMg=="><link id=prism-light rel=preload href=/prism-themes/prism-gruvbox-light.min.42a221741efe997fcc94187c39d63c555560678789ac9ca856c74a5f0ddb2aa6c50d38b2ffbecc7a99038cbbd2efa99746e862267f781c559e0cfec10b88a5fc.css as=style onload='this.onload=null,this.rel="stylesheet"' integrity="sha512-QqIhdB7+mX/MlBh8OdY8VVVgZ4eJrJyoVsdKXw3bKqbFDTiy/77MepkDjLvS76mXRuhiJn94HFWeDP7BC4il/A==" disabled><noscript><link rel=stylesheet href=/prism-themes/prism-gruvbox-dark.min.54aecc64074623a4f9898544dcbdab9e804f1560ef0b38f4cf8e10fcaaf72264e798cb407c601aca6ecd833ec4eb93d66535581f18d45ba202cf848b70dbc332.css integrity="sha512-VK7MZAdGI6T5iYVE3L2rnoBPFWDvCzj0z44Q/Kr3ImTnmMtAfGAaym7Ngz7E65PWZTVYHxjUW6ICz4SLcNvDMg=="><link rel=stylesheet href="/css/non-critical.337c8f4cb58340e40be13eb232f89e4e12c02a13f92b6cd3c29a31c1397a0b150922b6cf8f80cd3037768bdcf919626d3205923713ad33f8c502a973337d3d63.css" integrity="sha512-M3yPTLWDQOQL4T6yMvieThLAKhP5K2zTwpoxwTl6CxUJIrbPj4DNMDd2i9z5GWJtMgWSNxOtM/jFAqlzM309Yw=="></noscript><script>(()=>{function n(){if(localStorage&&localStorage.getItem("theme"))return localStorage.getItem("theme");if(window.matchMedia)return window.matchMedia("(prefers-color-scheme: light)").matches?"light":"dark"}function e(e){document.documentElement.setAttribute("data-theme",e);let t=document.getElementById("prism-dark"),n=document.getElementById("prism-light");t.toggleAttribute("disabled",e==="light"),n.toggleAttribute("disabled",e==="dark"),localStorage.setItem("theme",e)}var t=n();t&&e(t);function s(t){let n=t.currentTarget.classList.contains("light--hidden")?"light":"dark";e(n)}document.addEventListener("DOMContentLoaded",function(){document.querySelectorAll(".theme__toggle").forEach(e=>{e.addEventListener("click",s)})})})()</script><link rel=apple-touch-icon sizes=180x180 href=/apple-touch-icon.png><link rel=icon type=image/png sizes=32x32 href=/favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=/favicon-16x16.png><link rel=manifest href=/site.webmanifest><meta name=msapplication-TileColor content="#282828"><meta name=theme-color content="#282828"></head><body><div class=layout><header><a class=logo href=/><div class=logo__text>schnerring.net</div><div class=logo__chevron>></div><div class=logo__cursor>█</div></a><div class=search><input id=search__text type=search placeholder=Search... aria-label=Search autocomplete=off><div id=search__suggestions class=search__suggestions--hidden></div></div><nav id=menu><ul class=menu--horizontal><li class=menu__item><a href=/blog>Blog</a></li><li class=menu__item><a href=/projects>Projects</a></li><li class=menu__item><a href=/about>About</a></li><li class=menu__item><a href=/stats>Stats</a></li></ul><div class=menu__burger><input class=menu__item type=checkbox aria-label="Open main menu"><svg class="icon icon-tabler icon-tabler-menu-2" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M4 6h16"/><path d="M4 12h16"/><path d="M4 18h16"/></svg><ul class=menu--vertical><li><a class=menu__item href=/blog>Blog</a></li><li><a class=menu__item href=/projects>Projects</a></li><li><a class=menu__item href=/about>About</a></li><li><a class=menu__item href=/stats>Stats</a></li></ul></div></nav><button class="theme__toggle light--hidden" aria-label="Toggle light mode">
<svg class="icon icon-tabler icon-tabler-sun" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M12 12m-4 0a4 4 0 108 0 4 4 0 10-8 0"/><path d="M3 12h1m8-9v1m8 8h1m-9 8v1M5.6 5.6l.7.7m12.1-.7-.7.7m0 11.4.7.7m-12.1-.7-.7.7"/></svg>
</button>
<button class="theme__toggle dark--hidden" aria-label="Toggle dark mode"><svg class="icon icon-tabler icon-tabler-moon" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M12 3c.132.0.263.0.393.0a7.5 7.5.0 007.92 12.446A9 9 0 1112 2.992z"/></svg></button></header><main><div class=content><article class=post><div class=post-header><h1>Automate Building Custom Windows Images For Azure Virtual Desktop With Packer And GitHub Actions</h1><div class=post-meta><span>2022-03-27</span><span> (updated: 2024-09-02)</span><div class=post-tags><a class=post-tag href=https://schnerring.net/tags/avd>avd</a><a class=post-tag href=https://schnerring.net/tags/azure>azure</a><a class=post-tag href=https://schnerring.net/tags/azure-cli>azure&#8209;cli</a><a class=post-tag href=https://schnerring.net/tags/azure-virtual-desktop>azure&#8209;virtual&#8209;desktop</a><a class=post-tag href=https://schnerring.net/tags/ci>ci</a><a class=post-tag href=https://schnerring.net/tags/continuous-integration>continuous&#8209;integration</a><a class=post-tag href=https://schnerring.net/tags/devops>devops</a><a class=post-tag href=https://schnerring.net/tags/github-actions>github&#8209;actions</a><a class=post-tag href=https://schnerring.net/tags/iac>iac</a><a class=post-tag href=https://schnerring.net/tags/infrastructure-as-code>infrastructure&#8209;as&#8209;code</a><a class=post-tag href=https://schnerring.net/tags/packer>packer</a><a class=post-tag href=https://schnerring.net/tags/terraform>terraform</a></div><picture><source type=image/webp srcset="/blog/automate-building-custom-windows-images-for-azure-virtual-desktop-with-packer-and-github-actions/cover_hu10996455893973947933.webp 300w,/blog/automate-building-custom-windows-images-for-azure-virtual-desktop-with-packer-and-github-actions/cover_hu3354458120681946031.webp 500w,/blog/automate-building-custom-windows-images-for-azure-virtual-desktop-with-packer-and-github-actions/cover_hu10266261020035145055.webp 686w" sizes="(max-width: 499px) 300px,(max-width: 699px) 500px,686px"><img src=/blog/automate-building-custom-windows-images-for-azure-virtual-desktop-with-packer-and-github-actions/cover.jpg srcset="/blog/automate-building-custom-windows-images-for-azure-virtual-desktop-with-packer-and-github-actions/cover_hu16632931229246813798.jpg 300w,/blog/automate-building-custom-windows-images-for-azure-virtual-desktop-with-packer-and-github-actions/cover_hu12899227353321807897.jpg 500w,/blog/automate-building-custom-windows-images-for-azure-virtual-desktop-with-packer-and-github-actions/cover_hu8362396932978379277.jpg 686w" sizes="(max-width: 499px) 300px,(max-width: 699px) 500px,686px" alt width=686 height=515></picture></div></div><div class=post-content><p>One aspect of managing
<a href=https://azure.microsoft.com/en-us/services/virtual-desktop/ class=link--external target=_blank rel=noreferrer>Azure Virtual Desktop (AVD)</a>
is keeping it up-to-date. One strategy is periodically building a &ldquo;golden&rdquo; image
and re-deploying AVD session host VMs using the updated image. In this post,
we&rsquo;ll use <a href=https://www.packer.io/ class=link--external target=_blank rel=noreferrer>Packer</a> and
<a href=https://github.com/features/actions class=link--external target=_blank rel=noreferrer>GitHub Actions</a> to build a Windows 11
image and push it to Azure.</p><p>First, we&rsquo;ll use <a href=https://www.terraform.io/ class=link--external target=_blank rel=noreferrer>Terraform</a> to prepare some
resources for Packer: a resource group for build artifacts and a
<a href=https://www.packer.io/plugins/builders/azure/arm#service-principal class=link--external target=_blank rel=noreferrer>service principal (SP)</a>
for authentication. We&rsquo;ll also export the SP credentials as GitHub Actions
secrets, making them available to our CI workflow.</p><p>Then we&rsquo;ll build a customized Windows 11 image with Packer suitable for software
development workstations. We&rsquo;ll use <a href=https://chocolatey.org/ class=link--external target=_blank rel=noreferrer>Chocolatey</a> to
install some apps like Visual Studio 2022 for .NET development, 7zip, the
Kubernetes CLI and more. We&rsquo;ll also use a custom PowerShell script to install
<a href=https://github.com/Azure/azure-powershell class=link--external target=_blank rel=noreferrer>Azure PowerShell</a>.</p><p>Finally, we&rsquo;ll
<a href=https://docs.github.com/en/actions/using-workflows/events-that-trigger-workflows#schedule class=link--external target=_blank rel=noreferrer>schedule a GitHub Actions workflow</a>
that runs the Packer build. We&rsquo;ll query Azure daily to check for new Windows
releases and run Packer as soon as a new version is made available by Microsoft.</p><p>As usual,
<a href=https://github.com/schnerring/packer-windows-avd/tree/v0.4.0 class=link--external target=_blank rel=noreferrer>all the code is available on GitHub</a>.</p><h2 id=get-the-latest-windows-11-version-available-on-azure>Get the Latest Windows 11 Version Available on Azure<a href=#get-the-latest-windows-11-version-available-on-azure class=post-heading__anchor aria-hidden=true>#</a></h2><p><a href=https://docs.microsoft.com/en-us/windows/deployment/update/quality-updates#quality-updates class=link--external target=_blank rel=noreferrer>Microsoft releases monthly quality updates for Windows</a>,
on <em>Patch Tuesday</em>, the second Tuesday of each month. Microsoft can provide a
release outside of the monthly schedule in exceptional circumstances, e.g., to
fix a critical security vulnerability.</p><p>We can use the Azure CLI to query the available Windows versions on Azure like
this:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>az vm image list <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>  --publisher MicrosoftWindowsDesktop <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>  --offer office-365 <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>  --sku win11-23h2-avd-m365 <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>  --all
</span></span></code></pre></div><p>If you prefer using a Windows 11 base image without Office 365, use
<code>--offer windows-11</code> and <code>--sku win11-23h2-avd</code> instead. You can discover more
images using the Azure CLI commands <code>az vm image list-publishers</code>,
<code>az vm image list-offers</code>, and <code>az vm image list-skus</code>.</p><p>So, to specify an image, a value for <em>publisher</em>, <em>offer</em>, <em>SKU</em>, and <em>version</em>
is required. To get the <em>latest version number</em> available, we use the follwing
snippet (thanks <a href=https://github.com/pc-dok class=link--external target=_blank rel=noreferrer>pc-dok</a> for commenting and providing
a more elegant query):</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>az vm image show <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>  --urn <span style=color:#e6db74>&#34;</span><span style=color:#e6db74>${</span>IMAGE_PUBLISHER<span style=color:#e6db74>}</span><span style=color:#e6db74>:</span><span style=color:#e6db74>${</span>IMAGE_OFFER<span style=color:#e6db74>}</span><span style=color:#e6db74>:</span><span style=color:#e6db74>${</span>IMAGE_SKU<span style=color:#e6db74>}</span><span style=color:#e6db74>:latest&#34;</span> <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>  --query name <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>  --out tsv
</span></span></code></pre></div><p>The result of the command above looks like this:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-text data-lang=text><span style=display:flex><span>22631.4037.240813
</span></span></code></pre></div><h2 id=prepare-packer-resources-with-terraform>Prepare Packer Resources with Terraform<a href=#prepare-packer-resources-with-terraform class=post-heading__anchor aria-hidden=true>#</a></h2><p>Before being able to use Packer, we have to create some resources. I like using
Terraform, but you could also use the Azure CLI or the Azure Portal.</p><h3 id=resource-groups>Resource Groups<a href=#resource-groups class=post-heading__anchor aria-hidden=true>#</a></h3><p>First we create two resource groups:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-hcl data-lang=hcl><span style=display:flex><span><span style=color:#66d9ef>resource</span> <span style=color:#e6db74>&#34;azurerm_resource_group&#34; &#34;packer_artifacts&#34;</span> {
</span></span><span style=display:flex><span>  name     <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;packer-artifacts-rg&#34;</span>
</span></span><span style=display:flex><span>  location <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;Switzerland North&#34;</span>
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>resource</span> <span style=color:#e6db74>&#34;azurerm_resource_group&#34; &#34;packer_build&#34;</span> {
</span></span><span style=display:flex><span>  name     <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;packer-build-rg&#34;</span>
</span></span><span style=display:flex><span>  location <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;Switzerland North&#34;</span>
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>Packer puts resources required during build time into the <code>packer-build-rg</code>
resource group, which means it should only contain resources during build time.
Packer publishes the resulting
<a href=https://docs.microsoft.com/en-us/azure/virtual-machines/windows/capture-image-resource class=link--external target=_blank rel=noreferrer>managed images</a>
to the <code>packer-artifacts-rg</code> resource group. We could also let Packer manage the
creation of resource groups, but in my opinion, it&rsquo;s easier to scope permissions
if we pre-provision them.</p><h3 id=authentication-and-authorization>Authentication and Authorization<a href=#authentication-and-authorization class=post-heading__anchor aria-hidden=true>#</a></h3><p>We&rsquo;ll use
<a href="https://www.packer.io/plugins/builders/azure/arm#service-principal=" class=link--external target=_blank rel=noreferrer>SP authentication</a>
with Packer because it integrates well with GitHub Actions:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-hcl data-lang=hcl><span style=display:flex><span><span style=color:#66d9ef>resource</span> <span style=color:#e6db74>&#34;azuread_application&#34; &#34;packer&#34;</span> {
</span></span><span style=display:flex><span>  display_name <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;packer-sp-app&#34;</span>
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>resource</span> <span style=color:#e6db74>&#34;azuread_service_principal&#34; &#34;packer&#34;</span> {
</span></span><span style=display:flex><span>  client_id <span style=color:#f92672>=</span> <span style=color:#66d9ef>azuread_application</span>.<span style=color:#66d9ef>packer</span>.<span style=color:#66d9ef>client_id</span>
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>resource</span> <span style=color:#e6db74>&#34;azuread_service_principal_password&#34; &#34;packer&#34;</span> {
</span></span><span style=display:flex><span>  service_principal_id <span style=color:#f92672>=</span> <span style=color:#66d9ef>azuread_service_principal</span>.<span style=color:#66d9ef>packer</span>.<span style=color:#66d9ef>id</span>
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>To authorize the SP to manage resources inside the resource groups, we use
<a href=https://docs.microsoft.com/en-us/azure/role-based-access-control/overview class=link--external target=_blank rel=noreferrer>role-based access control (RBAC)</a>
and assign the SP the <code>Contributor</code> role. To allow the SP to check for existing
images via the Azure CLI
<a href="https://docs.microsoft.com/en-us/cli/azure/image?view=azure-cli-latest#az-image-show" class=link--external target=_blank rel=noreferrer><code>az image show</code> command</a>,
we also assign it the <code>Reader</code> role on the subscription level.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-hcl data-lang=hcl><span style=display:flex><span><span style=color:#66d9ef>data</span> <span style=color:#e6db74>&#34;azurerm_subscription&#34; &#34;subscription&#34;</span> {}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>resource</span> <span style=color:#e6db74>&#34;azurerm_role_assignment&#34; &#34;subscription_reader&#34;</span> {
</span></span><span style=display:flex><span>  scope                <span style=color:#f92672>=</span> <span style=color:#66d9ef>data</span>.<span style=color:#66d9ef>azurerm_subscription</span>.<span style=color:#66d9ef>subscription</span>.<span style=color:#66d9ef>id</span>
</span></span><span style=display:flex><span>  role_definition_name <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;Reader&#34;</span>
</span></span><span style=display:flex><span>  principal_id         <span style=color:#f92672>=</span> <span style=color:#66d9ef>azuread_service_principal</span>.<span style=color:#66d9ef>packer</span>.<span style=color:#66d9ef>id</span>
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>resource</span> <span style=color:#e6db74>&#34;azurerm_role_assignment&#34; &#34;packer_build_contributor&#34;</span> {
</span></span><span style=display:flex><span>  scope                <span style=color:#f92672>=</span> <span style=color:#66d9ef>azurerm_resource_group</span>.<span style=color:#66d9ef>packer_build</span>.<span style=color:#66d9ef>id</span>
</span></span><span style=display:flex><span>  role_definition_name <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;Contributor&#34;</span>
</span></span><span style=display:flex><span>  principal_id         <span style=color:#f92672>=</span> <span style=color:#66d9ef>azuread_service_principal</span>.<span style=color:#66d9ef>packer</span>.<span style=color:#66d9ef>id</span>
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>resource</span> <span style=color:#e6db74>&#34;azurerm_role_assignment&#34; &#34;packer_artifacts_contributor&#34;</span> {
</span></span><span style=display:flex><span>  scope                <span style=color:#f92672>=</span> <span style=color:#66d9ef>azurerm_resource_group</span>.<span style=color:#66d9ef>packer_artifacts</span>.<span style=color:#66d9ef>id</span>
</span></span><span style=display:flex><span>  role_definition_name <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;Contributor&#34;</span>
</span></span><span style=display:flex><span>  principal_id         <span style=color:#f92672>=</span> <span style=color:#66d9ef>azuread_service_principal</span>.<span style=color:#66d9ef>packer</span>.<span style=color:#66d9ef>id</span>
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><h3 id=export-github-actions-secrets>Export GitHub Actions Secrets<a href=#export-github-actions-secrets class=post-heading__anchor aria-hidden=true>#</a></h3><p>To make the credentials accessible to GitHub Actions, we export them to GitHub
as
<a href=https://docs.github.com/en/actions/security-guides/encrypted-secrets class=link--external target=_blank rel=noreferrer>encrypted secrets</a>
like this:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-hcl data-lang=hcl><span style=display:flex><span><span style=color:#66d9ef>data</span> <span style=color:#e6db74>&#34;github_repository&#34; &#34;packer_windows_avd&#34;</span> {
</span></span><span style=display:flex><span>  full_name <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;schnerring/packer-windows-avd&#34;</span>
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>resource</span> <span style=color:#e6db74>&#34;github_actions_secret&#34; &#34;packer_client_id&#34;</span> {
</span></span><span style=display:flex><span>  repository      <span style=color:#f92672>=</span> <span style=color:#66d9ef>data</span>.<span style=color:#66d9ef>github_repository</span>.<span style=color:#66d9ef>packer_windows_avd</span>.<span style=color:#66d9ef>name</span>
</span></span><span style=display:flex><span>  secret_name     <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;PACKER_CLIENT_ID&#34;</span>
</span></span><span style=display:flex><span>  plaintext_value <span style=color:#f92672>=</span> <span style=color:#66d9ef>azuread_application</span>.<span style=color:#66d9ef>packer</span>.<span style=color:#66d9ef>client_id</span>
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>resource</span> <span style=color:#e6db74>&#34;github_actions_secret&#34; &#34;packer_client_secret&#34;</span> {
</span></span><span style=display:flex><span>  repository      <span style=color:#f92672>=</span> <span style=color:#66d9ef>data</span>.<span style=color:#66d9ef>github_repository</span>.<span style=color:#66d9ef>packer_windows_avd</span>.<span style=color:#66d9ef>name</span>
</span></span><span style=display:flex><span>  secret_name     <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;PACKER_CLIENT_SECRET&#34;</span>
</span></span><span style=display:flex><span>  plaintext_value <span style=color:#f92672>=</span> <span style=color:#66d9ef>azuread_service_principal_password</span>.<span style=color:#66d9ef>packer</span>.<span style=color:#66d9ef>value</span>
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>resource</span> <span style=color:#e6db74>&#34;github_actions_secret&#34; &#34;packer_subscription_id&#34;</span> {
</span></span><span style=display:flex><span>  repository      <span style=color:#f92672>=</span> <span style=color:#66d9ef>data</span>.<span style=color:#66d9ef>github_repository</span>.<span style=color:#66d9ef>packer_windows_avd</span>.<span style=color:#66d9ef>name</span>
</span></span><span style=display:flex><span>  secret_name     <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;PACKER_SUBSCRIPTION_ID&#34;</span>
</span></span><span style=display:flex><span>  plaintext_value <span style=color:#f92672>=</span> <span style=color:#66d9ef>data</span>.<span style=color:#66d9ef>azurerm_subscription</span>.<span style=color:#66d9ef>subscription</span>.<span style=color:#66d9ef>subscription_id</span>
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>resource</span> <span style=color:#e6db74>&#34;github_actions_secret&#34; &#34;packer_tenant_id&#34;</span> {
</span></span><span style=display:flex><span>  repository      <span style=color:#f92672>=</span> <span style=color:#66d9ef>data</span>.<span style=color:#66d9ef>github_repository</span>.<span style=color:#66d9ef>packer_windows_avd</span>.<span style=color:#66d9ef>name</span>
</span></span><span style=display:flex><span>  secret_name     <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;PACKER_TENANT_ID&#34;</span>
</span></span><span style=display:flex><span>  plaintext_value <span style=color:#f92672>=</span> <span style=color:#66d9ef>data</span>.<span style=color:#66d9ef>azurerm_subscription</span>.<span style=color:#66d9ef>subscription</span>.<span style=color:#66d9ef>tenant_id</span>
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>We&rsquo;ll later also make use of the
<a href=https://github.com/Azure/login#configure-a-service-principal-with-a-secret class=link--external target=_blank rel=noreferrer>Azure Login Action</a>
to dynamically query the latest Windows version available on Azure with the
<a href=https://docs.microsoft.com/en-us/cli/azure/ class=link--external target=_blank rel=noreferrer>Azure CLI</a>.
<a href=https://github.com/Azure/login#configure-a-service-principal-with-a-secret class=link--external target=_blank rel=noreferrer>It expects the credentials in the following JSON format</a>:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-json data-lang=json><span style=display:flex><span>{
</span></span><span style=display:flex><span>  <span style=color:#f92672>&#34;clientId&#34;</span>: <span style=color:#e6db74>&#34;&lt;GUID&gt;&#34;</span>,
</span></span><span style=display:flex><span>  <span style=color:#f92672>&#34;clientSecret&#34;</span>: <span style=color:#e6db74>&#34;&lt;GUID&gt;&#34;</span>,
</span></span><span style=display:flex><span>  <span style=color:#f92672>&#34;subscriptionId&#34;</span>: <span style=color:#e6db74>&#34;&lt;GUID&gt;&#34;</span>,
</span></span><span style=display:flex><span>  <span style=color:#f92672>&#34;tenantId&#34;</span>: <span style=color:#e6db74>&#34;&lt;GUID&gt;&#34;</span>
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>Let&rsquo;s export another secret named <code>AZURE_CREDENTIALS</code> containing the credentials
in the JSON format above using Terraform&rsquo;s <code>jsonencode</code> function:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-hcl data-lang=hcl><span style=display:flex><span><span style=color:#66d9ef>resource</span> <span style=color:#e6db74>&#34;github_actions_secret&#34; &#34;github_actions_azure_credentials&#34;</span> {
</span></span><span style=display:flex><span>  repository  <span style=color:#f92672>=</span> <span style=color:#66d9ef>data</span>.<span style=color:#66d9ef>github_repository</span>.<span style=color:#66d9ef>packer_windows_avd</span>.<span style=color:#66d9ef>name</span>
</span></span><span style=display:flex><span>  secret_name <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;AZURE_CREDENTIALS&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  plaintext_value <span style=color:#f92672>=</span> <span style=color:#66d9ef>jsonencode</span>(
</span></span><span style=display:flex><span>    {
</span></span><span style=display:flex><span>      clientId       <span style=color:#f92672>=</span> <span style=color:#66d9ef>azuread_application</span>.<span style=color:#66d9ef>packer</span>.<span style=color:#66d9ef>client_id</span>
</span></span><span style=display:flex><span>      clientSecret   <span style=color:#f92672>=</span> <span style=color:#66d9ef>azuread_service_principal_password</span>.<span style=color:#66d9ef>packer</span>.<span style=color:#66d9ef>value</span>
</span></span><span style=display:flex><span>      subscriptionId <span style=color:#f92672>=</span> <span style=color:#66d9ef>data</span>.<span style=color:#66d9ef>azurerm_subscription</span>.<span style=color:#66d9ef>subscription</span>.<span style=color:#66d9ef>subscription_id</span>
</span></span><span style=display:flex><span>      tenantId       <span style=color:#f92672>=</span> <span style=color:#66d9ef>data</span>.<span style=color:#66d9ef>azurerm_subscription</span>.<span style=color:#66d9ef>subscription</span>.<span style=color:#66d9ef>tenant_id</span>
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>  )
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>Finally, we export the names of the resource groups we created like this:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-hcl data-lang=hcl><span style=display:flex><span><span style=color:#66d9ef>resource</span> <span style=color:#e6db74>&#34;github_actions_secret&#34; &#34;packer_artifacts_resource_group&#34;</span> {
</span></span><span style=display:flex><span>  repository      <span style=color:#f92672>=</span> <span style=color:#66d9ef>data</span>.<span style=color:#66d9ef>github_repository</span>.<span style=color:#66d9ef>packer_windows_avd</span>.<span style=color:#66d9ef>name</span>
</span></span><span style=display:flex><span>  secret_name     <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;PACKER_ARTIFACTS_RESOURCE_GROUP&#34;</span>
</span></span><span style=display:flex><span>  plaintext_value <span style=color:#f92672>=</span> <span style=color:#66d9ef>azurerm_resource_group</span>.<span style=color:#66d9ef>packer_artifacts</span>.<span style=color:#66d9ef>name</span>
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>resource</span> <span style=color:#e6db74>&#34;github_actions_secret&#34; &#34;packer_build_resource_group&#34;</span> {
</span></span><span style=display:flex><span>  repository      <span style=color:#f92672>=</span> <span style=color:#66d9ef>data</span>.<span style=color:#66d9ef>github_repository</span>.<span style=color:#66d9ef>packer_windows_avd</span>.<span style=color:#66d9ef>name</span>
</span></span><span style=display:flex><span>  secret_name     <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;PACKER_BUILD_RESOURCE_GROUP&#34;</span>
</span></span><span style=display:flex><span>  plaintext_value <span style=color:#f92672>=</span> <span style=color:#66d9ef>azurerm_resource_group</span>.<span style=color:#66d9ef>packer_build</span>.<span style=color:#66d9ef>name</span>
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><h3 id=add-terraform-outputs>Add Terraform Outputs<a href=#add-terraform-outputs class=post-heading__anchor aria-hidden=true>#</a></h3><p>To run Packer locally, we also need to access the credentials locally. We can
use <a href=https://www.terraform.io/language/values/outputs class=link--external target=_blank rel=noreferrer>Terraform outputs</a> for
this:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-hcl data-lang=hcl><span style=display:flex><span><span style=color:#66d9ef>output</span> <span style=color:#e6db74>&#34;packer_artifacts_resource_group&#34;</span> {
</span></span><span style=display:flex><span>  value     <span style=color:#f92672>=</span> <span style=color:#66d9ef>azurerm_resource_group</span>.<span style=color:#66d9ef>packer_artifacts</span>.<span style=color:#66d9ef>name</span>
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>output</span> <span style=color:#e6db74>&#34;packer_build_resource_group&#34;</span> {
</span></span><span style=display:flex><span>  value     <span style=color:#f92672>=</span> <span style=color:#66d9ef>azurerm_resource_group</span>.<span style=color:#66d9ef>packer_build</span>.<span style=color:#66d9ef>name</span>
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>output</span> <span style=color:#e6db74>&#34;packer_client_id&#34;</span> {
</span></span><span style=display:flex><span>  value     <span style=color:#f92672>=</span> <span style=color:#66d9ef>azuread_application</span>.<span style=color:#66d9ef>packer</span>.<span style=color:#66d9ef>client_id</span>
</span></span><span style=display:flex><span>  sensitive <span style=color:#f92672>=</span> <span style=color:#66d9ef>true</span>
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>output</span> <span style=color:#e6db74>&#34;packer_client_secret&#34;</span> {
</span></span><span style=display:flex><span>  value     <span style=color:#f92672>=</span> <span style=color:#66d9ef>azuread_service_principal_password</span>.<span style=color:#66d9ef>packer</span>.<span style=color:#66d9ef>value</span>
</span></span><span style=display:flex><span>  sensitive <span style=color:#f92672>=</span> <span style=color:#66d9ef>true</span>
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>output</span> <span style=color:#e6db74>&#34;packer_subscription_id&#34;</span> {
</span></span><span style=display:flex><span>  value     <span style=color:#f92672>=</span> <span style=color:#66d9ef>data</span>.<span style=color:#66d9ef>azurerm_subscription</span>.<span style=color:#66d9ef>subscription</span>.<span style=color:#66d9ef>subscription_id</span>
</span></span><span style=display:flex><span>  sensitive <span style=color:#f92672>=</span> <span style=color:#66d9ef>true</span>
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>output</span> <span style=color:#e6db74>&#34;packer_tenant_id&#34;</span> {
</span></span><span style=display:flex><span>  value     <span style=color:#f92672>=</span> <span style=color:#66d9ef>data</span>.<span style=color:#66d9ef>azurerm_subscription</span>.<span style=color:#66d9ef>subscription</span>.<span style=color:#66d9ef>tenant_id</span>
</span></span><span style=display:flex><span>  sensitive <span style=color:#f92672>=</span> <span style=color:#66d9ef>true</span>
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>After running <code>terraform apply</code> to deploy everything, we can access output
values like this: <code>terraform output packer_client_secret</code>.</p><h2 id=create-the-packer-template>Create the Packer Template<a href=#create-the-packer-template class=post-heading__anchor aria-hidden=true>#</a></h2><p>Let&rsquo;s add a Packer template file named <code>windows.pkr.hcl</code>.</p><h3 id=input-variables>Input Variables<a href=#input-variables class=post-heading__anchor aria-hidden=true>#</a></h3><p><a href=https://www.packer.io/guides/hcl/variables class=link--external target=_blank rel=noreferrer>Input variables</a> allow us to
parameterize the Packer build. We can later set their values from default
values, environment, file, or CLI arguments.</p><p>We need to add variables allowing us to pass the SP credentials and resource
group names, as well as the image publisher, offer, SKU, and version:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-hcl data-lang=hcl><span style=display:flex><span><span style=color:#66d9ef>variable</span> <span style=color:#e6db74>&#34;client_id&#34;</span> {
</span></span><span style=display:flex><span>  type        <span style=color:#f92672>=</span> <span style=color:#66d9ef>string</span>
</span></span><span style=display:flex><span>  description <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;Azure Service Principal App ID.&#34;</span>
</span></span><span style=display:flex><span>  sensitive   <span style=color:#f92672>=</span> <span style=color:#66d9ef>true</span>
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>variable</span> <span style=color:#e6db74>&#34;client_secret&#34;</span> {
</span></span><span style=display:flex><span>  type        <span style=color:#f92672>=</span> <span style=color:#66d9ef>string</span>
</span></span><span style=display:flex><span>  description <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;Azure Service Principal Secret.&#34;</span>
</span></span><span style=display:flex><span>  sensitive   <span style=color:#f92672>=</span> <span style=color:#66d9ef>true</span>
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>variable</span> <span style=color:#e6db74>&#34;subscription_id&#34;</span> {
</span></span><span style=display:flex><span>  type        <span style=color:#f92672>=</span> <span style=color:#66d9ef>string</span>
</span></span><span style=display:flex><span>  description <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;Azure Subscription ID.&#34;</span>
</span></span><span style=display:flex><span>  sensitive   <span style=color:#f92672>=</span> <span style=color:#66d9ef>true</span>
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>variable</span> <span style=color:#e6db74>&#34;tenant_id&#34;</span> {
</span></span><span style=display:flex><span>  type        <span style=color:#f92672>=</span> <span style=color:#66d9ef>string</span>
</span></span><span style=display:flex><span>  description <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;Azure Tenant ID.&#34;</span>
</span></span><span style=display:flex><span>  sensitive   <span style=color:#f92672>=</span> <span style=color:#66d9ef>true</span>
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>variable</span> <span style=color:#e6db74>&#34;artifacts_resource_group&#34;</span> {
</span></span><span style=display:flex><span>  type        <span style=color:#f92672>=</span> <span style=color:#66d9ef>string</span>
</span></span><span style=display:flex><span>  description <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;Packer Artifacts Resource Group.&#34;</span>
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>variable</span> <span style=color:#e6db74>&#34;build_resource_group&#34;</span> {
</span></span><span style=display:flex><span>  type        <span style=color:#f92672>=</span> <span style=color:#66d9ef>string</span>
</span></span><span style=display:flex><span>  description <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;Packer Build Resource Group.&#34;</span>
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>variable</span> <span style=color:#e6db74>&#34;source_image_publisher&#34;</span> {
</span></span><span style=display:flex><span>  type        <span style=color:#f92672>=</span> <span style=color:#66d9ef>string</span>
</span></span><span style=display:flex><span>  description <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;Windows Image Publisher.&#34;</span>
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>variable</span> <span style=color:#e6db74>&#34;source_image_offer&#34;</span> {
</span></span><span style=display:flex><span>  type        <span style=color:#f92672>=</span> <span style=color:#66d9ef>string</span>
</span></span><span style=display:flex><span>  description <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;Windows Image Offer.&#34;</span>
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>variable</span> <span style=color:#e6db74>&#34;source_image_sku&#34;</span> {
</span></span><span style=display:flex><span>  type        <span style=color:#f92672>=</span> <span style=color:#66d9ef>string</span>
</span></span><span style=display:flex><span>  description <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;Windows Image SKU.&#34;</span>
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>variable</span> <span style=color:#e6db74>&#34;source_image_version&#34;</span> {
</span></span><span style=display:flex><span>  type        <span style=color:#f92672>=</span> <span style=color:#66d9ef>string</span>
</span></span><span style=display:flex><span>  description <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;Windows Image Version.&#34;</span>
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><h3 id=configure-azure-arm-builder>Configure Azure ARM Builder<a href=#configure-azure-arm-builder class=post-heading__anchor aria-hidden=true>#</a></h3><p>Next, we configure
<a href=https://www.packer.io/plugins/builders/azure/arm class=link--external target=_blank rel=noreferrer>Packer&rsquo;s Azure Resource Manager (ARM) Builder</a>.
We start with the
<a href=https://www.packer.io/docs/templates/hcl_templates/blocks/source class=link--external target=_blank rel=noreferrer><code>source</code></a>
configuration block:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-hcl data-lang=hcl><span style=display:flex><span><span style=color:#66d9ef>source</span> <span style=color:#e6db74>&#34;azure-arm&#34; &#34;avd&#34;</span> {<span style=color:#75715e>
</span></span></span><span style=display:flex><span><span style=color:#75715e>  # WinRM Communicator
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span>  communicator   <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;winrm&#34;</span>
</span></span><span style=display:flex><span>  winrm_use_ssl  <span style=color:#f92672>=</span> <span style=color:#66d9ef>true</span>
</span></span><span style=display:flex><span>  winrm_insecure <span style=color:#f92672>=</span> <span style=color:#66d9ef>true</span>
</span></span><span style=display:flex><span>  winrm_timeout  <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;5m&#34;</span>
</span></span><span style=display:flex><span>  winrm_username <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;packer&#34;</span><span style=color:#75715e>
</span></span></span><span style=display:flex><span><span style=color:#75715e>
</span></span></span><span style=display:flex><span><span style=color:#75715e>  # Service Principal Authentication
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span>  client_id       <span style=color:#f92672>=</span> <span style=color:#66d9ef>var</span>.<span style=color:#66d9ef>client_id</span>
</span></span><span style=display:flex><span>  client_secret   <span style=color:#f92672>=</span> <span style=color:#66d9ef>var</span>.<span style=color:#66d9ef>client_secret</span>
</span></span><span style=display:flex><span>  subscription_id <span style=color:#f92672>=</span> <span style=color:#66d9ef>var</span>.<span style=color:#66d9ef>subscription_id</span>
</span></span><span style=display:flex><span>  tenant_id       <span style=color:#f92672>=</span> <span style=color:#66d9ef>var</span>.<span style=color:#66d9ef>tenant_id</span><span style=color:#75715e>
</span></span></span><span style=display:flex><span><span style=color:#75715e>
</span></span></span><span style=display:flex><span><span style=color:#75715e>  # Source Image
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span>  os_type         <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;Windows&#34;</span>
</span></span><span style=display:flex><span>  image_publisher <span style=color:#f92672>=</span> <span style=color:#66d9ef>var</span>.<span style=color:#66d9ef>source_image_publisher</span>
</span></span><span style=display:flex><span>  image_offer     <span style=color:#f92672>=</span> <span style=color:#66d9ef>var</span>.<span style=color:#66d9ef>source_image_offer</span>
</span></span><span style=display:flex><span>  image_sku       <span style=color:#f92672>=</span> <span style=color:#66d9ef>var</span>.<span style=color:#66d9ef>source_image_sku</span>
</span></span><span style=display:flex><span>  image_version   <span style=color:#f92672>=</span> <span style=color:#66d9ef>var</span>.<span style=color:#66d9ef>source_image_version</span><span style=color:#75715e>
</span></span></span><span style=display:flex><span><span style=color:#75715e>
</span></span></span><span style=display:flex><span><span style=color:#75715e>  # Destination Image
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span>  managed_image_resource_group_name <span style=color:#f92672>=</span> <span style=color:#66d9ef>var</span>.<span style=color:#66d9ef>artifacts_resource_group</span>
</span></span><span style=display:flex><span>  managed_image_name                <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;${var.source_image_sku}-${var.source_image_version}&#34;</span><span style=color:#75715e>
</span></span></span><span style=display:flex><span><span style=color:#75715e>
</span></span></span><span style=display:flex><span><span style=color:#75715e>  # Packer Computing Resources
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span>  build_resource_group_name <span style=color:#f92672>=</span> <span style=color:#66d9ef>var</span>.<span style=color:#66d9ef>build_resource_group</span>
</span></span><span style=display:flex><span>  vm_size                   <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;Standard_D4ds_v4&#34;</span>
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>The <a href=https://www.packer.io/docs/communicators/winrm class=link--external target=_blank rel=noreferrer>WinRM communicator</a> is
Packer&rsquo;s way of talking to Azure Windows VMs. We give the resulting image a
unique <code>managed_image_name</code> by concatenating the values of the SKU and version.
The remaining options are self-explanatory.</p><p>Next, we define a <code>builder</code> block that contains our provisioning steps:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-hcl data-lang=hcl><span style=display:flex><span><span style=color:#66d9ef>build</span> {
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>source</span> <span style=color:#e6db74>&#34;azure-arm.avd&#34;</span> {}<span style=color:#75715e>
</span></span></span><span style=display:flex><span><span style=color:#75715e>
</span></span></span><span style=display:flex><span><span style=color:#75715e>  # Install Chocolatey: https://chocolatey.org/install#individual
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>  <span style=color:#66d9ef>provisioner</span> <span style=color:#e6db74>&#34;powershell&#34;</span> {
</span></span><span style=display:flex><span>    inline <span style=color:#f92672>=</span> [&#34;Set-ExecutionPolicy Bypass -Scope Process -Force; [System.Net.ServicePointManager]::SecurityProtocol <span style=color:#f92672>=</span> [<span style=color:#66d9ef>System</span>.<span style=color:#66d9ef>Net</span>.<span style=color:#66d9ef>ServicePointManager</span>]<span style=color:#960050;background-color:#1e0010>::</span><span style=color:#66d9ef>SecurityProtocol</span> <span style=color:#960050;background-color:#1e0010>-</span><span style=color:#66d9ef>bor</span> <span style=color:#ae81ff>3072</span><span style=color:#960050;background-color:#1e0010>;</span> <span style=color:#66d9ef>iex</span> ((<span style=color:#66d9ef>New</span><span style=color:#960050;background-color:#1e0010>-</span><span style=color:#66d9ef>Object</span> <span style=color:#66d9ef>System</span>.<span style=color:#66d9ef>Net</span>.<span style=color:#66d9ef>WebClient</span>).<span style=color:#66d9ef>DownloadString</span>(<span style=color:#960050;background-color:#1e0010>&#39;</span><span style=color:#66d9ef>https</span><span style=color:#960050;background-color:#1e0010>://</span><span style=color:#66d9ef>community</span>.<span style=color:#66d9ef>chocolatey</span>.<span style=color:#66d9ef>org</span><span style=color:#960050;background-color:#1e0010>/</span><span style=color:#66d9ef>install</span>.<span style=color:#66d9ef>ps1</span><span style=color:#960050;background-color:#1e0010>&#39;</span>))<span style=color:#960050;background-color:#1e0010>&#34;</span>]
</span></span><span style=display:flex><span>  }<span style=color:#75715e>
</span></span></span><span style=display:flex><span><span style=color:#75715e>
</span></span></span><span style=display:flex><span><span style=color:#75715e>  # Install Chocolatey packages
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>  <span style=color:#66d9ef>provisioner</span> <span style=color:#e6db74>&#34;file&#34;</span> {
</span></span><span style=display:flex><span>    source      <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;./packages.config&#34;</span>
</span></span><span style=display:flex><span>    destination <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;D:/packages.config&#34;</span>
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>provisioner</span> <span style=color:#e6db74>&#34;powershell&#34;</span> {
</span></span><span style=display:flex><span>    inline <span style=color:#f92672>=</span> [<span style=color:#e6db74>&#34;choco install --confirm D:/packages.config&#34;</span>]<span style=color:#75715e>
</span></span></span><span style=display:flex><span><span style=color:#75715e>    # See https://docs.chocolatey.org/en-us/choco/commands/install#exit-codes
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    valid_exit_codes <span style=color:#f92672>=</span> [<span style=color:#ae81ff>0</span>, <span style=color:#ae81ff>3010</span>]
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>provisioner</span> <span style=color:#e6db74>&#34;windows-restart&#34;</span> {}<span style=color:#75715e>
</span></span></span><span style=display:flex><span><span style=color:#75715e>
</span></span></span><span style=display:flex><span><span style=color:#75715e>  # Azure PowerShell Modules
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>  <span style=color:#66d9ef>provisioner</span> <span style=color:#e6db74>&#34;powershell&#34;</span> {
</span></span><span style=display:flex><span>    script <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;./install-azure-powershell.ps1&#34;</span>
</span></span><span style=display:flex><span>  }<span style=color:#75715e>
</span></span></span><span style=display:flex><span><span style=color:#75715e>
</span></span></span><span style=display:flex><span><span style=color:#75715e>  # Generalize image using Sysprep
</span></span></span><span style=display:flex><span><span style=color:#75715e>  # See https://www.packer.io/docs/builders/azure/arm#windows
</span></span></span><span style=display:flex><span><span style=color:#75715e>  # See https://docs.microsoft.com/en-us/azure/virtual-machines/windows/build-image-with-packer#define-packer-template
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>  <span style=color:#66d9ef>provisioner</span> <span style=color:#e6db74>&#34;powershell&#34;</span> {
</span></span><span style=display:flex><span>    inline <span style=color:#f92672>=</span> [
</span></span><span style=display:flex><span>      <span style=color:#e6db74>&#34;while ((Get-Service RdAgent).Status -ne &#39;Running&#39;) { Start-Sleep -s 5 }&#34;</span>,
</span></span><span style=display:flex><span>      <span style=color:#e6db74>&#34;while ((Get-Service WindowsAzureGuestAgent).Status -ne &#39;Running&#39;) { Start-Sleep -s 5 }&#34;</span>,
</span></span><span style=display:flex><span>      <span style=color:#e6db74>&#34;&amp; $env:SystemRoot\\System32\\Sysprep\\Sysprep.exe /oobe /generalize /quiet /quit /mode:vm&#34;</span>,
</span></span><span style=display:flex><span>      &#34;while ($true) { $imageState <span style=color:#f92672>=</span> <span style=color:#66d9ef>Get</span><span style=color:#960050;background-color:#1e0010>-</span><span style=color:#66d9ef>ItemProperty</span> <span style=color:#66d9ef>HKLM</span><span style=color:#960050;background-color:#1e0010>:\\</span><span style=color:#66d9ef>SOFTWARE</span><span style=color:#960050;background-color:#1e0010>\\</span><span style=color:#66d9ef>Microsoft</span><span style=color:#960050;background-color:#1e0010>\\</span><span style=color:#66d9ef>Windows</span><span style=color:#960050;background-color:#1e0010>\\</span><span style=color:#66d9ef>CurrentVersion</span><span style=color:#960050;background-color:#1e0010>\\</span><span style=color:#66d9ef>Setup</span><span style=color:#960050;background-color:#1e0010>\\</span><span style=color:#66d9ef>State</span> <span style=color:#960050;background-color:#1e0010>|</span> <span style=color:#66d9ef>Select</span> <span style=color:#66d9ef>ImageState</span><span style=color:#960050;background-color:#1e0010>;</span> <span style=color:#66d9ef>if</span>(<span style=color:#960050;background-color:#1e0010>$</span><span style=color:#66d9ef>imageState</span>.<span style=color:#66d9ef>ImageState</span> <span style=color:#960050;background-color:#1e0010>-</span><span style=color:#66d9ef>ne</span> <span style=color:#960050;background-color:#1e0010>&#39;</span><span style=color:#66d9ef>IMAGE_STATE_GENERALIZE_RESEAL_TO_OOBE</span><span style=color:#960050;background-color:#1e0010>&#39;</span>) { <span style=color:#66d9ef>Write</span><span style=color:#960050;background-color:#1e0010>-</span><span style=color:#66d9ef>Output</span> <span style=color:#960050;background-color:#1e0010>$</span><span style=color:#66d9ef>imageState</span>.<span style=color:#66d9ef>ImageState</span><span style=color:#960050;background-color:#1e0010>;</span> <span style=color:#66d9ef>Start</span><span style=color:#960050;background-color:#1e0010>-</span><span style=color:#66d9ef>Sleep</span> <span style=color:#960050;background-color:#1e0010>-</span><span style=color:#66d9ef>s</span> <span style=color:#ae81ff>10</span>  } <span style=color:#66d9ef>else</span> { <span style=color:#66d9ef>break</span> } }<span style=color:#960050;background-color:#1e0010>&#34;</span>
</span></span><span style=display:flex><span>    ]
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>Let&rsquo;s look at what&rsquo;s happening here:</p><ul><li>First, we reference the <code>source</code> block that we defined before.</li><li>We install Chocolatey using the
<a href=https://chocolatey.org/install#individual class=link--external target=_blank rel=noreferrer>one-liner PowerShell command from the official docs</a>.</li><li>We copy the <code>packages.config</code> file, an XML manifest containing a list of apps
for Chocolatey to install, to the
<a href=https://docs.microsoft.com/en-us/azure/virtual-machines/managed-disks-overview#temporary-disk class=link--external target=_blank rel=noreferrer>temporary disk <code>D:</code> of the VM</a>.
Then we pass the manifest to the
<a href=https://docs.chocolatey.org/en-us/choco/commands/install class=link--external target=_blank rel=noreferrer><code>choco install</code></a>
command.
<a href=https://docs.chocolatey.org/en-us/choco/commands/install#exit-codes class=link--external target=_blank rel=noreferrer>When the command exits with the code <code>3010</code>, a reboot is required</a>.
We make Packer aware of that by passing <code>3010</code> to the list of
<code>valid_exit_codes</code>.</li><li>For good measure, we reboot the VM.</li><li>We run a custom PowerShell script to install the
<a href="https://docs.microsoft.com/en-us/powershell/azure/install-az-ps?view=azps-7.3.2" class=link--external target=_blank rel=noreferrer>Azure PowerShell modules</a>.</li><li><a href=https://www.packer.io/plugins/builders/azure/arm#windows class=link--external target=_blank rel=noreferrer>Finally, we generalize the image using Sysprep</a></li></ul><p>The <code>packages.config</code> manifest looks like this:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-xml data-lang=xml><span style=display:flex><span><span style=color:#75715e>&lt;?xml version=&#34;1.0&#34; encoding=&#34;utf-8&#34;?&gt;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>&lt;packages&gt;</span>
</span></span><span style=display:flex><span>  <span style=color:#75715e>&lt;!-- FSLogix --&gt;</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>&lt;package</span> <span style=color:#a6e22e>id=</span><span style=color:#e6db74>&#34;fslogix&#34;</span> <span style=color:#f92672>/&gt;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#75715e>&lt;!-- PowerShell --&gt;</span>
</span></span><span style=display:flex><span>  <span style=color:#75715e>&lt;!-- See https://learn.microsoft.com/en-us/powershell/scripting/install/installing-powershell-on-windows?view=powershell-7.4#install-the-msi-package-from-the-command-line --&gt;</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>&lt;package</span> <span style=color:#a6e22e>id=</span><span style=color:#e6db74>&#34;powershell-core&#34;</span> <span style=color:#a6e22e>installArguments=</span><span style=color:#e6db74>&#34;ADD_FILE_CONTEXT_MENU_RUNPOWERSHELL=1 ADD_EXPLORER_CONTEXT_MENU_OPENPOWERSHELL=1&#34;</span> <span style=color:#f92672>/&gt;</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>&lt;package</span> <span style=color:#a6e22e>id=</span><span style=color:#e6db74>&#34;openssh&#34;</span> <span style=color:#f92672>/&gt;</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>&lt;package</span> <span style=color:#a6e22e>id=</span><span style=color:#e6db74>&#34;curl&#34;</span> <span style=color:#f92672>/&gt;</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>&lt;package</span> <span style=color:#a6e22e>id=</span><span style=color:#e6db74>&#34;wget&#34;</span> <span style=color:#f92672>/&gt;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#75715e>&lt;!-- Visual Studio 2022 Community --&gt;</span>
</span></span><span style=display:flex><span>  <span style=color:#75715e>&lt;!-- See https://docs.microsoft.com/en-us/visualstudio/install/use-command-line-parameters-to-install-visual-studio?view=vs-2022#layout-command-and-command-line-parameters --&gt;</span>
</span></span><span style=display:flex><span>  <span style=color:#75715e>&lt;!-- See https://docs.microsoft.com/en-us/visualstudio/install/workload-component-id-vs-community?view=vs-2022 --&gt;</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>&lt;package</span> <span style=color:#a6e22e>id=</span><span style=color:#e6db74>&#34;visualstudio2022community&#34;</span> <span style=color:#a6e22e>packageParameters=</span><span style=color:#e6db74>&#34;--add Microsoft.VisualStudio.Workload.Azure;includeRecommended --add Microsoft.VisualStudio.Workload.ManagedDesktop;includeRecommended --add Microsoft.VisualStudio.Workload.NetCrossPlat;includeRecommended --add Microsoft.VisualStudio.Workload.NetWeb;includeRecommended --add Microsoft.VisualStudio.Workload.Office;includeRecommended&#34;</span> <span style=color:#f92672>/&gt;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#75715e>&lt;!-- System Administration --&gt;</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>&lt;package</span> <span style=color:#a6e22e>id=</span><span style=color:#e6db74>&#34;sysinternals&#34;</span> <span style=color:#f92672>/&gt;</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>&lt;package</span> <span style=color:#a6e22e>id=</span><span style=color:#e6db74>&#34;rsat&#34;</span> <span style=color:#f92672>/&gt;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#75715e>&lt;!-- Developer Tools --&gt;</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>&lt;package</span> <span style=color:#a6e22e>id=</span><span style=color:#e6db74>&#34;azure-cli&#34;</span> <span style=color:#f92672>/&gt;</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>&lt;package</span> <span style=color:#a6e22e>id=</span><span style=color:#e6db74>&#34;filezilla&#34;</span> <span style=color:#f92672>/&gt;</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>&lt;package</span> <span style=color:#a6e22e>id=</span><span style=color:#e6db74>&#34;git&#34;</span> <span style=color:#f92672>/&gt;</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>&lt;package</span> <span style=color:#a6e22e>id=</span><span style=color:#e6db74>&#34;sql-server-management-studio&#34;</span> <span style=color:#f92672>/&gt;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#75715e>&lt;!-- Kubernetes --&gt;</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>&lt;package</span> <span style=color:#a6e22e>id=</span><span style=color:#e6db74>&#34;kubernetes-cli&#34;</span> <span style=color:#f92672>/&gt;</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>&lt;package</span> <span style=color:#a6e22e>id=</span><span style=color:#e6db74>&#34;kubernetes-helm&#34;</span> <span style=color:#f92672>/&gt;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#75715e>&lt;!-- Hashicorp --&gt;</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>&lt;package</span> <span style=color:#a6e22e>id=</span><span style=color:#e6db74>&#34;packer&#34;</span> <span style=color:#f92672>/&gt;</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>&lt;package</span> <span style=color:#a6e22e>id=</span><span style=color:#e6db74>&#34;terraform&#34;</span> <span style=color:#f92672>/&gt;</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>&lt;package</span> <span style=color:#a6e22e>id=</span><span style=color:#e6db74>&#34;graphviz&#34;</span> <span style=color:#f92672>/&gt;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#75715e>&lt;!-- Common Apps --&gt;</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>&lt;package</span> <span style=color:#a6e22e>id=</span><span style=color:#e6db74>&#34;7zip&#34;</span> <span style=color:#f92672>/&gt;</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>&lt;package</span> <span style=color:#a6e22e>id=</span><span style=color:#e6db74>&#34;sumatrapdf&#34;</span> <span style=color:#f92672>/&gt;</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>&lt;package</span> <span style=color:#a6e22e>id=</span><span style=color:#e6db74>&#34;keepassxc&#34;</span> <span style=color:#f92672>/&gt;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>&lt;/packages&gt;</span>
</span></span></code></pre></div><p>Note that installing Chocolatey packages like that is a pretty naive approach
that I wouldn&rsquo;t recommend for production-level scenarios.
<a href=https://docs.chocolatey.org/en-us/community-repository/community-packages-disclaimer class=link--external target=_blank rel=noreferrer>Using the Chocolatey community repository has limits in terms of reliability, control, and trust.</a>.
Also, any failing package installation breaks the entire build, so pinning
versions is a good idea.</p><p>The <code>install-azure-powershell.ps1</code> provisioning script to install the Azure
PowerShell modules looks like this:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-powershell data-lang=powershell><span style=display:flex><span><span style=color:#75715e># See https://learn.microsoft.com/en-us/powershell/azure/install-azps-windows?view=azps-12.2.0&amp;tabs=powershell&amp;pivots=windows-msi</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>$ErrorActionPreference = <span style=color:#e6db74>&#34;Stop&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>$downloadUrl = <span style=color:#e6db74>&#34;https://github.com/Azure/azure-powershell/releases/download/v12.2.0-August2024/Az-Cmdlets-12.2.0.38863-x64.msi&#34;</span>
</span></span><span style=display:flex><span>$outFile = <span style=color:#e6db74>&#34;D:\az_pwsh.msi&#34;</span> <span style=color:#75715e># temporary disk</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>Write-Host <span style=color:#e6db74>&#34;Downloading </span>$downloadUrl<span style=color:#e6db74> ...&#34;</span>
</span></span><span style=display:flex><span>[<span style=color:#66d9ef>Net.ServicePointManager</span>]::SecurityProtocol = [<span style=color:#66d9ef>Net.SecurityProtocolType</span>]::Tls12
</span></span><span style=display:flex><span>Invoke-WebRequest -Uri $downloadUrl -OutFile $outFile
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>Write-Host <span style=color:#e6db74>&#34;Installing ...&#34;</span>
</span></span><span style=display:flex><span>Start-Process <span style=color:#e6db74>&#34;msiexec.exe&#34;</span> -Wait -ArgumentList <span style=color:#e6db74>&#34;/package </span>$outFile<span style=color:#e6db74>&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>Write-Host <span style=color:#e6db74>&#34;Done.&#34;</span>
</span></span></code></pre></div><p>We only covered two methods for installing software into the golden image. Often
it doesn&rsquo;t even make sense to bake apps into your golden image, e.g., when app
deployments frequently change. For these scenarios, other solutions like
<a href=https://docs.microsoft.com/en-us/mem/endpoint-manager-overview class=link--external target=_blank rel=noreferrer>Microsoft Endpoint Manager</a>
or
<a href=https://docs.microsoft.com/en-us/azure/virtual-desktop/what-is-app-attach class=link--external target=_blank rel=noreferrer>MSIX App Attach</a>
exist.</p><h3 id=run-packer-locally>Run Packer Locally<a href=#run-packer-locally class=post-heading__anchor aria-hidden=true>#</a></h3><p>To run Packer locally, we use the following command (note the <code>.</code> at the very
end):</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>packer build <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>  -var <span style=color:#e6db74>&#34;artifacts_resource_group=</span><span style=color:#66d9ef>$(</span>terraform output -raw packer_artifacts_resource_group<span style=color:#66d9ef>)</span><span style=color:#e6db74>&#34;</span> <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>  -var <span style=color:#e6db74>&#34;build_resource_group=</span><span style=color:#66d9ef>$(</span>terraform output -raw packer_build_resource_group<span style=color:#66d9ef>)</span><span style=color:#e6db74>&#34;</span> <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>  -var <span style=color:#e6db74>&#34;client_id=</span><span style=color:#66d9ef>$(</span>terraform output -raw packer_client_id<span style=color:#66d9ef>)</span><span style=color:#e6db74>&#34;</span> <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>  -var <span style=color:#e6db74>&#34;client_secret=</span><span style=color:#66d9ef>$(</span>terraform output -raw packer_client_secret<span style=color:#66d9ef>)</span><span style=color:#e6db74>&#34;</span> <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>  -var <span style=color:#e6db74>&#34;subscription_id=</span><span style=color:#66d9ef>$(</span>terraform output -raw packer_subscription_id<span style=color:#66d9ef>)</span><span style=color:#e6db74>&#34;</span> <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>  -var <span style=color:#e6db74>&#34;tenant_id=</span><span style=color:#66d9ef>$(</span>terraform output -raw packer_tenant_id<span style=color:#66d9ef>)</span><span style=color:#e6db74>&#34;</span> <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>  -var <span style=color:#e6db74>&#34;source_image_publisher=MicrosoftWindowsDesktop&#34;</span> <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>  -var <span style=color:#e6db74>&#34;source_image_offer=office-365&#34;</span> <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>  -var <span style=color:#e6db74>&#34;source_image_sku=win11-23h2-avd-m365&#34;</span> <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>  -var <span style=color:#e6db74>&#34;source_image_version=22631.4037.240813&#34;</span> <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>  .
</span></span></code></pre></div><p>With the <code>-var</code> option, we can set Packer variables. We pass the Terraform
outputs that we configured earlier to Packer using command substitution.</p><h2 id=github-actions>GitHub Actions<a href=#github-actions class=post-heading__anchor aria-hidden=true>#</a></h2><p>Next, we tie everything together using GitHub Actions. Add a workflow by adding
a file named <code>.github/workflows/packer.yml</code>. We name the workflow and specify
the events that trigger it:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yml data-lang=yml><span style=display:flex><span><span style=color:#f92672>name</span>: <span style=color:#ae81ff>Packer Windows 11</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#f92672>on</span>:
</span></span><span style=display:flex><span>  <span style=color:#f92672>push</span>:
</span></span><span style=display:flex><span>    <span style=color:#f92672>branches</span>:
</span></span><span style=display:flex><span>      - <span style=color:#ae81ff>main</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>schedule</span>:
</span></span><span style=display:flex><span>    - <span style=color:#f92672>cron</span>: <span style=color:#ae81ff>0</span> <span style=color:#ae81ff>0</span> * * *
</span></span></code></pre></div><p>It&rsquo;s triggered whenever we push code to the <code>main</code> branch. We schedule to run
the workflow daily at 0:00 UTC using the
<a href=https://pubs.opengroup.org/onlinepubs/9699919799/utilities/crontab.html#tag_20_25_07 class=link--external target=_blank rel=noreferrer>POSIX cron syntax</a>.</p><p>Using workflow-level environment variables, we specify the desired source image
publisher, offer, and SKU :</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yml data-lang=yml><span style=display:flex><span><span style=color:#f92672>env</span>:
</span></span><span style=display:flex><span>  <span style=color:#f92672>AZ_CLI_VERSION</span>: <span style=color:#ae81ff>2.40.1</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>IMAGE_PUBLISHER</span>: <span style=color:#ae81ff>MicrosoftWindowsDesktop</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#75715e># With Office 365</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>IMAGE_OFFER</span>: <span style=color:#ae81ff>office-365</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>IMAGE_SKU</span>: <span style=color:#ae81ff>win11-23h2-avd-m365</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#75715e># Without Office 365</span>
</span></span><span style=display:flex><span>  <span style=color:#75715e>#IMAGE_OFFER: windows-11</span>
</span></span><span style=display:flex><span>  <span style=color:#75715e>#IMAGE_SKU: win11-23h2-avd</span>
</span></span></code></pre></div><p>Here is a high-level overview of the workflow <code>jobs</code> where all the magic
happens:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yml data-lang=yml><span style=display:flex><span><span style=color:#f92672>jobs</span>:
</span></span><span style=display:flex><span>  <span style=color:#f92672>latest_windows_version</span>:
</span></span><span style=display:flex><span>    <span style=color:#75715e># Get latest Windows version from Azure</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>check_image_exists</span>:
</span></span><span style=display:flex><span>    <span style=color:#75715e># Check if latest version has already been built</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>packer</span>:
</span></span><span style=display:flex><span>    <span style=color:#75715e># Run Packer</span>
</span></span></code></pre></div><p>Let&rsquo;s look into each job in detail next.</p><h3 id=job-latest_windows_version>Job: <code>latest_windows_version</code><a href=#job-latest_windows_version class=post-heading__anchor aria-hidden=true>#</a></h3><p>We use the <code>AZURE_CREDENTIALS</code> secret we defined earlier with Terraform to
authenticate to Azure with the
<a href=https://github.com/Azure/login class=link--external target=_blank rel=noreferrer>Azure Login Action</a>.</p><p>After, we use the <a href=https://github.com/Azure/cli class=link--external target=_blank rel=noreferrer>Azure CLI Action</a> to run
<a href=#get-the-latest-windows-11-version-available-on-azure>the snippet to calculate the latest available image version</a>.</p><p>To allow using the result from the other jobs, we define the <code>version</code> job
output. It&rsquo;s set using the <code>echo "version=${latest_version}" >> $GITHUB_OUTPUT</code>
command.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yml data-lang=yml><span style=display:flex><span><span style=color:#f92672>latest_windows_version</span>:
</span></span><span style=display:flex><span>  <span style=color:#f92672>name</span>: <span style=color:#ae81ff>Get latest Windows version from Azure</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>runs-on</span>: <span style=color:#ae81ff>ubuntu-latest</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>outputs</span>:
</span></span><span style=display:flex><span>    <span style=color:#f92672>version</span>: <span style=color:#ae81ff>${{ steps.get_latest_version.outputs.version }}</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>steps</span>:
</span></span><span style=display:flex><span>    - <span style=color:#f92672>name</span>: <span style=color:#ae81ff>Azure Login</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>uses</span>: <span style=color:#ae81ff>azure/login@v2</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>with</span>:
</span></span><span style=display:flex><span>        <span style=color:#f92672>creds</span>: <span style=color:#ae81ff>${{ secrets.AZURE_CREDENTIALS }}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    - <span style=color:#f92672>name</span>: <span style=color:#ae81ff>Get Latest Version</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>id</span>: <span style=color:#ae81ff>get_latest_version</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>uses</span>: <span style=color:#ae81ff>azure/cli@v2</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>with</span>:
</span></span><span style=display:flex><span>        <span style=color:#f92672>azcliversion</span>: <span style=color:#ae81ff>${{ env.AZ_CLI_VERSION }}</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>inlineScript</span>: |<span style=color:#e6db74>
</span></span></span><span style=display:flex><span><span style=color:#e6db74>          latest_version=$(
</span></span></span><span style=display:flex><span><span style=color:#e6db74>            az vm image show \
</span></span></span><span style=display:flex><span><span style=color:#e6db74>              --urn &#34;${IMAGE_PUBLISHER}:${IMAGE_OFFER}:${IMAGE_SKU}:latest&#34; \
</span></span></span><span style=display:flex><span><span style=color:#e6db74>              --query name \
</span></span></span><span style=display:flex><span><span style=color:#e6db74>              --out tsv
</span></span></span><span style=display:flex><span><span style=color:#e6db74>          )
</span></span></span><span style=display:flex><span><span style=color:#e6db74>          echo &#34;Publisher: ${IMAGE_PUBLISHER}&#34;
</span></span></span><span style=display:flex><span><span style=color:#e6db74>          echo &#34;Offer:     ${IMAGE_OFFER}&#34;
</span></span></span><span style=display:flex><span><span style=color:#e6db74>          echo &#34;SKU:       ${IMAGE_SKU}&#34;
</span></span></span><span style=display:flex><span><span style=color:#e6db74>          echo &#34;Version:   ${latest_version}&#34;
</span></span></span><span style=display:flex><span><span style=color:#e6db74>          echo &#34;version=${latest_version}&#34; &gt;&gt; $GITHUB_OUTPUT</span>          
</span></span></code></pre></div><h3 id=job-check_image_exists>Job: <code>check_image_exists</code><a href=#job-check_image_exists class=post-heading__anchor aria-hidden=true>#</a></h3><p>This job <code>needs</code> the <code>latest_windows_version</code> job to finish first because it
depends on its <code>version</code> output.</p><p>Remember that we name our Packer images (<code>managed_image_name</code>) like
<code>${sku}-${version}</code>. Using the <code>IMAGE_SKU</code> workflow environment variable and the
<code>version</code> output from the <code>latest_windows_version</code> job, we can use the
<code>az image show</code> command to check for existing images inside the Packer artifacts
resource group.</p><p>Depending on whether or not an image exists, we set the job output <code>exists</code> to
<code>true</code> or <code>false</code>.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yml data-lang=yml><span style=display:flex><span><span style=color:#f92672>check_image_exists</span>:
</span></span><span style=display:flex><span>  <span style=color:#f92672>name</span>: <span style=color:#ae81ff>Check if latest version has already been built</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>runs-on</span>: <span style=color:#ae81ff>ubuntu-latest</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>needs</span>: <span style=color:#ae81ff>latest_windows_version</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>outputs</span>:
</span></span><span style=display:flex><span>    <span style=color:#f92672>exists</span>: <span style=color:#ae81ff>${{ steps.get_image.outputs.exists }}</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>steps</span>:
</span></span><span style=display:flex><span>    - <span style=color:#f92672>name</span>: <span style=color:#ae81ff>Azure Login</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>uses</span>: <span style=color:#ae81ff>azure/login@v2</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>with</span>:
</span></span><span style=display:flex><span>        <span style=color:#f92672>creds</span>: <span style=color:#ae81ff>${{ secrets.AZURE_CREDENTIALS }}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    - <span style=color:#f92672>name</span>: <span style=color:#ae81ff>Check If Image Exists</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>id</span>: <span style=color:#ae81ff>get_image</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>uses</span>: <span style=color:#ae81ff>azure/cli@v2</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>with</span>:
</span></span><span style=display:flex><span>        <span style=color:#f92672>azcliversion</span>: <span style=color:#ae81ff>${{ env.AZ_CLI_VERSION }}</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>inlineScript</span>: |<span style=color:#e6db74>
</span></span></span><span style=display:flex><span><span style=color:#e6db74>          if az image show \
</span></span></span><span style=display:flex><span><span style=color:#e6db74>            --resource-group &#34;${{ secrets.PACKER_ARTIFACTS_RESOURCE_GROUP }}&#34; \
</span></span></span><span style=display:flex><span><span style=color:#e6db74>            --name &#34;${IMAGE_SKU}-${{ needs.latest_windows_version.outputs.version }}&#34;; then
</span></span></span><span style=display:flex><span><span style=color:#e6db74>            image_exists=true
</span></span></span><span style=display:flex><span><span style=color:#e6db74>          else
</span></span></span><span style=display:flex><span><span style=color:#e6db74>            image_exists=false
</span></span></span><span style=display:flex><span><span style=color:#e6db74>          fi
</span></span></span><span style=display:flex><span><span style=color:#e6db74>          echo &#34;Image Exists: ${image_exists}&#34;
</span></span></span><span style=display:flex><span><span style=color:#e6db74>          echo &#34;exists=${image_exists}&#34; &gt;&gt; $GITHUB_OUTPUT</span>          
</span></span></code></pre></div><h3 id=job-packer>Job: <code>packer</code><a href=#job-packer class=post-heading__anchor aria-hidden=true>#</a></h3><p>This job <code>needs</code> the outputs from both previous jobs. It only runs <code>if</code> the
<code>exists</code> output of the <code>check_image_exists</code> job equals <code>false</code>. Otherwise, it&rsquo;s
skipped.</p><p>We use the <a href=https://github.com/actions/checkout class=link--external target=_blank rel=noreferrer>Checkout Action</a> to make the
code available to the workflow and validate the syntax of the Packer template by
running <code>packer validate</code>.</p><p>Finally, we run <code>packer build</code>. This time we use environment variables in the
form of <code>PKR_VAR_*</code> to set the Packer inputs opposed to the <code>-var</code> CLI option we
used earlier when running Packer locally.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yml data-lang=yml><span style=display:flex><span><span style=color:#f92672>packer</span>:
</span></span><span style=display:flex><span>  <span style=color:#f92672>name</span>: <span style=color:#ae81ff>Run Packer</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>runs-on</span>: <span style=color:#ae81ff>ubuntu-latest</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>needs</span>: [<span style=color:#ae81ff>latest_windows_version, check_image_exists]</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>if</span>: <span style=color:#ae81ff>needs.check_image_exists.outputs.exists == &#39;false&#39;</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>steps</span>:
</span></span><span style=display:flex><span>    - <span style=color:#f92672>name</span>: <span style=color:#ae81ff>Checkout Repository</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>uses</span>: <span style=color:#ae81ff>actions/checkout@v2</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    - <span style=color:#f92672>name</span>: <span style=color:#ae81ff>Validate Packer Template</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>uses</span>: <span style=color:#ae81ff>hashicorp/packer-github-actions@master</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>with</span>:
</span></span><span style=display:flex><span>        <span style=color:#f92672>command</span>: <span style=color:#ae81ff>validate</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>arguments</span>: -<span style=color:#ae81ff>syntax-only</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    - <span style=color:#f92672>name</span>: <span style=color:#ae81ff>Build Packer Image</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>uses</span>: <span style=color:#ae81ff>hashicorp/packer-github-actions@master</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>with</span>:
</span></span><span style=display:flex><span>        <span style=color:#f92672>command</span>: <span style=color:#ae81ff>build</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>arguments</span>: -<span style=color:#ae81ff>color=false -on-error=abort</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>env</span>:
</span></span><span style=display:flex><span>        <span style=color:#f92672>PKR_VAR_client_id</span>: <span style=color:#ae81ff>${{ secrets.PACKER_CLIENT_ID }}</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>PKR_VAR_client_secret</span>: <span style=color:#ae81ff>${{ secrets.PACKER_CLIENT_SECRET }}</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>PKR_VAR_subscription_id</span>: <span style=color:#ae81ff>${{ secrets.PACKER_SUBSCRIPTION_ID }}</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>PKR_VAR_tenant_id</span>: <span style=color:#ae81ff>${{ secrets.PACKER_TENANT_ID }}</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>PKR_VAR_artifacts_resource_group</span>:
</span></span><span style=display:flex><span>          <span style=color:#ae81ff>${{ secrets.PACKER_ARTIFACTS_RESOURCE_GROUP }}</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>PKR_VAR_build_resource_group</span>: <span style=color:#ae81ff>${{ secrets.PACKER_BUILD_RESOURCE_GROUP }}</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>PKR_VAR_source_image_publisher</span>: <span style=color:#ae81ff>${{ env.IMAGE_PUBLISHER }}</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>PKR_VAR_source_image_offer</span>: <span style=color:#ae81ff>${{ env.IMAGE_OFFER }}</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>PKR_VAR_source_image_sku</span>: <span style=color:#ae81ff>${{ env.IMAGE_SKU }}</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>PKR_VAR_source_image_version</span>:
</span></span><span style=display:flex><span>          <span style=color:#ae81ff>${{ needs.latest_windows_version.outputs.version }}</span>
</span></span></code></pre></div><h3 id=job-cleanup>Job: <code>cleanup</code><a href=#job-cleanup class=post-heading__anchor aria-hidden=true>#</a></h3><p>If the pipeline crashes somewhere along the way, resources inside the
<code>packer-build-rg</code> resource group may linger and incur costs. We want to define a
job that purges everything from the resource group.</p><p>One way to achieve this is by starting a deployment to the resource group using
an empty ARM template. First, we add an empty
<a href="https://docs.microsoft.com/en-us/azure/azure-resource-manager/bicep/overview?tabs=bicep" class=link--external target=_blank rel=noreferrer>Bicep</a>
named <code>cleanup-resource-group.bicep</code>. We can then deploy the template using
<a href="https://docs.microsoft.com/en-us/cli/azure/deployment/group?view=azure-cli-latest#az-deployment-group-create" class=link--external target=_blank rel=noreferrer><code>az deployment group create</code></a>:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yml data-lang=yml><span style=display:flex><span><span style=color:#f92672>cleanup</span>:
</span></span><span style=display:flex><span>  <span style=color:#f92672>name</span>: <span style=color:#ae81ff>Cleanup Packer Resources</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>runs-on</span>: <span style=color:#ae81ff>ubuntu-latest</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>needs</span>: <span style=color:#ae81ff>packer</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>steps</span>:
</span></span><span style=display:flex><span>    - <span style=color:#f92672>name</span>: <span style=color:#ae81ff>Checkout Repository</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>uses</span>: <span style=color:#ae81ff>actions/checkout@v2</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    - <span style=color:#f92672>name</span>: <span style=color:#ae81ff>Azure Login</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>uses</span>: <span style=color:#ae81ff>azure/login@v2</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>with</span>:
</span></span><span style=display:flex><span>        <span style=color:#f92672>creds</span>: <span style=color:#ae81ff>${{ secrets.AZURE_CREDENTIALS }}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    - <span style=color:#f92672>name</span>: <span style=color:#ae81ff>Cleanup Resource Group</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>uses</span>: <span style=color:#ae81ff>azure/cli@v2</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>with</span>:
</span></span><span style=display:flex><span>        <span style=color:#f92672>azcliversion</span>: <span style=color:#ae81ff>${{ env.AZ_CLI_VERSION }}</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>inlineScript</span>: |<span style=color:#e6db74>
</span></span></span><span style=display:flex><span><span style=color:#e6db74>          az deployment group create \
</span></span></span><span style=display:flex><span><span style=color:#e6db74>            --mode Complete \
</span></span></span><span style=display:flex><span><span style=color:#e6db74>            --resource-group &#34;${{ secrets.PACKER_BUILD_RESOURCE_GROUP }}&#34; \
</span></span></span><span style=display:flex><span><span style=color:#e6db74>            --template-file cleanup-resource-group.bicep</span>          
</span></span></code></pre></div><h2 id=what-do-you-think>What Do You Think?<a href=#what-do-you-think class=post-heading__anchor aria-hidden=true>#</a></h2><p>Phew! That was quite a bit of work.
<a href=https://github.com/schnerring/packer-windows-avd/actions class=link--external target=_blank rel=noreferrer>Here is a summary one of the workflow runs</a>
that took around one hour to complete:</p><p><picture><source type=image/webp srcset="/blog/automate-building-custom-windows-images-for-azure-virtual-desktop-with-packer-and-github-actions/workflow-summary_hu6020749313852848853.webp 300w,/blog/automate-building-custom-windows-images-for-azure-virtual-desktop-with-packer-and-github-actions/workflow-summary_hu681709381304995500.webp 431w" sizes="(max-width: 499px) 300px,431px"><img src=/blog/automate-building-custom-windows-images-for-azure-virtual-desktop-with-packer-and-github-actions/workflow-summary.PNG srcset="/blog/automate-building-custom-windows-images-for-azure-virtual-desktop-with-packer-and-github-actions/workflow-summary_hu7452666276042200797.PNG 300w,/blog/automate-building-custom-windows-images-for-azure-virtual-desktop-with-packer-and-github-actions/workflow-summary_hu9610742948285587587.PNG 431w" sizes="(max-width: 499px) 300px,431px" alt="Sample workflow summary" loading=lazy width=431 height=424></picture></p><p>I especially like how the GitHub Actions part turned out. Leave a comment or at
me on Twitter to let me know what you think about it!</p></div><div class=social-share><strong class=social-share__heading>Share this post: </strong><a class=social-share__item href="https://x.com/intent/post?url=https%3A%2F%2Fschnerring.net%2Fblog%2Fautomate-building-custom-windows-images-for-azure-virtual-desktop-with-packer-and-github-actions%2F&amp;text=Automate+Building+Custom+Windows+Images+For+Azure+Virtual+Desktop+With+Packer+And+GitHub+Actions" target=_blank rel=noreferrer><svg role="img" viewBox="0 0 24 24"><title>X</title><path d="M18.901 1.153h3.68l-8.04 9.19L24 22.846h-7.406l-5.8-7.584-6.638 7.584H.474l8.6-9.83L0 1.154h7.594l5.243 6.932zM17.61 20.644h2.039L6.486 3.24H4.298z"/></svg>
</a><a class=social-share__item href="https://www.linkedin.com/sharing/share-offsite/?url=https%3A%2F%2Fschnerring.net%2Fblog%2Fautomate-building-custom-windows-images-for-azure-virtual-desktop-with-packer-and-github-actions%2F" target=_blank rel=noreferrer><svg role="img" viewBox="0 0 24 24"><title>LinkedIn</title><path d="M20.447 20.452h-3.554v-5.569c0-1.328-.027-3.037-1.852-3.037-1.853.0-2.136 1.445-2.136 2.939v5.667H9.351V9h3.414v1.561h.046c.477-.9 1.637-1.85 3.37-1.85 3.601.0 4.267 2.37 4.267 5.455v6.286zM5.337 7.433c-1.144.0-2.063-.926-2.063-2.065.0-1.138.92-2.063 2.063-2.063 1.14.0 2.064.925 2.064 2.063.0 1.139-.925 2.065-2.064 2.065zm1.782 13.019H3.555V9h3.564v11.452zM22.225.0H1.771C.792.0.0.774.0 1.729v20.542C0 23.227.792 24 1.771 24h20.451C23.2 24 24 23.227 24 22.271V1.729C24 .774 23.2.0 22.222.0h.003z"/></svg>
</a><a class=social-share__item href="https://www.facebook.com/sharer.php?u=https%3A%2F%2Fschnerring.net%2Fblog%2Fautomate-building-custom-windows-images-for-azure-virtual-desktop-with-packer-and-github-actions%2F" target=_blank rel=noreferrer><svg role="img" viewBox="0 0 24 24"><title>Facebook</title><path d="M9.101 23.691v-7.98H6.627v-3.667h2.474v-1.58c0-4.085 1.848-5.978 5.858-5.978.401.0.955.042 1.468.103a8.68 8.68.0 011.141.195v3.325a8.623 8.623.0 00-.653-.036 26.805 26.805.0 00-.733-.009c-.707.0-1.259.096-1.675.309a1.686 1.686.0 00-.679.622c-.258.42-.374.995-.374 1.752v1.297h3.919l-.386 2.103-.287 1.564h-3.246v8.245C19.396 23.238 24 18.179 24 12.044c0-6.627-5.373-12-12-12s-12 5.373-12 12c0 5.628 3.874 10.35 9.101 11.647z"/></svg>
</a><a class=social-share__item href="https://reddit.com/submit?url=https%3A%2F%2Fschnerring.net%2Fblog%2Fautomate-building-custom-windows-images-for-azure-virtual-desktop-with-packer-and-github-actions%2F&amp;title=Automate+Building+Custom+Windows+Images+For+Azure+Virtual+Desktop+With+Packer+And+GitHub+Actions" target=_blank rel=noreferrer><svg role="img" viewBox="0 0 24 24"><title>Reddit</title><path d="M12 0C5.373.0.0 5.373.0 12c0 3.314 1.343 6.314 3.515 8.485l-2.286 2.286C.775 23.225 1.097 24 1.738 24H12c6.627.0 12-5.373 12-12S18.627.0 12 0zm4.388 3.199c1.104.0 1.999.895 1.999 1.999.0 1.105-.895 2-1.999 2-.946.0-1.739-.657-1.947-1.539v.002c-1.147.162-2.032 1.15-2.032 2.341v.007c1.776.067 3.4.567 4.686 1.363.473-.363 1.064-.58 1.707-.58 1.547.0 2.802 1.254 2.802 2.802.0 1.117-.655 2.081-1.601 2.531-.088 3.256-3.637 5.876-7.997 5.876-4.361.0-7.905-2.617-7.998-5.87-.954-.447-1.614-1.415-1.614-2.538.0-1.548 1.255-2.802 2.803-2.802.645.0 1.239.218 1.712.585 1.275-.79 2.881-1.291 4.64-1.365v-.01c0-1.663 1.263-3.034 2.88-3.207.188-.911.993-1.595 1.959-1.595zm-8.085 8.376c-.784.0-1.459.78-1.506 1.797-.047 1.016.64 1.429 1.426 1.429s1.371-.369 1.418-1.385c.047-1.017-.553-1.841-1.338-1.841zm7.406.0c-.786.0-1.385.824-1.338 1.841.047 1.017.634 1.385 1.418 1.385.785.0 1.473-.413 1.426-1.429-.046-1.017-.721-1.797-1.506-1.797zm-3.703 4.013c-.974.0-1.907.048-2.77.135-.147.015-.241.168-.183.305.483 1.154 1.622 1.964 2.953 1.964 1.33.0 2.47-.81 2.953-1.964.057-.137-.037-.29-.184-.305-.863-.087-1.795-.135-2.769-.135z"/></svg>
</a><a class=social-share__item href="https://news.ycombinator.com/submitlink?u=https%3A%2F%2Fschnerring.net%2Fblog%2Fautomate-building-custom-windows-images-for-azure-virtual-desktop-with-packer-and-github-actions%2F&amp;t=Automate+Building+Custom+Windows+Images+For+Azure+Virtual+Desktop+With+Packer+And+GitHub+Actions" target=_blank rel=noreferrer><svg role="img" viewBox="0 0 24 24"><title>Y Combinator</title><path d="M0 24V0h24v24H0zM6.951 5.896l4.112 7.708v5.064h1.583v-4.972l4.148-7.799h-1.749l-2.457 4.875c-.372.745-.688 1.434-.688 1.434s-.297-.708-.651-1.434L8.831 5.896h-1.88z"/></svg>
</a><a class=social-share__item href="mailto:?subject=Automate+Building+Custom+Windows+Images+For+Azure+Virtual+Desktop+With+Packer+And+GitHub+Actions&amp;body=https%3A%2F%2Fschnerring.net%2Fblog%2Fautomate-building-custom-windows-images-for-azure-virtual-desktop-with-packer-and-github-actions%2F" target=_blank rel=noreferrer><svg class="icon icon-tabler icon-tabler-mail" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M3 7a2 2 0 012-2h14a2 2 0 012 2v10a2 2 0 01-2 2H5a2 2 0 01-2-2V7z"/><path d="M3 7l9 6 9-6"/></svg></a></div><div id=remark42></div><script>var remark_config={host:"https://remark42.schnerring.net",site_id:"schnerring.net",theme:localStorage.getItem("theme"),show_email_subscription:!1}</script><script>!function(e,t){for(s=0;s<e.length;s++){var s,n=t.createElement("script"),o=".js",i=t.head||t.body;"noModule"in n?(n.type="module",o=".mjs"):n.async=!0,n.defer=!0,n.src=remark_config.host+"/web/"+e[s]+o,i.appendChild(n)}}(remark_config.components||["embed"],document)</script><script>const themeToggleLight=document.getElementsByClassName("theme__toggle light--hidden").item(0);themeToggleLight.addEventListener("click",()=>{setTimeout(()=>window.REMARK42.changeTheme("light"),10)});const themeToggleDark=document.getElementsByClassName("theme__toggle dark--hidden").item(0);themeToggleDark.addEventListener("click",()=>{setTimeout(()=>window.REMARK42.changeTheme("dark"),10)})</script><script>function cookieConsentClick(){localStorage.setItem("cookie-consent",!0);const e=document.getElementById("cookie-consent");e.classList.add("cookie-consent--hidden")}</script><div id=cookie-consent class=cookie-consent--hidden><div class=cli-prompt><div class=cli-prompt__chevron>>&nbsp;</div><div class=cli-prompt__text><span>When you participate in the comments, a cookie is used to keep you logged in.</span>
<span class=cli-prompt__cursor>█</span></div><button onclick=cookieConsentClick()>Got it!</button></div></div><script>const cookieConsentAccepted=localStorage&&localStorage.getItem("cookie-consent");if(!cookieConsentAccepted){const e=document.getElementById("cookie-consent");e.classList.remove("cookie-consent--hidden")}</script></article></div><div class=sidebar><aside class=toc><nav><p class=sidebar__heading>Table Of Contents</p><nav id=TableOfContents><ul><li><a href=#get-the-latest-windows-11-version-available-on-azure>Get the Latest Windows 11 Version Available on Azure</a></li><li><a href=#prepare-packer-resources-with-terraform>Prepare Packer Resources with Terraform</a><ul><li><a href=#resource-groups>Resource Groups</a></li><li><a href=#authentication-and-authorization>Authentication and Authorization</a></li><li><a href=#export-github-actions-secrets>Export GitHub Actions Secrets</a></li><li><a href=#add-terraform-outputs>Add Terraform Outputs</a></li></ul></li><li><a href=#create-the-packer-template>Create the Packer Template</a><ul><li><a href=#input-variables>Input Variables</a></li><li><a href=#configure-azure-arm-builder>Configure Azure ARM Builder</a></li><li><a href=#run-packer-locally>Run Packer Locally</a></li></ul></li><li><a href=#github-actions>GitHub Actions</a><ul><li><a href=#job-latest_windows_version>Job: <code>latest_windows_version</code></a></li><li><a href=#job-check_image_exists>Job: <code>check_image_exists</code></a></li><li><a href=#job-packer>Job: <code>packer</code></a></li><li><a href=#job-cleanup>Job: <code>cleanup</code></a></li></ul></li><li><a href=#what-do-you-think>What Do You Think?</a></li></ul></nav></nav></aside><hr><aside class=bio><div class="jr__item jr-basics__item"><div class=jr-basics__image><img src=https://schnerring.net/michael-schnerring.jpg alt="Picture of Michael Schnerring" width=250 height=250></div><div class=jr-basics__name>Michael Schnerring</div><div class=jr-basics__label>Software Engineer</div><div class=jr-basics__summary>I've been a computer geek all my life. I'm passionate about open-source and digital privacy. I like video games and CrossFit. I also blog sometimes.</div><div class=jr-basics__location-city>Basel</div><div class=jr-basics__location-region>Switzerland</div><hr><div class="jr-basics__profile jr-basics__profile--row"><a href=https://github.com/schnerring target=_blank rel="noreferrer me"><div class=jr-basics__profile-item><div class=jr-basics__profile-icon><svg role="img" viewBox="0 0 24 24"><title>GitHub</title><path d="M12 .297c-6.63.0-12 5.373-12 12 0 5.303 3.438 9.8 8.205 11.385.6.113.82-.258.82-.577.0-.285-.01-1.04-.015-2.04-3.338.724-4.042-1.61-4.042-1.61C4.422 18.07 3.633 17.7 3.633 17.7c-1.087-.744.084-.729.084-.729 1.205.084 1.838 1.236 1.838 1.236 1.07 1.835 2.809 1.305 3.495.998.108-.776.417-1.305.76-1.605-2.665-.3-5.466-1.332-5.466-5.93.0-1.31.465-2.38 1.235-3.22-.135-.303-.54-1.523.105-3.176.0.0 1.005-.322 3.3 1.23.96-.267 1.98-.399 3-.405 1.02.006 2.04.138 3 .405 2.28-1.552 3.285-1.23 3.285-1.23.645 1.653.24 2.873.12 3.176.765.84 1.23 1.91 1.23 3.22.0 4.61-2.805 5.625-5.475 5.92.42.36.81 1.096.81 2.22.0 1.606-.015 2.896-.015 3.286.0.315.21.69.825.57C20.565 22.092 24 17.592 24 12.297c0-6.627-5.373-12-12-12"/></svg></div></div></a><a href=https://x.com/schnerringo target=_blank rel="noreferrer me"><div class=jr-basics__profile-item><div class=jr-basics__profile-icon><svg role="img" viewBox="0 0 24 24"><title>X</title><path d="M18.901 1.153h3.68l-8.04 9.19L24 22.846h-7.406l-5.8-7.584-6.638 7.584H.474l8.6-9.83L0 1.154h7.594l5.243 6.932zM17.61 20.644h2.039L6.486 3.24H4.298z"/></svg></div></div></a><a href=https://hachyderm.io/@schnerring target=_blank rel="noreferrer me"><div class=jr-basics__profile-item><div class=jr-basics__profile-icon><svg role="img" viewBox="0 0 24 24"><title>Mastodon</title><path d="M23.268 5.313c-.35-2.578-2.617-4.61-5.304-5.004C17.51.242 15.792.0 11.813.0h-.03c-3.98.0-4.835.242-5.288.309C3.882.692 1.496 2.518.917 5.127.64 6.412.61 7.837.661 9.143c.074 1.874.088 3.745.26 5.611.118 1.24.325 2.47.62 3.68.55 2.237 2.777 4.098 4.96 4.857 2.336.792 4.849.923 7.256.38.265-.061.527-.132.786-.213.585-.184 1.27-.39 1.774-.753a.057.057.0 00.023-.043v-1.809a.052.052.0 00-.02-.041.053.053.0 00-.046-.01 20.282 20.282.0 01-4.709.545c-2.73.0-3.463-1.284-3.674-1.818a5.593 5.593.0 01-.319-1.433.053.053.0 01.066-.054c1.517.363 3.072.546 4.632.546.376.0.75.0 1.125-.01 1.57-.044 3.224-.124 4.768-.422.038-.008.077-.015.11-.024 2.435-.464 4.753-1.92 4.989-5.604.008-.145.03-1.52.03-1.67.002-.512.167-3.63-.024-5.545zm-3.748 9.195h-2.561V8.29c0-1.309-.55-1.976-1.67-1.976-1.23.0-1.846.79-1.846 2.35v3.403h-2.546V8.663c0-1.56-.617-2.35-1.848-2.35-1.112.0-1.668.668-1.67 1.977v6.218H4.822V8.102c0-1.31.337-2.35 1.011-3.12.696-.77 1.608-1.164 2.74-1.164 1.311.0 2.302.5 2.962 1.498l.638 1.06.638-1.06c.66-.999 1.65-1.498 2.96-1.498 1.13.0 2.043.395 2.74 1.164.675.77 1.012 1.81 1.012 3.12z"/></svg></div></div></a><a href=https://www.linkedin.com/in/schnerring target=_blank rel="noreferrer me"><div class=jr-basics__profile-item><div class=jr-basics__profile-icon><svg role="img" viewBox="0 0 24 24"><title>LinkedIn</title><path d="M20.447 20.452h-3.554v-5.569c0-1.328-.027-3.037-1.852-3.037-1.853.0-2.136 1.445-2.136 2.939v5.667H9.351V9h3.414v1.561h.046c.477-.9 1.637-1.85 3.37-1.85 3.601.0 4.267 2.37 4.267 5.455v6.286zM5.337 7.433c-1.144.0-2.063-.926-2.063-2.065.0-1.138.92-2.063 2.063-2.063 1.14.0 2.064.925 2.064 2.063.0 1.139-.925 2.065-2.064 2.065zm1.782 13.019H3.555V9h3.564v11.452zM22.225.0H1.771C.792.0.0.774.0 1.729v20.542C0 23.227.792 24 1.771 24h20.451C23.2 24 24 23.227 24 22.271V1.729C24 .774 23.2.0 22.222.0h.003z"/></svg></div></div></a><a href=https://schnerring.net/index.xml target=_blank rel="noreferrer me"><div class=jr-basics__profile-item><div class=jr-basics__profile-icon><svg role="img" viewBox="0 0 24 24"><title>RSS</title><path d="M19.199 24C19.199 13.467 10.533 4.8.0 4.8V0c13.165.0 24 10.835 24 24h-4.801zM3.291 17.415c1.814.0 3.293 1.479 3.293 3.295.0 1.813-1.485 3.29-3.301 3.29C1.47 24 0 22.526.0 20.71s1.475-3.294 3.291-3.295zM15.909 24h-4.665c0-6.169-5.075-11.245-11.244-11.245V8.09c8.727.0 15.909 7.184 15.909 15.91z"/></svg></div></div></a></div></div></aside></div></main><footer><div class=copyright>© 2020 - 2023 Michael Schnerring</div></footer><script src=/js/main.64c1438168ce40659c4587f5c9c4360f879c91bf1a11a0108f4a10e6fffccd9d6ad88c2ba6ee9e4196298d61146a14f05b5f3f94f839654339bb28daae75220f.js integrity="sha512-ZMFDgWjOQGWcRYf1ycQ2D4eckb8aEaAQj0oQ5v/8zZ1q2Iwrpu6eQZYpjWEUahTwW18/lPg5ZUM5uyjarnUiDw=="></script><script src=/js/flexsearch.1ab5b109bf2ed66903ae10907394415caa12f5c0ee66bc80088ba135ec4a751f62e4961d6a7303b562e4db724392da85945b763b8e1858ea3fd05cc36f9b8156.js integrity="sha512-GrWxCb8u1mkDrhCQc5RBXKoS9cDuZryACIuhNexKdR9i5JYdanMDtWLk23JDktqFlFt2O44YWOo/0FzDb5uBVg=="></script></div></body></html>