<!doctype html><html lang=en data-theme=dark><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><link rel=preload as=font type=font/woff2 href=/fonts/roboto-slab-latin-400.woff2 crossorigin=anonymous><link rel=preload as=font type=font/woff2 href=/fonts/roboto-slab-latin-700.woff2 crossorigin=anonymous><link rel=preload as=font type=font/woff2 href=/fonts/fira-code-latin-300.woff2 crossorigin=anonymous><link rel=preload as=font type=font/woff2 href=/fonts/fira-code-latin-400.woff2 crossorigin=anonymous><link rel=preload as=font type=font/woff2 href=/fonts/fira-code-latin-700.woff2 crossorigin=anonymous><meta name=robots content="index, follow, max-snippet:-1, max-image-preview:large, max-video-preview:-1"><title>Deploy a Matrix Homeserver to Azure Kubernetes Service (AKS) with Terraform</title>
<meta name=description content="Did you ever think about running a Matrix homeserver? In this post, we will set one up on the Azure Kubernetes Service (AKS). We will use the reference homeserver implementation, which is Synapse from the folks at matrix.org. This post focuses on the Kubernetes stuff, keeping Synapse configuration to a minimum. Things like federation, delegation and PostgreSQL are out of scope, because plenty of excellent guides and the official documentation exist covering that. The icing on the cake will be the Synapse Admin UI deployment with secure access to the administration endpoints to make management of our homeserver easier.
"><link rel=canonical href=https://schnerring.net/blog/deploy-a-matrix-homeserver-to-azure-kubernetes-service-aks-with-terraform/><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="https://schnerring.net/blog/deploy-a-matrix-homeserver-to-azure-kubernetes-service-aks-with-terraform/cover.svg"><meta name=twitter:title content="Deploy a Matrix Homeserver to Azure Kubernetes Service (AKS) with Terraform"><meta name=twitter:description content="Did you ever think about running a Matrix homeserver? In this post, we will set one up on the Azure Kubernetes Service (AKS). We will use the reference homeserver implementation, which is Synapse from the folks at matrix.org. This post focuses on the Kubernetes stuff, keeping Synapse configuration to a minimum. Things like federation, delegation and PostgreSQL are out of scope, because plenty of excellent guides and the official documentation exist covering that. The icing on the cake will be the Synapse Admin UI deployment with secure access to the administration endpoints to make management of our homeserver easier."><meta property="og:url" content="https://schnerring.net/blog/deploy-a-matrix-homeserver-to-azure-kubernetes-service-aks-with-terraform/"><meta property="og:site_name" content="Michael Schnerring"><meta property="og:title" content="Deploy a Matrix Homeserver to Azure Kubernetes Service (AKS) with Terraform"><meta property="og:description" content="Did you ever think about running a Matrix homeserver? In this post, we will set one up on the Azure Kubernetes Service (AKS). We will use the reference homeserver implementation, which is Synapse from the folks at matrix.org. This post focuses on the Kubernetes stuff, keeping Synapse configuration to a minimum. Things like federation, delegation and PostgreSQL are out of scope, because plenty of excellent guides and the official documentation exist covering that. The icing on the cake will be the Synapse Admin UI deployment with secure access to the administration endpoints to make management of our homeserver easier."><meta property="og:locale" content="en"><meta property="og:type" content="article"><meta property="article:section" content="blog"><meta property="article:published_time" content="2021-05-14T01:13:33+02:00"><meta property="article:modified_time" content="2022-04-22T05:35:34+02:00"><meta property="article:tag" content="AKS"><meta property="article:tag" content="Azure"><meta property="article:tag" content="Azure Kubernetes Service"><meta property="article:tag" content="Cloud"><meta property="article:tag" content="K8s"><meta property="article:tag" content="Kubernetes"><meta property="og:image" content="https://schnerring.net/blog/deploy-a-matrix-homeserver-to-azure-kubernetes-service-aks-with-terraform/cover.svg"><meta itemprop=name content="Deploy a Matrix Homeserver to Azure Kubernetes Service (AKS) with Terraform"><meta itemprop=description content="Did you ever think about running a Matrix homeserver? In this post, we will set one up on the Azure Kubernetes Service (AKS). We will use the reference homeserver implementation, which is Synapse from the folks at matrix.org. This post focuses on the Kubernetes stuff, keeping Synapse configuration to a minimum. Things like federation, delegation and PostgreSQL are out of scope, because plenty of excellent guides and the official documentation exist covering that. The icing on the cake will be the Synapse Admin UI deployment with secure access to the administration endpoints to make management of our homeserver easier."><meta itemprop=datePublished content="2021-05-14T01:13:33+02:00"><meta itemprop=dateModified content="2022-04-22T05:35:34+02:00"><meta itemprop=wordCount content="1917"><meta itemprop=image content="https://schnerring.net/blog/deploy-a-matrix-homeserver-to-azure-kubernetes-service-aks-with-terraform/cover.svg"><meta itemprop=keywords content="AKS,Azure,Azure Kubernetes Service,Cloud,K8s,Kubernetes,Matrix,Self-Host,Synapse,Terraform"><script async defer data-domain=schnerring.net src=https://plausible.schnerring.net/js/plausible.js></script><style>@font-face{font-display:swap;font-family:Roboto Slab;font-style:normal;font-weight:100;src:local("Roboto Slab Thin "),local("Roboto Slab-Thin"),url(/fonts/roboto-slab-latin-100.woff2) format("woff2"),url(/fonts/roboto-slab-latin-100.woff) format("woff")}@font-face{font-display:swap;font-family:Roboto Slab;font-style:normal;font-weight:200;src:local("Roboto Slab Extra Light "),local("Roboto Slab-Extra Light"),url(/fonts/roboto-slab-latin-200.woff2) format("woff2"),url(/fonts/roboto-slab-latin-200.woff) format("woff")}@font-face{font-display:swap;font-family:Roboto Slab;font-style:normal;font-weight:300;src:local("Roboto Slab Light "),local("Roboto Slab-Light"),url(/fonts/roboto-slab-latin-300.woff2) format("woff2"),url(/fonts/roboto-slab-latin-300.woff) format("woff")}@font-face{font-display:swap;font-family:Roboto Slab;font-style:normal;font-weight:400;src:local("Roboto Slab Regular "),local("Roboto Slab-Regular"),url(/fonts/roboto-slab-latin-400.woff2) format("woff2"),url(/fonts/roboto-slab-latin-400.woff) format("woff")}@font-face{font-display:swap;font-family:Roboto Slab;font-style:normal;font-weight:500;src:local("Roboto Slab Medium "),local("Roboto Slab-Medium"),url(/fonts/roboto-slab-latin-500.woff2) format("woff2"),url(/fonts/roboto-slab-latin-500.woff) format("woff")}@font-face{font-display:swap;font-family:Roboto Slab;font-style:normal;font-weight:600;src:local("Roboto Slab SemiBold "),local("Roboto Slab-SemiBold"),url(/fonts/roboto-slab-latin-600.woff2) format("woff2"),url(/fonts/roboto-slab-latin-600.woff) format("woff")}@font-face{font-display:swap;font-family:Roboto Slab;font-style:normal;font-weight:700;src:local("Roboto Slab Bold "),local("Roboto Slab-Bold"),url(/fonts/roboto-slab-latin-700.woff2) format("woff2"),url(/fonts/roboto-slab-latin-700.woff) format("woff")}@font-face{font-display:swap;font-family:Roboto Slab;font-style:normal;font-weight:800;src:local("Roboto Slab ExtraBold "),local("Roboto Slab-ExtraBold"),url(/fonts/roboto-slab-latin-800.woff2) format("woff2"),url(/fonts/roboto-slab-latin-800.woff) format("woff")}@font-face{font-display:swap;font-family:Roboto Slab;font-style:normal;font-weight:900;src:local("Roboto Slab Black "),local("Roboto Slab-Black"),url(/fonts/roboto-slab-latin-900.woff2) format("woff2"),url(/fonts/roboto-slab-latin-900.woff) format("woff")}@font-face{font-display:swap;font-family:Fira Code;font-style:normal;font-weight:300;src:local("Fira Code Light "),local("Fira Code-Light"),url(/fonts/fira-code-latin-300.woff2) format("woff2"),url(/fonts/fira-code-latin-300.woff) format("woff")}@font-face{font-display:swap;font-family:Fira Code;font-style:normal;font-weight:400;src:local("Fira Code Regular "),local("Fira Code-Regular"),url(/fonts/fira-code-latin-400.woff2) format("woff2"),url(/fonts/fira-code-latin-400.woff) format("woff")}@font-face{font-display:swap;font-family:Fira Code;font-style:normal;font-weight:500;src:local("Fira Code Medium "),local("Fira Code-Medium"),url(/fonts/fira-code-latin-500.woff2) format("woff2"),url(/fonts/fira-code-latin-500.woff) format("woff")}@font-face{font-display:swap;font-family:Fira Code;font-style:normal;font-weight:600;src:local("Fira Code SemiBold "),local("Fira Code-SemiBold"),url(/fonts/fira-code-latin-600.woff2) format("woff2"),url(/fonts/fira-code-latin-600.woff) format("woff")}@font-face{font-display:swap;font-family:Fira Code;font-style:normal;font-weight:700;src:local("Fira Code Bold "),local("Fira Code-Bold"),url(/fonts/fira-code-latin-700.woff2) format("woff2"),url(/fonts/fira-code-latin-700.woff) format("woff")}

/*! normalize.css v8.0.1 | MIT License | github.com/necolas/normalize.css */html{line-height:1.15;-webkit-text-size-adjust:100%}body{margin:0}main{display:block}h1{font-size:2em;margin:.67em 0}hr{box-sizing:content-box;height:0;overflow:visible}pre{font-family:monospace,monospace;font-size:1em}a{background-color:transparent}abbr[title]{border-bottom:none;-webkit-text-decoration:underline;text-decoration:underline;-webkit-text-decoration:underline dotted;text-decoration:underline dotted}b,strong{font-weight:bolder}code,kbd,samp{font-family:monospace,monospace;font-size:1em}small{font-size:80%}sub,sup{font-size:75%;line-height:0;position:relative;vertical-align:baseline}sub{bottom:-.25em}sup{top:-.5em}img{border-style:none}button,input,optgroup,select,textarea{font-family:inherit;font-size:100%;line-height:1.15;margin:0}button,input{overflow:visible}button,select{text-transform:none}[type=button],[type=reset],[type=submit],button{-webkit-appearance:button}[type=button]::-moz-focus-inner,[type=reset]::-moz-focus-inner,[type=submit]::-moz-focus-inner,button::-moz-focus-inner{border-style:none;padding:0}[type=button]:-moz-focusring,[type=reset]:-moz-focusring,[type=submit]:-moz-focusring,button:-moz-focusring{outline:1px dotted ButtonText}fieldset{padding:.35em .75em .625em}legend{box-sizing:border-box;color:inherit;display:table;max-width:100%;padding:0;white-space:normal}progress{vertical-align:baseline}textarea{overflow:auto}[type=checkbox],[type=radio]{box-sizing:border-box;padding:0}[type=number]::-webkit-inner-spin-button,[type=number]::-webkit-outer-spin-button{height:auto}[type=search]{-webkit-appearance:textfield;outline-offset:-2px}[type=search]::-webkit-search-decoration{-webkit-appearance:none}::-webkit-file-upload-button{-webkit-appearance:button;font:inherit}details{display:block}summary{display:list-item}[hidden],template{display:none}

/*! CC BY-SA 3.0 License | https://stackoverflow.com/a/36118384/1154965 */@keyframes blink{50%{opacity:0}to{opacity:1}}

/*! MIT License | github.com/schnerring/hugo-theme-gruvbox */:root[data-theme=light]{--bg:var(--bg0_h);--bg0:#fbf1c7;--bg0_h:#f9f5d7;--bg0_s:#f2e5bc;--bg1:#ebdbb2;--bg2:#d5c4a1;--bg3:#bdae93;--bg4:#a89984;--fg:var(--fg1);--fg0:#282828;--fg1:#3c3836;--fg2:#504945;--fg3:#665c54;--fg4:#7c6f64;--gray1:var(--fg4);--gray2:#928374;--red1:#cc241d;--red2:#9d0006;--green1:#98971a;--green2:#797403;--yellow1:#d79921;--yellow2:#b57614;--blue1:#458588;--blue2:#076678;--purple1:#b16286;--purple2:#8f3f71;--aqua1:#689d6a;--aqua2:#427b58;--orange1:#d65d0e;--orange2:#af3a03}[data-theme=light]:root .light--hidden{display:none}:root[data-theme=dark]{--bg:var(--bg0_h);--bg0:#282828;--bg0_h:#1d2021;--bg0_s:#32302f;--bg1:#3c3836;--bg2:#504945;--bg3:#665c54;--bg4:#7c6f64;--fg:var(--fg1);--fg0:#fbf1c7;--fg1:#ebdbb2;--fg2:#d5c4a1;--fg3:#bdae93;--fg4:#a89984;--gray1:var(--fg4);--gray2:#928374;--red1:#cc241d;--red2:#fb4934;--green1:#98971a;--green2:#b8bb26;--yellow1:#d79921;--yellow2:#fabd2f;--blue1:#458588;--blue2:#83a598;--purple1:#b16286;--purple2:#d3869b;--aqua1:#689d6a;--aqua2:#8ec07c;--orange1:#d65d0e;--orange2:#fe8019}[data-theme=dark]:root .dark--hidden{display:none}:root{--primary:var(--aqua1);--primary-alt:var(--aqua2);--font-monospace:"Fira Code","Lucida Console",Monaco,monospace;--font-sans-serif:Verdana,Helvetica,sans-serif;--font-serif:"Roboto Slab",Georgia,serif}html{font-family:Roboto Slab,Georgia,serif;font-family:var(--font-serif);font-size:1rem;scroll-behavior:smooth}body{background:var(--bg);color:var(--fg);line-height:1.675;word-wrap:break-word}strong{letter-spacing:.35px}a{color:inherit;-webkit-text-decoration:none;text-decoration:none}a.link--external:after{content:"\2009↗"}img,video{border:2px solid var(--bg1);height:auto;max-width:100%}figure{display:inline-block}figcaption{color:var(--fg3);font-family:Roboto Slab,Georgia,serif;font-family:var(--font-serif);font-size:.9rem}::-moz-selection{background:var(--bg4);color:var(--fg0)}::selection{background:var(--bg4);color:var(--fg0)}h1,h2,h3,h4,h5{color:var(--fg0);font-family:Fira Code,Lucida Console,Monaco,monospace;font-family:var(--font-monospace);font-weight:300;line-height:1.4}h1 code,h2 code,h3 code,h4 code,h5 code{font-size:1em}h2,h3,h4,h5{border-bottom:1px solid var(--bg1)}h1,h2{font-weight:400}h1{font-size:1.875rem}h2{font-size:1.75rem}h3{font-size:1.625rem}@media (min-width:768px){h1{font-size:2.375rem}h2{font-size:2rem}h3{font-size:1.75rem}}h4{font-size:1.5rem}h5{font-size:1.375rem}table{border-collapse:collapse;margin:2rem 0;table-layout:fixed;width:100%}table,td,th{border:1px solid var(--bg1);padding:.5rem}hr{background:var(--bg1);border:none;height:1px;margin:3rem auto;width:80%}blockquote,code,pre{border-radius:.2rem;padding:0 .2em}pre code{padding:0}blockquote,code,pre,th{background:var(--bg1)}code,pre,th{font-family:Fira Code,Lucida Console,Monaco,monospace;font-family:var(--font-monospace)}code code{background:var(--bg2)}blockquote,pre{padding:1rem}pre{background:var(--bg1)!important;overflow:auto}pre code{background:none}blockquote{border-left:5px solid var(--primary-alt);margin:.5rem 0}blockquote:not(.does-not-exist) code{background:var(--bg2)}blockquote:not(.does-not-exist) p:first-of-type{margin-top:0}blockquote:not(.does-not-exist) p:last-of-type{margin-bottom:0}pre::-webkit-scrollbar{height:.5rem;scrollbar-width:auto}pre::-webkit-scrollbar-track{background:var(--bg2);border-radius:.2rem}pre::-webkit-scrollbar-thumb{background:var(--bg4);border-radius:.2rem}.layout{display:grid;grid-template-areas:"header" "main" "footer";grid-template-rows:auto 1fr auto;height:100vh}main{align-items:start;display:grid;grid-area:main;grid-template-areas:"empty content sidebar";grid-template-columns:1fr minmax(0,650px) 4fr}header{background:var(--bg1);grid-area:header}footer{grid-area:footer}footer,main{margin:.5em 1.1em}.content{grid-area:content}.sidebar{display:none;flex-direction:column;grid-area:sidebar;margin-top:3rem;position:sticky;top:2rem}@media (min-width:992px){.sidebar{display:flex}}header{display:grid;font-family:Fira Code,Lucida Console,Monaco,monospace;font-family:var(--font-monospace);font-size:1.125rem;grid-template-areas:"heading search nav theme-toggle";grid-template-columns:auto auto 1fr auto;padding:.75rem}.logo{color:var(--fg0);display:flex;font-weight:700;grid-area:heading}.logo:hover .logo__cursor{animation:blink 1s infinite;opacity:1}.logo__chevron,.logo__cursor{margin-left:.5rem}.logo__cursor{opacity:0}.logo__text{display:none}@media (min-width:768px){.logo__text{display:block}}.search{display:flex;grid-area:search;margin:0 1rem}#search__text{background:var(--bg2);border:1px solid var(--bg2);border-radius:.2rem;caret-color:var(--fg);color:var(--fg);outline:none;padding:0 .5rem;width:100%}#search__text:hover{border-color:var(--bg3)}#search__text:focus{border-color:var(--bg4)}#search__text::-moz-placeholder{color:var(--fg3)}#search__text::placeholder{color:var(--fg3)}#search__text[type=search]::-webkit-search-cancel-button{-webkit-appearance:none;appearance:none}#search__suggestions{background:var(--bg);border-radius:.2rem;box-shadow:0 .5rem 1rem var(--bg1);font-family:Roboto Slab,Georgia,serif;font-family:var(--font-serif);left:0;margin-top:2rem;position:absolute;width:95vw;z-index:1000}@media (min-width:768px){.search{position:relative}#search__suggestions{width:60vw}}.search__suggestions--hidden{display:none}.search__suggestion-item{border-bottom:1px dashed var(--bg2);display:grid;grid-template-columns:1fr 2fr}.search__suggestion-item:focus,.search__suggestion-item:focus-visible,.search__suggestion-item:hover{background:var(--bg1);cursor:pointer;outline:none}.search__suggestion-item:last-child{border:none}.search__suggestion-description,.search__suggestion-title{margin:1rem 0;padding:0 1rem}.search__suggestion-title{font-weight:700}.search__suggestion-description{border-left:1px solid var(--bg2)}.search__no-results{padding:.75rem}.theme__toggle{align-items:center;background:none;border:none;color:var(--yellow1);cursor:pointer;display:flex;grid-area:theme-toggle;margin:0 1rem}.theme__toggle:hover{color:var(--yellow2)}.theme__toggle svg{height:28px;width:28px}nav#menu{align-items:center;display:flex;grid-area:nav;justify-content:flex-end}nav#menu .menu__item{color:var(--fg)}nav#menu .menu__item:hover{color:var(--fg3);cursor:pointer}nav#menu ul{list-style:none;margin:0;padding:0}nav#menu ul.menu--horizontal{align-items:center;display:none}nav#menu ul.menu--horizontal li{display:inline-block;margin:0 .75rem}@media (min-width:768px){nav#menu ul.menu--horizontal{display:flex}}nav#menu ul.menu--vertical{background:var(--fg0);bottom:0;margin:0;padding:3rem;position:fixed;right:0;top:0;transform:translate(100%);transition:transform .5s cubic-bezier(.9,0,.1,1);width:50%;z-index:10}nav#menu ul.menu--vertical .menu__item{color:var(--bg1)}nav#menu ul.menu--vertical .menu__item:hover{color:var(--bg4)}nav#menu .menu__burger{display:flex;height:24px;width:24px}nav#menu .menu__burger>*{position:absolute}nav#menu .menu__burger svg{height:inherit;width:inherit;z-index:20}nav#menu .menu__burger svg line{transition-duration:.5s;transition-property:stroke,opacity,transform;transition-timing-function:cubic-bezier(.9,0,.1,1)}nav#menu .menu__burger svg line:first-of-type{transform-origin:center 6px}nav#menu .menu__burger svg line:nth-of-type(2){transform-origin:center 12px}nav#menu .menu__burger svg line:nth-of-type(3){transform-origin:center 18px}nav#menu .menu__burger input{height:inherit;opacity:0;width:inherit;z-index:30}nav#menu .menu__burger input:checked~ul.menu--vertical{transform:none}nav#menu .menu__burger input:checked~svg{stroke:var(--bg1)}nav#menu .menu__burger input:checked~svg line:first-of-type{transform:translateY(6px) rotate(45deg)}nav#menu .menu__burger input:checked~svg line:nth-of-type(2){opacity:0;transform:scale(.2)}nav#menu .menu__burger input:checked~svg line:nth-of-type(3){transform:translateY(-6px) rotate(-45deg)}@media (min-width:768px){nav#menu .menu__burger{display:none}}.sidebar{font-family:Fira Code,Lucida Console,Monaco,monospace;font-family:var(--font-monospace);margin-left:auto;margin-right:auto;max-width:350px;padding-left:2.5rem}.sidebar hr{margin:1.5rem auto}.sidebar svg{fill:var(--fg)}.sidebar__heading{font-size:1.3rem}aside.toc a{color:var(--primary-alt)}aside.toc a:hover{color:var(--primary)}aside.toc ul{list-style:none;margin:0;padding:0}aside.toc ul ul{font-size:.9rem;margin-left:.5rem}aside.toc ul li{line-height:1.1}aside.toc ul li a{display:block;padding:.2rem 0}.jr-basics__image{background:var(--bg1);border:2px solid var(--bg2)}.jr-basics__summary{color:var(--fg3);font-family:Roboto Slab,Georgia,serif;font-family:var(--font-serif);margin:.75rem 0}.jr-basics__profile a:hover{color:var(--fg3)}.jr-basics__profile a:hover svg{fill:var(--fg3)}.content-section,.post{border-bottom:2px dotted var(--bg1);padding:2rem 0}.post figure,.post img:not(figure img),.post video:not(figure video){box-sizing:border-box;margin:.5rem 0}.post-content__read-more,.post-header{font-family:Fira Code,Lucida Console,Monaco,monospace;font-family:var(--font-monospace)}.post-content{margin:1.3rem 0}.post-content__read-more{color:var(--primary-alt);margin-top:1.3rem}.post-content a,.post-header a{color:var(--primary-alt)}.post-content a:hover,.post-header a:hover{color:var(--primary)}.post-tags{align-items:center;display:flex;flex-wrap:wrap;gap:.9rem;margin:1rem 0}.post-tag{font-size:.9rem;line-height:1}.post-tag:before{content:"#"}.post-heading__anchor{display:none}h1:hover .post-heading__anchor,h2:hover .post-heading__anchor,h3:hover .post-heading__anchor,h4:hover .post-heading__anchor,h5:hover .post-heading__anchor{display:inline-block}.jr__item-meta{flex-direction:column}.jr-basics__image,.jr-basics__item,.jr-basics__profile-icon,.jr-basics__profile-item,.jr__item-meta{align-items:center;display:flex}.jr-basics__name,.jr-projects__roles,.jr-work__position{font-size:1.125rem;font-weight:700}.jr-basics__item{flex-direction:column;text-align:center}.jr-basics__item hr{margin:1.5rem auto}.jr-basics__image{border-radius:50%;height:250px;justify-content:center;overflow:hidden;width:250px}.jr-basics__label,.jr-basics__name,.jr-basics__summary{margin-top:.75rem}.jr-basics__profile svg{height:24px;width:24px}.jr-basics__profile,.jr-basics__profile-item{display:flex}.jr-basics__profile-item{display:flex;padding:.2rem}.jr-basics__profile--row{flex-wrap:wrap;justify-content:space-evenly}.jr-basics__profile-icon{padding:0 .75rem}.jr__item-meta{align-items:start;flex-flow:column;font-family:Fira Code,Lucida Console,Monaco,monospace;font-family:var(--font-monospace)}@media (min-width:768px){.jr__item-meta{align-items:center;flex-flow:row wrap}.jr-work__location,.jr__date-range{flex-grow:1;text-align:right}}#cookie-consent{animation:fadeIn .75s;background:var(--fg0);border-radius:.2rem;bottom:1rem;box-shadow:0 -.5rem 1rem var(--bg1);color:var(--bg1);font-family:Fira Code,Lucida Console,Monaco,monospace;font-family:var(--font-monospace);left:1rem;padding:1rem;position:fixed;right:1rem;z-index:2000}@media (min-width:768px){#cookie-consent{padding:2.5rem}}#cookie-consent button{background:none;border:none;color:var(--primary);font-size:1.125rem;margin:0 1rem;white-space:nowrap}#cookie-consent button:hover{color:var(--primary-alt);cursor:pointer}.cookie-consent--hidden{display:none}.cli-prompt{display:flex;justify-content:center}.cli-prompt__cursor{animation:blink 1s infinite}@keyframes fadeIn{0%{opacity:0}to{opacity:1}}.social-share{align-items:center;border-top:2px dotted var(--bg1);display:flex;flex-wrap:wrap;gap:.9rem;margin:3rem 0;padding-top:3rem}.social-share svg{fill:var(--fg);height:24px;width:24px}.social-share svg.icon-tabler{fill:none;stroke:var(--fg)}.social-share__item{background:var(--bg1);display:flex;padding:.5rem}</style><link rel=preload href="/css/non-critical.337c8f4cb58340e40be13eb232f89e4e12c02a13f92b6cd3c29a31c1397a0b150922b6cf8f80cd3037768bdcf919626d3205923713ad33f8c502a973337d3d63.css" as=style onload='this.onload=null,this.rel="stylesheet"' integrity="sha512-M3yPTLWDQOQL4T6yMvieThLAKhP5K2zTwpoxwTl6CxUJIrbPj4DNMDd2i9z5GWJtMgWSNxOtM/jFAqlzM309Yw=="><link id=prism-dark rel=preload href=/prism-themes/prism-gruvbox-dark.min.54aecc64074623a4f9898544dcbdab9e804f1560ef0b38f4cf8e10fcaaf72264e798cb407c601aca6ecd833ec4eb93d66535581f18d45ba202cf848b70dbc332.css as=style onload='this.onload=null,this.rel="stylesheet"' integrity="sha512-VK7MZAdGI6T5iYVE3L2rnoBPFWDvCzj0z44Q/Kr3ImTnmMtAfGAaym7Ngz7E65PWZTVYHxjUW6ICz4SLcNvDMg=="><link id=prism-light rel=preload href=/prism-themes/prism-gruvbox-light.min.42a221741efe997fcc94187c39d63c555560678789ac9ca856c74a5f0ddb2aa6c50d38b2ffbecc7a99038cbbd2efa99746e862267f781c559e0cfec10b88a5fc.css as=style onload='this.onload=null,this.rel="stylesheet"' integrity="sha512-QqIhdB7+mX/MlBh8OdY8VVVgZ4eJrJyoVsdKXw3bKqbFDTiy/77MepkDjLvS76mXRuhiJn94HFWeDP7BC4il/A==" disabled><noscript><link rel=stylesheet href=/prism-themes/prism-gruvbox-dark.min.54aecc64074623a4f9898544dcbdab9e804f1560ef0b38f4cf8e10fcaaf72264e798cb407c601aca6ecd833ec4eb93d66535581f18d45ba202cf848b70dbc332.css integrity="sha512-VK7MZAdGI6T5iYVE3L2rnoBPFWDvCzj0z44Q/Kr3ImTnmMtAfGAaym7Ngz7E65PWZTVYHxjUW6ICz4SLcNvDMg=="><link rel=stylesheet href="/css/non-critical.337c8f4cb58340e40be13eb232f89e4e12c02a13f92b6cd3c29a31c1397a0b150922b6cf8f80cd3037768bdcf919626d3205923713ad33f8c502a973337d3d63.css" integrity="sha512-M3yPTLWDQOQL4T6yMvieThLAKhP5K2zTwpoxwTl6CxUJIrbPj4DNMDd2i9z5GWJtMgWSNxOtM/jFAqlzM309Yw=="></noscript><script>(()=>{function n(){if(localStorage&&localStorage.getItem("theme"))return localStorage.getItem("theme");if(window.matchMedia)return window.matchMedia("(prefers-color-scheme: light)").matches?"light":"dark"}function e(e){document.documentElement.setAttribute("data-theme",e);let t=document.getElementById("prism-dark"),n=document.getElementById("prism-light");t.toggleAttribute("disabled",e==="light"),n.toggleAttribute("disabled",e==="dark"),localStorage.setItem("theme",e)}var t=n();t&&e(t);function s(t){let n=t.currentTarget.classList.contains("light--hidden")?"light":"dark";e(n)}document.addEventListener("DOMContentLoaded",function(){document.querySelectorAll(".theme__toggle").forEach(e=>{e.addEventListener("click",s)})})})()</script><link rel=apple-touch-icon sizes=180x180 href=/apple-touch-icon.png><link rel=icon type=image/png sizes=32x32 href=/favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=/favicon-16x16.png><link rel=manifest href=/site.webmanifest><meta name=msapplication-TileColor content="#282828"><meta name=theme-color content="#282828"></head><body><div class=layout><header><a class=logo href=/><div class=logo__text>schnerring.net</div><div class=logo__chevron>></div><div class=logo__cursor>█</div></a><div class=search><input id=search__text type=search placeholder=Search... aria-label=Search autocomplete=off><div id=search__suggestions class=search__suggestions--hidden></div></div><nav id=menu><ul class=menu--horizontal><li class=menu__item><a href=/blog>Blog</a></li><li class=menu__item><a href=/projects>Projects</a></li><li class=menu__item><a href=/about>About</a></li><li class=menu__item><a href=/stats>Stats</a></li></ul><div class=menu__burger><input class=menu__item type=checkbox aria-label="Open main menu"><svg class="icon icon-tabler icon-tabler-menu-2" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M4 6h16"/><path d="M4 12h16"/><path d="M4 18h16"/></svg><ul class=menu--vertical><li><a class=menu__item href=/blog>Blog</a></li><li><a class=menu__item href=/projects>Projects</a></li><li><a class=menu__item href=/about>About</a></li><li><a class=menu__item href=/stats>Stats</a></li></ul></div></nav><button class="theme__toggle light--hidden" aria-label="Toggle light mode">
<svg class="icon icon-tabler icon-tabler-sun" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M12 12m-4 0a4 4 0 108 0 4 4 0 10-8 0"/><path d="M3 12h1m8-9v1m8 8h1m-9 8v1M5.6 5.6l.7.7m12.1-.7-.7.7m0 11.4.7.7m-12.1-.7-.7.7"/></svg>
</button>
<button class="theme__toggle dark--hidden" aria-label="Toggle dark mode"><svg class="icon icon-tabler icon-tabler-moon" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M12 3c.132.0.263.0.393.0a7.5 7.5.0 007.92 12.446A9 9 0 1112 2.992z"/></svg></button></header><main><div class=content><article class=post><div class=post-header><h1>Deploy a Matrix Homeserver to Azure Kubernetes Service (AKS) with Terraform</h1><div class=post-meta><span>2021-05-14</span><span> (updated: 2022-04-22)</span><div class=post-tags><a class=post-tag href=https://schnerring.net/tags/aks>aks</a><a class=post-tag href=https://schnerring.net/tags/azure>azure</a><a class=post-tag href=https://schnerring.net/tags/azure-kubernetes-service>azure&#8209;kubernetes&#8209;service</a><a class=post-tag href=https://schnerring.net/tags/cloud>cloud</a><a class=post-tag href=https://schnerring.net/tags/k8s>k8s</a><a class=post-tag href=https://schnerring.net/tags/kubernetes>kubernetes</a><a class=post-tag href=https://schnerring.net/tags/matrix>matrix</a><a class=post-tag href=https://schnerring.net/tags/self-host>self&#8209;host</a><a class=post-tag href=https://schnerring.net/tags/synapse>synapse</a><a class=post-tag href=https://schnerring.net/tags/terraform>terraform</a></div><img src=/blog/deploy-a-matrix-homeserver-to-azure-kubernetes-service-aks-with-terraform/cover.svg alt></div></div><div class=post-content><p>Did you ever think about running a Matrix homeserver? In this post, we will set one up on the <a href=https://azure.microsoft.com/en-us/services/kubernetes-service/ class=link--external target=_blank rel=noreferrer>Azure Kubernetes Service</a> (AKS). We will use the reference homeserver implementation, which is <a href=https://github.com/matrix-org/synapse/ class=link--external target=_blank rel=noreferrer>Synapse</a> from the folks at <a href=https://matrix.org/ class=link--external target=_blank rel=noreferrer>matrix.org</a>. This post focuses on the Kubernetes stuff, keeping Synapse configuration to a minimum. Things like <a href=https://github.com/matrix-org/synapse/blob/master/docs/federate.md class=link--external target=_blank rel=noreferrer>federation</a>, <a href=https://github.com/matrix-org/synapse/blob/master/docs/delegate.md class=link--external target=_blank rel=noreferrer>delegation</a> and <a href=https://github.com/matrix-org/synapse/blob/master/docs/postgres.md#set-up-database class=link--external target=_blank rel=noreferrer>PostgreSQL</a> are out of scope, because plenty of excellent guides and the official documentation exist covering that. The icing on the cake will be the <a href=https://github.com/Awesome-Technologies/synapse-admin class=link--external target=_blank rel=noreferrer>Synapse Admin UI</a> deployment with secure access to the <a href=https://github.com/matrix-org/synapse/blob/develop/docs/reverse_proxy.md#synapse-administration-endpoints class=link--external target=_blank rel=noreferrer>administration endpoints</a> to make management of our homeserver easier.</p><h2 id=preface>Preface<a href=#preface class=post-heading__anchor aria-hidden=true>#</a></h2><p>Besides some basic knowledge about AKS, Kubernetes, and Terraform, we have to set up a couple of other things before getting started.</p><p>We need an AKS cluster with a configured <a href=https://kubernetes.io/docs/concepts/services-networking/ingress-controllers/ class=link--external target=_blank rel=noreferrer>Ingress Controller</a> to be able to expose our homeserver to the world. I use <a href=https://doc.traefik.io/traefik/ class=link--external target=_blank rel=noreferrer>Traefik 2</a> in combination with its <a href=https://doc.traefik.io/traefik/providers/kubernetes-ingress/ class=link--external target=_blank rel=noreferrer>Kubernetes Ingress</a> implementation.</p><p>Synapse requires valid TLS certificates to work. It <a href=https://github.com/matrix-org/synapse/commit/55f2617f8ce798da4e8ca0fa351db60dc13ef355#diff-fb360161e5a1b576c9029cc93122255ed2d90639274c5744b282f71c68db5963 class=link--external target=_blank rel=noreferrer><del>ships</del> used to ship with functionality</a> to automatically provision <a href=https://letsencrypt.org/ class=link--external target=_blank rel=noreferrer>Let&rsquo;s Encrypt</a> certificates. However, I use <a href=https://cert-manager.io/ class=link--external target=_blank rel=noreferrer>cert-manager</a> as a certificate management solution for all my services. So we skip over that part of the configuration, too.</p><p>The last thing we have to set up is <a href=https://www.terraform.io/ class=link--external target=_blank rel=noreferrer>Terraform</a> with a <a href=https://registry.terraform.io/providers/hashicorp/kubernetes/latest/docs class=link--external target=_blank rel=noreferrer>properly configured <code>kubernetes</code> provider</a>. If you do not want to use Terraform, transforming the code to regular YAML manifests is trivial.</p><p>Depending on your needs, reverse proxy (ingress) functionality and certificate management is the part where your setup differs the most. If you are starting out from scratch, check out <a href=/blog/use-terraform-to-deploy-an-azure-kubernetes-service-aks-cluster-traefik-2-cert-manager-and-lets-encrypt-certificates>my previous post</a>, covering much of the steps required to set up the AKS cluster.</p><h2 id=ingress>Ingress<a href=#ingress class=post-heading__anchor aria-hidden=true>#</a></h2><p>We work from the outside to the inside. The <code>Ingress</code> is what exposes our Kubernetes <code>Service</code> to the public internet. We also add a <code>Namespace</code> for all our Matrix resources to a new Terraform file <code>matrix.tf</code>:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-hcl data-lang=hcl><span style=display:flex><span><span style=color:#66d9ef>resource</span> <span style=color:#e6db74>&#34;kubernetes_namespace&#34; &#34;matrix&#34;</span> {
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>metadata</span> {
</span></span><span style=display:flex><span>    name <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;matrix&#34;</span>
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>resource</span> <span style=color:#e6db74>&#34;kubernetes_ingress_v1&#34; &#34;matrix&#34;</span> {
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>metadata</span> {
</span></span><span style=display:flex><span>    name      <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;matrix-ing&#34;</span>
</span></span><span style=display:flex><span>    namespace <span style=color:#f92672>=</span> <span style=color:#66d9ef>kubernetes_namespace</span>.<span style=color:#66d9ef>matrix</span>.<span style=color:#66d9ef>metadata</span>.<span style=color:#ae81ff>0</span>.<span style=color:#66d9ef>name</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    annotations <span style=color:#f92672>=</span> {
</span></span><span style=display:flex><span>      &#34;cert-manager.io/cluster-issuer&#34;           <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;letsencrypt-staging&#34;</span>
</span></span><span style=display:flex><span>      &#34;traefik.ingress.kubernetes.io/router.tls&#34; <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;true&#34;</span>
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>spec</span> {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>rule</span> {
</span></span><span style=display:flex><span>      host <span style=color:#f92672>=</span> <span style=color:#66d9ef>var</span>.<span style=color:#66d9ef>synapse_server_name</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>http</span> {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>path</span> {
</span></span><span style=display:flex><span>          path <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;/_matrix&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>          <span style=color:#66d9ef>backend</span> {
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>service</span> {
</span></span><span style=display:flex><span>              name <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;matrix-svc&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>              <span style=color:#66d9ef>port</span> {
</span></span><span style=display:flex><span>                number <span style=color:#f92672>=</span> <span style=color:#ae81ff>8008</span>
</span></span><span style=display:flex><span>              }
</span></span><span style=display:flex><span>            }
</span></span><span style=display:flex><span>          }
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>path</span> {
</span></span><span style=display:flex><span>          path <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;/_synapse/client&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>          <span style=color:#66d9ef>backend</span> {
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>service</span> {
</span></span><span style=display:flex><span>              name <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;matrix-svc&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>              <span style=color:#66d9ef>port</span> {
</span></span><span style=display:flex><span>                number <span style=color:#f92672>=</span> <span style=color:#ae81ff>8008</span>
</span></span><span style=display:flex><span>              }
</span></span><span style=display:flex><span>            }
</span></span><span style=display:flex><span>          }
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>path</span> {
</span></span><span style=display:flex><span>          path <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;/&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>          <span style=color:#66d9ef>backend</span> {
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>service</span> {
</span></span><span style=display:flex><span>              name <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;matrix-admin-svc&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>              <span style=color:#66d9ef>port</span> {
</span></span><span style=display:flex><span>                number <span style=color:#f92672>=</span> <span style=color:#ae81ff>8080</span>
</span></span><span style=display:flex><span>              }
</span></span><span style=display:flex><span>            }
</span></span><span style=display:flex><span>          }
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>      }
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>tls</span> {
</span></span><span style=display:flex><span>      secret_name <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;matrix-tls-secret&#34;</span>
</span></span><span style=display:flex><span>      hosts       <span style=color:#f92672>=</span> [<span style=color:#66d9ef>var</span>.<span style=color:#66d9ef>synapse_server_name</span>]
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>To route external traffic to the Synapse <code>Service</code> (<code>matrix-svc</code>), we set up the <code>/_matrix</code> and <code>/_synapse/client</code> endpoints according to the <a href=https://github.com/matrix-org/synapse/blob/develop/docs/reverse_proxy.md class=link--external target=_blank rel=noreferrer>official reverse proxy documentation</a>. The <code>/</code> endpoint routes traffic to the Synapse Admin UI (<code>matrix-admin-svc</code>). We do <strong>NOT</strong> expose the <code>/_synapse/admin</code> endpoint. We will look at how to access this endpoint at the end of this post.</p><p>After we finish testing, we must change the certificate issuer from <code>letsencrypt-staging</code> to <code>letsencrypt-production</code>. Later on, we will also define the <code>var.synapse_server_name</code> Terraform input variable.</p><h2 id=services>Services<a href=#services class=post-heading__anchor aria-hidden=true>#</a></h2><p><code>Service</code>s expose our Synapse and Synapse Admin UI deployments as network services inside our Kubernetes cluster:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-hcl data-lang=hcl><span style=display:flex><span><span style=color:#66d9ef>resource</span> <span style=color:#e6db74>&#34;kubernetes_service&#34; &#34;matrix&#34;</span> {
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>metadata</span> {
</span></span><span style=display:flex><span>    name      <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;matrix-svc&#34;</span>
</span></span><span style=display:flex><span>    namespace <span style=color:#f92672>=</span> <span style=color:#66d9ef>kubernetes_namespace</span>.<span style=color:#66d9ef>matrix</span>.<span style=color:#66d9ef>metadata</span>.<span style=color:#ae81ff>0</span>.<span style=color:#66d9ef>name</span>
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>spec</span> {
</span></span><span style=display:flex><span>    selector <span style=color:#f92672>=</span> {
</span></span><span style=display:flex><span>      &#34;app&#34; <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;matrix&#34;</span>
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>port</span> {
</span></span><span style=display:flex><span>      port        <span style=color:#f92672>=</span> <span style=color:#ae81ff>8008</span>
</span></span><span style=display:flex><span>      target_port <span style=color:#f92672>=</span> <span style=color:#ae81ff>8008</span>
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>resource</span> <span style=color:#e6db74>&#34;kubernetes_service&#34; &#34;matrix_admin&#34;</span> {
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>metadata</span> {
</span></span><span style=display:flex><span>    name      <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;matrix-admin-svc&#34;</span>
</span></span><span style=display:flex><span>    namespace <span style=color:#f92672>=</span> <span style=color:#66d9ef>kubernetes_namespace</span>.<span style=color:#66d9ef>matrix</span>.<span style=color:#66d9ef>metadata</span>.<span style=color:#ae81ff>0</span>.<span style=color:#66d9ef>name</span>
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>spec</span> {
</span></span><span style=display:flex><span>    selector <span style=color:#f92672>=</span> {
</span></span><span style=display:flex><span>      &#34;app&#34; <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;matrix-admin&#34;</span>
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>port</span> {
</span></span><span style=display:flex><span>      port        <span style=color:#f92672>=</span> <span style=color:#ae81ff>8080</span>
</span></span><span style=display:flex><span>      target_port <span style=color:#f92672>=</span> <span style=color:#ae81ff>80</span>
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>Pretty self-explanatory. We map the service ports to container ports of the deployments that we add in a later step.</p><h2 id=configuration-files>Configuration Files<a href=#configuration-files class=post-heading__anchor aria-hidden=true>#</a></h2><p>Before adding the deployment to our cluster, we generate the initial configuration files for Synapse:</p><ul><li><code>homeserver.yaml</code>: Synapse configuration</li><li><code>matrix.schnerring.net.log.config</code>: logging configuration</li><li><code>matrix.schnerring.net.signature.key</code>: the key, Synapse signs messages with</li></ul><p>We can do that with the <code>generate</code> command which is part of Synapse:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl run matrix-generate-pod <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>  --stdin <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>  --rm <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>  --restart<span style=color:#f92672>=</span>Never <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>  --command<span style=color:#f92672>=</span>true <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>  --image matrixdotorg/synapse:latest <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>  --env<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;SYNAPSE_REPORT_STATS=yes&#34;</span> <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>  --env<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;SYNAPSE_SERVER_NAME=matrix.schnerring.net&#34;</span> <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>  -- bash -c <span style=color:#e6db74>&#34;/start.py generate &amp;&amp; sleep 300&#34;</span>
</span></span></code></pre></div><p>This command creates a pod, runs <code>generate</code>, <code>sleep</code>s for 300 seconds, and then cleans itself up. Five minutes should be enough time to copy the generated files from the container before it terminates. The following command copies the entire <code>/data</code> directory from the container to a local <code>synapse-config</code> directory:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl cp matrix-generate-pod:/data synapse-config
</span></span></code></pre></div><p>We then store the three configuration files as <code>Secret</code> on the cluster. But before, make sure to change the value of <code>handlers.file.filename</code> from <code>/homeserver.log</code> to <code>/data/homeserver.log</code> inside the <code>*.log.config</code> file. Otherwise, you will run into <a href=https://github.com/matrix-org/synapse/issues/9970 class=link--external target=_blank rel=noreferrer>a permission issue caused by the default logger configuration</a> that I discovered.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-hcl data-lang=hcl><span style=display:flex><span><span style=color:#66d9ef>locals</span> {
</span></span><span style=display:flex><span>  synapse_log_config       <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;/data/${var.synapse_server_name}.log.config&#34;</span>
</span></span><span style=display:flex><span>  synapse_signing_key_path <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;/data/${var.synapse_server_name}.signing.key&#34;</span>
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>resource</span> <span style=color:#e6db74>&#34;kubernetes_secret&#34; &#34;matrix&#34;</span> {
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>metadata</span> {
</span></span><span style=display:flex><span>    name      <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;matrix-secret&#34;</span>
</span></span><span style=display:flex><span>    namespace <span style=color:#f92672>=</span> <span style=color:#66d9ef>kubernetes_namespace</span>.<span style=color:#66d9ef>matrix</span>.<span style=color:#66d9ef>metadata</span>.<span style=color:#ae81ff>0</span>.<span style=color:#66d9ef>name</span>
</span></span><span style=display:flex><span>  }<span style=color:#75715e>
</span></span></span><span style=display:flex><span><span style=color:#75715e>
</span></span></span><span style=display:flex><span><span style=color:#75715e>  # See also: https://github.com/matrix-org/synapse/blob/master/docker/README.md#generating-a-configuration-file
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>  data <span style=color:#f92672>=</span> {
</span></span><span style=display:flex><span>    &#34;homeserver.yaml&#34; <span style=color:#f92672>=</span> <span style=color:#66d9ef>templatefile</span>(
</span></span><span style=display:flex><span>      <span style=color:#e6db74>&#34;${path.module}/synapse-config/homeserver.tpl.yaml&#34;</span>,
</span></span><span style=display:flex><span>      {
</span></span><span style=display:flex><span>        &#34;server_name&#34;                <span style=color:#f92672>=</span> <span style=color:#66d9ef>var</span>.<span style=color:#66d9ef>synapse_server_name</span>
</span></span><span style=display:flex><span>        &#34;report_stats&#34;               <span style=color:#f92672>=</span> <span style=color:#66d9ef>var</span>.<span style=color:#66d9ef>synapse_report_stats</span>
</span></span><span style=display:flex><span>        &#34;log_config&#34;                 <span style=color:#f92672>=</span> <span style=color:#66d9ef>local</span>.<span style=color:#66d9ef>synapse_log_config</span>
</span></span><span style=display:flex><span>        &#34;signing_key_path&#34;           <span style=color:#f92672>=</span> <span style=color:#66d9ef>local</span>.<span style=color:#66d9ef>synapse_signing_key_path</span>
</span></span><span style=display:flex><span>        &#34;registration_shared_secret&#34; <span style=color:#f92672>=</span> <span style=color:#66d9ef>var</span>.<span style=color:#66d9ef>synapse_registration_shared_secret</span>
</span></span><span style=display:flex><span>        &#34;macaroon_secret_key&#34;        <span style=color:#f92672>=</span> <span style=color:#66d9ef>var</span>.<span style=color:#66d9ef>synapse_macaroon_secret_key</span>
</span></span><span style=display:flex><span>        &#34;form_secret&#34;                <span style=color:#f92672>=</span> <span style=color:#66d9ef>var</span>.<span style=color:#66d9ef>synapse_form_secret</span>
</span></span><span style=display:flex><span>      }
</span></span><span style=display:flex><span>    )
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    &#34;log.config&#34; <span style=color:#f92672>=</span> <span style=color:#66d9ef>templatefile</span>(
</span></span><span style=display:flex><span>      <span style=color:#e6db74>&#34;${path.module}/synapse-config/log.tpl.config&#34;</span>,
</span></span><span style=display:flex><span>      {
</span></span><span style=display:flex><span>        &#34;log_filename&#34; <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;/data/homeserver.log&#34;</span>
</span></span><span style=display:flex><span>        &#34;log_level&#34;    <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;INFO&#34;</span>
</span></span><span style=display:flex><span>      }
</span></span><span style=display:flex><span>    )
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    &#34;signing.key&#34; <span style=color:#f92672>=</span> <span style=color:#66d9ef>var</span>.<span style=color:#66d9ef>synapse_signing_key</span>
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>To protect the signing key and the secrets contained inside the <code>homeserver.yaml</code> file, we use the Terraform <a href=https://www.terraform.io/docs/language/functions/templatefile.html class=link--external target=_blank rel=noreferrer><code>templatefile()</code></a> function, which allows us to put variable placeholders into the configuration files that are interpolated during <code>terraform apply</code>. This way, we can commit the configuration files to source control securely. To denote the files as template files, we change the file names to <code>homeserver.tpl.yaml</code> and <code>log.tpl.config</code>. Here is an example of how to define interpolation sequences inside <code>homeserver.yaml</code>:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#f92672>server_name</span>: <span style=color:#e6db74>&#34;${server_name}&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># ...</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># a secret which is used to sign access tokens. If none is specified,</span>
</span></span><span style=display:flex><span><span style=color:#75715e># the registration_shared_secret is used, if one is given; otherwise,</span>
</span></span><span style=display:flex><span><span style=color:#75715e># a secret key is derived from the signing key.</span>
</span></span><span style=display:flex><span><span style=color:#75715e>#</span>
</span></span><span style=display:flex><span><span style=color:#f92672>macaroon_secret_key</span>: <span style=color:#e6db74>&#34;${macaroon_secret_key}&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># a secret which is used to calculate HMACs for form values, to stop</span>
</span></span><span style=display:flex><span><span style=color:#75715e># falsification of values. Must be specified for the User Consent</span>
</span></span><span style=display:flex><span><span style=color:#75715e># forms to work.</span>
</span></span><span style=display:flex><span><span style=color:#75715e>#</span>
</span></span><span style=display:flex><span><span style=color:#f92672>form_secret</span>: <span style=color:#e6db74>&#34;${form_secret}&#34;</span>
</span></span></code></pre></div><p>Of course, you can also check out the <a href=https://github.com/schnerring/infrastructure-core/tree/v0.3.0/synapse-config class=link--external target=_blank rel=noreferrer>config file templates on my GitHub</a>.</p><p>To find the values inside the huge <code>homeserver.yaml</code> file, we use the following regular expression. It matches any line that is not a comment or whitespace:</p><pre tabindex=0><code class=language-regexp data-lang=regexp>^(?!^\s*#)^(?!\n).*
</code></pre><p>All we have to do now is define the <a href=https://www.terraform.io/docs/language/values/variables.html class=link--external target=_blank rel=noreferrer>Terraform input variables</a> and set them to the values we originally generated:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-hcl data-lang=hcl><span style=display:flex><span><span style=color:#66d9ef>variable</span> <span style=color:#e6db74>&#34;synapse_image_version&#34;</span> {
</span></span><span style=display:flex><span>  type        <span style=color:#f92672>=</span> <span style=color:#66d9ef>string</span>
</span></span><span style=display:flex><span>  description <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;Synapse image version.&#34;</span>
</span></span><span style=display:flex><span>  default     <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;v1.33.2&#34;</span>
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>variable</span> <span style=color:#e6db74>&#34;synapse_server_name&#34;</span> {
</span></span><span style=display:flex><span>  type        <span style=color:#f92672>=</span> <span style=color:#66d9ef>string</span>
</span></span><span style=display:flex><span>  description <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;Public Synapse hostname.&#34;</span>
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>variable</span> <span style=color:#e6db74>&#34;synapse_report_stats&#34;</span> {
</span></span><span style=display:flex><span>  type        <span style=color:#f92672>=</span> <span style=color:#66d9ef>bool</span>
</span></span><span style=display:flex><span>  description <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;Enable anonymous statistics reporting.&#34;</span>
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>variable</span> <span style=color:#e6db74>&#34;synapse_signing_key&#34;</span> {
</span></span><span style=display:flex><span>  type        <span style=color:#f92672>=</span> <span style=color:#66d9ef>string</span>
</span></span><span style=display:flex><span>  description <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;Signing key Synapse signs messages with.&#34;</span>
</span></span><span style=display:flex><span>  sensitive   <span style=color:#f92672>=</span> <span style=color:#66d9ef>true</span>
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>variable</span> <span style=color:#e6db74>&#34;synapse_registration_shared_secret&#34;</span> {
</span></span><span style=display:flex><span>  type        <span style=color:#f92672>=</span> <span style=color:#66d9ef>string</span>
</span></span><span style=display:flex><span>  description <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;Allows registration of standard or admin accounts by anyone who has the shared secret.&#34;</span>
</span></span><span style=display:flex><span>  sensitive   <span style=color:#f92672>=</span> <span style=color:#66d9ef>true</span>
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>variable</span> <span style=color:#e6db74>&#34;synapse_macaroon_secret_key&#34;</span> {
</span></span><span style=display:flex><span>  type        <span style=color:#f92672>=</span> <span style=color:#66d9ef>string</span>
</span></span><span style=display:flex><span>  description <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;Secret which is used to sign access tokens.&#34;</span>
</span></span><span style=display:flex><span>  sensitive   <span style=color:#f92672>=</span> <span style=color:#66d9ef>true</span>
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>variable</span> <span style=color:#e6db74>&#34;synapse_form_secret&#34;</span> {
</span></span><span style=display:flex><span>  type        <span style=color:#f92672>=</span> <span style=color:#66d9ef>string</span>
</span></span><span style=display:flex><span>  description <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;Secret which is used to calculate HMACs for form values.&#34;</span>
</span></span><span style=display:flex><span>  sensitive   <span style=color:#f92672>=</span> <span style=color:#66d9ef>true</span>
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><h2 id=persistent-volume-claim>Persistent Volume Claim<a href=#persistent-volume-claim class=post-heading__anchor aria-hidden=true>#</a></h2><p>To be able to persist media, we create a <a href=https://kubernetes.io/docs/concepts/storage/persistent-volumes/#persistentvolumeclaims class=link--external target=_blank rel=noreferrer><code>PersistentVolumeClaim</code></a> (PVC):</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-hcl data-lang=hcl><span style=display:flex><span><span style=color:#66d9ef>resource</span> <span style=color:#e6db74>&#34;kubernetes_persistent_volume_claim&#34; &#34;matrix&#34;</span> {
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>metadata</span> {
</span></span><span style=display:flex><span>    name      <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;matrix-pvc&#34;</span>
</span></span><span style=display:flex><span>    namespace <span style=color:#f92672>=</span> <span style=color:#66d9ef>kubernetes_namespace</span>.<span style=color:#66d9ef>matrix</span>.<span style=color:#66d9ef>metadata</span>.<span style=color:#ae81ff>0</span>.<span style=color:#66d9ef>name</span>
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>spec</span> {
</span></span><span style=display:flex><span>    access_modes <span style=color:#f92672>=</span> [<span style=color:#e6db74>&#34;ReadWriteOnce&#34;</span>]
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>resources</span> {
</span></span><span style=display:flex><span>      requests <span style=color:#f92672>=</span> {
</span></span><span style=display:flex><span>        &#34;storage&#34; <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;4Gi&#34;</span>
</span></span><span style=display:flex><span>      }
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>Note that the <code>default</code> AKS <a href=https://kubernetes.io/docs/concepts/storage/storage-classes/ class=link--external target=_blank rel=noreferrer><code>StorageClass</code></a> has the <code>ReclaimPolicy</code> set to <code>Delete</code> . I recommend defining a custom storage class for production. Setting its reclaim policy to <code>Retain</code> makes accidentally purging the media PVC much harder.</p><h2 id=synapse>Synapse<a href=#synapse class=post-heading__anchor aria-hidden=true>#</a></h2><p>Let us finally deploy Synapse. We just need to mount the configuration files and the PVC we just defined:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-hcl data-lang=hcl><span style=display:flex><span><span style=color:#66d9ef>resource</span> <span style=color:#e6db74>&#34;kubernetes_deployment&#34; &#34;matrix&#34;</span> {
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>metadata</span> {
</span></span><span style=display:flex><span>    name      <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;matrix-deploy&#34;</span>
</span></span><span style=display:flex><span>    namespace <span style=color:#f92672>=</span> <span style=color:#66d9ef>kubernetes_namespace</span>.<span style=color:#66d9ef>matrix</span>.<span style=color:#66d9ef>metadata</span>.<span style=color:#ae81ff>0</span>.<span style=color:#66d9ef>name</span>
</span></span><span style=display:flex><span>    labels <span style=color:#f92672>=</span> {
</span></span><span style=display:flex><span>      &#34;app&#34; <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;matrix&#34;</span>
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>spec</span> {
</span></span><span style=display:flex><span>    replicas <span style=color:#f92672>=</span> <span style=color:#ae81ff>1</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>selector</span> {
</span></span><span style=display:flex><span>      match_labels <span style=color:#f92672>=</span> {
</span></span><span style=display:flex><span>        &#34;app&#34; <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;matrix&#34;</span>
</span></span><span style=display:flex><span>      }
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>strategy</span> {
</span></span><span style=display:flex><span>      type <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;Recreate&#34;</span>
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>template</span> {
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>metadata</span> {
</span></span><span style=display:flex><span>        labels <span style=color:#f92672>=</span> {
</span></span><span style=display:flex><span>          &#34;app&#34; <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;matrix&#34;</span>
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>      }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>spec</span> {
</span></span><span style=display:flex><span>        hostname       <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;matrix&#34;</span>
</span></span><span style=display:flex><span>        restart_policy <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;Always&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>security_context</span> {
</span></span><span style=display:flex><span>          run_as_user     <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;991&#34;</span>
</span></span><span style=display:flex><span>          run_as_group    <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;991&#34;</span>
</span></span><span style=display:flex><span>          fs_group        <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;991&#34;</span>
</span></span><span style=display:flex><span>          run_as_non_root <span style=color:#f92672>=</span> <span style=color:#66d9ef>true</span>
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>container</span> {
</span></span><span style=display:flex><span>          name  <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;synapse&#34;</span>
</span></span><span style=display:flex><span>          image <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;matrixdotorg/synapse:${var.synapse_image_version}&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>          <span style=color:#66d9ef>security_context</span> {
</span></span><span style=display:flex><span>            read_only_root_filesystem <span style=color:#f92672>=</span> <span style=color:#66d9ef>true</span>
</span></span><span style=display:flex><span>          }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>          <span style=color:#66d9ef>port</span> {
</span></span><span style=display:flex><span>            container_port <span style=color:#f92672>=</span> <span style=color:#ae81ff>8008</span>
</span></span><span style=display:flex><span>          }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>          <span style=color:#66d9ef>volume_mount</span> {
</span></span><span style=display:flex><span>            mount_path <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;/data&#34;</span>
</span></span><span style=display:flex><span>            name       <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;data-vol&#34;</span>
</span></span><span style=display:flex><span>          }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>          <span style=color:#66d9ef>volume_mount</span> {
</span></span><span style=display:flex><span>            name       <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;secret-vol&#34;</span>
</span></span><span style=display:flex><span>            mount_path <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;/data/homeserver.yaml&#34;</span>
</span></span><span style=display:flex><span>            sub_path   <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;homeserver.yaml&#34;</span>
</span></span><span style=display:flex><span>            read_only  <span style=color:#f92672>=</span> <span style=color:#66d9ef>true</span>
</span></span><span style=display:flex><span>          }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>          <span style=color:#66d9ef>volume_mount</span> {
</span></span><span style=display:flex><span>            name       <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;secret-vol&#34;</span>
</span></span><span style=display:flex><span>            mount_path <span style=color:#f92672>=</span> <span style=color:#66d9ef>local</span>.<span style=color:#66d9ef>synapse_log_config</span>
</span></span><span style=display:flex><span>            sub_path   <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;log.config&#34;</span>
</span></span><span style=display:flex><span>            read_only  <span style=color:#f92672>=</span> <span style=color:#66d9ef>true</span>
</span></span><span style=display:flex><span>          }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>          <span style=color:#66d9ef>volume_mount</span> {
</span></span><span style=display:flex><span>            name       <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;secret-vol&#34;</span>
</span></span><span style=display:flex><span>            mount_path <span style=color:#f92672>=</span> <span style=color:#66d9ef>local</span>.<span style=color:#66d9ef>synapse_signing_key_path</span>
</span></span><span style=display:flex><span>            sub_path   <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;signing.key&#34;</span>
</span></span><span style=display:flex><span>            read_only  <span style=color:#f92672>=</span> <span style=color:#66d9ef>true</span>
</span></span><span style=display:flex><span>          }
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>volume</span> {
</span></span><span style=display:flex><span>          name <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;data-vol&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>          <span style=color:#66d9ef>persistent_volume_claim</span> {
</span></span><span style=display:flex><span>            claim_name <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;matrix-pvc&#34;</span>
</span></span><span style=display:flex><span>          }
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>volume</span> {
</span></span><span style=display:flex><span>          name <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;secret-vol&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>          <span style=color:#66d9ef>secret</span> {
</span></span><span style=display:flex><span>            secret_name <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;matrix-secret&#34;</span>
</span></span><span style=display:flex><span>          }
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>      }
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>It is good practice to lock down the container by making the root filesystem read-only, if possible. We also run the container as the <code>991</code> user and group, respectively, the <a href=https://github.com/matrix-org/synapse/blob/e550ab17adc8dd3c48daf7fedcd09418a73f524b/docker/start.py#L184-L185 class=link--external target=_blank rel=noreferrer>default user used by Synapse</a>.</p><p>To deploy everything, we run the following commands:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>terraform plan -out infrastructure.tfplan
</span></span><span style=display:flex><span>terraform apply infrastructure.tfplan
</span></span></code></pre></div><p>After the deployment succeeds, do not forget to change the cluster issuer to <code>letsencrypt-production</code> and <code>terraform apply</code> again.</p><p>Next, we <a href=https://github.com/matrix-org/synapse/blob/5688a74cf3042c0064e3600cb03f6edaa7f7c838/INSTALL.md#registering-a-user class=link--external target=_blank rel=noreferrer>register a new user</a>. Synapse includes the <code>register_new_matrix_user</code> command. First, we query the name of the pod:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl get pods --namespace matrix
</span></span></code></pre></div><p>We then run the following to connect to the pod:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl exec --stdin --tty --namespace matrix matrix-deploy-xxxxxxxxxx-xxxxx -- bash
</span></span></code></pre></div><p>Now we register the user:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>register_new_matrix_user <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>  --admin <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>  --user michael <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>  --config /data/homeserver.yaml <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>  http://localhost:8008
</span></span></code></pre></div><p>We use <a href=https://element.io/ class=link--external target=_blank rel=noreferrer>Element</a> or any other Matrix client and sign in. Great!</p><h2 id=synapse-admin-ui>Synapse Admin UI<a href=#synapse-admin-ui class=post-heading__anchor aria-hidden=true>#</a></h2><p>The Synapse API includes administration endpoints but lacks a UI for administration tasks. There is an <a href=https://github.com/matrix-org/synapse/issues/2032 class=link--external target=_blank rel=noreferrer>open GitHub issue</a> which seems to be inactive. However, <a href=https://github.com/Awesome-Technologies/synapse-admin class=link--external target=_blank rel=noreferrer>awesometechnologies/synapse-admin</a> is being actively developed and works well.</p><p>We already configured the ingress to route traffic to the <code>matrix-admin-svc</code>, so the only thing missing is the deployment:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-hcl data-lang=hcl><span style=display:flex><span><span style=color:#66d9ef>resource</span> <span style=color:#e6db74>&#34;kubernetes_deployment&#34; &#34;matrix_admin&#34;</span> {
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>metadata</span> {
</span></span><span style=display:flex><span>    name      <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;matrix-admin-deploy&#34;</span>
</span></span><span style=display:flex><span>    namespace <span style=color:#f92672>=</span> <span style=color:#66d9ef>kubernetes_namespace</span>.<span style=color:#66d9ef>matrix</span>.<span style=color:#66d9ef>metadata</span>.<span style=color:#ae81ff>0</span>.<span style=color:#66d9ef>name</span>
</span></span><span style=display:flex><span>    labels <span style=color:#f92672>=</span> {
</span></span><span style=display:flex><span>      &#34;app&#34; <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;matrix-admin&#34;</span>
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>spec</span> {
</span></span><span style=display:flex><span>    replicas <span style=color:#f92672>=</span> <span style=color:#ae81ff>1</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>selector</span> {
</span></span><span style=display:flex><span>      match_labels <span style=color:#f92672>=</span> {
</span></span><span style=display:flex><span>        &#34;app&#34; <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;matrix-admin&#34;</span>
</span></span><span style=display:flex><span>      }
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>strategy</span> {
</span></span><span style=display:flex><span>      type <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;Recreate&#34;</span>
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>template</span> {
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>metadata</span> {
</span></span><span style=display:flex><span>        labels <span style=color:#f92672>=</span> {
</span></span><span style=display:flex><span>          &#34;app&#34; <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;matrix-admin&#34;</span>
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>      }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>spec</span> {
</span></span><span style=display:flex><span>        hostname       <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;matrix-admin&#34;</span>
</span></span><span style=display:flex><span>        restart_policy <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;Always&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>container</span> {
</span></span><span style=display:flex><span>          name  <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;synapse-admin&#34;</span>
</span></span><span style=display:flex><span>          image <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;awesometechnologies/synapse-admin:latest&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>          <span style=color:#66d9ef>port</span> {
</span></span><span style=display:flex><span>            container_port <span style=color:#f92672>=</span> <span style=color:#ae81ff>80</span>
</span></span><span style=display:flex><span>          }
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>      }
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>No configuration is required because the Admin UI is a client-side application. After running <code>terraform apply</code>, we can browse to <code>matrix.schnerring.net</code> to access the app:</p><p><picture><source type=image/webp srcset="/blog/deploy-a-matrix-homeserver-to-azure-kubernetes-service-aks-with-terraform/admin-ui-login_hu397499082509692493.webp 300w,/blog/deploy-a-matrix-homeserver-to-azure-kubernetes-service-aks-with-terraform/admin-ui-login_hu13153871563204941383.webp 500w,/blog/deploy-a-matrix-homeserver-to-azure-kubernetes-service-aks-with-terraform/admin-ui-login_hu5112511607969151886.webp 501w" sizes="(max-width: 499px) 300px,(max-width: 699px) 500px,501px"><img src=/blog/deploy-a-matrix-homeserver-to-azure-kubernetes-service-aks-with-terraform/admin-ui-login.png srcset="/blog/deploy-a-matrix-homeserver-to-azure-kubernetes-service-aks-with-terraform/admin-ui-login_hu6766590887082031324.png 300w,/blog/deploy-a-matrix-homeserver-to-azure-kubernetes-service-aks-with-terraform/admin-ui-login_hu8572344259356199173.png 500w,/blog/deploy-a-matrix-homeserver-to-azure-kubernetes-service-aks-with-terraform/admin-ui-login_hu14272842193850635607.png 501w" sizes="(max-width: 499px) 300px,(max-width: 699px) 500px,501px" alt="Synapse Admin UI Login" loading=lazy width=501 height=543></picture></p><p>Synapse Admin UI requires access to the <code>_synapse/admin</code> endpoint. But we do not want to expose that endpoint to the public internet, so we have to connect to it by other means. <code>kubectl port-forward</code> allows us to securely forward a local port to a port on a Kubernetes service:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl port-forward service/matrix-svc --namespace matrix 8008:8008
</span></span></code></pre></div><p>We can now enter <code>http://localhost:8008</code> as homeserver URL and login to the admin UI with the user we created earlier:</p><p><picture><source type=image/webp srcset="/blog/deploy-a-matrix-homeserver-to-azure-kubernetes-service-aks-with-terraform/admin-ui-users_hu15773994833118332911.webp 300w,/blog/deploy-a-matrix-homeserver-to-azure-kubernetes-service-aks-with-terraform/admin-ui-users_hu785211056436679620.webp 500w,/blog/deploy-a-matrix-homeserver-to-azure-kubernetes-service-aks-with-terraform/admin-ui-users_hu9771446565920229338.webp 700w" sizes="(max-width: 499px) 300px,(max-width: 699px) 500px,700px"><img src=/blog/deploy-a-matrix-homeserver-to-azure-kubernetes-service-aks-with-terraform/admin-ui-users.png srcset="/blog/deploy-a-matrix-homeserver-to-azure-kubernetes-service-aks-with-terraform/admin-ui-users_hu5370482025619465707.png 300w,/blog/deploy-a-matrix-homeserver-to-azure-kubernetes-service-aks-with-terraform/admin-ui-users_hu6841835502586580951.png 500w,/blog/deploy-a-matrix-homeserver-to-azure-kubernetes-service-aks-with-terraform/admin-ui-users_hu18217046273657818045.png 700w" sizes="(max-width: 499px) 300px,(max-width: 699px) 500px,700px" alt="Synapse Admin UI Users" loading=lazy width=1283 height=292></picture></p><h2 id=whats-next>What&rsquo;s Next?<a href=#whats-next class=post-heading__anchor aria-hidden=true>#</a></h2><p>Regardless of what you plan on doing with your homeserver, replacing SQLite with PostgreSQL should be at the top of the priority list. Other than that, there is tons of other stuff to configure depending on your needs.</p><p>I am super happy with what we have built and curious about what you think. I would appreciate it if you shared your opinion in the comments below.</p></div><div class=social-share><strong class=social-share__heading>Share this post: </strong><a class=social-share__item href="https://x.com/intent/post?url=https%3A%2F%2Fschnerring.net%2Fblog%2Fdeploy-a-matrix-homeserver-to-azure-kubernetes-service-aks-with-terraform%2F&amp;text=Deploy+a+Matrix+Homeserver+to+Azure+Kubernetes+Service+%28AKS%29+with+Terraform" target=_blank rel=noreferrer><svg role="img" viewBox="0 0 24 24"><title>X</title><path d="M18.901 1.153h3.68l-8.04 9.19L24 22.846h-7.406l-5.8-7.584-6.638 7.584H.474l8.6-9.83L0 1.154h7.594l5.243 6.932zM17.61 20.644h2.039L6.486 3.24H4.298z"/></svg>
</a><a class=social-share__item href="https://www.linkedin.com/sharing/share-offsite/?url=https%3A%2F%2Fschnerring.net%2Fblog%2Fdeploy-a-matrix-homeserver-to-azure-kubernetes-service-aks-with-terraform%2F" target=_blank rel=noreferrer><svg role="img" viewBox="0 0 24 24"><title>LinkedIn</title><path d="M20.447 20.452h-3.554v-5.569c0-1.328-.027-3.037-1.852-3.037-1.853.0-2.136 1.445-2.136 2.939v5.667H9.351V9h3.414v1.561h.046c.477-.9 1.637-1.85 3.37-1.85 3.601.0 4.267 2.37 4.267 5.455v6.286zM5.337 7.433c-1.144.0-2.063-.926-2.063-2.065.0-1.138.92-2.063 2.063-2.063 1.14.0 2.064.925 2.064 2.063.0 1.139-.925 2.065-2.064 2.065zm1.782 13.019H3.555V9h3.564v11.452zM22.225.0H1.771C.792.0.0.774.0 1.729v20.542C0 23.227.792 24 1.771 24h20.451C23.2 24 24 23.227 24 22.271V1.729C24 .774 23.2.0 22.222.0h.003z"/></svg>
</a><a class=social-share__item href="https://www.facebook.com/sharer.php?u=https%3A%2F%2Fschnerring.net%2Fblog%2Fdeploy-a-matrix-homeserver-to-azure-kubernetes-service-aks-with-terraform%2F" target=_blank rel=noreferrer><svg role="img" viewBox="0 0 24 24"><title>Facebook</title><path d="M9.101 23.691v-7.98H6.627v-3.667h2.474v-1.58c0-4.085 1.848-5.978 5.858-5.978.401.0.955.042 1.468.103a8.68 8.68.0 011.141.195v3.325a8.623 8.623.0 00-.653-.036 26.805 26.805.0 00-.733-.009c-.707.0-1.259.096-1.675.309a1.686 1.686.0 00-.679.622c-.258.42-.374.995-.374 1.752v1.297h3.919l-.386 2.103-.287 1.564h-3.246v8.245C19.396 23.238 24 18.179 24 12.044c0-6.627-5.373-12-12-12s-12 5.373-12 12c0 5.628 3.874 10.35 9.101 11.647z"/></svg>
</a><a class=social-share__item href="https://reddit.com/submit?url=https%3A%2F%2Fschnerring.net%2Fblog%2Fdeploy-a-matrix-homeserver-to-azure-kubernetes-service-aks-with-terraform%2F&amp;title=Deploy+a+Matrix+Homeserver+to+Azure+Kubernetes+Service+%28AKS%29+with+Terraform" target=_blank rel=noreferrer><svg role="img" viewBox="0 0 24 24"><title>Reddit</title><path d="M12 0C5.373.0.0 5.373.0 12c0 3.314 1.343 6.314 3.515 8.485l-2.286 2.286C.775 23.225 1.097 24 1.738 24H12c6.627.0 12-5.373 12-12S18.627.0 12 0zm4.388 3.199c1.104.0 1.999.895 1.999 1.999.0 1.105-.895 2-1.999 2-.946.0-1.739-.657-1.947-1.539v.002c-1.147.162-2.032 1.15-2.032 2.341v.007c1.776.067 3.4.567 4.686 1.363.473-.363 1.064-.58 1.707-.58 1.547.0 2.802 1.254 2.802 2.802.0 1.117-.655 2.081-1.601 2.531-.088 3.256-3.637 5.876-7.997 5.876-4.361.0-7.905-2.617-7.998-5.87-.954-.447-1.614-1.415-1.614-2.538.0-1.548 1.255-2.802 2.803-2.802.645.0 1.239.218 1.712.585 1.275-.79 2.881-1.291 4.64-1.365v-.01c0-1.663 1.263-3.034 2.88-3.207.188-.911.993-1.595 1.959-1.595zm-8.085 8.376c-.784.0-1.459.78-1.506 1.797-.047 1.016.64 1.429 1.426 1.429s1.371-.369 1.418-1.385c.047-1.017-.553-1.841-1.338-1.841zm7.406.0c-.786.0-1.385.824-1.338 1.841.047 1.017.634 1.385 1.418 1.385.785.0 1.473-.413 1.426-1.429-.046-1.017-.721-1.797-1.506-1.797zm-3.703 4.013c-.974.0-1.907.048-2.77.135-.147.015-.241.168-.183.305.483 1.154 1.622 1.964 2.953 1.964 1.33.0 2.47-.81 2.953-1.964.057-.137-.037-.29-.184-.305-.863-.087-1.795-.135-2.769-.135z"/></svg>
</a><a class=social-share__item href="https://news.ycombinator.com/submitlink?u=https%3A%2F%2Fschnerring.net%2Fblog%2Fdeploy-a-matrix-homeserver-to-azure-kubernetes-service-aks-with-terraform%2F&amp;t=Deploy+a+Matrix+Homeserver+to+Azure+Kubernetes+Service+%28AKS%29+with+Terraform" target=_blank rel=noreferrer><svg role="img" viewBox="0 0 24 24"><title>Y Combinator</title><path d="M0 24V0h24v24H0zM6.951 5.896l4.112 7.708v5.064h1.583v-4.972l4.148-7.799h-1.749l-2.457 4.875c-.372.745-.688 1.434-.688 1.434s-.297-.708-.651-1.434L8.831 5.896h-1.88z"/></svg>
</a><a class=social-share__item href="mailto:?subject=Deploy+a+Matrix+Homeserver+to+Azure+Kubernetes+Service+%28AKS%29+with+Terraform&amp;body=https%3A%2F%2Fschnerring.net%2Fblog%2Fdeploy-a-matrix-homeserver-to-azure-kubernetes-service-aks-with-terraform%2F" target=_blank rel=noreferrer><svg class="icon icon-tabler icon-tabler-mail" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M3 7a2 2 0 012-2h14a2 2 0 012 2v10a2 2 0 01-2 2H5a2 2 0 01-2-2V7z"/><path d="M3 7l9 6 9-6"/></svg></a></div><div id=remark42></div><script>var remark_config={host:"https://remark42.schnerring.net",site_id:"schnerring.net",theme:localStorage.getItem("theme"),show_email_subscription:!1}</script><script>!function(e,t){for(s=0;s<e.length;s++){var s,n=t.createElement("script"),o=".js",i=t.head||t.body;"noModule"in n?(n.type="module",o=".mjs"):n.async=!0,n.defer=!0,n.src=remark_config.host+"/web/"+e[s]+o,i.appendChild(n)}}(remark_config.components||["embed"],document)</script><script>const themeToggleLight=document.getElementsByClassName("theme__toggle light--hidden").item(0);themeToggleLight.addEventListener("click",()=>{setTimeout(()=>window.REMARK42.changeTheme("light"),10)});const themeToggleDark=document.getElementsByClassName("theme__toggle dark--hidden").item(0);themeToggleDark.addEventListener("click",()=>{setTimeout(()=>window.REMARK42.changeTheme("dark"),10)})</script><script>function cookieConsentClick(){localStorage.setItem("cookie-consent",!0);const e=document.getElementById("cookie-consent");e.classList.add("cookie-consent--hidden")}</script><div id=cookie-consent class=cookie-consent--hidden><div class=cli-prompt><div class=cli-prompt__chevron>>&nbsp;</div><div class=cli-prompt__text><span>When you participate in the comments, a cookie is used to keep you logged in.</span>
<span class=cli-prompt__cursor>█</span></div><button onclick=cookieConsentClick()>Got it!</button></div></div><script>const cookieConsentAccepted=localStorage&&localStorage.getItem("cookie-consent");if(!cookieConsentAccepted){const e=document.getElementById("cookie-consent");e.classList.remove("cookie-consent--hidden")}</script></article></div><div class=sidebar><aside class=bio><div class="jr__item jr-basics__item"><div class=jr-basics__image><img src=https://schnerring.net/michael-schnerring.jpg alt="Picture of Michael Schnerring" width=250 height=250></div><div class=jr-basics__name>Michael Schnerring</div><div class=jr-basics__label>Software Engineer</div><div class=jr-basics__summary>I've been a computer geek all my life. I'm passionate about open-source and digital privacy. I like video games and CrossFit. I also blog sometimes.</div><div class=jr-basics__location-city>Basel</div><div class=jr-basics__location-region>Switzerland</div><hr><div class="jr-basics__profile jr-basics__profile--row"><a href=https://github.com/schnerring target=_blank rel="noreferrer me"><div class=jr-basics__profile-item><div class=jr-basics__profile-icon><svg role="img" viewBox="0 0 24 24"><title>GitHub</title><path d="M12 .297c-6.63.0-12 5.373-12 12 0 5.303 3.438 9.8 8.205 11.385.6.113.82-.258.82-.577.0-.285-.01-1.04-.015-2.04-3.338.724-4.042-1.61-4.042-1.61C4.422 18.07 3.633 17.7 3.633 17.7c-1.087-.744.084-.729.084-.729 1.205.084 1.838 1.236 1.838 1.236 1.07 1.835 2.809 1.305 3.495.998.108-.776.417-1.305.76-1.605-2.665-.3-5.466-1.332-5.466-5.93.0-1.31.465-2.38 1.235-3.22-.135-.303-.54-1.523.105-3.176.0.0 1.005-.322 3.3 1.23.96-.267 1.98-.399 3-.405 1.02.006 2.04.138 3 .405 2.28-1.552 3.285-1.23 3.285-1.23.645 1.653.24 2.873.12 3.176.765.84 1.23 1.91 1.23 3.22.0 4.61-2.805 5.625-5.475 5.92.42.36.81 1.096.81 2.22.0 1.606-.015 2.896-.015 3.286.0.315.21.69.825.57C20.565 22.092 24 17.592 24 12.297c0-6.627-5.373-12-12-12"/></svg></div></div></a><a href=https://x.com/schnerringo target=_blank rel="noreferrer me"><div class=jr-basics__profile-item><div class=jr-basics__profile-icon><svg role="img" viewBox="0 0 24 24"><title>X</title><path d="M18.901 1.153h3.68l-8.04 9.19L24 22.846h-7.406l-5.8-7.584-6.638 7.584H.474l8.6-9.83L0 1.154h7.594l5.243 6.932zM17.61 20.644h2.039L6.486 3.24H4.298z"/></svg></div></div></a><a href=https://hachyderm.io/@schnerring target=_blank rel="noreferrer me"><div class=jr-basics__profile-item><div class=jr-basics__profile-icon><svg role="img" viewBox="0 0 24 24"><title>Mastodon</title><path d="M23.268 5.313c-.35-2.578-2.617-4.61-5.304-5.004C17.51.242 15.792.0 11.813.0h-.03c-3.98.0-4.835.242-5.288.309C3.882.692 1.496 2.518.917 5.127.64 6.412.61 7.837.661 9.143c.074 1.874.088 3.745.26 5.611.118 1.24.325 2.47.62 3.68.55 2.237 2.777 4.098 4.96 4.857 2.336.792 4.849.923 7.256.38.265-.061.527-.132.786-.213.585-.184 1.27-.39 1.774-.753a.057.057.0 00.023-.043v-1.809a.052.052.0 00-.02-.041.053.053.0 00-.046-.01 20.282 20.282.0 01-4.709.545c-2.73.0-3.463-1.284-3.674-1.818a5.593 5.593.0 01-.319-1.433.053.053.0 01.066-.054c1.517.363 3.072.546 4.632.546.376.0.75.0 1.125-.01 1.57-.044 3.224-.124 4.768-.422.038-.008.077-.015.11-.024 2.435-.464 4.753-1.92 4.989-5.604.008-.145.03-1.52.03-1.67.002-.512.167-3.63-.024-5.545zm-3.748 9.195h-2.561V8.29c0-1.309-.55-1.976-1.67-1.976-1.23.0-1.846.79-1.846 2.35v3.403h-2.546V8.663c0-1.56-.617-2.35-1.848-2.35-1.112.0-1.668.668-1.67 1.977v6.218H4.822V8.102c0-1.31.337-2.35 1.011-3.12.696-.77 1.608-1.164 2.74-1.164 1.311.0 2.302.5 2.962 1.498l.638 1.06.638-1.06c.66-.999 1.65-1.498 2.96-1.498 1.13.0 2.043.395 2.74 1.164.675.77 1.012 1.81 1.012 3.12z"/></svg></div></div></a><a href=https://www.linkedin.com/in/schnerring target=_blank rel="noreferrer me"><div class=jr-basics__profile-item><div class=jr-basics__profile-icon><svg role="img" viewBox="0 0 24 24"><title>LinkedIn</title><path d="M20.447 20.452h-3.554v-5.569c0-1.328-.027-3.037-1.852-3.037-1.853.0-2.136 1.445-2.136 2.939v5.667H9.351V9h3.414v1.561h.046c.477-.9 1.637-1.85 3.37-1.85 3.601.0 4.267 2.37 4.267 5.455v6.286zM5.337 7.433c-1.144.0-2.063-.926-2.063-2.065.0-1.138.92-2.063 2.063-2.063 1.14.0 2.064.925 2.064 2.063.0 1.139-.925 2.065-2.064 2.065zm1.782 13.019H3.555V9h3.564v11.452zM22.225.0H1.771C.792.0.0.774.0 1.729v20.542C0 23.227.792 24 1.771 24h20.451C23.2 24 24 23.227 24 22.271V1.729C24 .774 23.2.0 22.222.0h.003z"/></svg></div></div></a><a href=https://schnerring.net/index.xml target=_blank rel="noreferrer me"><div class=jr-basics__profile-item><div class=jr-basics__profile-icon><svg role="img" viewBox="0 0 24 24"><title>RSS</title><path d="M19.199 24C19.199 13.467 10.533 4.8.0 4.8V0c13.165.0 24 10.835 24 24h-4.801zM3.291 17.415c1.814.0 3.293 1.479 3.293 3.295.0 1.813-1.485 3.29-3.301 3.29C1.47 24 0 22.526.0 20.71s1.475-3.294 3.291-3.295zM15.909 24h-4.665c0-6.169-5.075-11.245-11.244-11.245V8.09c8.727.0 15.909 7.184 15.909 15.91z"/></svg></div></div></a></div></div></aside></div></main><footer><div class=copyright>© 2020 - 2023 Michael Schnerring</div></footer><script src=/js/main.64c1438168ce40659c4587f5c9c4360f879c91bf1a11a0108f4a10e6fffccd9d6ad88c2ba6ee9e4196298d61146a14f05b5f3f94f839654339bb28daae75220f.js integrity="sha512-ZMFDgWjOQGWcRYf1ycQ2D4eckb8aEaAQj0oQ5v/8zZ1q2Iwrpu6eQZYpjWEUahTwW18/lPg5ZUM5uyjarnUiDw=="></script><script src=/js/flexsearch.1ab5b109bf2ed66903ae10907394415caa12f5c0ee66bc80088ba135ec4a751f62e4961d6a7303b562e4db724392da85945b763b8e1858ea3fd05cc36f9b8156.js integrity="sha512-GrWxCb8u1mkDrhCQc5RBXKoS9cDuZryACIuhNexKdR9i5JYdanMDtWLk23JDktqFlFt2O44YWOo/0FzDb5uBVg=="></script></div></body></html>