<!doctype html><html lang=en theme=dark><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><link rel=preload as=font type=font/woff2 href=/fonts/roboto-slab-latin-400.woff2 crossorigin=anonymous><link rel=prefetch as=font type=font/woff2 href=/fonts/roboto-slab-latin-700.woff2 crossorigin=anonymous><link rel=preload as=font type=font/woff2 href=/fonts/fira-code-latin-300.woff2 crossorigin=anonymous><link rel=preload as=font type=font/woff2 href=/fonts/fira-code-latin-400.woff2 crossorigin=anonymous><link rel=prefetch as=font type=font/woff2 href=/fonts/fira-code-latin-700.woff2 crossorigin=anonymous><meta name=robots content="index, follow, max-snippet:-1, max-image-preview:large, max-video-preview:-1"><title>Use Terraform to Deploy an Azure Kubernetes Service (AKS) Cluster, Traefik 2, cert-manager, and Let's Encrypt Certificates</title><meta name=description content="In this post, we will deploy a simple Azure Kubernetes Service (AKS) cluster from scratch. To expose our web services securely, we will install Traefik 2 and configure cert-manager to manage Let&amp;rsquo;s Encrypt certificates. The best part about it: we will do everything with Terraform.
"><link rel=canonical href=https://schnerring.net/blog/use-terraform-to-deploy-an-azure-kubernetes-service-aks-cluster-traefik-2-cert-manager-and-lets-encrypt-certificates/><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="https://schnerring.net/blog/use-terraform-to-deploy-an-azure-kubernetes-service-aks-cluster-traefik-2-cert-manager-and-lets-encrypt-certificates/cover.png"><meta name=twitter:title content="Use Terraform to Deploy an Azure Kubernetes Service (AKS) Cluster, Traefik 2, cert-manager, and Let's Encrypt Certificates"><meta name=twitter:description content="In this post, we will deploy a simple Azure Kubernetes Service (AKS) cluster from scratch. To expose our web services securely, we will install Traefik 2 and configure cert-manager to manage Let&rsquo;s Encrypt certificates. The best part about it: we will do everything with Terraform."><meta property="og:title" content="Use Terraform to Deploy an Azure Kubernetes Service (AKS) Cluster, Traefik 2, cert-manager, and Let's Encrypt Certificates"><meta property="og:description" content="In this post, we will deploy a simple Azure Kubernetes Service (AKS) cluster from scratch. To expose our web services securely, we will install Traefik 2 and configure cert-manager to manage Let&rsquo;s Encrypt certificates. The best part about it: we will do everything with Terraform."><meta property="og:type" content="article"><meta property="og:url" content="https://schnerring.net/blog/use-terraform-to-deploy-an-azure-kubernetes-service-aks-cluster-traefik-2-cert-manager-and-lets-encrypt-certificates/"><meta property="og:image" content="https://schnerring.net/blog/use-terraform-to-deploy-an-azure-kubernetes-service-aks-cluster-traefik-2-cert-manager-and-lets-encrypt-certificates/cover.png"><meta property="article:section" content="blog"><meta property="article:published_time" content="2021-04-25T01:00:27+02:00"><meta property="article:modified_time" content="2021-04-25T01:00:27+02:00"><meta itemprop=name content="Use Terraform to Deploy an Azure Kubernetes Service (AKS) Cluster, Traefik 2, cert-manager, and Let's Encrypt Certificates"><meta itemprop=description content="In this post, we will deploy a simple Azure Kubernetes Service (AKS) cluster from scratch. To expose our web services securely, we will install Traefik 2 and configure cert-manager to manage Let&rsquo;s Encrypt certificates. The best part about it: we will do everything with Terraform."><meta itemprop=datePublished content="2021-04-25T01:00:27+02:00"><meta itemprop=dateModified content="2021-04-25T01:00:27+02:00"><meta itemprop=wordCount content="2123"><meta itemprop=image content="https://schnerring.net/blog/use-terraform-to-deploy-an-azure-kubernetes-service-aks-cluster-traefik-2-cert-manager-and-lets-encrypt-certificates/cover.png"><meta itemprop=keywords content="AKS,Azure,Azure Kubernetes Service,cert-manager,Cloud,DevOps,Helm,k8s,Kubernetes,Let's Encrypt,Network,Reverse Proxy,Self-host,Terraform,Traefik,"><script async defer data-domain=schnerring.net src=https://plausible.schnerring.net/js/plausible.js></script><style>@font-face{font-display:swap;font-family:Roboto Slab;font-style:normal;font-weight:100;src:local("Roboto Slab Thin "),local("Roboto Slab-Thin"),url(/fonts/roboto-slab-latin-100.woff2) format("woff2"),url(/fonts/roboto-slab-latin-100.woff) format("woff")}@font-face{font-display:swap;font-family:Roboto Slab;font-style:normal;font-weight:200;src:local("Roboto Slab Extra Light "),local("Roboto Slab-Extra Light"),url(/fonts/roboto-slab-latin-200.woff2) format("woff2"),url(/fonts/roboto-slab-latin-200.woff) format("woff")}@font-face{font-display:swap;font-family:Roboto Slab;font-style:normal;font-weight:300;src:local("Roboto Slab Light "),local("Roboto Slab-Light"),url(/fonts/roboto-slab-latin-300.woff2) format("woff2"),url(/fonts/roboto-slab-latin-300.woff) format("woff")}@font-face{font-display:swap;font-family:Roboto Slab;font-style:normal;font-weight:400;src:local("Roboto Slab Regular "),local("Roboto Slab-Regular"),url(/fonts/roboto-slab-latin-400.woff2) format("woff2"),url(/fonts/roboto-slab-latin-400.woff) format("woff")}@font-face{font-display:swap;font-family:Roboto Slab;font-style:normal;font-weight:500;src:local("Roboto Slab Medium "),local("Roboto Slab-Medium"),url(/fonts/roboto-slab-latin-500.woff2) format("woff2"),url(/fonts/roboto-slab-latin-500.woff) format("woff")}@font-face{font-display:swap;font-family:Roboto Slab;font-style:normal;font-weight:600;src:local("Roboto Slab SemiBold "),local("Roboto Slab-SemiBold"),url(/fonts/roboto-slab-latin-600.woff2) format("woff2"),url(/fonts/roboto-slab-latin-600.woff) format("woff")}@font-face{font-display:swap;font-family:Roboto Slab;font-style:normal;font-weight:700;src:local("Roboto Slab Bold "),local("Roboto Slab-Bold"),url(/fonts/roboto-slab-latin-700.woff2) format("woff2"),url(/fonts/roboto-slab-latin-700.woff) format("woff")}@font-face{font-display:swap;font-family:Roboto Slab;font-style:normal;font-weight:800;src:local("Roboto Slab ExtraBold "),local("Roboto Slab-ExtraBold"),url(/fonts/roboto-slab-latin-800.woff2) format("woff2"),url(/fonts/roboto-slab-latin-800.woff) format("woff")}@font-face{font-display:swap;font-family:Roboto Slab;font-style:normal;font-weight:900;src:local("Roboto Slab Black "),local("Roboto Slab-Black"),url(/fonts/roboto-slab-latin-900.woff2) format("woff2"),url(/fonts/roboto-slab-latin-900.woff) format("woff")}@font-face{font-display:swap;font-family:Fira Code;font-style:normal;font-weight:300;src:local("Fira Code Light "),local("Fira Code-Light"),url(/fonts/fira-code-latin-300.woff2) format("woff2"),url(/fonts/fira-code-latin-300.woff) format("woff")}@font-face{font-display:swap;font-family:Fira Code;font-style:normal;font-weight:400;src:local("Fira Code Regular "),local("Fira Code-Regular"),url(/fonts/fira-code-latin-400.woff2) format("woff2"),url(/fonts/fira-code-latin-400.woff) format("woff")}@font-face{font-display:swap;font-family:Fira Code;font-style:normal;font-weight:500;src:local("Fira Code Medium "),local("Fira Code-Medium"),url(/fonts/fira-code-latin-500.woff2) format("woff2"),url(/fonts/fira-code-latin-500.woff) format("woff")}@font-face{font-display:swap;font-family:Fira Code;font-style:normal;font-weight:600;src:local("Fira Code SemiBold "),local("Fira Code-SemiBold"),url(/fonts/fira-code-latin-600.woff2) format("woff2"),url(/fonts/fira-code-latin-600.woff) format("woff")}@font-face{font-display:swap;font-family:Fira Code;font-style:normal;font-weight:700;src:local("Fira Code Bold "),local("Fira Code-Bold"),url(/fonts/fira-code-latin-700.woff2) format("woff2"),url(/fonts/fira-code-latin-700.woff) format("woff")}

/*! normalize.css v8.0.1 | MIT License | github.com/necolas/normalize.css */html{-webkit-text-size-adjust:100%;line-height:1.15}body{margin:0}main{display:block}h1{font-size:2em;margin:.67em 0}hr{box-sizing:content-box;height:0;overflow:visible}pre{font-family:monospace,monospace;font-size:1em}a{background-color:transparent}abbr[title]{border-bottom:none;text-decoration:underline;-webkit-text-decoration:underline dotted;text-decoration:underline dotted}b,strong{font-weight:bolder}code,kbd,samp{font-family:monospace,monospace;font-size:1em}small{font-size:80%}sub,sup{font-size:75%;line-height:0;position:relative;vertical-align:baseline}sub{bottom:-.25em}sup{top:-.5em}img{border-style:none}button,input,optgroup,select,textarea{font-family:inherit;font-size:100%;line-height:1.15;margin:0}button,input{overflow:visible}button,select{text-transform:none}[type=button],[type=reset],[type=submit],button{-webkit-appearance:button}[type=button]::-moz-focus-inner,[type=reset]::-moz-focus-inner,[type=submit]::-moz-focus-inner,button::-moz-focus-inner{border-style:none;padding:0}[type=button]:-moz-focusring,[type=reset]:-moz-focusring,[type=submit]:-moz-focusring,button:-moz-focusring{outline:1px dotted ButtonText}fieldset{padding:.35em .75em .625em}legend{box-sizing:border-box;color:inherit;display:table;max-width:100%;padding:0;white-space:normal}progress{vertical-align:baseline}textarea{overflow:auto}[type=checkbox],[type=radio]{box-sizing:border-box;padding:0}[type=number]::-webkit-inner-spin-button,[type=number]::-webkit-outer-spin-button{height:auto}[type=search]{-webkit-appearance:textfield;outline-offset:-2px}[type=search]::-webkit-search-decoration{-webkit-appearance:none}::-webkit-file-upload-button{-webkit-appearance:button;font:inherit}details{display:block}summary{display:list-item}[hidden],template{display:none}:root[theme=light]{--bg:var(--bg0_h);--bg0:#fbf1c7;--bg0_h:#f9f5d7;--bg0_s:#f2e5bc;--bg1:#ebdbb2;--bg2:#d5c4a1;--bg3:#bdae93;--bg4:#a89984;--fg:var(--fg1);--fg0:#282828;--fg1:#3c3836;--fg2:#504945;--fg3:#665c54;--fg4:#7c6f64;--gray1:var(--fg4);--gray2:#928374;--red1:#cc241d;--red2:#9d0006;--green1:#98971a;--green2:#797403;--yellow1:#d79921;--yellow2:#b57614;--blue1:#458588;--blue2:#076678;--purple1:#b16286;--purple2:#8f3f71;--aqua1:#689d6a;--aqua2:#427b58;--orange1:#d65d0e;--orange2:#af3a03}[theme=light]:root .light--hidden{display:none}:root[theme=dark]{--bg:var(--bg0_h);--bg0:#282828;--bg0_h:#1d2021;--bg0_s:#32302f;--bg1:#3c3836;--bg2:#504945;--bg3:#665c54;--bg4:#7c6f64;--fg:var(--fg1);--fg0:#fbf1c7;--fg1:#ebdbb2;--fg2:#d5c4a1;--fg3:#bdae93;--fg4:#a89984;--gray1:var(--fg4);--gray2:#928374;--red1:#cc241d;--red2:#fb4934;--green1:#98971a;--green2:#b8bb26;--yellow1:#d79921;--yellow2:#fabd2f;--blue1:#458588;--blue2:#83a598;--purple1:#b16286;--purple2:#d3869b;--aqua1:#689d6a;--aqua2:#8ec07c;--orange1:#d65d0e;--orange2:#fe8019}[theme=dark]:root .dark--hidden{display:none}:root{--primary:var(--aqua1);--primary-alt:var(--aqua2);--font-monospace:"Fira Code","Lucida Console",Monaco,monospace;--font-sans-serif:Verdana,Helvetica,sans-serif;--font-serif:"Roboto Slab",Georgia,serif}html{font-family:Roboto Slab,Georgia,serif;font-family:var(--font-serif);font-size:1rem;scroll-behavior:smooth}body{word-wrap:break-word;background:var(--bg);color:var(--fg);line-height:1.675}strong{letter-spacing:.35px}a{color:inherit;text-decoration:none}a.link--external:after{content:"\2009↗"}img,video{border:2px solid var(--bg1);height:auto;max-width:100%}figure{display:inline-block}figcaption{color:var(--fg3);font-family:Roboto Slab,Georgia,serif;font-family:var(--font-serif);font-size:.9rem}::-moz-selection{background:var(--bg4);color:var(--fg0)}::selection{background:var(--bg4);color:var(--fg0)}h1,h2,h3,h4,h5{color:var(--fg0);font-family:Fira Code,Lucida Console,Monaco,monospace;font-family:var(--font-monospace);font-weight:300;line-height:1.4}h1 code,h2 code,h3 code,h4 code,h5 code{font-size:1em}h2,h3,h4,h5{border-bottom:1px solid var(--bg1)}h1,h2{font-weight:400}h1{font-size:1.875rem}h2{font-size:1.75rem}h3{font-size:1.625rem}@media (min-width:768px){h1{font-size:2.375rem}h2{font-size:2rem}h3{font-size:1.75rem}}h4{font-size:1.5rem}h5{font-size:1.375rem}table{border-collapse:collapse;margin:2rem 0;table-layout:fixed;width:100%}table,td,th{border:1px solid var(--bg1);padding:.5rem}hr{background:var(--bg1);border:none;height:1px;margin:3rem auto;width:80%}blockquote,code,pre{border-radius:.2rem;padding:0 .2em}pre code{padding:0}blockquote,code,pre,th{background:var(--bg1)}code,pre,th{font-family:Fira Code,Lucida Console,Monaco,monospace;font-family:var(--font-monospace)}code code{background:var(--bg2)}blockquote,pre{padding:1rem}pre{background:var(--bg1)!important;overflow:auto}pre code{background:none}blockquote{border-left:5px solid var(--primary-alt);margin:.5rem 0}blockquote:not(.does-not-exist) code{background:var(--bg2)}blockquote:not(.does-not-exist) p:first-of-type{margin-top:0}blockquote:not(.does-not-exist) p:last-of-type{margin-bottom:0}pre::-webkit-scrollbar{height:.5rem;scrollbar-width:auto}pre::-webkit-scrollbar-track{background:var(--bg2);border-radius:.2rem}pre::-webkit-scrollbar-thumb{background:var(--bg4);border-radius:.2rem}.layout{display:grid;grid-template-areas:"header" "main" "footer";grid-template-rows:auto 1fr auto;height:100vh}main{align-items:start;display:grid;grid-area:main;grid-template-areas:"empty content sidebar";grid-template-columns:1fr minmax(0,650px) 4fr}header{background:var(--bg1);grid-area:header}footer{grid-area:footer}footer,main{margin:.5em 1.1em}.content{grid-area:content}.sidebar{display:none;flex-direction:column;grid-area:sidebar;margin-top:3rem;position:-webkit-sticky;position:sticky;top:2rem}@media (min-width:992px){.sidebar{display:flex}}header{display:grid;font-family:Fira Code,Lucida Console,Monaco,monospace;font-family:var(--font-monospace);font-size:1.125rem;grid-template-areas:"heading search nav theme-toggle";grid-template-columns:auto auto 1fr auto;padding:.75rem}.logo{color:var(--fg0);display:flex;font-weight:700;grid-area:heading}.logo:hover .logo__cursor{-webkit-animation:blink 1s infinite;animation:blink 1s infinite;opacity:1}.logo__chevron,.logo__cursor{margin-left:.5rem}.logo__cursor{opacity:0}.logo__text{display:none}@media (min-width:768px){.logo__text{display:block}}.search{display:flex;grid-area:search;margin:0 1rem}#search__text{background:var(--bg2);border:1px solid var(--bg2);border-radius:.2rem;caret-color:var(--fg);color:var(--fg);outline:none;padding:0 .5rem;width:100%}#search__text:hover{border-color:var(--bg3)}#search__text:focus{border-color:var(--bg4)}#search__text::-moz-placeholder{color:var(--fg3)}#search__text::placeholder{color:var(--fg3)}#search__text[type=search]::-webkit-search-cancel-button{-webkit-appearance:none;appearance:none}#search__suggestions{background:var(--bg);border-radius:.2rem;box-shadow:0 .5rem 1rem var(--bg1);font-family:Roboto Slab,Georgia,serif;font-family:var(--font-serif);left:0;margin-top:2rem;position:absolute;width:95vw;z-index:1000}@media (min-width:768px){.search{position:relative}#search__suggestions{width:60vw}}.search__suggestions--hidden{display:none}.search__suggestion-item{border-bottom:1px dashed var(--bg2);display:grid;grid-template-columns:1fr 2fr}.search__suggestion-item.focus-visible,.search__suggestion-item:focus,.search__suggestion-item:hover{background:var(--bg1);cursor:pointer;outline:none}.search__suggestion-item:focus,.search__suggestion-item:focus-visible,.search__suggestion-item:hover{background:var(--bg1);cursor:pointer;outline:none}.search__suggestion-item:last-child{border:none}.search__suggestion-description,.search__suggestion-title{margin:1rem 0;padding:0 1rem}.search__suggestion-title{font-weight:700}.search__suggestion-description{border-left:1px solid var(--bg2)}.search__no-results{padding:.75rem}.theme__toggle{align-items:center;background:none;border:none;color:var(--yellow1);cursor:pointer;display:flex;grid-area:theme-toggle;margin:0 1rem}.theme__toggle:hover{color:var(--yellow2)}.theme__toggle svg{height:28px;width:28px}nav#menu{align-items:center;display:flex;grid-area:nav;justify-content:flex-end}nav#menu .menu__item{color:var(--fg)}nav#menu .menu__item:hover{color:var(--fg3);cursor:pointer}nav#menu ul{list-style:none;margin:0;padding:0}nav#menu ul.menu--horizontal{align-items:center;display:none}nav#menu ul.menu--horizontal li{display:inline-block;margin:0 .75rem}@media (min-width:768px){nav#menu ul.menu--horizontal{display:flex}}nav#menu ul.menu--vertical{background:var(--fg0);bottom:0;margin:0;padding:3rem;position:fixed;right:0;top:0;transform:translate(100%);transition:transform .5s cubic-bezier(.9,0,.1,1);width:50%;z-index:10}nav#menu ul.menu--vertical .menu__item{color:var(--bg1)}nav#menu ul.menu--vertical .menu__item:hover{color:var(--bg4)}nav#menu .menu__burger{display:flex;height:24px;width:24px}nav#menu .menu__burger>*{position:absolute}nav#menu .menu__burger svg{height:inherit;width:inherit;z-index:20}nav#menu .menu__burger svg line{transition-duration:.5s;transition-property:stroke,opacity,transform;transition-timing-function:cubic-bezier(.9,0,.1,1)}nav#menu .menu__burger svg line:first-of-type{transform-origin:center 6px}nav#menu .menu__burger svg line:nth-of-type(2){transform-origin:center 12px}nav#menu .menu__burger svg line:nth-of-type(3){transform-origin:center 18px}nav#menu .menu__burger input{height:inherit;opacity:0;width:inherit;z-index:30}:is(nav#menu .menu__burger input:checked)~ul.menu--vertical{transform:none}:is(nav#menu .menu__burger input:checked)~svg{stroke:var(--bg1)}:is(nav#menu .menu__burger input:checked)~svg line:first-of-type{transform:translateY(6px) rotate(45deg)}:is(nav#menu .menu__burger input:checked)~svg line:nth-of-type(2){opacity:0;transform:scale(.2)}:is(nav#menu .menu__burger input:checked)~svg line:nth-of-type(3){transform:translateY(-6px) rotate(-45deg)}@media (min-width:768px){nav#menu .menu__burger{display:none}}

/*! Source: https://stackoverflow.com/a/36118384/1154965 */@-webkit-keyframes blink{50%{opacity:0}to{opacity:1}}@keyframes blink{50%{opacity:0}to{opacity:1}}.sidebar{font-family:Fira Code,Lucida Console,Monaco,monospace;font-family:var(--font-monospace);margin-left:auto;margin-right:auto;max-width:350px;padding-left:2.5rem}.sidebar svg{fill:var(--fg)}.sidebar__heading{font-size:1.3rem}aside.toc a{color:var(--aqua2);color:var(--primary-alt)}aside.toc a:hover{color:var(--aqua1);color:var(--primary)}aside.toc ul{list-style:none;margin:0;padding:0}aside.toc ul ul{font-size:.9rem;margin-left:.5rem}aside.toc ul li{line-height:1.1}aside.toc ul li a{display:block;padding:.2rem 0}.jr-basics__image{background:var(--bg1);border:2px solid var(--bg2)}.jr-basics__summary{color:var(--fg3);font-family:Roboto Slab,Georgia,serif;font-family:var(--font-serif);margin:.75rem 0}.jr-basics__profile a:hover{color:var(--fg3)}.jr-basics__profile a:hover svg{fill:var(--fg3)}.post{border-bottom:2px dotted var(--bg1);padding:2rem 0}.post figure,.post img:not(figure img),.post video:not(figure video){box-sizing:border-box;margin:.5rem 0}.post-content__read-more,.post-header{font-family:Fira Code,Lucida Console,Monaco,monospace;font-family:var(--font-monospace)}.post-content{margin:1.3rem 0}.post-content__read-more{margin-top:1.3rem}.post-content a,.post-content__read-more,.post-header a{color:var(--aqua2);color:var(--primary-alt)}.post-content a:hover,.post-header a:hover{color:var(--aqua1);color:var(--primary)}.post-tags{align-items:center;display:flex;flex-wrap:wrap;gap:.9rem;margin:1rem 0}.post-tag{font-size:.9rem;line-height:1}.post-tag:before{content:"#"}.post-heading__anchor{display:none}h1:hover .post-heading__anchor,h2:hover .post-heading__anchor,h3:hover .post-heading__anchor,h4:hover .post-heading__anchor,h5:hover .post-heading__anchor{display:inline-block}.jr__item-meta{flex-direction:column}.jr-basics__image,.jr-basics__item,.jr-basics__profile-icon,.jr-basics__profile-item,.jr__item-meta{align-items:center;display:flex}.jr-basics__name,.jr-projects__roles,.jr-work__position{font-size:1.125rem;font-weight:700}.jr-basics__item{flex-direction:column;text-align:center}.jr-basics__item hr{margin:1.5rem auto}.jr-basics__image{border-radius:50%;height:250px;justify-content:center;overflow:hidden;width:250px}.jr-basics__label,.jr-basics__name,.jr-basics__summary{margin-top:.75rem}.jr-basics__profile svg{height:24px;width:24px}.jr-basics__profile,.jr-basics__profile-item{display:flex}.jr-basics__profile-item{display:flex;padding:.2rem}.jr-basics__profile--row{flex-wrap:wrap;justify-content:space-evenly}.jr-basics__profile-icon{padding:0 .75rem}.jr__item-meta{align-items:start;flex-flow:column;font-family:Fira Code,Lucida Console,Monaco,monospace;font-family:var(--font-monospace)}@media (min-width:768px){.jr__item-meta{align-items:center;flex-flow:row wrap}.jr-work__location,.jr__date-range{flex-grow:1;text-align:right}}#cookie-consent{-webkit-animation:fadeIn .75s;animation:fadeIn .75s;background:var(--fg0);border-radius:.2rem;bottom:1rem;box-shadow:0 -.5rem 1rem var(--bg1);color:var(--bg1);font-family:Fira Code,Lucida Console,Monaco,monospace;font-family:var(--font-monospace);left:1rem;padding:1rem;position:fixed;right:1rem;z-index:2000}@media (min-width:768px){#cookie-consent{padding:2.5rem}}#cookie-consent button{background:none;border:none;color:var(--aqua1);color:var(--primary);font-size:1.125rem;margin:0 1rem;white-space:nowrap}#cookie-consent button:hover{color:var(--aqua2);color:var(--primary-alt);cursor:pointer}.cookie-consent--hidden{display:none}.cli-prompt{display:flex;justify-content:center}.cli-prompt__cursor{-webkit-animation:blink 1s infinite;animation:blink 1s infinite}@-webkit-keyframes fadeIn{0%{opacity:0}to{opacity:1}}@keyframes fadeIn{0%{opacity:0}to{opacity:1}}.social-share{align-items:center;border-top:2px dotted var(--bg1);display:flex;flex-wrap:wrap;gap:.9rem;margin:3rem 0;padding-top:3rem}.social-share svg{fill:var(--fg);height:24px;width:24px}.social-share svg.icon-tabler{fill:none;stroke:var(--fg)}.social-share__item{background:var(--bg1);display:flex;padding:.5rem}</style><link rel=preload href="/css/non-critical.4c16944048dc81442c729543003397777e3de2307882ac78c50608a144535781c7193da357c9387385c86e0cc61228f994aa606838b44abeade39c034a34a3d0.css" as=style onload='this.onload=null,this.rel="stylesheet"' integrity="sha512-TBaUQEjcgUQscpVDADOXd3494jB4gqx4xQYIoURTV4HHGT2jV8k4c4XIbgzGEij5lKpgaDi0Sr6t45wDSjSj0A=="><link id=prism-dark rel=prefetch href=/prism-themes/prism-gruvbox-dark.min.54aecc64074623a4f9898544dcbdab9e804f1560ef0b38f4cf8e10fcaaf72264e798cb407c601aca6ecd833ec4eb93d66535581f18d45ba202cf848b70dbc332.css as=style onload='this.onload=null,this.rel="stylesheet"' integrity="sha512-VK7MZAdGI6T5iYVE3L2rnoBPFWDvCzj0z44Q/Kr3ImTnmMtAfGAaym7Ngz7E65PWZTVYHxjUW6ICz4SLcNvDMg=="><link id=prism-light rel=prefetch href=/prism-themes/prism-gruvbox-light.min.42a221741efe997fcc94187c39d63c555560678789ac9ca856c74a5f0ddb2aa6c50d38b2ffbecc7a99038cbbd2efa99746e862267f781c559e0cfec10b88a5fc.css as=style onload='this.onload=null,this.rel="stylesheet"' integrity="sha512-QqIhdB7+mX/MlBh8OdY8VVVgZ4eJrJyoVsdKXw3bKqbFDTiy/77MepkDjLvS76mXRuhiJn94HFWeDP7BC4il/A==" disabled><noscript><link rel=stylesheet href=/prism-themes/prism-gruvbox-dark.min.54aecc64074623a4f9898544dcbdab9e804f1560ef0b38f4cf8e10fcaaf72264e798cb407c601aca6ecd833ec4eb93d66535581f18d45ba202cf848b70dbc332.css integrity="sha512-VK7MZAdGI6T5iYVE3L2rnoBPFWDvCzj0z44Q/Kr3ImTnmMtAfGAaym7Ngz7E65PWZTVYHxjUW6ICz4SLcNvDMg=="><link rel=stylesheet href="/css/non-critical.4c16944048dc81442c729543003397777e3de2307882ac78c50608a144535781c7193da357c9387385c86e0cc61228f994aa606838b44abeade39c034a34a3d0.css" integrity="sha512-TBaUQEjcgUQscpVDADOXd3494jB4gqx4xQYIoURTV4HHGT2jV8k4c4XIbgzGEij5lKpgaDi0Sr6t45wDSjSj0A=="></noscript><script>(()=>{function n(){if(localStorage&&localStorage.getItem("theme"))return localStorage.getItem("theme");if(window.matchMedia)return window.matchMedia("(prefers-color-scheme: light)").matches?"light":"dark"}function e(e){document.documentElement.setAttribute("theme",e);let t=document.getElementById("prism-dark"),n=document.getElementById("prism-light");t.toggleAttribute("disabled",e==="light"),n.toggleAttribute("disabled",e==="dark"),localStorage.setItem("theme",e)}var t=n();t&&e(t);function s(t){let n=t.currentTarget.classList.contains("light--hidden")?"light":"dark";e(n)}document.addEventListener("DOMContentLoaded",function(){document.querySelectorAll(".theme__toggle").forEach(e=>{e.addEventListener("click",s)})})})()</script><link rel=apple-touch-icon sizes=180x180 href=/apple-touch-icon.png><link rel=icon type=image/png sizes=32x32 href=/favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=/favicon-16x16.png><link rel=manifest href=/site.webmanifest><meta name=msapplication-TileColor content="#282828"><meta name=theme-color content="#282828"></head><body><div class=layout><header><a class=logo href=/><div class=logo__text>schnerring.net</div><div class=logo__chevron>></div><div class=logo__cursor>█</div></a><div class=search><input id=search__text type=search placeholder=Search... aria-label=Search autocomplete=off><div id=search__suggestions class=search__suggestions--hidden></div></div><nav id=menu><ul class=menu--horizontal><li class=menu__item><a href=/blog>Blog</a></li><li class=menu__item><a href=/cv>CV</a></li><li class=menu__item><a href=/about>About</a></li><li class=menu__item><a href=/stats>Stats</a></li></ul><div class=menu__burger><input class=menu__item type=checkbox aria-label="Open main menu"><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-menu-2" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><line x1="4" y1="6" x2="20" y2="6"/><line x1="4" y1="12" x2="20" y2="12"/><line x1="4" y1="18" x2="20" y2="18"/></svg><ul class=menu--vertical><li><a class=menu__item href=/blog>Blog</a></li><li><a class=menu__item href=/cv>CV</a></li><li><a class=menu__item href=/about>About</a></li><li><a class=menu__item href=/stats>Stats</a></li></ul></div></nav><button class="theme__toggle light--hidden" aria-label="Toggle light mode"><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-sun" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><circle cx="12" cy="12" r="4"/><path d="M3 12h1m8-9v1m8 8h1m-9 8v1M5.6 5.6l.7.7m12.1-.7-.7.7m0 11.4.7.7m-12.1-.7-.7.7"/></svg></button>
<button class="theme__toggle dark--hidden" aria-label="Toggle dark mode"><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-moon" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M12 3c.132.0.263.0.393.0a7.5 7.5.0 007.92 12.446A9 9 0 1112 2.992z"/></svg></button></header><main><div class=content><article class=post><div class=post-header><h1><a href=/blog/use-terraform-to-deploy-an-azure-kubernetes-service-aks-cluster-traefik-2-cert-manager-and-lets-encrypt-certificates/>Use Terraform to Deploy an Azure Kubernetes Service (AKS) Cluster, Traefik 2, cert-manager, and Let&rsquo;s Encrypt Certificates</a></h1><div class=post-meta><span>2021-04-25</span><div class=post-tags><a class=post-tag href=https://schnerring.net/tags/aks>aks</a>
<a class=post-tag href=https://schnerring.net/tags/azure>azure</a>
<a class=post-tag href=https://schnerring.net/tags/azure-kubernetes-service>azure&#8209;kubernetes&#8209;service</a>
<a class=post-tag href=https://schnerring.net/tags/cert-manager>cert&#8209;manager</a>
<a class=post-tag href=https://schnerring.net/tags/cloud>cloud</a>
<a class=post-tag href=https://schnerring.net/tags/devops>devops</a>
<a class=post-tag href=https://schnerring.net/tags/helm>helm</a>
<a class=post-tag href=https://schnerring.net/tags/k8s>k8s</a>
<a class=post-tag href=https://schnerring.net/tags/kubernetes>kubernetes</a>
<a class=post-tag href=https://schnerring.net/tags/lets-encrypt>lets&#8209;encrypt</a>
<a class=post-tag href=https://schnerring.net/tags/network>network</a>
<a class=post-tag href=https://schnerring.net/tags/reverse-proxy>reverse&#8209;proxy</a>
<a class=post-tag href=https://schnerring.net/tags/self-host>self&#8209;host</a>
<a class=post-tag href=https://schnerring.net/tags/terraform>terraform</a>
<a class=post-tag href=https://schnerring.net/tags/traefik>traefik</a></div><picture><source srcset="/blog/use-terraform-to-deploy-an-azure-kubernetes-service-aks-cluster-traefik-2-cert-manager-and-lets-encrypt-certificates/cover_hub92c13112e866e68a0ecc70223090fce_159308_300x0_resize_q90_h2_box_3.webp 300w,/blog/use-terraform-to-deploy-an-azure-kubernetes-service-aks-cluster-traefik-2-cert-manager-and-lets-encrypt-certificates/cover_hub92c13112e866e68a0ecc70223090fce_159308_400x0_resize_q90_h2_box_3.webp 400w,/blog/use-terraform-to-deploy-an-azure-kubernetes-service-aks-cluster-traefik-2-cert-manager-and-lets-encrypt-certificates/cover_hub92c13112e866e68a0ecc70223090fce_159308_500x0_resize_q90_h2_box_3.webp 500w,/blog/use-terraform-to-deploy-an-azure-kubernetes-service-aks-cluster-traefik-2-cert-manager-and-lets-encrypt-certificates/cover_hub92c13112e866e68a0ecc70223090fce_159308_600x0_resize_q90_h2_box_3.webp 600w,/blog/use-terraform-to-deploy-an-azure-kubernetes-service-aks-cluster-traefik-2-cert-manager-and-lets-encrypt-certificates/cover_hub92c13112e866e68a0ecc70223090fce_159308_700x0_resize_q90_h2_box_3.webp 700w"><img src=/blog/use-terraform-to-deploy-an-azure-kubernetes-service-aks-cluster-traefik-2-cert-manager-and-lets-encrypt-certificates/cover.png srcset="/blog/use-terraform-to-deploy-an-azure-kubernetes-service-aks-cluster-traefik-2-cert-manager-and-lets-encrypt-certificates/cover_hub92c13112e866e68a0ecc70223090fce_159308_300x0_resize_box_3.png 300w,/blog/use-terraform-to-deploy-an-azure-kubernetes-service-aks-cluster-traefik-2-cert-manager-and-lets-encrypt-certificates/cover_hub92c13112e866e68a0ecc70223090fce_159308_400x0_resize_box_3.png 400w,/blog/use-terraform-to-deploy-an-azure-kubernetes-service-aks-cluster-traefik-2-cert-manager-and-lets-encrypt-certificates/cover_hub92c13112e866e68a0ecc70223090fce_159308_500x0_resize_box_3.png 500w,/blog/use-terraform-to-deploy-an-azure-kubernetes-service-aks-cluster-traefik-2-cert-manager-and-lets-encrypt-certificates/cover_hub92c13112e866e68a0ecc70223090fce_159308_600x0_resize_box_3.png 600w,/blog/use-terraform-to-deploy-an-azure-kubernetes-service-aks-cluster-traefik-2-cert-manager-and-lets-encrypt-certificates/cover_hub92c13112e866e68a0ecc70223090fce_159308_700x0_resize_box_3.png 700w" alt loading=lazy width=921 height=482></picture></div></div><div class=post-content><p>In this post, we will deploy a simple <a href=https://azure.microsoft.com/en-us/services/kubernetes-service/ class=link--external target=_blank rel=noreferrer>Azure Kubernetes Service (AKS)</a> cluster from scratch. To expose our web services securely, we will install Traefik 2 and configure <a href=https://cert-manager.io/ class=link--external target=_blank rel=noreferrer>cert-manager</a> to manage Let&rsquo;s Encrypt certificates. The best part about it: we will do everything with <a href=https://www.terraform.io/ class=link--external target=_blank rel=noreferrer>Terraform</a>.</p><h2 id=prerequisites>Prerequisites
<a href=#prerequisites class=post-heading__anchor aria-hidden=true>#</a></h2><p>Keep in mind that I have tested the steps that follow on Windows. So if you are using another OS, you might have to modify them slightly. I also omit some non-essential steps in between, so it helps if you are already familiar with Azure, Kubernetes, and Terraform.</p><p>To follow along, you will need the following things:</p><ul><li><a href=https://azure.microsoft.com/en-us/free/ class=link--external target=_blank rel=noreferrer>An active Azure subscription</a></li><li><a href=https://www.terraform.io/downloads.html class=link--external target=_blank rel=noreferrer>Install Terraform</a></li><li><a href=https://kubernetes.io/docs/tasks/tools/install-kubectl-windows/ class=link--external target=_blank rel=noreferrer>Install kubectl</a></li><li>A registered domain</li><li>A DNS provider:<ul><li>that <a href=https://cert-manager.io/docs/configuration/acme/dns01/#supported-dns01-providers class=link--external target=_blank rel=noreferrer>supports cert-manager DNS01 challenge validation</a></li><li>with API access, so we can manage DNS records with Terraform — I use Cloudflare</li></ul></li></ul><h2 id=overview>Overview
<a href=#overview class=post-heading__anchor aria-hidden=true>#</a></h2><p>Here is an outline of the steps required to build our solution:</p><ol><li><a href=#step-1-setup-terraform>Setup Terraform</a></li><li><a href=#step-2-create-the-aks-cluster>Create the AKS cluster</a></li><li><a href=#step-3-deploy-cert-manager>Deploy cert-manager</a></li><li><a href=#step-4-configure-lets-encrypt-certificates>Configure Let&rsquo;s Encrypt certificates</a></li><li><a href=#step-5-deploy-traefik>Deploy Traefik</a></li><li><a href=#step-6-deploy-a-demo-application>Deploy a demo application</a></li></ol><h2 id=step-1-setup-terraform>Step 1: Setup Terraform
<a href=#step-1-setup-terraform class=post-heading__anchor aria-hidden=true>#</a></h2><p>We will make use of Terraform providers to put everything together:</p><ul><li><a href=https://registry.terraform.io/providers/hashicorp/azurerm/latest class=link--external target=_blank rel=noreferrer><code>azurerm</code></a> to manage our AKS cluster</li><li><a href=https://registry.terraform.io/providers/hashicorp/helm/latest class=link--external target=_blank rel=noreferrer><code>helm</code></a> to deploy cert-manager and Traefik</li><li><a href=https://registry.terraform.io/providers/hashicorp/kubernetes/latest class=link--external target=_blank rel=noreferrer><code>kubernetes</code></a> to manage namespaces and deploy our demo app</li><li><a href=https://registry.terraform.io/providers/cloudflare/cloudflare/latest class=link--external target=_blank rel=noreferrer><code>cloudflare</code></a> to manage DNS records</li></ul><p>We add a <code>provider.tf</code> file with the following content:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-hcl data-lang=hcl><span style=display:flex><span><span style=color:#66d9ef>terraform</span> {
</span></span><span style=display:flex><span>  required_version <span style=color:#f92672>=</span> &#34;<span style=color:#f92672>=</span> <span style=color:#ae81ff>0</span>.<span style=color:#ae81ff>14</span>.<span style=color:#ae81ff>9</span><span style=color:#960050;background-color:#1e0010>&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>required_providers</span> {
</span></span><span style=display:flex><span>    azurerm <span style=color:#f92672>=</span> {
</span></span><span style=display:flex><span>      source  <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;azurerm&#34;</span>
</span></span><span style=display:flex><span>      version <span style=color:#f92672>=</span> &#34;<span style=color:#f92672>=</span><span style=color:#ae81ff>2</span>.<span style=color:#ae81ff>97</span>.<span style=color:#ae81ff>0</span><span style=color:#960050;background-color:#1e0010>&#34;</span>
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    cloudflare <span style=color:#f92672>=</span> {
</span></span><span style=display:flex><span>      source  <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;cloudflare/cloudflare&#34;</span>
</span></span><span style=display:flex><span>      version <span style=color:#f92672>=</span> &#34;<span style=color:#f92672>=</span><span style=color:#ae81ff>3</span>.<span style=color:#ae81ff>9</span>.<span style=color:#ae81ff>1</span><span style=color:#960050;background-color:#1e0010>&#34;</span>
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    helm <span style=color:#f92672>=</span> {
</span></span><span style=display:flex><span>      source  <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;helm&#34;</span>
</span></span><span style=display:flex><span>      version <span style=color:#f92672>=</span> &#34;<span style=color:#f92672>=</span><span style=color:#ae81ff>2</span>.<span style=color:#ae81ff>4</span>.<span style=color:#ae81ff>1</span><span style=color:#960050;background-color:#1e0010>&#34;</span>
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    kubernetes <span style=color:#f92672>=</span> {
</span></span><span style=display:flex><span>      source  <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;kubernetes&#34;</span>
</span></span><span style=display:flex><span>      version <span style=color:#f92672>=</span> &#34;<span style=color:#f92672>=</span><span style=color:#ae81ff>2</span>.<span style=color:#ae81ff>8</span>.<span style=color:#ae81ff>0</span><span style=color:#960050;background-color:#1e0010>&#34;</span>
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>provider</span> <span style=color:#e6db74>&#34;azurerm&#34;</span> {
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>features</span> {}
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>provider</span> <span style=color:#e6db74>&#34;cloudflare&#34;</span> {}
</span></span></code></pre></div><p>For now, we only configured the <code>azurerm</code> and <code>cloudflare</code> providers. After setting up the AKS cluster, we will configure the <code>helm</code> and <code>kubernetes</code> providers.</p><p>I have opted to <a href=https://registry.terraform.io/providers/hashicorp/azurerm/latest/docs/guides/service_principal_client_secret#configuring-the-service-principal-in-terraform class=link--external target=_blank rel=noreferrer>configure the <code>azurerm</code> provider with environment variables</a>. You might want to <a href=https://registry.terraform.io/providers/hashicorp/azurerm/latest/docs#authenticating-to-azure class=link--external target=_blank rel=noreferrer>choose a different approach</a> depending on your needs.</p><p>To authenticate the <code>cloudflare</code> provider, I use a <a href=https://developers.cloudflare.com/api/tokens/create class=link--external target=_blank rel=noreferrer>Cloudflare API Token</a> with <code>Edit Zone</code> permissions.</p><p>After, we make sure to run <code>terraform init</code> to get started.</p><h2 id=step-2-create-the-aks-cluster>Step 2: Create the AKS cluster
<a href=#step-2-create-the-aks-cluster class=post-heading__anchor aria-hidden=true>#</a></h2><p>Creating a production-ready AKS cluster is out of scope for this post, which means that we will not delve too deep into AKS configuration. There are many things we are skipping over, like <a href=https://docs.microsoft.com/en-us/azure/aks/operator-best-practices-storage class=link--external target=_blank rel=noreferrer>backups</a> and <a href=https://docs.microsoft.com/en-us/azure/azure-monitor/containers/container-insights-overview class=link--external target=_blank rel=noreferrer>monitoring</a>. For a little more elaborate example, check out the <a href=https://docs.microsoft.com/en-us/azure/developer/terraform/create-k8s-cluster-with-tf-and-aks class=link--external target=_blank rel=noreferrer>official Terraform on Azure documentation</a>.</p><p>We create a new file <code>k8s.tf</code> with the following content:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-hcl data-lang=hcl><span style=display:flex><span><span style=color:#66d9ef>resource</span> <span style=color:#e6db74>&#34;azurerm_resource_group&#34; &#34;k8s&#34;</span> {
</span></span><span style=display:flex><span>  name     <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;k8s-rg&#34;</span>
</span></span><span style=display:flex><span>  location <span style=color:#f92672>=</span> <span style=color:#66d9ef>var</span>.<span style=color:#66d9ef>location</span>
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>resource</span> <span style=color:#e6db74>&#34;random_id&#34; &#34;random&#34;</span> {
</span></span><span style=display:flex><span>  byte_length <span style=color:#f92672>=</span> <span style=color:#ae81ff>2</span>
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>resource</span> <span style=color:#e6db74>&#34;azurerm_kubernetes_cluster&#34; &#34;k8s&#34;</span> {
</span></span><span style=display:flex><span>  name                <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;k8s-aks&#34;</span>
</span></span><span style=display:flex><span>  resource_group_name <span style=color:#f92672>=</span> <span style=color:#66d9ef>azurerm_resource_group</span>.<span style=color:#66d9ef>k8s</span>.<span style=color:#66d9ef>name</span>
</span></span><span style=display:flex><span>  location            <span style=color:#f92672>=</span> <span style=color:#66d9ef>var</span>.<span style=color:#66d9ef>location</span>
</span></span><span style=display:flex><span>  tags                <span style=color:#f92672>=</span> <span style=color:#66d9ef>var</span>.<span style=color:#66d9ef>tags</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  dns_prefix <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;k8saks${random_id.random.dec}&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>default_node_pool</span> {
</span></span><span style=display:flex><span>    name       <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;default&#34;</span>
</span></span><span style=display:flex><span>    node_count <span style=color:#f92672>=</span> <span style=color:#ae81ff>1</span>
</span></span><span style=display:flex><span>    vm_size    <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;Standard_B2ms&#34;</span>
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>identity</span> {
</span></span><span style=display:flex><span>    type <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;SystemAssigned&#34;</span>
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>Note that I have defined the <code>var.location</code> and <code>var.tags</code> variables in a separate <a href=https://github.com/schnerring/infrastructure-core/blob/v0.1.0/variables.tf class=link--external target=_blank rel=noreferrer>variables.tf</a> file.</p><p>To be able to access the AKS cluster locally with <code>kubectl</code>, we define a Terraform <a href=https://www.terraform.io/docs/language/values/outputs.html class=link--external target=_blank rel=noreferrer><code>output</code></a> in the <code>outputs.tf</code> file:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-hcl data-lang=hcl><span style=display:flex><span><span style=color:#66d9ef>output</span> <span style=color:#e6db74>&#34;kube_config&#34;</span> {
</span></span><span style=display:flex><span>  value       <span style=color:#f92672>=</span> <span style=color:#66d9ef>azurerm_kubernetes_cluster</span>.<span style=color:#66d9ef>k8s</span>.<span style=color:#66d9ef>kube_config_raw</span>
</span></span><span style=display:flex><span>  description <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;kubeconfig for kubectl access.&#34;</span>
</span></span><span style=display:flex><span>  sensitive   <span style=color:#f92672>=</span> <span style=color:#66d9ef>true</span>
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>We have to set <code>sensitive = true</code> so our credentials will not get leaked, which could happen if we later decide to run Terraform with GitHub Actions. We apply our configuration by running Terraform:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>terraform plan -out infrastructure.tfplan
</span></span><span style=display:flex><span>terraform apply infrastructure.tfplan
</span></span></code></pre></div><p>After the deployment completes, we set up <code>kubectl</code> to be able to access our cluster:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>terraform output -raw kube_config &gt; ~/.kube/config
</span></span></code></pre></div><p>We check the deployment by running <code>kubectl get all</code>:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-text data-lang=text><span style=display:flex><span>NAME                 TYPE        CLUSTER-IP   EXTERNAL-IP   PORT(S)   AGE
</span></span><span style=display:flex><span>service/kubernetes   ClusterIP   10.0.0.1     &lt;none&gt;        443/TCP   3m54s
</span></span></code></pre></div><h2 id=step-3-deploy-cert-manager>Step 3: Deploy cert-manager
<a href=#step-3-deploy-cert-manager class=post-heading__anchor aria-hidden=true>#</a></h2><p>To issue free <a href=https://letsencrypt.org/ class=link--external target=_blank rel=noreferrer>Let&rsquo;s Encrypt</a> certificates for the web services we provide, the first thing we have to deploy is <a href=https://cert-manager.io/docs/installation/kubernetes/#installing-with-helm class=link--external target=_blank rel=noreferrer>cert-manager</a>. We need to configure the <a href=https://registry.terraform.io/providers/hashicorp/helm/latest/docs#credentials-config class=link--external target=_blank rel=noreferrer><code>helm</code></a> provider first. While we are on it, we also configure the <a href=https://registry.terraform.io/providers/hashicorp/kubernetes/latest/docs#authentication class=link--external target=_blank rel=noreferrer><code>kubernetes</code></a> provider:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-hcl data-lang=hcl><span style=display:flex><span><span style=color:#66d9ef>provider</span> <span style=color:#e6db74>&#34;helm&#34;</span> {
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>kubernetes</span> {
</span></span><span style=display:flex><span>    host <span style=color:#f92672>=</span> <span style=color:#66d9ef>azurerm_kubernetes_cluster</span>.<span style=color:#66d9ef>k8s</span>.<span style=color:#66d9ef>kube_config</span>.<span style=color:#ae81ff>0</span>.<span style=color:#66d9ef>host</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    client_certificate     <span style=color:#f92672>=</span> <span style=color:#66d9ef>base64decode</span>(<span style=color:#66d9ef>azurerm_kubernetes_cluster</span>.<span style=color:#66d9ef>k8s</span>.<span style=color:#66d9ef>kube_config</span>.<span style=color:#ae81ff>0</span>.<span style=color:#66d9ef>client_certificate</span>)
</span></span><span style=display:flex><span>    client_key             <span style=color:#f92672>=</span> <span style=color:#66d9ef>base64decode</span>(<span style=color:#66d9ef>azurerm_kubernetes_cluster</span>.<span style=color:#66d9ef>k8s</span>.<span style=color:#66d9ef>kube_config</span>.<span style=color:#ae81ff>0</span>.<span style=color:#66d9ef>client_key</span>)
</span></span><span style=display:flex><span>    cluster_ca_certificate <span style=color:#f92672>=</span> <span style=color:#66d9ef>base64decode</span>(<span style=color:#66d9ef>azurerm_kubernetes_cluster</span>.<span style=color:#66d9ef>k8s</span>.<span style=color:#66d9ef>kube_config</span>.<span style=color:#ae81ff>0</span>.<span style=color:#66d9ef>cluster_ca_certificate</span>)
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>provider</span> <span style=color:#e6db74>&#34;kubernetes&#34;</span> {
</span></span><span style=display:flex><span>  host <span style=color:#f92672>=</span> <span style=color:#66d9ef>azurerm_kubernetes_cluster</span>.<span style=color:#66d9ef>k8s</span>.<span style=color:#66d9ef>kube_config</span>.<span style=color:#ae81ff>0</span>.<span style=color:#66d9ef>host</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  client_certificate     <span style=color:#f92672>=</span> <span style=color:#66d9ef>base64decode</span>(<span style=color:#66d9ef>azurerm_kubernetes_cluster</span>.<span style=color:#66d9ef>k8s</span>.<span style=color:#66d9ef>kube_config</span>.<span style=color:#ae81ff>0</span>.<span style=color:#66d9ef>client_certificate</span>)
</span></span><span style=display:flex><span>  client_key             <span style=color:#f92672>=</span> <span style=color:#66d9ef>base64decode</span>(<span style=color:#66d9ef>azurerm_kubernetes_cluster</span>.<span style=color:#66d9ef>k8s</span>.<span style=color:#66d9ef>kube_config</span>.<span style=color:#ae81ff>0</span>.<span style=color:#66d9ef>client_key</span>)
</span></span><span style=display:flex><span>  cluster_ca_certificate <span style=color:#f92672>=</span> <span style=color:#66d9ef>base64decode</span>(<span style=color:#66d9ef>azurerm_kubernetes_cluster</span>.<span style=color:#66d9ef>k8s</span>.<span style=color:#66d9ef>kube_config</span>.<span style=color:#ae81ff>0</span>.<span style=color:#66d9ef>cluster_ca_certificate</span>)
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>Stacking the providers above with our managed Kubernetes cluster resources can lead to errors and <a href=https://registry.terraform.io/providers/hashicorp/kubernetes/latest/docs#stacking-with-managed-kubernetes-cluster-resources class=link--external target=_blank rel=noreferrer>should be avoided</a>. I will mention this once more at the <a href=#one-last-thing>end of the post</a>.</p><p>Next, we deploy cert-manager with Helm by adding the following Terraform code to the <code>k8s.tf</code> file:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-hcl data-lang=hcl><span style=display:flex><span><span style=color:#66d9ef>resource</span> <span style=color:#e6db74>&#34;kubernetes_namespace&#34; &#34;cert_manager&#34;</span> {
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>metadata</span> {
</span></span><span style=display:flex><span>    name <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;cert-manager&#34;</span>
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>resource</span> <span style=color:#e6db74>&#34;helm_release&#34; &#34;cert_manager&#34;</span> {
</span></span><span style=display:flex><span>  name       <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;cert-manager&#34;</span>
</span></span><span style=display:flex><span>  repository <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;https://charts.jetstack.io&#34;</span>
</span></span><span style=display:flex><span>  chart      <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;cert-manager&#34;</span>
</span></span><span style=display:flex><span>  version    <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;v1.7.1&#34;</span>
</span></span><span style=display:flex><span>  namespace  <span style=color:#f92672>=</span> <span style=color:#66d9ef>kubernetes_namespace</span>.<span style=color:#66d9ef>cert_manager</span>.<span style=color:#66d9ef>metadata</span>.<span style=color:#ae81ff>0</span>.<span style=color:#66d9ef>name</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>set</span> {
</span></span><span style=display:flex><span>    name  <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;installCRDs&#34;</span>
</span></span><span style=display:flex><span>    value <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;true&#34;</span>
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>We then run <code>terraform apply</code> to deploy cert-manager. We then check our work by running <code>kubectl get all --namespace cert-manager</code>, which should display something like this:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-text data-lang=text><span style=display:flex><span>NAME                                           READY   STATUS    RESTARTS   AGE
</span></span><span style=display:flex><span>pod/cert-manager-7998c69865-vrvrd              1/1     Running   0          75s
</span></span><span style=display:flex><span>pod/cert-manager-cainjector-7b744d56fb-qb54k   1/1     Running   0          75s
</span></span><span style=display:flex><span>pod/cert-manager-webhook-7d6d4c78bc-svzq5      1/1     Running   0          75s
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>NAME                           TYPE        CLUSTER-IP    EXTERNAL-IP   PORT(S)    AGE
</span></span><span style=display:flex><span>service/cert-manager           ClusterIP   10.0.141.59   &lt;none&gt;        9402/TCP   75s
</span></span><span style=display:flex><span>service/cert-manager-webhook   ClusterIP   10.0.18.192   &lt;none&gt;        443/TCP    75s
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>NAME                                      READY   UP-TO-DATE   AVAILABLE   AGE
</span></span><span style=display:flex><span>deployment.apps/cert-manager              1/1     1            1           75s
</span></span><span style=display:flex><span>deployment.apps/cert-manager-cainjector   1/1     1            1           75s
</span></span><span style=display:flex><span>deployment.apps/cert-manager-webhook      1/1     1            1           75s
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>NAME                                                 DESIRED   CURRENT   READY   AGE
</span></span><span style=display:flex><span>replicaset.apps/cert-manager-7998c69865              1         1         1       75s
</span></span><span style=display:flex><span>replicaset.apps/cert-manager-cainjector-7b744d56fb   1         1         1       75s
</span></span><span style=display:flex><span>replicaset.apps/cert-manager-webhook-7d6d4c78bc      1         1         1       75s
</span></span></code></pre></div><h2 id=step-4-configure-lets-encrypt-certificates>Step 4: Configure Let&rsquo;s Encrypt Certificates
<a href=#step-4-configure-lets-encrypt-certificates class=post-heading__anchor aria-hidden=true>#</a></h2><p>In Kubernetes, <code>Issuer</code>s are Kubernetes resources representing certificate authorities able to generate certificates. We have to create a single <code>ClusterIssuer</code>, a cluster-wide <code>Issuer</code>, using <a href=https://cert-manager.io/docs/configuration/acme/dns01/ class=link--external target=_blank rel=noreferrer>DNS01 challenge validation</a> with Let&rsquo;s Encrypt servers. As mentioned earlier, we will use Cloudflare, but <a href=https://cert-manager.io/docs/configuration/acme/dns01/#supported-dns01-providers class=link--external target=_blank rel=noreferrer>many other DNS providers are supported</a>.</p><p>First, we need to create a Cloudflare API Token on the Cloudflare website, at <code>User Profile</code> → <code>API Tokens</code>. <a href=https://cert-manager.io/docs/configuration/acme/dns01/cloudflare/#api-tokens class=link--external target=_blank rel=noreferrer>The following permissions are required</a>:</p><ul><li><code>Zone</code> - <code>DNS</code> - <code>Edit</code></li><li><code>Zone</code> - <code>Zone</code> - <code>Read</code></li></ul><p>To securely pass the token to Terraform, we create a <code>sensitive</code> variable. We also add a variable containing the email address where Let&rsquo;s Encrypt can notify us about expiring certificates:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-hcl data-lang=hcl><span style=display:flex><span><span style=color:#66d9ef>variable</span> <span style=color:#e6db74>&#34;letsencrypt_email&#34;</span> {
</span></span><span style=display:flex><span>  type        <span style=color:#f92672>=</span> <span style=color:#66d9ef>string</span>
</span></span><span style=display:flex><span>  description <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;Email address that Let&#39;s Encrypt will use to send notifications about expiring certificates and account-related issues to.&#34;</span>
</span></span><span style=display:flex><span>  sensitive   <span style=color:#f92672>=</span> <span style=color:#66d9ef>true</span>
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>variable</span> <span style=color:#e6db74>&#34;letsencrypt_cloudflare_api_token&#34;</span> {
</span></span><span style=display:flex><span>  type        <span style=color:#f92672>=</span> <span style=color:#66d9ef>string</span>
</span></span><span style=display:flex><span>  description <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;Cloudflare API token with Zone-DNS-Edit and Zone-Zone-Read permissions, which is required for DNS01 challenge validation.&#34;</span>
</span></span><span style=display:flex><span>  sensitive   <span style=color:#f92672>=</span> <span style=color:#66d9ef>true</span>
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>With Terraform, we then add the secret containing the API token to our cluster. Since <code>ClusterIssuer</code> is a cluster-scoped resource, we need to make sure the secret is globally available by putting it in the <code>cert-manager</code> namespace:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-hcl data-lang=hcl><span style=display:flex><span><span style=color:#66d9ef>resource</span> <span style=color:#e6db74>&#34;kubernetes_secret&#34; &#34;letsencrypt_cloudflare_api_token_secret&#34;</span> {
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>metadata</span> {
</span></span><span style=display:flex><span>    name      <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;letsencrypt-cloudflare-api-token-secret&#34;</span>
</span></span><span style=display:flex><span>    namespace <span style=color:#f92672>=</span> <span style=color:#66d9ef>kubernetes_namespace</span>.<span style=color:#66d9ef>cert_manager</span>.<span style=color:#66d9ef>metadata</span>.<span style=color:#ae81ff>0</span>.<span style=color:#66d9ef>name</span>
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  data <span style=color:#f92672>=</span> {
</span></span><span style=display:flex><span>    &#34;api-token&#34; <span style=color:#f92672>=</span> <span style=color:#66d9ef>var</span>.<span style=color:#66d9ef>letsencrypt_cloudflare_api_token</span>
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>Next, we add the staging and production <code>ClusterIssuer</code> cert-manager CRD resources that use Let&rsquo;s Encrypt servers. We will have to use regular Kubernetes YAML manifests since we cannot deploy CRDs with the <code>kubernetes</code> provider. Here, the <a href=https://registry.terraform.io/providers/hashicorp/kubernetes/latest/docs/resources/manifest class=link--external target=_blank rel=noreferrer><code>kubernetes_manifest</code></a> resource comes in. Together with the Terraform <a href=https://www.terraform.io/docs/language/functions/yamldecode.html class=link--external target=_blank rel=noreferrer><code>yamldecode()</code></a> and <a href=https://www.terraform.io/docs/language/functions/templatefile.html class=link--external target=_blank rel=noreferrer><code>templatefile()</code></a> functions, we get a pretty nice solution.</p><p>Let&rsquo;s start by defining the <code>letsencrypt-issuer.tpl.yaml</code> template file:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#f92672>apiVersion</span>: <span style=color:#ae81ff>cert-manager.io/v1</span>
</span></span><span style=display:flex><span><span style=color:#f92672>kind</span>: <span style=color:#ae81ff>ClusterIssuer</span>
</span></span><span style=display:flex><span><span style=color:#f92672>metadata</span>:
</span></span><span style=display:flex><span>  <span style=color:#f92672>name</span>: <span style=color:#ae81ff>${name}</span>
</span></span><span style=display:flex><span><span style=color:#f92672>spec</span>:
</span></span><span style=display:flex><span>  <span style=color:#f92672>acme</span>:
</span></span><span style=display:flex><span>    <span style=color:#f92672>email</span>: <span style=color:#ae81ff>${email}</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>server</span>: <span style=color:#ae81ff>${server}</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>privateKeySecretRef</span>:
</span></span><span style=display:flex><span>      <span style=color:#f92672>name</span>: <span style=color:#ae81ff>issuer-account-key-${name}</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>solvers</span>:
</span></span><span style=display:flex><span>      - <span style=color:#f92672>dns01</span>:
</span></span><span style=display:flex><span>          <span style=color:#f92672>cloudflare</span>:
</span></span><span style=display:flex><span>            <span style=color:#f92672>apiTokenSecretRef</span>:
</span></span><span style=display:flex><span>              <span style=color:#f92672>name</span>: <span style=color:#ae81ff>${api_token_secret_name}</span>
</span></span><span style=display:flex><span>              <span style=color:#f92672>key</span>: <span style=color:#ae81ff>${api_token_secret_data_key}</span>
</span></span></code></pre></div><p>We then create the staging and production <code>ClusterIssuer</code>s like so:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-hcl data-lang=hcl><span style=display:flex><span><span style=color:#66d9ef>resource</span> <span style=color:#e6db74>&#34;kubernetes_manifest&#34; &#34;letsencrypt_issuer_staging&#34;</span> {
</span></span><span style=display:flex><span>  manifest <span style=color:#f92672>=</span> <span style=color:#66d9ef>yamldecode</span>(<span style=color:#66d9ef>templatefile</span>(
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#34;${path.module}/letsencrypt-issuer.tpl.yaml&#34;</span>,
</span></span><span style=display:flex><span>    {
</span></span><span style=display:flex><span>      &#34;name&#34;                      <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;letsencrypt-staging&#34;</span>
</span></span><span style=display:flex><span>      &#34;email&#34;                     <span style=color:#f92672>=</span> <span style=color:#66d9ef>var</span>.<span style=color:#66d9ef>letsencrypt_email</span>
</span></span><span style=display:flex><span>      &#34;server&#34;                    <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;https://acme-staging-v02.api.letsencrypt.org/directory&#34;</span>
</span></span><span style=display:flex><span>      &#34;api_token_secret_name&#34;     <span style=color:#f92672>=</span> <span style=color:#66d9ef>kubernetes_secret</span>.<span style=color:#66d9ef>letsencrypt_cloudflare_api_token_secret</span>.<span style=color:#66d9ef>metadata</span>.<span style=color:#ae81ff>0</span>.<span style=color:#66d9ef>name</span>
</span></span><span style=display:flex><span>      &#34;api_token_secret_data_key&#34; <span style=color:#f92672>=</span> <span style=color:#66d9ef>keys</span>(<span style=color:#66d9ef>kubernetes_secret</span>.<span style=color:#66d9ef>letsencrypt_cloudflare_api_token_secret</span>.<span style=color:#66d9ef>data</span>).<span style=color:#ae81ff>0</span>
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>  ))
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  depends_on <span style=color:#f92672>=</span> [<span style=color:#66d9ef>helm_release</span>.<span style=color:#66d9ef>cert_manager</span>]
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>resource</span> <span style=color:#e6db74>&#34;kubernetes_manifest&#34; &#34;letsencrypt_issuer_production&#34;</span> {
</span></span><span style=display:flex><span>  manifest <span style=color:#f92672>=</span> <span style=color:#66d9ef>yamldecode</span>(<span style=color:#66d9ef>templatefile</span>(
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#34;${path.module}/letsencrypt-issuer.tpl.yaml&#34;</span>,
</span></span><span style=display:flex><span>    {
</span></span><span style=display:flex><span>      &#34;name&#34;                      <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;letsencrypt-production&#34;</span>
</span></span><span style=display:flex><span>      &#34;email&#34;                     <span style=color:#f92672>=</span> <span style=color:#66d9ef>var</span>.<span style=color:#66d9ef>letsencrypt_email</span>
</span></span><span style=display:flex><span>      &#34;server&#34;                    <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;https://acme-v02.api.letsencrypt.org/directory&#34;</span>
</span></span><span style=display:flex><span>      &#34;api_token_secret_name&#34;     <span style=color:#f92672>=</span> <span style=color:#66d9ef>kubernetes_secret</span>.<span style=color:#66d9ef>letsencrypt_cloudflare_api_token_secret</span>.<span style=color:#66d9ef>metadata</span>.<span style=color:#ae81ff>0</span>.<span style=color:#66d9ef>name</span>
</span></span><span style=display:flex><span>      &#34;api_token_secret_data_key&#34; <span style=color:#f92672>=</span> <span style=color:#66d9ef>keys</span>(<span style=color:#66d9ef>kubernetes_secret</span>.<span style=color:#66d9ef>letsencrypt_cloudflare_api_token_secret</span>.<span style=color:#66d9ef>data</span>).<span style=color:#ae81ff>0</span>
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>  ))
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  depends_on <span style=color:#f92672>=</span> [<span style=color:#66d9ef>helm_release</span>.<span style=color:#66d9ef>cert_manager</span>]
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>Now we <code>terraform apply</code> the changes.</p><h2 id=step-5-deploy-traefik>Step 5: Deploy Traefik
<a href=#step-5-deploy-traefik class=post-heading__anchor aria-hidden=true>#</a></h2><p>To manage external access to our Kubernetes cluster, we need to configure Kubernetes <a href=https://kubernetes.io/docs/concepts/services-networking/ingress/ class=link--external target=_blank rel=noreferrer><code>Ingress</code> resources</a>. To satisfy an <code>Ingress</code>, we first need to configure an <a href=https://kubernetes.io/docs/concepts/services-networking/ingress-controllers/ class=link--external target=_blank rel=noreferrer>Ingress Controller</a>. We will use Traefik for this.</p><p>To manage ingress, we could also use the Traefik <code>IngressRoute</code> CRD. At the time of this writing, <a href=https://doc.traefik.io/traefik/providers/kubernetes-crd/#letsencrypt-support-with-the-custom-resource-definition-provider class=link--external target=_blank rel=noreferrer>cert-manager cannot directly interface with Traefik CRDs</a>, so we would have to manage <code>Certificate</code> and <code>Secret</code> resources manually, which is cumbersome.</p><p>We add the following to the <code>k8s.tf</code> file:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-hcl data-lang=hcl><span style=display:flex><span><span style=color:#66d9ef>resource</span> <span style=color:#e6db74>&#34;kubernetes_namespace&#34; &#34;traefik&#34;</span> {
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>metadata</span> {
</span></span><span style=display:flex><span>    name <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;traefik&#34;</span>
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>resource</span> <span style=color:#e6db74>&#34;helm_release&#34; &#34;traefik&#34;</span> {
</span></span><span style=display:flex><span>  name       <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;traefik&#34;</span>
</span></span><span style=display:flex><span>  repository <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;https://helm.traefik.io/traefik&#34;</span>
</span></span><span style=display:flex><span>  chart      <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;traefik&#34;</span>
</span></span><span style=display:flex><span>  version    <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;10.14.2&#34;</span>
</span></span><span style=display:flex><span>  namespace  <span style=color:#f92672>=</span> <span style=color:#66d9ef>kubernetes_namespace</span>.<span style=color:#66d9ef>traefik</span>.<span style=color:#66d9ef>metadata</span>.<span style=color:#ae81ff>0</span>.<span style=color:#66d9ef>name</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>set</span> {
</span></span><span style=display:flex><span>    name  <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;ports.web.redirectTo&#34;</span>
</span></span><span style=display:flex><span>    value <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;websecure&#34;</span>
</span></span><span style=display:flex><span>  }<span style=color:#75715e>
</span></span></span><span style=display:flex><span><span style=color:#75715e>
</span></span></span><span style=display:flex><span><span style=color:#75715e>  # Trust private AKS IP range
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>  <span style=color:#66d9ef>set</span> {
</span></span><span style=display:flex><span>    name  <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;additionalArguments&#34;</span>
</span></span><span style=display:flex><span>    value <span style=color:#f92672>=</span> &#34;{--entryPoints.websecure.forwardedHeaders.trustedIPs<span style=color:#f92672>=</span><span style=color:#ae81ff>10</span>.<span style=color:#ae81ff>0</span>.<span style=color:#ae81ff>0</span>.<span style=color:#ae81ff>0</span><span style=color:#960050;background-color:#1e0010>/</span><span style=color:#ae81ff>8</span>}<span style=color:#960050;background-color:#1e0010>&#34;</span>
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>Setting <code>ports.web.redirectTo</code> to <code>websecure</code> forces all HTTP traffic to be redirected to HTTPS.</p><p>To <a href=https://doc.traefik.io/traefik/v2.3/routing/entrypoints/#forwarded-headers class=link--external target=_blank rel=noreferrer>configure Traefik to trust forwarded headers</a> from Azure, we set <code>entryPoints.websecure.forwardedHeaders.trustedIPs=10.0.0.0/8</code>.</p><p>After running <code>terraform apply</code>, we check the deployment by running <code>kubectl get all --namespace traefik</code>:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-text data-lang=text><span style=display:flex><span>NAME                           READY   STATUS    RESTARTS   AGE
</span></span><span style=display:flex><span>pod/traefik-6b6767d778-hxzzw   1/1     Running   0          68s
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>NAME              TYPE           CLUSTER-IP   EXTERNAL-IP      PORT(S)                      AGE
</span></span><span style=display:flex><span>service/traefik   LoadBalancer   10.0.247.4   51.103.157.225   80:32468/TCP,443:31284/TCP   69s
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>NAME                      READY   UP-TO-DATE   AVAILABLE   AGE
</span></span><span style=display:flex><span>deployment.apps/traefik   1/1     1            1           69s
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>NAME                                 DESIRED   CURRENT   READY   AGE
</span></span><span style=display:flex><span>replicaset.apps/traefik-6b6767d778   1         1         1       69s
</span></span></code></pre></div><p>Next, we add a DNS record with the IP of our Traefik service. To obtain the external IP address of the service, we leverage the <code>kubernetes_service</code> <a href=https://www.terraform.io/docs/language/data-sources/index.html class=link--external target=_blank rel=noreferrer>Data Source</a> of the <code>kubernetes</code> provider. We then add the DNS record <code>k8s.schnerring.net</code> pointing to the external IP of Traefik.</p><p>Let us update the <code>k8s.tf</code> file accordingly and <code>terraform apply</code> the changes:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-hcl data-lang=hcl><span style=display:flex><span><span style=color:#66d9ef>data</span> <span style=color:#e6db74>&#34;kubernetes_service&#34; &#34;traefik&#34;</span> {
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>metadata</span> {
</span></span><span style=display:flex><span>    name      <span style=color:#f92672>=</span> <span style=color:#66d9ef>helm_release</span>.<span style=color:#66d9ef>traefik</span>.<span style=color:#66d9ef>name</span>
</span></span><span style=display:flex><span>    namespace <span style=color:#f92672>=</span> <span style=color:#66d9ef>helm_release</span>.<span style=color:#66d9ef>traefik</span>.<span style=color:#66d9ef>namespace</span>
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>resource</span> <span style=color:#e6db74>&#34;cloudflare_record&#34; &#34;traefik&#34;</span> {
</span></span><span style=display:flex><span>  zone_id <span style=color:#f92672>=</span> <span style=color:#66d9ef>cloudflare_zone</span>.<span style=color:#66d9ef>schnerring_net</span>.<span style=color:#66d9ef>id</span>
</span></span><span style=display:flex><span>  name    <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;k8s&#34;</span>
</span></span><span style=display:flex><span>  type    <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;A&#34;</span>
</span></span><span style=display:flex><span>  value   <span style=color:#f92672>=</span> <span style=color:#66d9ef>data</span>.<span style=color:#66d9ef>kubernetes_service</span>.<span style=color:#66d9ef>traefik</span>.<span style=color:#66d9ef>status</span>.<span style=color:#ae81ff>0</span>.<span style=color:#66d9ef>load_balancer</span>.<span style=color:#ae81ff>0</span>.<span style=color:#66d9ef>ingress</span>.<span style=color:#ae81ff>0</span>.<span style=color:#66d9ef>ip</span>
</span></span><span style=display:flex><span>  proxied <span style=color:#f92672>=</span> <span style=color:#66d9ef>true</span>
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>How awesome is that?</p><h2 id=step-6-deploy-a-demo-application>Step 6: Deploy a Demo Application
<a href=#step-6-deploy-a-demo-application class=post-heading__anchor aria-hidden=true>#</a></h2><p>We are almost at the finish line. All that is missing is reaping the fruit of our hard labor. To create a simple demo, we will use the <a href=https://hub.docker.com/r/nginxdemos/hello/ class=link--external target=_blank rel=noreferrer>nginxdemos/hello</a> image and make it available at <code>https://hello.k8s.schnerring.net/</code>.</p><blockquote><p>I moved the demo to <a href=https://hello.schnerring.net class=link--external target=_blank rel=noreferrer>https://hello.schnerring.net</a>. I put my AKS cluster behind Cloudflare and the free universal SSL certificate only supports subdomains (<code>sub.schnerring.net</code>) but not subsubdomains (<code>sub.sub.schnerring.net</code>).</p></blockquote><p>To make it happen, we add a <code>kubernetes_namespace</code>, <code>kubernetes_deployment</code>, <code>kubernetes_service</code>, and <code>kubernetes_ingress</code> resource to a new <code>hello.tf</code> file:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-hcl data-lang=hcl><span style=display:flex><span><span style=color:#66d9ef>resource</span> <span style=color:#e6db74>&#34;kubernetes_namespace&#34; &#34;hello&#34;</span> {
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>metadata</span> {
</span></span><span style=display:flex><span>    name <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;hello&#34;</span>
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>resource</span> <span style=color:#e6db74>&#34;kubernetes_deployment&#34; &#34;hello&#34;</span> {
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>metadata</span> {
</span></span><span style=display:flex><span>    name      <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;hello-deploy&#34;</span>
</span></span><span style=display:flex><span>    namespace <span style=color:#f92672>=</span> <span style=color:#66d9ef>kubernetes_namespace</span>.<span style=color:#66d9ef>hello</span>.<span style=color:#66d9ef>metadata</span>.<span style=color:#ae81ff>0</span>.<span style=color:#66d9ef>name</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    labels <span style=color:#f92672>=</span> {
</span></span><span style=display:flex><span>      app <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;hello&#34;</span>
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>spec</span> {
</span></span><span style=display:flex><span>    replicas <span style=color:#f92672>=</span> <span style=color:#ae81ff>2</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>selector</span> {
</span></span><span style=display:flex><span>      match_labels <span style=color:#f92672>=</span> {
</span></span><span style=display:flex><span>        app <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;hello&#34;</span>
</span></span><span style=display:flex><span>      }
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>template</span> {
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>metadata</span> {
</span></span><span style=display:flex><span>        labels <span style=color:#f92672>=</span> {
</span></span><span style=display:flex><span>          app <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;hello&#34;</span>
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>      }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>spec</span> {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>container</span> {
</span></span><span style=display:flex><span>          image <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;nginxdemos/hello&#34;</span>
</span></span><span style=display:flex><span>          name  <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;hello&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>          <span style=color:#66d9ef>port</span> {
</span></span><span style=display:flex><span>            container_port <span style=color:#f92672>=</span> <span style=color:#ae81ff>80</span>
</span></span><span style=display:flex><span>          }
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>      }
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>resource</span> <span style=color:#e6db74>&#34;kubernetes_service&#34; &#34;hello&#34;</span> {
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>metadata</span> {
</span></span><span style=display:flex><span>    name      <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;hello-svc&#34;</span>
</span></span><span style=display:flex><span>    namespace <span style=color:#f92672>=</span> <span style=color:#66d9ef>kubernetes_namespace</span>.<span style=color:#66d9ef>hello</span>.<span style=color:#66d9ef>metadata</span>.<span style=color:#ae81ff>0</span>.<span style=color:#66d9ef>name</span>
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>spec</span> {
</span></span><span style=display:flex><span>    selector <span style=color:#f92672>=</span> {
</span></span><span style=display:flex><span>      app <span style=color:#f92672>=</span> <span style=color:#66d9ef>kubernetes_deployment</span>.<span style=color:#66d9ef>hello</span>.<span style=color:#66d9ef>metadata</span>.<span style=color:#ae81ff>0</span>.<span style=color:#66d9ef>labels</span>.<span style=color:#66d9ef>app</span>
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>port</span> {
</span></span><span style=display:flex><span>      port        <span style=color:#f92672>=</span> <span style=color:#ae81ff>80</span>
</span></span><span style=display:flex><span>      target_port <span style=color:#f92672>=</span> <span style=color:#ae81ff>80</span>
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>resource</span> <span style=color:#e6db74>&#34;kubernetes_ingress_v1&#34; &#34;hello&#34;</span> {
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>metadata</span> {
</span></span><span style=display:flex><span>    name      <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;hello-ing&#34;</span>
</span></span><span style=display:flex><span>    namespace <span style=color:#f92672>=</span> <span style=color:#66d9ef>kubernetes_namespace</span>.<span style=color:#66d9ef>hello</span>.<span style=color:#66d9ef>metadata</span>.<span style=color:#ae81ff>0</span>.<span style=color:#66d9ef>name</span>
</span></span><span style=display:flex><span>    annotations <span style=color:#f92672>=</span> {
</span></span><span style=display:flex><span>      &#34;cert-manager.io/cluster-issuer&#34;           <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;letsencrypt-staging&#34;</span>
</span></span><span style=display:flex><span>      &#34;traefik.ingress.kubernetes.io/router.tls&#34; <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;true&#34;</span>
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>spec</span> {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>rule</span> {
</span></span><span style=display:flex><span>      host <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;hello.k8s.schnerring.net&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>http</span> {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>path</span> {
</span></span><span style=display:flex><span>          path <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;/&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>          <span style=color:#66d9ef>backend</span> {
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>service</span> {
</span></span><span style=display:flex><span>              name <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;hello-svc&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>              <span style=color:#66d9ef>port</span> {
</span></span><span style=display:flex><span>                number <span style=color:#f92672>=</span> <span style=color:#ae81ff>80</span>
</span></span><span style=display:flex><span>              }
</span></span><span style=display:flex><span>            }
</span></span><span style=display:flex><span>          }
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>      }
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>tls</span> {
</span></span><span style=display:flex><span>      hosts       <span style=color:#f92672>=</span> [<span style=color:#e6db74>&#34;hello.k8s.schnerring.net&#34;</span>]
</span></span><span style=display:flex><span>      secret_name <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;hello-tls-secret&#34;</span>
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>After running <code>terraform apply</code> again, we should be able to visit the demo site <code>https://hello.k8s.schnerring.net/</code>:</p><p><picture><source srcset="/blog/use-terraform-to-deploy-an-azure-kubernetes-service-aks-cluster-traefik-2-cert-manager-and-lets-encrypt-certificates/nginx-demo_hu7a98c42d9313c7f5293a33b35b37539b_27633_300x0_resize_q90_h2_box_3.webp 300w,/blog/use-terraform-to-deploy-an-azure-kubernetes-service-aks-cluster-traefik-2-cert-manager-and-lets-encrypt-certificates/nginx-demo_hu7a98c42d9313c7f5293a33b35b37539b_27633_400x0_resize_q90_h2_box_3.webp 400w,/blog/use-terraform-to-deploy-an-azure-kubernetes-service-aks-cluster-traefik-2-cert-manager-and-lets-encrypt-certificates/nginx-demo_hu7a98c42d9313c7f5293a33b35b37539b_27633_500x0_resize_q90_h2_box_3.webp 500w,/blog/use-terraform-to-deploy-an-azure-kubernetes-service-aks-cluster-traefik-2-cert-manager-and-lets-encrypt-certificates/nginx-demo_hu7a98c42d9313c7f5293a33b35b37539b_27633_526x0_resize_q90_h2_box_3.webp 526w"><img src=/blog/use-terraform-to-deploy-an-azure-kubernetes-service-aks-cluster-traefik-2-cert-manager-and-lets-encrypt-certificates/nginx-demo.png srcset="/blog/use-terraform-to-deploy-an-azure-kubernetes-service-aks-cluster-traefik-2-cert-manager-and-lets-encrypt-certificates/nginx-demo_hu7a98c42d9313c7f5293a33b35b37539b_27633_300x0_resize_box_3.png 300w,/blog/use-terraform-to-deploy-an-azure-kubernetes-service-aks-cluster-traefik-2-cert-manager-and-lets-encrypt-certificates/nginx-demo_hu7a98c42d9313c7f5293a33b35b37539b_27633_400x0_resize_box_3.png 400w,/blog/use-terraform-to-deploy-an-azure-kubernetes-service-aks-cluster-traefik-2-cert-manager-and-lets-encrypt-certificates/nginx-demo_hu7a98c42d9313c7f5293a33b35b37539b_27633_500x0_resize_box_3.png 500w,/blog/use-terraform-to-deploy-an-azure-kubernetes-service-aks-cluster-traefik-2-cert-manager-and-lets-encrypt-certificates/nginx-demo_hu7a98c42d9313c7f5293a33b35b37539b_27633_526x0_resize_box_3.png 526w" alt="nginx Demo" loading=lazy width=526 height=306></picture></p><p>To verify the HTTPS redirect works, we run <code>curl -svDL http://hello.k8s.schnerring.net</code> (PowerShell), or <code>curl -sLD - http://hello.k8s.schnerring.net</code> (Bash):</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-text data-lang=text><span style=display:flex><span>...
</span></span><span style=display:flex><span>&lt; HTTP/1.1 301 Moved Permanently
</span></span><span style=display:flex><span>&lt; Location: https://hello.k8s.schnerring.net/
</span></span><span style=display:flex><span>...
</span></span></code></pre></div><p>To get rid of the certificate warning, set <code>"cert-manager.io/cluster-issuer" = "letsencrypt-production"</code>. But be aware of <a href=https://letsencrypt.org/docs/rate-limits/ class=link--external target=_blank rel=noreferrer>rate limits that apply to the Let&rsquo;s Encrypt production API</a>!</p><h2 id=one-last-thing>One Last Thing
<a href=#one-last-thing class=post-heading__anchor aria-hidden=true>#</a></h2><p>If we want to tear down the cluster and rebuild, we cannot achieve this in <em>one</em> <code>terraform apply</code> operation. The reason is that the <code>kubernetes</code> provider requires an operational cluster during the <code>terraform plan</code> phase. On top of that, any CRDs we deploy have to be available during <code>terraform plan</code>, too.</p><p>So when rebuilding, we would first create the AKS cluster and deploy cert-manager and then apply the rest:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>terraform destroy -target <span style=color:#e6db74>&#34;azurerm_resource_group.k8s&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>terraform plan -out infrastructure.tfplan -target <span style=color:#e6db74>&#34;helm_release.cert_manager&#34;</span>
</span></span><span style=display:flex><span>terraform apply infrastructure.tfplan
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>terraform plan -out infrastructure.tfplan
</span></span><span style=display:flex><span>terraform apply infrastructure.tfplan
</span></span></code></pre></div><p>I already mentioned this earlier. The need for the workaround above originates from stacking Kubernetes cluster infrastructure with Kubernetes resources which the <a href=https://registry.terraform.io/providers/hashicorp/kubernetes/latest/docs#stacking-with-managed-kubernetes-cluster-resources class=link--external target=_blank rel=noreferrer>official Kubernetes provider documentation discourages</a>. Adhering to the docs and separating cluster and Kubernetes resources into different modules will probably save you a headache!</p><p>Other than that, we created a pretty cool solution, fully managed by Terraform, did we not?</p><p>You can find all the code on GitHub in my <a href=https://github.com/schnerring/infrastructure-core/blob/v0.5.0/k8s.tf class=link--external target=_blank rel=noreferrer>schnerring/infrastructure-core repository</a>, which is evolving continuously. After committing the code to the repo, I added the <code>v0.4.0</code> tag. This way, in the future, we can easily find the code depicted in this post.</p></div><div class=social-share><strong class=social-share__heading>Share this post:</strong>
<a class=social-share__item href="https://twitter.com/intent/tweet?url=https%3A%2F%2Fschnerring.net%2Fblog%2Fuse-terraform-to-deploy-an-azure-kubernetes-service-aks-cluster-traefik-2-cert-manager-and-lets-encrypt-certificates%2F&text=Use+Terraform+to+Deploy+an+Azure+Kubernetes+Service+%28AKS%29+Cluster%2C+Traefik+2%2C+cert-manager%2C+and+Let%27s+Encrypt+Certificates" target=_blank rel=noreferrer><svg role="img" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><title>Twitter</title><path d="M23.953 4.57a10 10 0 01-2.825.775 4.958 4.958.0 002.163-2.723c-.951.555-2.005.959-3.127 1.184A4.92 4.92.0 0011.78 8.288C7.69 8.095 4.067 6.13 1.64 3.162A4.822 4.822.0 00.974 5.637c0 1.71.87 3.213 2.188 4.096A4.904 4.904.0 01.934 9.117v.06a4.923 4.923.0 003.946 4.827 4.996 4.996.0 01-2.212.085 4.936 4.936.0 004.604 3.417A9.867 9.867.0 011.17 19.611c-.39.0-.779-.023-1.17-.067a13.995 13.995.0 007.557 2.209c9.053.0 13.998-7.496 13.998-13.985.0-.21.0-.42-.015-.63A9.935 9.935.0 0024 4.59z"/></svg></a><a class=social-share__item href="https://www.linkedin.com/sharing/share-offsite/?url=https%3A%2F%2Fschnerring.net%2Fblog%2Fuse-terraform-to-deploy-an-azure-kubernetes-service-aks-cluster-traefik-2-cert-manager-and-lets-encrypt-certificates%2F" target=_blank rel=noreferrer><svg role="img" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><title>LinkedIn</title><path d="M20.447 20.452h-3.554v-5.569c0-1.328-.027-3.037-1.852-3.037-1.853.0-2.136 1.445-2.136 2.939v5.667H9.351V9h3.414v1.561h.046c.477-.9 1.637-1.85 3.37-1.85 3.601.0 4.267 2.37 4.267 5.455v6.286zM5.337 7.433c-1.144.0-2.063-.926-2.063-2.065.0-1.138.92-2.063 2.063-2.063 1.14.0 2.064.925 2.064 2.063.0 1.139-.925 2.065-2.064 2.065zm1.782 13.019H3.555V9h3.564v11.452zM22.225.0H1.771C.792.0.0.774.0 1.729v20.542C0 23.227.792 24 1.771 24h20.451C23.2 24 24 23.227 24 22.271V1.729C24 .774 23.2.0 22.222.0h.003z"/></svg></a><a class=social-share__item href="https://www.facebook.com/sharer.php?u=https%3A%2F%2Fschnerring.net%2Fblog%2Fuse-terraform-to-deploy-an-azure-kubernetes-service-aks-cluster-traefik-2-cert-manager-and-lets-encrypt-certificates%2F" target=_blank rel=noreferrer><svg role="img" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><title>Facebook</title><path d="M24 12.073c0-6.627-5.373-12-12-12s-12 5.373-12 12c0 5.99 4.388 10.954 10.125 11.854v-8.385H7.078v-3.47h3.047V9.43c0-3.007 1.792-4.669 4.533-4.669 1.312.0 2.686.235 2.686.235v2.953H15.83c-1.491.0-1.956.925-1.956 1.874v2.25h3.328l-.532 3.47h-2.796v8.385C19.612 23.027 24 18.062 24 12.073z"/></svg></a><a class=social-share__item href="https://reddit.com/submit?url=https%3A%2F%2Fschnerring.net%2Fblog%2Fuse-terraform-to-deploy-an-azure-kubernetes-service-aks-cluster-traefik-2-cert-manager-and-lets-encrypt-certificates%2F&title=Use+Terraform+to+Deploy+an+Azure+Kubernetes+Service+%28AKS%29+Cluster%2C+Traefik+2%2C+cert-manager%2C+and+Let%27s+Encrypt+Certificates" target=_blank rel=noreferrer><svg role="img" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><title>Reddit</title><path d="M12 0A12 12 0 000 12a12 12 0 0012 12 12 12 0 0012-12A12 12 0 0012 0zm5.01 4.744c.688.0 1.25.561 1.25 1.249a1.25 1.25.0 01-2.498.056l-2.597-.547-.8 3.747c1.824.07 3.48.632 4.674 1.488.308-.309.73-.491 1.207-.491.968.0 1.754.786 1.754 1.754.0.716-.435 1.333-1.01 1.614a3.111 3.111.0 01.042.52c0 2.694-3.13 4.87-7.004 4.87s-7.004-2.176-7.004-4.87c0-.183.015-.366.043-.534A1.748 1.748.0 014.028 12c0-.968.786-1.754 1.754-1.754.463.0.898.196 1.207.49 1.207-.883 2.878-1.43 4.744-1.487l.885-4.182a.342.342.0 01.14-.197.35.35.0 01.238-.042l2.906.617a1.214 1.214.0 011.108-.701zM9.25 12C8.561 12 8 12.562 8 13.25c0 .687.561 1.248 1.25 1.248.687.0 1.248-.561 1.248-1.249S9.937 12 9.249 12zm5.5.0c-.687.0-1.248.561-1.248 1.25.0.687.561 1.248 1.249 1.248S16 13.937 16 13.249c0-.687-.562-1.249-1.25-1.249zm-5.466 3.99a.327.327.0 00-.231.094.33.33.0 000 .463c.842.842 2.484.913 2.961.913s2.105-.056 2.961-.913a.361.361.0 00.029-.463.33.33.0 00-.464.0c-.547.533-1.684.73-2.512.73-.828.0-1.979-.196-2.512-.73a.326.326.0 00-.232-.095z"/></svg></a><a class=social-share__item href="https://news.ycombinator.com/submitlink?u=https%3A%2F%2Fschnerring.net%2Fblog%2Fuse-terraform-to-deploy-an-azure-kubernetes-service-aks-cluster-traefik-2-cert-manager-and-lets-encrypt-certificates%2F&t=Use+Terraform+to+Deploy+an+Azure+Kubernetes+Service+%28AKS%29+Cluster%2C+Traefik+2%2C+cert-manager%2C+and+Let%27s+Encrypt+Certificates" target=_blank rel=noreferrer><svg role="img" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><title>Y Combinator</title><path d="M0 24V0h24v24H0zM6.951 5.896l4.112 7.708v5.064h1.583v-4.972l4.148-7.799h-1.749l-2.457 4.875c-.372.745-.688 1.434-.688 1.434s-.297-.708-.651-1.434L8.831 5.896h-1.88z"/></svg></a><a class=social-share__item href="mailto:?subject=Use+Terraform+to+Deploy+an+Azure+Kubernetes+Service+%28AKS%29+Cluster%2C+Traefik+2%2C+cert-manager%2C+and+Let%27s+Encrypt+Certificates&body=https%3A%2F%2Fschnerring.net%2Fblog%2Fuse-terraform-to-deploy-an-azure-kubernetes-service-aks-cluster-traefik-2-cert-manager-and-lets-encrypt-certificates%2F" target=_blank rel=noreferrer><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-mail" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><rect x="3" y="5" width="18" height="14" rx="2"/><polyline points="3 7 12 13 21 7"/></svg></a></div><div id=remark42></div><script>var remark_config={host:"https://remark42.schnerring.net",site_id:"schnerring.net",theme:localStorage.getItem("theme"),show_email_subscription:!1}</script><script>!function(s,n){for(t=0;t<s.length;t++){var t,e=n.createElement("script"),o=".js",i=n.head||n.body;"noModule"in e?(e.type="module",o=".mjs"):e.async=!0,e.defer=!0,e.src=remark_config.host+"/web/"+s[t]+o,i.appendChild(e)}}(remark_config.components||["embed"],document)</script><script>const themeToggleLight=document.getElementsByClassName("theme__toggle light--hidden").item(0);themeToggleLight.addEventListener("click",()=>{setTimeout(()=>window.REMARK42.changeTheme("light"),10)});const themeToggleDark=document.getElementsByClassName("theme__toggle dark--hidden").item(0);themeToggleDark.addEventListener("click",()=>{setTimeout(()=>window.REMARK42.changeTheme("dark"),10)})</script><script>function cookieConsentClick(){localStorage.setItem("cookie-consent",!0);const e=document.getElementById("cookie-consent");e.classList.add("cookie-consent--hidden")}</script><div id=cookie-consent class=cookie-consent--hidden><div class=cli-prompt><div class=cli-prompt__chevron>>&nbsp;</div><div class=cli-prompt__text><span>When you participate in the comments, a cookie is used to keep you logged in.</span>
<span class=cli-prompt__cursor>█</span></div><button onclick=cookieConsentClick()>Got it!</button></div></div><script>const cookieConsentAccepted=localStorage&&localStorage.getItem("cookie-consent");if(!cookieConsentAccepted){const e=document.getElementById("cookie-consent");e.classList.remove("cookie-consent--hidden")}</script></article></div><div class=sidebar><aside class=bio><section class="jr__item jr-basics__item"><div class=jr-basics__image><img src=https://schnerring.net/michael-schnerring.jpg alt="Picture of Michael Schnerring" width=250 height=250></div><div class=jr-basics__name>Michael Schnerring</div><div class=jr-basics__label>Software Engineer</div><div class=jr-basics__summary>I've been a computer geek all my life. I'm passionate about open-source and digital privacy. I like video games and CrossFit. I'm also terrible at blogging.</div><div class=jr-basics__location-city>Zurich</div><div class=jr-basics__location-region>Switzerland</div><hr><div class="jr-basics__profile jr-basics__profile--row"><a href=https://github.com/schnerring><div class=jr-basics__profile-item><div class=jr-basics__profile-icon><svg role="img" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><title>GitHub</title><path d="M12 .297c-6.63.0-12 5.373-12 12 0 5.303 3.438 9.8 8.205 11.385.6.113.82-.258.82-.577.0-.285-.01-1.04-.015-2.04-3.338.724-4.042-1.61-4.042-1.61C4.422 18.07 3.633 17.7 3.633 17.7c-1.087-.744.084-.729.084-.729 1.205.084 1.838 1.236 1.838 1.236 1.07 1.835 2.809 1.305 3.495.998.108-.776.417-1.305.76-1.605-2.665-.3-5.466-1.332-5.466-5.93.0-1.31.465-2.38 1.235-3.22-.135-.303-.54-1.523.105-3.176.0.0 1.005-.322 3.3 1.23.96-.267 1.98-.399 3-.405 1.02.006 2.04.138 3 .405 2.28-1.552 3.285-1.23 3.285-1.23.645 1.653.24 2.873.12 3.176.765.84 1.23 1.91 1.23 3.22.0 4.61-2.805 5.625-5.475 5.92.42.36.81 1.096.81 2.22.0 1.606-.015 2.896-.015 3.286.0.315.21.69.825.57C20.565 22.092 24 17.592 24 12.297c0-6.627-5.373-12-12-12"/></svg></div></div></a><a href=https://www.linkedin.com/in/schnerring><div class=jr-basics__profile-item><div class=jr-basics__profile-icon><svg role="img" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><title>LinkedIn</title><path d="M20.447 20.452h-3.554v-5.569c0-1.328-.027-3.037-1.852-3.037-1.853.0-2.136 1.445-2.136 2.939v5.667H9.351V9h3.414v1.561h.046c.477-.9 1.637-1.85 3.37-1.85 3.601.0 4.267 2.37 4.267 5.455v6.286zM5.337 7.433c-1.144.0-2.063-.926-2.063-2.065.0-1.138.92-2.063 2.063-2.063 1.14.0 2.064.925 2.064 2.063.0 1.139-.925 2.065-2.064 2.065zm1.782 13.019H3.555V9h3.564v11.452zM22.225.0H1.771C.792.0.0.774.0 1.729v20.542C0 23.227.792 24 1.771 24h20.451C23.2 24 24 23.227 24 22.271V1.729C24 .774 23.2.0 22.222.0h.003z"/></svg></div></div></a><a href=https://twitter.com/schnerringo><div class=jr-basics__profile-item><div class=jr-basics__profile-icon><svg role="img" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><title>Twitter</title><path d="M23.953 4.57a10 10 0 01-2.825.775 4.958 4.958.0 002.163-2.723c-.951.555-2.005.959-3.127 1.184A4.92 4.92.0 0011.78 8.288C7.69 8.095 4.067 6.13 1.64 3.162A4.822 4.822.0 00.974 5.637c0 1.71.87 3.213 2.188 4.096A4.904 4.904.0 01.934 9.117v.06a4.923 4.923.0 003.946 4.827 4.996 4.996.0 01-2.212.085 4.936 4.936.0 004.604 3.417A9.867 9.867.0 011.17 19.611c-.39.0-.779-.023-1.17-.067a13.995 13.995.0 007.557 2.209c9.053.0 13.998-7.496 13.998-13.985.0-.21.0-.42-.015-.63A9.935 9.935.0 0024 4.59z"/></svg></div></div></a><a href=https://matrix.to/#/@michael:schnerring.net><div class=jr-basics__profile-item><div class=jr-basics__profile-icon><svg role="img" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><title>Matrix</title><path d="M.632.55v22.9H2.28V24H0V0h2.28v.55zm7.043 7.26v1.157h.033c.309-.443.683-.784 1.117-1.024.433-.245.936-.365 1.5-.365.54.0 1.033.107 1.481.314.448.208.785.582 1.02 1.108.254-.374.6-.706 1.034-.992.434-.287.95-.43 1.546-.43.453.0.872.056 1.26.167.388.11.716.286.993.53.276.245.489.559.646.951.152.392.23.863.23 1.417v5.728h-2.349V11.52c0-.286-.01-.559-.032-.812a1.755 1.755.0 00-.18-.66 1.106 1.106.0 00-.438-.448c-.194-.11-.457-.166-.785-.166-.332.0-.6.064-.803.189a1.38 1.38.0 00-.48.499 1.946 1.946.0 00-.231.696 5.56 5.56.0 00-.06.785v4.768h-2.35v-4.8c0-.254-.004-.503-.018-.752a2.074 2.074.0 00-.143-.688 1.052 1.052.0 00-.415-.503c-.194-.125-.476-.19-.854-.19-.111.0-.259.024-.439.074-.18.051-.36.143-.53.282-.171.138-.319.337-.439.595-.12.259-.18.6-.18 1.02v4.966H5.46V7.81zm15.693 15.64V.55H21.72V0H24v24h-2.28v-.55z"/></svg></div></div></a><a href=https://stackoverflow.com/users/1154965/michael-schnerring><div class=jr-basics__profile-item><div class=jr-basics__profile-icon><svg role="img" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><title>Stack Overflow</title><path d="M15.725.0l-1.72 1.277 6.39 8.588 1.716-1.277L15.725.0zm-3.94 3.418-1.369 1.644 8.225 6.85 1.369-1.644-8.225-6.85zm-3.15 4.465-.905 1.94 9.702 4.517.904-1.94-9.701-4.517zm-1.85 4.86-.44 2.093 10.473 2.201.44-2.092-10.473-2.203zM1.89 15.47V24h19.19v-8.53h-2.133v6.397H4.021v-6.396H1.89zm4.265 2.133v2.13h10.66v-2.13H6.154z"/></svg></div></div></a><a href=https://schnerring.net/index.xml><div class=jr-basics__profile-item><div class=jr-basics__profile-icon><svg role="img" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><title>RSS</title><path d="M19.199 24C19.199 13.467 10.533 4.8.0 4.8V0c13.165.0 24 10.835 24 24h-4.801zM3.291 17.415c1.814.0 3.293 1.479 3.293 3.295.0 1.813-1.485 3.29-3.301 3.29C1.47 24 0 22.526.0 20.71s1.475-3.294 3.291-3.295zM15.909 24h-4.665c0-6.169-5.075-11.245-11.244-11.245V8.09c8.727.0 15.909 7.184 15.909 15.91z"/></svg></div></div></a></div></section></aside></div></main><footer><div class=copyright>© 2020 Michael Schnerring</div></footer><script type=text/javascript src=/js/main.4ce80f0edb5c88e820c9ef238ad8731cce50d4377a4e3ef6cf92e90021a7ca51413183f6f87c7b1189f80cd36d0768f97a084cfe8145be39c118bde35e75ff7c.js integrity="sha512-TOgPDttciOggye8jithzHM5Q1Dd6Tj72z5LpACGnylFBMYP2+Hx7EYn4DNNtB2j5eghM/oFFvjnBGL3jXnX/fA=="></script><script type=text/javascript src=/js/flexsearch.9be8956ca92d1ad7f26c5204c7ea89934cb498023eb72801410c77be60e3f092f22ef2103e3c1189579dda9705c48167cfe01626cca21693802ff08ad66154f6.js integrity="sha512-m+iVbKktGtfybFIEx+qJk0y0mAI+tygBQQx3vmDj8JLyLvIQPjwRiVed2pcFxIFnz+AWJsyiFpOAL/CK1mFU9g=="></script></div></body></html>